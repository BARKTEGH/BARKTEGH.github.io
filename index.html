<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"yoursite.com","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.23.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"æœç´¢...","empty":"æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœç´¢ç»“æœï¼š${query}","hits_time":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰","hits":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœ"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js" defer></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="ä¸‰åè€Œç«‹çš„åšå®¢">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="ä¸‰åè€Œç«‹çš„åšå®¢">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="ä¸‰åè€Œç«‹">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://yoursite.com/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>ä¸‰åè€Œç«‹çš„åšå®¢</title>
  








  
  <script size="300" alpha="0.6" zIndex="-1" src="https://cdnjs.cloudflare.com/ajax/libs/ribbon.js/1.0.2/ribbon.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous" defer></script>
<script src="/js/third-party/search/local-search.js" defer></script>







  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/rss2.xml" title="ä¸‰åè€Œç«‹çš„åšå®¢" type="application/rss+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ " role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">ä¸‰åè€Œç«‹çš„åšå®¢</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">äººç”Ÿè‹¦çŸ­</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="æœç´¢" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>å…³äº</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾<span class="badge">26</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»<span class="badge">14</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£<span class="badge">20</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="æœç´¢..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="ä¸‰åè€Œç«‹"
      src="/uploads/image.png">
  <p class="site-author-name" itemprop="name">ä¸‰åè€Œç«‹</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">20</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">14</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">26</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/BARKTEGH" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;BARKTEGH" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2025/07/21/%E9%B8%BF%E8%92%99%E5%88%A4%E6%96%AD%E5%BA%94%E7%94%A8%E6%98%AF%E5%90%A6%E6%94%AF%E6%8C%81%E6%9F%90%E8%83%BD%E5%8A%9B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/image.png">
      <meta itemprop="name" content="ä¸‰åè€Œç«‹">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ä¸‰åè€Œç«‹çš„åšå®¢">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ä¸‰åè€Œç«‹çš„åšå®¢">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/07/21/%E9%B8%BF%E8%92%99%E5%88%A4%E6%96%AD%E5%BA%94%E7%94%A8%E6%98%AF%E5%90%A6%E6%94%AF%E6%8C%81%E6%9F%90%E8%83%BD%E5%8A%9B/" class="post-title-link" itemprop="url">é¸¿è’™åˆ¤æ–­åº”ç”¨æ˜¯å¦æ”¯æŒæŸèƒ½åŠ›</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2025-07-21 23:47:21" itemprop="dateCreated datePublished" datetime="2025-07-21T23:47:21+08:00">2025-07-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-09-22 00:01:57" itemprop="dateModified" datetime="2025-09-22T00:01:57+08:00">2025-09-22</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>991</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>4 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><p>åœ¨é¸¿è’™ç³»ç»Ÿè·¨åº”ç”¨èƒ½åŠ›è°ƒç”¨åœºæ™¯ä¸­ï¼Œéœ€è§£å†³ä»¥ä¸‹æ ¸å¿ƒé—®é¢˜ï¼šè¢«è°ƒç”¨æ–¹åº”ç”¨çš„ç‰ˆæœ¬æ˜¯å¦æ»¡è¶³å½“å‰æ‰€éœ€åŠŸèƒ½ã€‚ä¾‹å¦‚SDKåˆ¤æ–­æŠ–éŸ³æ˜¯å¦æ”¯æŒæŠ•ç¨¿ã€æˆæƒæ‰çœŸæ­£è¿›è¡Œæ‹‰èµ·æŠ–éŸ³ï¼Œä¸ç„¶ä¼šå‡ºç°æ‹‰èµ·æŠ–éŸ³åæ²¡æœ‰ä»»ä½•ååº”æˆ–è€…èƒ½åŠ›ç¼ºå¤±ã€‚å› æ­¤ç›®æ ‡ä¸ºå®ç°åœ¨SDKä¾§èƒ½åˆ¤æ–­åº”ç”¨æ˜¯å¦æ”¯æŒæŸèƒ½åŠ›ã€‚</p>
<h2 id="æ–¹æ¡ˆå¯¹æ¯”ï¼ˆå¤ªé•¿ä¸çœ‹ç‰ˆï¼‰"><a href="#æ–¹æ¡ˆå¯¹æ¯”ï¼ˆå¤ªé•¿ä¸çœ‹ç‰ˆï¼‰" class="headerlink" title="æ–¹æ¡ˆå¯¹æ¯”ï¼ˆå¤ªé•¿ä¸çœ‹ç‰ˆï¼‰"></a>æ–¹æ¡ˆå¯¹æ¯”ï¼ˆå¤ªé•¿ä¸çœ‹ç‰ˆï¼‰</h2><table>
<thead>
<tr>
<th>æ–¹æ¡ˆ</th>
<th>å®ç°</th>
<th>æ˜¯å¦å¯ç”¨</th>
<th>æ˜¯å¦å¯åŠ¨å¯¹æ–¹è¿›ç¨‹</th>
<th>ä¼˜ç‚¹</th>
<th>ç¼ºç‚¹</th>
</tr>
</thead>
<tbody><tr>
<td>metadata å­—æ®µè¯»å–</td>
<td>åº”ç”¨ A åœ¨ module.json5 å£°æ˜èƒ½åŠ›åŠç‰ˆæœ¬å·ï¼ŒSDK ä¾§ç”¨ bundleManager è¯»å–</td>
<td>âŒ</td>
<td>ä¸ä¼šå¯åŠ¨</td>
<td>è¯»å–è½»é‡ï¼Œæ€§èƒ½æé«˜ï¼Œä¸ä¾èµ–è¿›ç¨‹å­˜æ´»ï¼›å¯ä»¥éšæ„è‡ªå®šä¹‰å­—æ®µ</td>
<td>ä¸‰æ–¹åº”ç”¨åªèƒ½æŸ¥è‡ªèº«åŒ…ä¿¡æ¯ï¼ŒSDK æ— æ³•è¯»å–å…¶ä»–åº”ç”¨ä¿¡æ¯</td>
</tr>
<tr>
<td>DataShareExtensionAbility</td>
<td>åº”ç”¨ A ä¾§å£°æ˜å¹¶æ³¨å†Œæ‰©å±•èƒ½åŠ›ï¼ŒSDK ä¾§åˆ›å»º DataShareHelper æŸ¥è¯¢</td>
<td>âŒ</td>
<td>ä¼šå¯åŠ¨å¯¹æ–¹çš„ DataShareExtensionAbility è¿›ç¨‹ï¼ˆä½†ä¸æ‹‰ UIï¼‰</td>
<td>è·¨åº”ç”¨é€šç”¨ï¼Œæ•°æ®å¯åŠ¨æ€æ›´æ–°ã€‚å¦‚æœèƒ½åŠ›æœ‰é—®é¢˜åœ¨Appä¾§å¯ä»¥é€šè¿‡settingsä¿®æ”¹å€¼æ¥é¿å…æ‹‰èµ·å´ä¸å¯ç”¨çš„æƒ…å†µã€‚</td>
<td>ç¬¬ä¸€æ¬¡è°ƒç”¨è€—æ—¶ï¼ˆå†·å¯åŠ¨å‡ å~å‡ ç™¾ msï¼‰ï¼›IPC å¤§æ•°æ®æ•ˆç‡ä½ï¼›ç›®å‰ä»…å¯¹ç³»ç»Ÿåº”ç”¨å¼€æ”¾ï¼Œæš‚ä¸æä¾›ç›¸å…³å†…å®¹ä¸æŒ‡å¯¼</td>
</tr>
<tr>
<td>ä½¿ç”¨ canOpenLink åˆ¤æ–­åº”ç”¨æ˜¯å¦å¯è®¿é—®</td>
<td>è°ƒç”¨æ–¹åœ¨ module.json5 é…ç½® querySchemes å£°æ˜ URL schemeï¼Œè°ƒç”¨ canOpenLink æ¥å£ï¼›ç›®æ ‡æ–¹é…ç½® uris å±æ€§</td>
<td>âœ…</td>
<td>ä¸ä¼šå¯åŠ¨</td>
<td>è¯»å–è½»é‡ï¼Œæ€§èƒ½æé«˜ï¼Œä¸ä¾èµ–è¿›ç¨‹å­˜æ´»</td>
<td>1. è°ƒç”¨æ–¹çš„ querySchemes æœ€å¤šé…ç½® 50 ä¸ª URL scheme  2. æ¯æ¬¡æ–°å¢ç‰ˆæœ¬å·éœ€è¦åœ¨è¢«è°ƒç”¨ä¾§æ–°å¢ schema çš„ hostã€‚</td>
</tr>
</tbody></table>
<h2 id="æ–¹æ¡ˆè°ƒç ”"><a href="#æ–¹æ¡ˆè°ƒç ”" class="headerlink" title="æ–¹æ¡ˆè°ƒç ”"></a>æ–¹æ¡ˆè°ƒç ”</h2><h3 id="metadataå­—æ®µè¯»å–"><a href="#metadataå­—æ®µè¯»å–" class="headerlink" title="metadataå­—æ®µè¯»å–"></a>metadataå­—æ®µè¯»å–</h3><p><strong>å®ç°</strong></p>
<p>åœ¨åº”ç”¨Aä¾§çš„module.json5 é‡Œå£°æ˜èƒ½åŠ›åŠç‰ˆæœ¬å·ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;module&quot;: &#123;</span><br><span class="line">    &quot;abilities&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;name&quot;: &quot;MainAbility&quot;,</span><br><span class="line">        &quot;srcEntry&quot;: &quot;./ets/MainAbility.ets&quot;,</span><br><span class="line">        &quot;label&quot;: &quot;AppA&quot;,</span><br><span class="line">        &quot;metadata&quot;: [</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;name&quot;: &quot;bytedance_open_sdk_support&quot;,</span><br><span class="line">            &quot;value&quot;: &quot;1&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨SDKä¾§ä½¿ç”¨bundleManager è¯»å–å­—æ®µ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">import bundleManager from &#x27;@ohos.bundle.bundleManager&#x27;;</span><br><span class="line"></span><br><span class="line">async function getAppACapabilityVersion(): Promise&lt;string | null&gt; &#123;</span><br><span class="line">  try &#123;</span><br><span class="line">    let bundleInfo = await bundleManager.getBundleInfo(</span><br><span class="line">      &quot;com.example.appA&quot;,  // App A çš„åŒ…å</span><br><span class="line">      bundleManager.BundleFlag.GET_ABILITY_INFO_WITH_METADATA</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    for (let ability of bundleInfo.abilityInfos) &#123;</span><br><span class="line">      if (ability.metadata) &#123;</span><br><span class="line">        for (let meta of ability.metadata) &#123;</span><br><span class="line">          if (meta.name === &quot;bytedance_open_sdk_support&quot;) &#123;</span><br><span class="line">            console.log(`App A èƒ½åŠ›ç‰ˆæœ¬å·: $&#123;meta.value&#125;`);</span><br><span class="line">            return meta.value; </span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; catch (err) &#123;</span><br><span class="line">    console.error(&quot;è¯»å–èƒ½åŠ›å¤±è´¥: &quot; + JSON.stringify(err));</span><br><span class="line">  &#125;</span><br><span class="line">  return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>é—®é¢˜</strong></p>
<p>ä¸‰æ–¹åº”ç”¨ç›®å‰åªèƒ½æŸ¥è¯¢åˆ°è‡ªèº«åº”ç”¨åŒ…çš„ä¿¡æ¯ï¼Œç”±äºå®‰å…¨éšç§ï¼Œæš‚æ—¶ä¸æ”¯æŒæŸ¥è¯¢å…¶ä»–åº”ç”¨ã€‚å› æ­¤åœ¨SDKä¾§æ— æ³•é€šè¿‡bundleManagerè¯»å–å…¶ä»–åº”ç”¨çš„ä¿¡æ¯ã€‚<br><a href="https://developer.huawei.com/consumer/cn/doc/architecture-guides/insurance-v1_2-ts_34-0000002312854248">https://developer.huawei.com/consumer/cn/doc/architecture-guides/insurance-v1_2-ts_34-0000002312854248</a></p>
<h3 id="DataShareExtensionAbility"><a href="#DataShareExtensionAbility" class="headerlink" title="DataShareExtensionAbility"></a>DataShareExtensionAbility</h3><p><strong>å®ç°</strong></p>
<p>åœ¨åº”ç”¨Aä¾§å£°æ˜ DataShareExtensionAbilityåœ¨ ets&#x2F;CustomDataShare.ets é‡Œï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">import dataShare from &#x27;@ohos.data.dataShare&#x27;;</span><br><span class="line">import hilog from &#x27;@ohos.hilog&#x27;;</span><br><span class="line"></span><br><span class="line">const TAG: string = &quot;CustomDataShare&quot;;</span><br><span class="line"></span><br><span class="line">export default class CustomDataShare extends dataShare.DataShareExtensionAbility &#123;</span><br><span class="line">  onCreate(want, callback) &#123;</span><br><span class="line">    hilog.info(0x0000, TAG, &quot;DataShareExtensionAbility onCreate&quot;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // å¤„ç†æŸ¥è¯¢è¯·æ±‚</span><br><span class="line">  async query(uri, columns, predicates, callback) &#123;</span><br><span class="line">    hilog.info(0x0000, TAG, `query called. uri=$&#123;uri&#125;`);</span><br><span class="line"></span><br><span class="line">    // æ¨¡æ‹Ÿè¿”å›ä¸€ä¸ªè‡ªå®šä¹‰å­—æ®µ</span><br><span class="line">    let resultSet = &#123;</span><br><span class="line">      columnNames: [&quot;customField&quot;],</span><br><span class="line">      rowCount: 1,</span><br><span class="line">      rowIndex: 0,</span><br><span class="line">      getString: (index) =&gt; &#123;</span><br><span class="line">        if (index === 0) return &quot;HelloFromProviderApp&quot;;</span><br><span class="line">        return &quot;&quot;;</span><br><span class="line">      &#125;,</span><br><span class="line">      goToFirstRow: () =&gt; true,</span><br><span class="line">      close: () =&gt; &#123;&#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    callback.onResult(resultSet);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p> åœ¨ module.json5 æ³¨å†Œæ‰©å±•èƒ½åŠ›<br> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;extensionAbilities&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;name&quot;: &quot;CustomDataShare&quot;,</span><br><span class="line">      &quot;srcEntry&quot;: &quot;./ets/CustomDataShare.ets&quot;,</span><br><span class="line">      &quot;type&quot;: &quot;dataShare&quot;,</span><br><span class="line">      &quot;uri&quot;: &quot;datashareproxy://com.example.provider&quot; </span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>SDKä¾§</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">async queryCustomField() &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">      let context = featureAbility.getContext();</span><br><span class="line">      let helper = await dataShare.createDataShareHelper(</span><br><span class="line">        context,</span><br><span class="line">        &quot;datashareproxy://com.example.provider&quot;</span><br><span class="line">      );</span><br><span class="line">      </span><br><span class="line">      let resultSet = await helper.query(</span><br><span class="line">        &#123; uri: &quot;datashareproxy://com.example.provider/customField&quot; &#125;,</span><br><span class="line">        [&quot;customField&quot;],</span><br><span class="line">        null</span><br><span class="line">      );</span><br><span class="line"></span><br><span class="line">      if (resultSet.goToFirstRow()) &#123;</span><br><span class="line">        this.message = resultSet.getString(0);</span><br><span class="line">      &#125;</span><br><span class="line">      resultSet.close();</span><br><span class="line">    &#125; catch (err) &#123;</span><br><span class="line">      hilog.error(0x0000, TAG, &quot;query error: &quot; + JSON.stringify(err));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p><strong>é—®é¢˜</strong></p>
<p>ä½¿ç”¨DataShareExtensionAbilityå®ç°æ•°æ®å…±äº«ï¼šç›®å‰ä»…å¯¹ç³»ç»Ÿåº”ç”¨å¼€æ”¾ï¼Œæš‚ä¸å…·ä½“å±•å¼€æä¾›ç›¸å…³å†…å®¹å’ŒæŒ‡å¯¼ã€‚<br><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/data-share-overview">https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/data-share-overview</a></p>
<h3 id="canOpenLink-åˆ¤æ–­åº”ç”¨æ˜¯å¦å¯è®¿é—®"><a href="#canOpenLink-åˆ¤æ–­åº”ç”¨æ˜¯å¦å¯è®¿é—®" class="headerlink" title="canOpenLink åˆ¤æ–­åº”ç”¨æ˜¯å¦å¯è®¿é—®"></a>canOpenLink åˆ¤æ–­åº”ç”¨æ˜¯å¦å¯è®¿é—®</h3><p><strong>å®ç°</strong></p>
<p>å‚è€ƒæ–‡æ¡£ï¼š<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/canopenlink">https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/canopenlink</a></p>
<p>è°ƒç”¨æ–¹ï¼ˆSDKï¼‰ï¼š</p>
<ol>
<li>åœ¨ entry æ¨¡å—çš„ module.json5 æ–‡ä»¶ä¸­é…ç½® querySchemes å±æ€§ï¼Œå£°æ˜æƒ³è¦æŸ¥è¯¢çš„ URL schemeã€‚</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;module&quot;: &#123;</span><br><span class="line">    //...</span><br><span class="line">    &quot;querySchemes&quot;: [</span><br><span class="line">      &quot;app1Scheme&quot;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>è°ƒç”¨ canOpenLink æ¥å£ï¼š<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">import &#123; bundleManager &#125; from &#x27;@kit.AbilityKit&#x27;;</span><br><span class="line">import &#123; BusinessError &#125; from &#x27;@kit.BasicServicesKit&#x27;;</span><br><span class="line">import &#123; hilog &#125; from &#x27;@kit.PerformanceAnalysisKit&#x27;;</span><br><span class="line">try &#123;</span><br><span class="line">  let link = &#x27;app1Scheme://test.example.com/home&#x27;;</span><br><span class="line">  let canOpen = bundleManager.canOpenLink(link);</span><br><span class="line">  hilog.info(0x0000, &#x27;testTag&#x27;, &#x27;canOpenLink successfully: %&#123;public&#125;s&#x27;, JSON.stringify(canOpen));</span><br><span class="line">&#125; catch (err) &#123;</span><br><span class="line">  let message = (err as BusinessError).message;</span><br><span class="line">  hilog.error(0x0000, &#x27;testTag&#x27;, &#x27;canOpenLink failed: %&#123;public&#125;s&#x27;, message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p>ç›®æ ‡æ–¹ï¼š<br>åœ¨ module.json5 æ–‡ä»¶ä¸­é…ç½® uris å±æ€§ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;module&quot;: &#123;</span><br><span class="line">    //...</span><br><span class="line">    &quot;abilities&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        //...</span><br><span class="line">        &quot;skills&quot;: [</span><br><span class="line">          &#123;</span><br><span class="line">            // actionsä¸èƒ½ä¸ºç©ºï¼Œactionsä¸ºç©ºä¼šé€ æˆç›®æ ‡æ–¹åŒ¹é…å¤±è´¥</span><br><span class="line">            &quot;actions&quot;: [&quot;ohos.want.action.home&quot;],</span><br><span class="line">            &quot;uris&quot;: [</span><br><span class="line">              &#123;</span><br><span class="line">                &quot;scheme&quot;: &quot;app1Scheme&quot;,</span><br><span class="line">                &quot;host&quot;: &quot;test.example.com&quot;,</span><br><span class="line">                &quot;pathStartWith&quot;: &quot;home&quot;</span><br><span class="line">              &#125;</span><br><span class="line">            ]</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>é—®é¢˜</strong></p>
<p>querySchemes ä¸­æœ€å¤šå…è®¸é…ç½® 50 ä¸ª URL schemeã€‚å› æ­¤é™åˆ¶ä¸èƒ½æ— é™ä½¿ç”¨æ–°çš„ schema å¤´ï¼Œä½†æ•´ä½“æ–¹æ¡ˆæ˜¯å¯è¡Œçš„ã€‚</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2025/04/25/UV-Python%E5%8C%85%E5%92%8C%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86%E5%99%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/image.png">
      <meta itemprop="name" content="ä¸‰åè€Œç«‹">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ä¸‰åè€Œç«‹çš„åšå®¢">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ä¸‰åè€Œç«‹çš„åšå®¢">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/04/25/UV-Python%E5%8C%85%E5%92%8C%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86%E5%99%A8/" class="post-title-link" itemprop="url">UV-PythonåŒ…å’Œé¡¹ç›®ç®¡ç†å™¨</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2025-04-25 19:04:48" itemprop="dateCreated datePublished" datetime="2025-04-25T19:04:48+08:00">2025-04-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-09-21 23:32:32" itemprop="dateModified" datetime="2025-09-21T23:32:32+08:00">2025-09-21</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>1.4k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>5 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="è¯´æ˜"><a href="#è¯´æ˜" class="headerlink" title="è¯´æ˜"></a>è¯´æ˜</h2><p><a href="https://docs.astral.sh/uv/getting-started/installation/">UV</a>, ä¸€ä¸ªç”¨ Rust ç¼–å†™çš„æå¿«çš„ Python åŒ…å’Œé¡¹ç›®ç®¡ç†å™¨ã€‚</p>
<ul>
<li>ğŸš€ä¸€ä¸ªå·¥å…·å³å¯æ›¿æ¢<code>pip</code>ã€ã€ã€ã€ã€ã€ã€ç­‰ç­‰<code>pip-tools</code>ã€‚<code>pipx``poetry``pyenv``twine``virtualenv</code></li>
<li>âš¡ï¸æ¯”<a href="https://github.com/astral-sh/uv/blob/main/BENCHMARKS.md">å¿« 10-100 å€</a><code>pip</code>ã€‚</li>
<li>ğŸ—‚ï¸ æä¾›<a href="https://github.com/astral-sh/uv#projects">å…¨é¢çš„é¡¹ç›®ç®¡ç†</a>ï¼Œå¹¶å¸¦æœ‰Â <a href="https://docs.astral.sh/uv/concepts/projects/layout#the-lockfile">é€šç”¨çš„é”æ–‡ä»¶</a>ã€‚</li>
<li>â‡ï¸<a href="https://github.com/astral-sh/uv#scripts">è¿è¡Œè„šæœ¬</a>ï¼Œæ”¯æŒÂ <a href="https://docs.astral.sh/uv/guides/scripts#declaring-script-dependencies">å†…è”ä¾èµ–å…ƒæ•°æ®</a>ã€‚</li>
<li>ğŸ<a href="https://github.com/astral-sh/uv#python-versions">å®‰è£…å’Œç®¡ç†</a>Python ç‰ˆæœ¬ã€‚</li>
<li>ğŸ› ï¸<a href="https://github.com/astral-sh/uv#tools">è¿è¡Œå¹¶å®‰è£…</a>ä½œä¸º Python åŒ…å‘å¸ƒçš„å·¥å…·ã€‚</li>
<li>ğŸ”© åŒ…å«ä¸<a href="https://github.com/astral-sh/uv#the-pip-interface">pip å…¼å®¹çš„æ¥å£</a>ï¼Œå¯é€šè¿‡ç†Ÿæ‚‰çš„ CLI æé«˜æ€§èƒ½ã€‚</li>
<li>ğŸ¢ æ”¯æŒå¯æ‰©å±•é¡¹ç›®çš„Cargo é£æ ¼<a href="https://docs.astral.sh/uv/concepts/projects/workspaces">å·¥ä½œåŒºã€‚</a></li>
<li>ğŸ’¾ èŠ‚çœç£ç›˜ç©ºé—´ï¼Œå…·æœ‰ç”¨äºä¾èµ–æ€§é‡å¤æ•°æ®åˆ é™¤çš„<a href="https://docs.astral.sh/uv/concepts/cache">å…¨å±€ç¼“å­˜</a>ã€‚</li>
<li>â¬ æ— éœ€ Rust æˆ– Python å³å¯é€šè¿‡<code>curl</code>æˆ–å®‰è£…<code>pip</code>ã€‚</li>
<li>ğŸ–¥ï¸ æ”¯æŒ macOSã€Linux å’Œ Windowsã€‚</li>
</ul>
<h2 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h2><h3 id="ç‹¬ç«‹å®‰è£…"><a href="#ç‹¬ç«‹å®‰è£…" class="headerlink" title="ç‹¬ç«‹å®‰è£…"></a>ç‹¬ç«‹å®‰è£…</h3><p>uv æä¾›äº†ä¸€ä¸ªç‹¬ç«‹çš„å®‰è£…ç¨‹åºæ¥ä¸‹è½½å’Œå®‰è£… uvï¼š<br>Widnowä½¿ç”¨<code>irm</code>ä»¥ä¸‹æ–¹å¼ä¸‹è½½è„šæœ¬å¹¶æ‰§è¡Œ<code>iex</code>ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell -ExecutionPolicy ByPass -c &quot;irm https://astral.sh/uv/install.ps1 | iex&quot;</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡åœ¨ URL ä¸­åŒ…å«ç‰¹å®šç‰ˆæœ¬æ¥è¯·æ±‚å®ƒ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell -ExecutionPolicy ByPass -c &quot;irm https://astral.sh/uv/0.6.14/install.ps1 | iex&quot;</span><br></pre></td></tr></table></figure>

<h3 id="WinGet"><a href="#WinGet" class="headerlink" title="WinGet"></a>WinGet</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">winget install --id=astral-sh.uv  -e</span><br></pre></td></tr></table></figure>
<h3 id="Scoop"><a href="#Scoop" class="headerlink" title="Scoop"></a>Scoop</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scoop install main/uv</span><br></pre></td></tr></table></figure>


<p>å®‰è£…å®Œæˆåä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ¥æ£€æŸ¥uvæ˜¯å¦å¯ç”¨ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uv</span><br></pre></td></tr></table></figure>
<h2 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h2><p>uv æä¾›äº† Python å¼€å‘çš„åŸºæœ¬åŠŸèƒ½â€”â€”ä»å®‰è£… Python å’Œæ”¯æŒç®€å•è„šæœ¬åˆ°å¤„ç†æ”¯æŒå¤šä¸ª Python ç‰ˆæœ¬å’Œå¹³å°çš„å¤§å‹é¡¹ç›®ã€‚ç›®å‰uv ä¸»è¦åˆ†ä¸ºä¸‹é¢å‡ ä¸ªåŠŸèƒ½,ä¸‹é¢ç®€å•ä»‹ç»ä¸€ä¸‹ä½¿ç”¨ã€‚</p>
<ul>
<li>Pythonç‰ˆæœ¬çš„ç®¡ç†</li>
<li>è„šæœ¬æ‰§è¡Œ</li>
<li>é¡¹ç›®ç®¡ç†</li>
</ul>
<h3 id="é¡¹ç›®ç®¡ç†"><a href="#é¡¹ç›®ç®¡ç†" class="headerlink" title="é¡¹ç›®ç®¡ç†"></a><a href="https://docs.astral.sh/uv/concepts/projects/">é¡¹ç›®ç®¡ç†</a></h3><p>uv æ”¯æŒç®¡ç† Python é¡¹ç›®ï¼Œåœ¨æ–‡ä»¶ä¸­å®šä¹‰å…¶ä¾èµ–å…³ç³»<code>pyproject.toml</code>ã€‚<br>ä¸»è¦åŒ…å«ä¸‹é¢å‘½ä»¤:</p>
<ul>
<li><code>uv init</code>ï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ Python é¡¹ç›®ã€‚</li>
<li><code>uv add</code>ï¼šå‘é¡¹ç›®æ·»åŠ ä¾èµ–é¡¹ã€‚</li>
<li><code>uv remove</code>ï¼šä»é¡¹ç›®ä¸­åˆ é™¤ä¾èµ–é¡¹ã€‚</li>
<li><code>uv sync</code>ï¼šå°†é¡¹ç›®çš„ä¾èµ–é¡¹ä¸ç¯å¢ƒåŒæ­¥ã€‚</li>
<li><code>uv lock</code>ï¼šä¸ºé¡¹ç›®çš„ä¾èµ–é¡¹åˆ›å»ºä¸€ä¸ªé”æ–‡ä»¶ã€‚</li>
<li><code>uv run</code>ï¼šåœ¨é¡¹ç›®ç¯å¢ƒä¸­è¿è¡Œå‘½ä»¤ã€‚</li>
<li><code>uv tree</code>ï¼šæŸ¥çœ‹é¡¹ç›®çš„ä¾èµ–å…³ç³»æ ‘ã€‚</li>
<li><code>uv build</code>ï¼šå°†é¡¹ç›®æ„å»ºåˆ°åˆ†å‘æ¡£æ¡ˆä¸­ã€‚</li>
<li><code>uv publish</code>ï¼šå°†é¡¹ç›®å‘å¸ƒåˆ°åŒ…ç´¢å¼•ã€‚</li>
</ul>
<h4 id="åˆ›å»ºæ–°é¡¹ç›®"><a href="#åˆ›å»ºæ–°é¡¹ç›®" class="headerlink" title="åˆ›å»ºæ–°é¡¹ç›®"></a>åˆ›å»ºæ–°é¡¹ç›®</h4><p>å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åˆ›å»ºä¸€ä¸ªæ–°çš„ Python é¡¹ç›®<code>uv init</code>ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">uv init hello-world</span><br><span class="line">cd hello-world</span><br></pre></td></tr></table></figure>

<p>æˆ–è€…ï¼Œæ‚¨å¯ä»¥åœ¨å·¥ä½œç›®å½•ä¸­åˆå§‹åŒ–ä¸€ä¸ªé¡¹ç›®ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir hello-world</span><br><span class="line">cd hello-world</span><br><span class="line">uv init</span><br></pre></td></tr></table></figure>
<p>uv å°†åˆ›å»ºä»¥ä¸‹æ–‡ä»¶ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">â”œâ”€â”€ .python-version</span><br><span class="line">â”œâ”€â”€ README.md</span><br><span class="line">â”œâ”€â”€ main.py</span><br><span class="line">â””â”€â”€ pyproject.toml</span><br></pre></td></tr></table></figure>

<h4 id="é¡¹ç›®ç»“æ„"><a href="#é¡¹ç›®ç»“æ„" class="headerlink" title="é¡¹ç›®ç»“æ„"></a>é¡¹ç›®ç»“æ„</h4><p>ä¸€ä¸ªé¡¹ç›®ç”±å‡ ä¸ªé‡è¦çš„éƒ¨åˆ†ç»„æˆï¼Œå®ƒä»¬ååŒå·¥ä½œï¼Œå¹¶å…è®¸ uv ç®¡ç†ä½ çš„é¡¹ç›®ã€‚é™¤äº† ç”± åˆ›å»ºçš„æ–‡ä»¶ä¹‹å¤–ï¼ŒÂ å½“ä½ ç¬¬ä¸€æ¬¡è¿è¡Œé¡¹ç›®å‘½ä»¤ï¼ˆå³ã€Â æˆ– ï¼‰æ—¶ï¼ŒÂ <code>uv init</code>uv è¿˜ä¼šåœ¨é¡¹ç›®çš„æ ¹ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿç¯å¢ƒå’Œæ–‡ä»¶ã€‚å®Œæ•´åˆ—è¡¨å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">â”œâ”€â”€ .venv   //è™šæ‹Ÿç¯å¢ƒ</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ bin</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ lib</span><br><span class="line">â”‚Â Â  â””â”€â”€ pyvenv.cfg</span><br><span class="line">â”œâ”€â”€ .python-version  //åŒ…å«é¡¹ç›®çš„é»˜è®¤ Python ç‰ˆæœ¬ã€‚æ­¤æ–‡ä»¶å‘Šè¯‰ uv åœ¨åˆ›å»ºé¡¹ç›®çš„è™šæ‹Ÿç¯å¢ƒæ—¶ä½¿ç”¨å“ªä¸ª Python ç‰ˆæœ¬ã€‚</span><br><span class="line">â”œâ”€â”€ README.md  </span><br><span class="line">â”œâ”€â”€ main.py</span><br><span class="line">â”œâ”€â”€ pyproject.toml    // æœ‰å…³æ‚¨çš„é¡¹ç›®çš„å…ƒæ•°æ®</span><br><span class="line">â””â”€â”€ uv.lock  </span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­<code>uv.lock</code>æ˜¯ä¸€ä¸ªè·¨å¹³å°çš„é”æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«é¡¹ç›®ä¾èµ–é¡¹çš„ç²¾ç¡®ä¿¡æ¯ã€‚ä¸<code>pyproject.toml</code>ç”¨äºæŒ‡å®šé¡¹ç›®æ€»ä½“éœ€æ±‚çš„ ä¸åŒï¼Œé”æ–‡ä»¶åŒ…å«é¡¹ç›®ç¯å¢ƒä¸­å·²å®‰è£…çš„ç²¾ç¡®è§£æç‰ˆæœ¬ã€‚&#x3D;&#x3D;æ­¤æ–‡ä»¶åº”çº³å…¥ç‰ˆæœ¬æ§åˆ¶ï¼Œä»¥ä¾¿åœ¨ä¸åŒæœºå™¨ä¸Šå®ç°ä¸€è‡´ä¸”å¯é‡å¤çš„å®‰è£…&#x3D;&#x3D;ã€‚<code>uv.lock</code>æ˜¯äººç±»å¯è¯»çš„ TOML æ–‡ä»¶ï¼Œä½†ç”± uv ç®¡ç†ï¼Œä¸åº”æ‰‹åŠ¨ç¼–è¾‘ã€‚</p>
<h4 id="ç®¡ç†ä¾èµ–é¡¹"><a href="#ç®¡ç†ä¾èµ–é¡¹" class="headerlink" title="ç®¡ç†ä¾èµ–é¡¹"></a>ç®¡ç†ä¾èµ–é¡¹</h4><p>å¯ä»¥ä½¿ç”¨å‘½ä»¤<code>uv add</code>æ·»åŠ ä¾èµ–é¡¹ï¼Œè¿™ä¹Ÿä¼šæ›´æ–°é”pyproject.tomlæ–‡ä»¶å’Œé¡¹ç›®ç¯å¢ƒ&#96;&#96;&#96;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">uv add requests</span><br><span class="line"># æŒ‡å®šç‰¹å®šçš„ç‰ˆæœ¬</span><br><span class="line">uv add &#x27;requests==2.31.0&#x27;</span><br><span class="line"># æŒ‡å®šç‰¹å®šçš„æº</span><br><span class="line">uv add git+https://github.com/psf/requests</span><br></pre></td></tr></table></figure>
<p>å¦‚æœè¦åˆ é™¤ä¾èµ–ï¼Œå¯ä»¥ä½¿ç”¨<code>uv remove</code> å‘½ä»¤ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uv remove requests</span><br></pre></td></tr></table></figure>
<p>è¦å‡çº§è½¯ä»¶åŒ…ï¼Œè¯·<code>uv lock</code>ä½¿ç”¨ä»¥ä¸‹<code>--upgrade-package</code>æ ‡å¿—è¿è¡Œï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uv lock --upgrade-package requests</span><br></pre></td></tr></table></figure>

<p>è¯¥<code>--upgrade-package</code>æ ‡å¿—å°†å°è¯•å°†æŒ‡å®šçš„åŒ…æ›´æ–°åˆ°æœ€æ–°çš„å…¼å®¹ç‰ˆæœ¬ï¼ŒåŒæ—¶ä¿æŒé”æ–‡ä»¶çš„å…¶ä½™éƒ¨åˆ†å®Œå¥½æ— æŸã€‚</p>
<h4 id="è¿è¡Œå‘½ä»¤"><a href="#è¿è¡Œå‘½ä»¤" class="headerlink" title="è¿è¡Œå‘½ä»¤"></a>è¿è¡Œå‘½ä»¤</h4><p><code>uv run</code>å¯ç”¨äºåœ¨æ‚¨çš„é¡¹ç›®ç¯å¢ƒä¸­è¿è¡Œä»»æ„è„šæœ¬æˆ–å‘½ä»¤ã€‚</p>
<p>åœ¨æ¯æ¬¡è°ƒç”¨ä¹‹å‰<code>uv run</code>ï¼Œuv éƒ½ä¼šéªŒè¯é”æ–‡ä»¶æ˜¯å¦æ˜¯æœ€æ–°çš„Â <code>pyproject.toml</code>ï¼Œå¹¶ä¸”ç¯å¢ƒæ˜¯å¦æ˜¯æœ€æ–°çš„é”æ–‡ä»¶ï¼Œä»è€Œä½¿æ‚¨çš„é¡¹ç›®ä¿æŒåŒæ­¥ï¼Œè€Œæ— éœ€æ‰‹åŠ¨å¹²é¢„ã€‚<code>uv run</code>ä¿è¯æ‚¨çš„å‘½ä»¤åœ¨ä¸€è‡´çš„ã€é”å®šçš„ç¯å¢ƒä¸­è¿è¡Œã€‚</p>
<p>ä¾‹å¦‚ï¼Œä½¿ç”¨<code>flask</code>ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">uv add flask</span><br><span class="line">uv run -- flask run -p 3000</span><br></pre></td></tr></table></figure>
<p>ä¹Ÿå¯ä»¥ä½¿ç”¨<code>uv sync</code>æ‰‹åŠ¨æ›´æ–°ç¯å¢ƒï¼Œç„¶ååœ¨æ‰§è¡Œå‘½ä»¤ä¹‹å‰æ¿€æ´»å®ƒï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">uv sync</span><br><span class="line">source .venv\Scripts\activate</span><br><span class="line">flask run -p 3000</span><br></pre></td></tr></table></figure>

<h4 id="æ„å»ºå‘è¡Œç‰ˆ"><a href="#æ„å»ºå‘è¡Œç‰ˆ" class="headerlink" title="æ„å»ºå‘è¡Œç‰ˆ"></a>æ„å»ºå‘è¡Œç‰ˆ</h4><p><code>uv build</code>å¯ç”¨äºä¸ºæ‚¨çš„é¡¹ç›®æ„å»ºæºåˆ†å¸ƒå’ŒäºŒè¿›åˆ¶åˆ†å¸ƒï¼ˆè½®å­ï¼‰ã€‚<br>é»˜è®¤æƒ…å†µä¸‹ï¼Œ<code>uv build</code>å°†åœ¨å½“å‰ç›®å½•ä¸­æ„å»ºé¡¹ç›®ï¼Œå¹¶å°†æ„å»ºçš„å·¥ä»¶æ”¾åœ¨<code>dist/</code>å­ç›®å½•ä¸­ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">uv build</span><br><span class="line">ls dist/</span><br></pre></td></tr></table></figure>

<h3 id="Pythonç®¡ç†"><a href="#Pythonç®¡ç†" class="headerlink" title="Pythonç®¡ç†"></a>Pythonç®¡ç†</h3><p>å¦‚æœæ‚¨çš„ç³»ç»Ÿä¸Šå·²å®‰è£… Pythonï¼Œuv å°†Â <a href="https://docs.astral.sh/uv/guides/install-python/#using-existing-python-versions">æ£€æµ‹å¹¶ä½¿ç”¨</a>å®ƒï¼Œæ— éœ€ä»»ä½•é…ç½®ã€‚ä½†æ˜¯ï¼Œuv è¿˜å¯ä»¥å®‰è£…å’Œç®¡ç† Python ç‰ˆæœ¬ã€‚uv ä¼šæ ¹æ®éœ€è¦<a href="https://docs.astral.sh/uv/guides/install-python/#automatic-python-downloads">è‡ªåŠ¨å®‰è£…</a>ç¼ºå°‘çš„ Python ç‰ˆæœ¬â€”â€”æ‚¨æ— éœ€å®‰è£… Python å³å¯å¼€å§‹ä½¿ç”¨ã€‚</p>
<p>å®‰è£…æœ€æ–°çš„ç‰ˆæœ¬</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uv python install</span><br></pre></td></tr></table></figure>
<p>å®‰è£…ç‰¹å®šçš„ç‰ˆæœ¬</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uv python install 3.12</span><br></pre></td></tr></table></figure>
<p>é‡æ–°å®‰è£…</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uv python install --reinstall</span><br></pre></td></tr></table></figure>
<p>æŸ¥çœ‹å·²å®‰è£…çš„Pythonç‰ˆæœ¬</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uv python list</span><br></pre></td></tr></table></figure>

<h3 id="è¿è¡Œè„šæœ¬"><a href="#è¿è¡Œè„šæœ¬" class="headerlink" title="è¿è¡Œè„šæœ¬"></a><a href="https://docs.astral.sh/uv/guides/scripts/">è¿è¡Œè„šæœ¬</a></h3><p>Python è„šæœ¬æ˜¯ç”¨äºç‹¬ç«‹æ‰§è¡Œçš„æ–‡ä»¶ï¼Œä¾‹å¦‚<code>python &lt;script&gt;.py</code>ã€‚ä½¿ç”¨ uv æ‰§è¡Œè„šæœ¬å¯ç¡®ä¿ç®¡ç†è„šæœ¬ä¾èµ–å…³ç³»ï¼Œè€Œæ— éœ€æ‰‹åŠ¨ç®¡ç†ç¯å¢ƒã€‚</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2025/04/25/Scoop/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/image.png">
      <meta itemprop="name" content="ä¸‰åè€Œç«‹">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ä¸‰åè€Œç«‹çš„åšå®¢">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ä¸‰åè€Œç«‹çš„åšå®¢">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/04/25/Scoop/" class="post-title-link" itemprop="url">Scoop -windowä¸‹åŒ…ç®¡ç†å™¨</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2025-04-25 19:00:49" itemprop="dateCreated datePublished" datetime="2025-04-25T19:00:49+08:00">2025-04-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-09-21 23:32:32" itemprop="dateModified" datetime="2025-09-21T23:32:32+08:00">2025-09-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/windows/" itemprop="url" rel="index"><span itemprop="name">windows</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>808</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>3 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="ä»€ä¹ˆæ˜¯Scoop"><a href="#ä»€ä¹ˆæ˜¯Scoop" class="headerlink" title="ä»€ä¹ˆæ˜¯Scoop?"></a>ä»€ä¹ˆæ˜¯Scoop?</h2><p>Scoop æ˜¯ Windows çš„å‘½ä»¤è¡Œå®‰è£…ç¨‹åºï¼Œæ˜¯ä¸€ä¸ªå¼ºå¤§çš„åŒ…ç®¡ç†å·¥å…·ã€‚å¯ä»¥åœ¨ github ä¸Šæ‰¾åˆ°å…¶é¡¹ç›®çš„ç›¸å…³ä¿¡æ¯ï¼Œ<a href="https://www.mobaijun.com/go.html?u=aHR0cHM6Ly9naXRodWIuY29tL1Njb29wSW5zdGFsbGVyL1Njb29w">é¡¹ç›®åœ°å€</a>, Scoop ç­‰ä¸€ç³»åˆ—åŒ…ç®¡ç†å™¨çš„è¯ç”Ÿï¼Œç¬¬ä¸€å¤§ä¾¿åˆ©å°±æ˜¯çœå»äº†ä¸Šè¿°ç¹ççš„ã€Œæœç´¢ - ä¸‹è½½ - å®‰è£…ã€çš„æ­¥éª¤ï¼Œè®©æˆ‘ä»¬èƒ½å¤Ÿé€šè¿‡ã€Œä¸€è¡Œä»£ç ã€æ€¥é€Ÿå®‰è£…ã€‚</p>
<p>åŒæ—¶ï¼Œç”¨ Scoop æ¥å®‰è£…å’Œç®¡ç†æˆ‘ä»¬çš„è½¯ä»¶ï¼š</p>
<ul>
<li>é›†æœç´¢ã€ä¸‹è½½ã€å®‰è£…ã€æ›´æ–°è½¯ä»¶äºä¸€ä½“ï¼šæå¤§çš„é™ä½äº†å®‰è£…ç»´æŠ¤ä¸€ä¸ªè½¯ä»¶çš„æˆæœ¬ï¼Œæˆ‘ä»¬ç”šè‡³ä¸å¿…åœ¨è½¯ä»¶æœ¬èº«çš„å¤æ‚èœå•ä¸­å¯»æ‰¾é‚£ä¸ªæ›´æ–°æŒ‰é’®æ¥æ›´æ–°è½¯ä»¶è‡ªå·±</li>
<li>å°†è½¯ä»¶å¹²å¹²å‡€å‡€çš„å®‰è£…åˆ°ç”µè„‘çš„ã€Œç”¨æˆ·æ–‡ä»¶å¤¹ã€ä¸‹ï¼šè¿™æ ·æ—¢ä¸ä¼šæ±¡æŸ“è·¯å¾„ä¹Ÿä¸ä¼šè¯·æ±‚ä¸å¿…è¦çš„æƒé™ï¼ˆUACï¼‰</li>
<li>åœ¨å¸è½½è½¯ä»¶çš„æ—¶å€™ï¼Œèƒ½å¤Ÿå°½é‡æ¸…ç©ºè½¯ä»¶åœ¨ç”µè„‘ä¸Šå­˜å‚¨çš„ä»»ä½•æ•°æ®å’Œç—•è¿¹</li>
</ul>
<p>Scoop æœ€é€‚åˆå®‰è£…é‚£ç§å¹²å‡€ã€å°å·§ã€å¼€æºçš„è½¯ä»¶ã€‚å¹¶ä¸”ï¼ŒScoop ä¹Ÿæåº¦é€‚åˆä¸ºå¼€å‘è€…é…ç½®å¼€å‘ç¯å¢ƒï¼Œä¸è¿‡è¿™äº›å¾ˆå¤šéƒ½æ¶‰åŠåˆ°è¿›é˜¶ä½¿ç”¨æŠ€å·§ã€‚ä¸‹é¢å…ˆä»åŸºç¡€çš„å®‰è£…æ–¹æ³•å¼€å§‹ä»‹ç»ã€‚</p>
<h2 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h2><p><strong>è¦æ±‚ï¼š</strong></p>
<ul>
<li>PowerShell &gt;&#x3D; 5.0 (å¦‚æœæ˜¯ Window10 åˆ™é»˜è®¤æ»¡è¶³æ­¤æ¡ä»¶)</li>
<li>è¯·ç¡®ä¿å·²å…è®¸PowerShellæ‰§è¡Œæœ¬åœ°è„šæœ¬ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤å¼€å¯ï¼š<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">set-executionpolicy remotesigned -scope currentuser</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<p>ä» Power Shell  ç»ˆç«¯è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥å®‰è£… Scoopï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser</span><br><span class="line">Invoke-RestMethod -Uri https://get.scoop.sh | Invoke-Expression</span><br></pre></td></tr></table></figure>
<p>å®ƒä¼šå°† Scoop å®‰è£…åˆ°å…¶é»˜è®¤ä½ç½®ï¼š<code>C:\Users\&lt;YOUR USERNAME&gt;\scoop</code> ã€‚ å…¨å±€å®‰è£…çš„ç¨‹åºï¼ˆæ‰€æœ‰ç”¨æˆ·å¯ç”¨ï¼Œä½¿ç”¨<code>--global</code>æˆ–Â <code>-g</code>Â é€‰é¡¹ï¼‰ä½ äº<code>C\ProgramData\scoop</code>è·¯å¾„ä¸­ã€‚</p>
<p>å¦‚æœæƒ³è‡ªå®šä¹‰å®‰è£…ä½ç½®, å¯ä»¥åœ¨&#x3D;&#x3D;å®‰è£…å‰&#x3D;&#x3D;è®¾ç½® ï¼š<br>ç”¨æˆ·å®‰è£…ç›®å½•ï¼š</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$env:SCOOP</span>=<span class="string">&#x27;D:\Applications\Scoop&#x27;</span></span><br><span class="line">[<span class="type">Environment</span>]::SetEnvironmentVariable(<span class="string">&#x27;SCOOP&#x27;</span>, <span class="variable">$env:SCOOP</span>, <span class="string">&#x27;User&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>å…¨å±€å®‰è£…ç›®å½•ï¼š</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$env:SCOOP_GLOBAL</span>=<span class="string">&#x27;F:\GlobalScoopApps&#x27;</span></span><br><span class="line">[<span class="type">Environment</span>]::SetEnvironmentVariable(<span class="string">&#x27;SCOOP_GLOBAL&#x27;</span>, <span class="variable">$env:SCOOP_GLOBAL</span>, <span class="string">&#x27;Machine&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="å¸¸ç”¨å‘½ä»¤"><a href="#å¸¸ç”¨å‘½ä»¤" class="headerlink" title="å¸¸ç”¨å‘½ä»¤"></a>å¸¸ç”¨å‘½ä»¤</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">scoop install  git</span><br><span class="line">scoop install sudo # ç”³è¯·ç®¡ç†å‘˜æƒé™ï¼Œå’Œlinuxä¸‹sudoå‘½ä»¤ç›¸ä¼¼ï¼Œå…¨å±€å®‰è£…å¿…å¤‡</span><br><span class="line">sudo scoop install -g python # å…¶å®å¤§éƒ¨åˆ†æˆ‘éƒ½æ¨èå…¨å±€å®‰è£…</span><br><span class="line"></span><br><span class="line">scoop update latex # æ›´æ–°</span><br><span class="line">scoop update -g hugo # æ›´æ–°å…¨å±€å®‰è£…çš„è½¯ä»¶</span><br><span class="line">scoop update * # æ›´æ–°æ‰€æœ‰</span><br><span class="line">scoop uninstall curl # å¸è½½</span><br><span class="line">scoop uninstall -g gcc # å¸è½½å…¨å±€å®‰è£…çš„è½¯ä»¶</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">scoop search Source-Han-Mono # æœç´¢</span><br><span class="line">scoop info miniconda3 # è½¯ä»¶ä¿¡æ¯</span><br><span class="line">scoop home pwsh # æ‰“å¼€è½¯ä»¶ä¸»é¡µ</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">scoop help</span><br><span class="line">Usage: scoop &lt;command&gt; [&lt;args&gt;]</span><br><span class="line"></span><br><span class="line">Available commands are listed below.</span><br><span class="line"></span><br><span class="line">Type &#x27;scoop help &lt;command&gt;&#x27; to get more help for a specific command.</span><br><span class="line"></span><br><span class="line">Command    Summary</span><br><span class="line">-------    -------</span><br><span class="line">alias      Manage scoop aliases</span><br><span class="line">bucket     Manage Scoop buckets</span><br><span class="line">cache      Show or clear the download cache</span><br><span class="line">cat        Show content of specified manifest.</span><br><span class="line">checkup    Check for potential problems</span><br><span class="line">cleanup    Cleanup apps by removing old versions</span><br><span class="line">config     Get or set configuration values</span><br><span class="line">create     Create a custom app manifest</span><br><span class="line">depends    List dependencies for an app, in the order they&#x27;ll be installed</span><br><span class="line">download   Download apps in the cache folder and verify hashes</span><br><span class="line">export     Exports installed apps, buckets (and optionally configs) in JSON format</span><br><span class="line">help       Show help for a command</span><br><span class="line">hold       Hold an app to disable updates</span><br><span class="line">home       Opens the app homepage</span><br><span class="line">import     Imports apps, buckets and configs from a Scoopfile in JSON format</span><br><span class="line">info       Display information about an app</span><br><span class="line">install    Install apps</span><br><span class="line">list       List installed apps</span><br><span class="line">prefix     Returns the path to the specified app</span><br><span class="line">reset      Reset an app to resolve conflicts</span><br><span class="line">search     Search available apps</span><br><span class="line">shim       Manipulate Scoop shims</span><br><span class="line">status     Show status and check for new app versions</span><br><span class="line">unhold     Unhold an app to enable updates</span><br><span class="line">uninstall  Uninstall an app</span><br><span class="line">update     Update apps, or Scoop itself</span><br><span class="line">virustotal Look for app&#x27;s hash or url on virustotal.com</span><br><span class="line">which      Locate a shim/executable (similar to &#x27;which&#x27; on Linux)</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/24/%E5%AE%89%E5%8D%93weather%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/image.png">
      <meta itemprop="name" content="ä¸‰åè€Œç«‹">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ä¸‰åè€Œç«‹çš„åšå®¢">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ä¸‰åè€Œç«‹çš„åšå®¢">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/04/24/%E5%AE%89%E5%8D%93weather%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">å®‰å“å¼€å‘---å¤©æ°”</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2020-04-24 20:36:24" itemprop="dateCreated datePublished" datetime="2020-04-24T20:36:24+08:00">2020-04-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-09-21 23:32:32" itemprop="dateModified" datetime="2025-09-21T23:32:32+08:00">2025-09-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>5.5k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>20 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="å®‰å“å¼€å‘â€”å¤©æ°”"><a href="#å®‰å“å¼€å‘â€”å¤©æ°”" class="headerlink" title="å®‰å“å¼€å‘â€”å¤©æ°”"></a>å®‰å“å¼€å‘â€”å¤©æ°”</h1><hr>
<h3 id="æŠ€æœ¯é€‰å‹"><a href="#æŠ€æœ¯é€‰å‹" class="headerlink" title="æŠ€æœ¯é€‰å‹"></a>æŠ€æœ¯é€‰å‹</h3><ol>
<li>ViewPager  ç”¨æ¥å±•ç¤ºåˆ‡æ¢å¤šä¸ªåŸå¸‚å¤©æ°”æƒ…å†µ</li>
<li>SwipeRefreshLayout ä¸‹æ‹‰åˆ·æ–°å¤©æ°”</li>
<li>ScrollView æ»‘åŠ¨å±•ç¤ºå¤©æ°”è¯¦æƒ…</li>
<li>å‚è€ƒç¬¬ä¸€è¡Œä»£ç ä¸­CoolWeather</li>
</ol>
<h3 id="é¡µé¢å¸ƒå±€"><a href="#é¡µé¢å¸ƒå±€" class="headerlink" title="é¡µé¢å¸ƒå±€"></a>é¡µé¢å¸ƒå±€</h3><p>å¤©æ°”é¡µé¢çš„ç²—ç•¥å¸ƒå±€å¦‚ä¸‹ï¼š<br>ä¸»è¦ä¸ºSwipeRefreshLayoutåµŒå¥—ViewPager</p>
<pre><code>&lt;FrameLayout&gt;
    //å±•ç¤ºèƒŒæ™¯å›¾ç‰‡
    &lt;ImageView/&gt;
    &lt;LinearLayout&gt;
        &lt;LinearLayout/&gt;
        //ä¸‹æ‹‰åˆ·æ–°
        &lt;SwipeRefreshLayout&gt;	
            //å±•ç¤ºå¤©æ°”é¡µé¢
            &lt;ViewPager/&gt;
        &lt;/SwipeRefreshLayout&gt;
    &lt;/LinearLayout&gt;
&lt;/FrameLayout&gt;
</code></pre>
<p>ä¸‹é¢ä¸ºviewpagerçš„å¸ƒå±€ï¼ŒScrollViewç”¨æ¥æ»‘åŠ¨å±•ç¤ºå•ä¸ªåŸå¸‚çš„å¤©æ°”è¯¦æƒ…ï¼ŒLinearLayouté‡Œå±•ç¤ºå¤©æ°”è¯¦æƒ…</p>
<pre><code>&lt;FrameLayout&gt;
    //çºµå‘æ»‘åŠ¨æ˜¾ç¤ºå¤©æ°”è¯¦æƒ…
    &lt;ScrollView&gt;
        &lt;LinearLayout&gt;
            &lt;include layout=&quot;@layout/now&quot; /&gt;
            &lt;include layout=&quot;@layout/forecast&quot; /&gt;
            &lt;include layout=&quot;@layout/lifestyle&quot;/&gt;
        &lt;/LinearLayout&gt;
    &lt;/ScrollView&gt;
&lt;/FrameLayout&gt;
</code></pre>
<h3 id="é‡åˆ°çš„é—®é¢˜"><a href="#é‡åˆ°çš„é—®é¢˜" class="headerlink" title="é‡åˆ°çš„é—®é¢˜"></a>é‡åˆ°çš„é—®é¢˜</h3><h4 id="ViewPagerå’ŒSwipeRefreshLayoutå‘ç”Ÿæ»‘åŠ¨å†²çª"><a href="#ViewPagerå’ŒSwipeRefreshLayoutå‘ç”Ÿæ»‘åŠ¨å†²çª" class="headerlink" title="ViewPagerå’ŒSwipeRefreshLayoutå‘ç”Ÿæ»‘åŠ¨å†²çª"></a>ViewPagerå’ŒSwipeRefreshLayoutå‘ç”Ÿæ»‘åŠ¨å†²çª</h4><ul>
<li><p>åŸå› : SwipeRefreshLayoutçš„onInterceptæ–¹æ³•å‘ç°æ˜¯åœ¨è¿™é‡Œæ‹¦æˆªäº†æ»‘åŠ¨äº‹ä»¶ï¼Œæ— æ³•ä¼ é€’åˆ°viewpageré‡Œï¼Œå‡å¦‚æ— æ³•åƒç›´çº¿ä¸€æ ·æ¨ªå‘æ»‘åŠ¨å‡ºç°äº†çºµå‘åå·®å°±ä¼šè§¦å‘SwipeRefreshLayout</p>
</li>
<li><p>è§£å†³æ€è·¯ï¼šä¸‹æ‹‰åˆ·æ–°åªåœ¨çºµå‘æ»‘åŠ¨è§¦å‘ï¼Œé‚£ä¹ˆåœ¨SwipeRefreshLayouté‡Œåªæ‹¦æˆªçºµå‘æ»‘åŠ¨</p>
<pre><code>  import android.content.Context;
  import android.util.AttributeSet;
  import android.view.MotionEvent;
  import android.view.ViewConfiguration;
  
  import androidx.annotation.NonNull;
  import androidx.swiperefreshlayout.widget.SwipeRefreshLayout;
  
  public class PocketSwipeRefreshLayout extends SwipeRefreshLayout &#123;
      private float mStartX = 0;
      private float mStartY = 0;
  
      //è®°å½•Viewpageræ˜¯å¦è¢«æ‹–æ‹‰
      private boolean mIsVpDrag;
      private final int mTouchSlop;
      public PocketSwipeRefreshLayout(@NonNull Context context) &#123;
          super(context);
          mTouchSlop = ViewConfiguration.get(context).getScaledTouchSlop();
      &#125;
  
      public PocketSwipeRefreshLayout(@NonNull Context context, AttributeSet attrs) &#123;
          super(context,attrs);
          mTouchSlop = ViewConfiguration.get(context).getScaledTouchSlop();
      &#125;
  
      @Override
      public boolean onInterceptTouchEvent(MotionEvent ev) &#123;
          int action = ev.getAction();
          switch (action)&#123;
              case MotionEvent.ACTION_DOWN:
                  mStartX = ev.getX();
                  mStartY = ev.getY();
                  mIsVpDrag = false;
                  break;
              case MotionEvent.ACTION_MOVE:
                  //å¦‚æœviewpageræ­£åœ¨æ‹–æ‹½ï¼Œåˆ™ä¸æ‹¦æˆªviewpageräº‹ä»¶
                  if (mIsVpDrag)&#123;
                      return false;
                  &#125;
                  float x = ev.getX();
                  float y = ev.getY();
                  float distanceX = Math.abs(x - mStartX);
                  float distanceY = Math.abs(y - mStartY);
                  //å¦‚æœæ»‘åŠ¨xä½ç§»å¤§äºyï¼Œä¸æ‹¦æˆªviewpageräº‹ä»¶
                  if (distanceX &gt; mTouchSlop &amp;&amp; distanceX&gt;distanceY)&#123;
                      mIsVpDrag = true;
                      return false;
                  &#125;
                  break;
              case MotionEvent.ACTION_UP:
              case MotionEvent.ACTION_CANCEL:
                  mIsVpDrag = true;
                  break;
              default:
                  break;
          &#125;
          return super.onInterceptTouchEvent(ev);
  
      &#125;
  &#125;
</code></pre>
</li>
</ul>
<h4 id="SwipeRefreshLayoutä¸ScrollViewå‘ç”Ÿä¸‹æ»‘å†²çª"><a href="#SwipeRefreshLayoutä¸ScrollViewå‘ç”Ÿä¸‹æ»‘å†²çª" class="headerlink" title="SwipeRefreshLayoutä¸ScrollViewå‘ç”Ÿä¸‹æ»‘å†²çª"></a>SwipeRefreshLayoutä¸ScrollViewå‘ç”Ÿä¸‹æ»‘å†²çª</h4><ul>
<li><p>æƒ…å†µè¯´æ˜ï¼šåœ¨æœªé‡‡ç”¨ViewPageræ—¶ï¼Œå³åªå±•ç¤ºä¸€ä¸ªåŸå¸‚å¤©æ°”æ—¶ï¼ŒSwipeRefreshLayoutä¸ScrollViewå¹¶ä¸ä¼šå‘ç”Ÿä¸‹æ»‘å†²çªï¼Œä½†åœ¨é‡‡ç”¨ViewPageråä¼šå‘ç”Ÿå†²çªï¼Œå¯¼è‡´æµè§ˆåˆ°é¡µé¢ä¸‹éƒ¨åå´è§¦å‘SwipeRefreshLayoutæ— æ³•å‘ä¸Šæ»‘åŠ¨é¡µé¢</p>
</li>
<li><p>åŸå› ï¼šSwipeRefreshLayoutæ‹¦æˆªäº†çºµå‘æ»‘åŠ¨äº‹ä»¶ï¼Œä½†ä¸ºä»€ä¹ˆæœªé‡‡ç”¨viewpageræ˜¯ä¸ä¼šå‘ç”Ÿå†²çªè¿˜æœªæ˜ç™½</p>
</li>
<li><p>è§£å†³æ€è·¯ï¼šå½“ä¸”ä»…å½“æ»‘åŠ¨åˆ°é¡¶éƒ¨æ—¶æ‰éœ€è¦è§¦å‘ä¸‹æ‹‰åˆ·æ–°ï¼Œé‚£ä¹ˆåœ¨çºµåæ ‡æœªåœ¨é¡¶éƒ¨æ—¶å±è”½SwipeRefreshLayout</p>
<pre><code>  // åˆå§‹åŒ–å„æ§ä»¶
  ScrollView weatherLayout = (ScrollView) view.findViewById(R.id.weather_layout);
  //è§£å†³SwipeRefreshLayoutä¸ScrollViewçš„ä¸‹æ‹‰å†²çª
  weatherLayout.setOnScrollChangeListener(new View.OnScrollChangeListener() &#123;
      @Override
      public void onScrollChange(View v, int scrollX, int scrollY, int oldScrollX, int oldScrollY) &#123;
          if (swipeRefreshLayout != null)&#123;
              swipeRefreshLayout.setEnabled(scrollY==0);
          &#125;
      &#125;
  &#125;);
</code></pre>
</li>
</ul>
<h4 id="ViewPageråŠ¨æ€æ›´æ–°é¡µé¢"><a href="#ViewPageråŠ¨æ€æ›´æ–°é¡µé¢" class="headerlink" title="ViewPageråŠ¨æ€æ›´æ–°é¡µé¢"></a>ViewPageråŠ¨æ€æ›´æ–°é¡µé¢</h4><ul>
<li><p>æƒ…å†µè¯´æ˜ï¼šåœ¨ä¸‹æ‹‰åˆ·æ–°æ—¶ï¼Œéœ€è¦å»é‡æ–°å¾—åˆ°åŸå¸‚çš„å¤©æ°”æƒ…å†µå¹¶å±•ç¤ºåœ¨UIä¸­ã€‚</p>
</li>
<li><p>è§£å†³æ€è·¯ï¼šPagerAdapterå¯ä»¥é€šè¿‡è°ƒç”¨notifyDataSetChanged()æ–¹æ³•å®ç°æ•°æ®é›†çš„åˆ·æ–°ã€‚<br>viewpagerçš„åˆ·æ–°è¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼šåœ¨æ¯æ¬¡è°ƒç”¨notifyDataSetChanged()æ—¶ï¼Œéƒ½ä¼šæ¿€æ´»getItemPosition(Object object)æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šéå†viewpagerçš„æ‰€æœ‰itemï¼Œä¸ºæ¯ä¸ªitemè¿”å›ä¸€ä¸ªçŠ¶æ€å€¼ï¼ˆPOSITION_NONE&#x2F;POSITION_UNCHANGEDï¼‰ï¼Œå¦‚æœæ˜¯noneï¼Œé‚£ä¹ˆè¯¥itemä¼šè¢«destroyItem(ViewGroup container, int position, Object object)æ–¹æ³•removeæ‰ï¼Œç„¶åé‡æ–°åŠ è½½ï¼Œå¦‚æœæ˜¯unchangedï¼Œå°±ä¸ä¼šé‡æ–°åŠ è½½ï¼Œé»˜è®¤æ˜¯unchangedï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬ä¸é‡å†™getItemPosition(Object object)ï¼Œå°±æ— æ³•çœ‹åˆ°åˆ·æ–°æ•ˆæœã€‚</p>
<p>  é‚£ä¹ˆä¸ºäº†åªåˆ·æ–°å•ä¸ªé¡µé¢ï¼Œæˆ‘ä»¬é‡å†™getItemPositionæ–¹æ³•ï¼Œå¹¶ä¸”ä¸ºäº†ç¡®å®šéœ€è¦åˆ·æ–°å“ªä¸ªé¡µé¢ï¼Œç»™æ¯ä¸ªviewæ·»åŠ ä¸€ä¸ªtagã€‚</p>
<pre><code>  viewPager = (ViewPager) findViewById(R.id.weather_pager);
  LayoutInflater layoutInflater = getLayoutInflater();
  for (int i=0;i&lt;choosedCountyList.size(); i++)&#123;
      View view = layoutInflater.inflate(R.layout.weather_layout, null);
      view.setTag(i);
      String countyName = choosedCountyList.get(i);
      fillView(view, countyName,true);
      pageList.add(view);
  &#125;
  adapter = new PagerAdapter() &#123;
      @Override
      public int getCount() &#123;
          return pageList.size();
      &#125;

      @Override
      public int getItemPosition(@NonNull Object object) &#123;
          //æ›´æ–°å…¶ä¸­ä¸€ä¸ªé¡µé¢
          View view = (View) object;
          int currentPagerIdx = viewPager.getCurrentItem();
          if (currentPagerIdx == (Integer) view.getTag()) &#123;
              return POSITION_NONE;
          &#125; else &#123;
              return POSITION_UNCHANGED;
          &#125;
    
      &#125;

      @Override
      public boolean isViewFromObject(@NonNull View view, @NonNull Object object) &#123;
          return view==object;
      &#125;

      @Override
      public void destroyItem(@NonNull ViewGroup container, int position, @NonNull Object object) &#123;
          container.removeView(pageList.get(position));
      &#125;

      @NonNull
      @Override
      public Object instantiateItem(@NonNull ViewGroup container, int position) &#123;
          container.addView(pageList.get(position));
          return pageList.get(position);
      &#125;


  &#125;;
</code></pre>
</li>
</ul>
<h4 id="ViewPageré¡µæ·»åŠ æˆ–å‡å°‘åŸå¸‚"><a href="#ViewPageré¡µæ·»åŠ æˆ–å‡å°‘åŸå¸‚" class="headerlink" title="ViewPageré¡µæ·»åŠ æˆ–å‡å°‘åŸå¸‚"></a>ViewPageré¡µæ·»åŠ æˆ–å‡å°‘åŸå¸‚</h4><ul>
<li>æƒ…å†µè¯´æ˜ï¼š<ul>
<li>å½“å‡ºç°åˆ é™¤åŸå¸‚æ—¶ï¼Œå³åˆ é™¤viewPagerä¸­çš„viewï¼Œå¦‚æœç›´æ¥pageListä¸­removeé¡µé¢åä½¿ç”¨adapter.notifyDataSetChanged()æ¥é€šé€šçŸ¥è§†å›¾æ”¹å˜ï¼Œè¿™ä¼šå‡ºç°è¶…å‡ºç´¢å¼•çš„é—®é¢˜ã€‚</li>
<li>å½“å‡ºç°å¢åŠ åŸå¸‚ï¼Œä¸€èˆ¬ä¸ä¼šå‡ºç°é—®é¢˜ã€‚</li>
<li>å½“å‡ºç°åŸå¸‚æ•°é‡ä¸å˜ä½†æ˜¯åŸå¸‚å‘ç”Ÿäº†æ”¹å˜ï¼Œä¼šå‡ºç°æ˜¾ç¤ºåŸå¸‚é”™è¯¯çš„æƒ…å†µï¼Œä»ç„¶æ˜¾ç¤ºåŸæ¥çš„åŸå¸‚å¤©æ°”æƒ…å†µã€‚</li>
</ul>
</li>
<li>åŸå› ï¼š <ul>
<li>destroyItemæ–¹æ³•ä¸­é‡‡ç”¨äº†ä½ç½®ç´¢å¼•çš„æ–¹å¼æ¥åˆ é™¤é¡µé¢ï¼Œä½†æ˜¯å› ä¸ºpageListä¸­removeäº†é¡µé¢ï¼Œå¯¼è‡´ç´¢å¼•è¶…å‡ºäº†ã€‚</li>
<li>æ— é—®é¢˜</li>
<li>å› ä¸ºviewPagerä¼šç¼“å­˜å½“å‰é¡µé¢çš„å·¦å³é¡µé¢(3ä¸ªé¡µé¢)ï¼Œè¿™ä¼šå¯¼è‡´ä»ç„¶æ˜¾ç¤ºåŸæ¥çš„åŸå¸‚</li>
</ul>
</li>
<li>è§£å†³æ€è·¯ï¼š<ul>
<li>destroyItemæ–¹æ³•å°†objectè½¬ä¸ºviewååˆ é™¤çš„æ–¹å¼æ¥è§£å†³ç´¢å¼•é—®é¢˜ã€‚</li>
<li>æ¸…ç©ºpageListï¼Œé‡æ–°æ·»åŠ åŸå¸‚ï¼Œæ­¤æ—¶éœ€è¦æ³¨æ„å› ä¸ºä¸Šé¢é€‰æ‹©äº†åªæ›´æ–°å½“å‰é¡µé¢ï¼Œä½†ç°åœ¨éœ€è¦æ›´æ–°æ‰€æœ‰é¡µé¢ï¼Œè®¾ç½®æ ‡å¿—ä½æ¥è¾¨åˆ«æ›´æ–°ä¸€ä¸ªè¿˜æ˜¯æ›´æ–°æ‰€æœ‰ã€‚</li>
</ul>
</li>
</ul>
<p>ä¸»è¦çš„ä»£ç å˜åŠ¨å¦‚ä¸‹ï¼š</p>
<pre><code>//æ”¹å˜é€‚é…å™¨
adapter = new PagerAdapter() &#123;
    @Override
    public int getCount() &#123;
        return pageList.size();
    &#125;

    @Override
    public int getItemPosition(@NonNull Object object) &#123;
        if (updateStatu == UPDATE_ONE_PAGE)&#123;
            //æ›´æ–°å…¶ä¸­ä¸€ä¸ªé¡µé¢
            View view = (View) object;
            int currentPagerIdx = viewPager.getCurrentItem();
            if (currentPagerIdx == (Integer) view.getTag()) &#123;
                return POSITION_NONE;
            &#125; else &#123;
                return POSITION_UNCHANGED;
            &#125;
        &#125; else if (updateStatu == UPDATE_ALL_PAGE)&#123;
            //æ›´æ–°æ‰€æœ‰é¡µé¢ï¼Œç›®çš„ä¸ºå»é™¤ç¼“å­˜
            return POSITION_NONE;
       &#125;
        return POSITION_NONE;
    &#125;
&#125;


//åœ¨åŸå¸‚åˆ—è¡¨æ–¹å¼å˜åŒ–æ˜¯é‡æ–°ç”Ÿæˆé¡µé¢
//å½“å‰å˜åŒ–
if (!equalList(curList, choosedCountyList))&#123;
    LayoutInflater layoutInflater = getLayoutInflater();
    pageList.clear();
    for (int i=0; i&lt; curList.size();i++)&#123;
        //ä»¥å‰çš„æ²¡æœ‰ï¼Œæ–°å¢çš„åŸå¸‚ï¼Œæ–°å¢é¡µé¢
        View view = layoutInflater.inflate(R.layout.weather_layout, null);
        view.setTag(i);
        String countyName = curList.get(i);
        fillView(view, countyName,false);
        pageList.add(i, view);
    &#125;
    updateStatu = UPDATE_ALL_PAGE;
    adapter.notifyDataSetChanged();
&#125;
//ä¸€å®šè¦åœ¨é€‰æ‹©é¡µé¢å‰æ›´æ–°åŸå¸‚åˆ—è¡¨ï¼Œä¸ç„¶å¢åŠ åŸå¸‚æ—¶onPageSelectedå‡ºç°è¶…è¿‡ç´¢å¼•çš„é—®é¢˜
choosedCountyList = curList;
viewPager.setCurrentItem(position);

/**
 * æ›´æ–°å½“å‰é¡µå¤©æ°”
 */
private void updatePageView()&#123;
    updateStatu = UPDATE_ONE_PAGE;
    View view = pageList.get(position);
    String countyName = choosedCountyList.get(position);
    fillView(view, countyName, true);
    adapter.notifyDataSetChanged();
&#125;
</code></pre>
<h4 id="Weatherå±•ç¤º"><a href="#Weatherå±•ç¤º" class="headerlink" title="Weatherå±•ç¤º"></a>Weatherå±•ç¤º</h4><ul>
<li><p>æƒ…å†µï¼šé»˜è®¤æƒ…å†µæ¯æ¬¡éƒ½ä¼šç”Ÿæˆæ–°çš„æ´»åŠ¨ï¼Œä½†æ˜¯å¤©æ°”å±•ç¤ºé¡µé¢åªéœ€è¦ä¸€ä¸ªå°±å¤Ÿ</p>
</li>
<li><p>è§£å†³æ€è·¯: åœ¨manifestæ–‡ä»¶ä¸­è®¾ç½®WeatherActivityä¸ºsingleTask</p>
<pre><code>  &lt;activity android:name=&quot;.WeatherActivity&quot; android:launchMode=&quot;singleTask&quot;/&gt;
</code></pre>
</li>
</ul>
<h4 id="ä»åŸå¸‚æ·»åŠ é¡µé¢è·³è½¬åˆ°Weatheré¡µé¢å±•ç¤ºå½“å‰é€‰ä¸­çš„åŸå¸‚"><a href="#ä»åŸå¸‚æ·»åŠ é¡µé¢è·³è½¬åˆ°Weatheré¡µé¢å±•ç¤ºå½“å‰é€‰ä¸­çš„åŸå¸‚" class="headerlink" title="ä»åŸå¸‚æ·»åŠ é¡µé¢è·³è½¬åˆ°Weatheré¡µé¢å±•ç¤ºå½“å‰é€‰ä¸­çš„åŸå¸‚"></a>ä»åŸå¸‚æ·»åŠ é¡µé¢è·³è½¬åˆ°Weatheré¡µé¢å±•ç¤ºå½“å‰é€‰ä¸­çš„åŸå¸‚</h4><ul>
<li>æƒ…å†µï¼šä»ä»åŸå¸‚æ·»åŠ é¡µé¢è·³è½¬åˆ°Weatheré¡µé¢æ—¶é»˜è®¤æ˜¾ç¤ºä¹‹å‰Weatheré¡µé¢æ˜¾ç¤ºçš„åŸå¸‚æƒ…å†µ</li>
<li>è§£å†³æ€è·¯ï¼šåœ¨<code>prefs = PreferenceManager.getDefaultSharedPreferences (this)</code>ä¸­ä¿å­˜å½“å‰é€‰ä¸­çš„åŸå¸‚ï¼Œéšååœ¨Weatheræ´»åŠ¨ä¸­å–å‡ºï¼Œæ ¹æ®åŸå¸‚åå¾—åˆ°æ‰€åœ¨é¡µé¢çš„ç´¢å¼•ï¼Œè®¾ç½®ä¸ºå½“å‰é¡µã€‚<code>viewPager.setCurrentItem(position);</code></li>
</ul>
<h3 id="ä»£ç å±•ç¤º"><a href="#ä»£ç å±•ç¤º" class="headerlink" title="ä»£ç å±•ç¤º"></a>ä»£ç å±•ç¤º</h3><pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;manifest xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;
    package=&quot;com.coolweather.android&quot;&gt;

    &lt;!-- è¿™ä¸ªæƒé™ç”¨äºè¿›è¡Œç½‘ç»œå®šä½ --&gt;
    &lt;uses-permission android:name=&quot;android.permission.ACCESS_COARSE_LOCATION&quot; /&gt; &lt;!-- è¿™ä¸ªæƒé™ç”¨äºè®¿é—®GPSå®šä½ --&gt;
    &lt;uses-permission android:name=&quot;android.permission.ACCESS_FINE_LOCATION&quot; /&gt; &lt;!-- ç”¨äºè®¿é—®wifiç½‘ç»œä¿¡æ¯ï¼Œwifiä¿¡æ¯ä¼šç”¨äºè¿›è¡Œç½‘ç»œå®šä½ --&gt;
    &lt;uses-permission android:name=&quot;android.permission.ACCESS_WIFI_STATE&quot; /&gt; &lt;!-- è·å–è¿è¥å•†ä¿¡æ¯ï¼Œç”¨äºæ”¯æŒæä¾›è¿è¥å•†ä¿¡æ¯ç›¸å…³çš„æ¥å£ --&gt;
    &lt;uses-permission android:name=&quot;android.permission.ACCESS_NETWORK_STATE&quot; /&gt; &lt;!-- è¿™ä¸ªæƒé™ç”¨äºè·å–wifiçš„è·å–æƒé™ï¼Œwifiä¿¡æ¯ä¼šç”¨æ¥è¿›è¡Œç½‘ç»œå®šä½ --&gt;
    &lt;uses-permission android:name=&quot;android.permission.CHANGE_WIFI_STATE&quot; /&gt; &lt;!-- å†™å…¥æ‰©å±•å­˜å‚¨ï¼Œå‘æ‰©å±•å¡å†™å…¥æ•°æ®ï¼Œç”¨äºå†™å…¥ç¦»çº¿å®šä½æ•°æ® --&gt;
    &lt;uses-permission android:name=&quot;android.permission.WRITE_EXTERNAL_STORAGE&quot; /&gt; &lt;!-- è®¿é—®ç½‘ç»œï¼Œç½‘ç»œå®šä½éœ€è¦ä¸Šç½‘ --&gt;
    &lt;uses-permission android:name=&quot;android.permission.INTERNET&quot; /&gt;
    &lt;uses-permission android:name=&quot;android.permission.READ_PHONE_STATE&quot; /&gt;

    &lt;application
        android:name=&quot;org.litepal.LitePalApplication&quot;
        android:allowBackup=&quot;true&quot;
        android:icon=&quot;@mipmap/ic_launcher&quot;
        android:label=&quot;@string/app_name&quot;
        android:roundIcon=&quot;@mipmap/ic_launcher_round&quot;
        android:supportsRtl=&quot;true&quot;
        android:theme=&quot;@style/AppTheme&quot;&gt;
        &lt;service
            android:name=&quot;.AutoUpdateService&quot;
            android:enabled=&quot;true&quot;
            android:exported=&quot;true&quot;&gt;&lt;/service&gt;

        &lt;meta-data
            android:name=&quot;com.baidu.lbsapi.API_KEY&quot;
            android:value=&quot;xxxxxx&quot; /&gt;

        &lt;activity android:name=&quot;.ChooseAreaActivity&quot; /&gt;
        &lt;activity android:name=&quot;.CountyChoosedActivity&quot; /&gt;

        &lt;activity android:name=&quot;.WeatherActivity&quot;
            android:launchMode=&quot;singleTask&quot;/&gt;

        &lt;activity android:name=&quot;.MainActivity&quot;&gt;
            &lt;intent-filter&gt;
                &lt;action android:name=&quot;android.intent.action.MAIN&quot; /&gt;
                &lt;category android:name=&quot;android.intent.category.LAUNCHER&quot; /&gt;
            &lt;/intent-filter&gt;
        &lt;/activity&gt;

        &lt;service
            android:name=&quot;com.baidu.location.f&quot;
            android:enabled=&quot;true&quot;
            android:process=&quot;:remote&quot; /&gt;
    &lt;/application&gt;

&lt;/manifest&gt;
</code></pre>
<p>MainActivity</p>
<pre><code>package com.coolweather.android;

import androidx.annotation.NonNull;
import androidx.appcompat.app.AppCompatActivity;
import androidx.core.app.ActivityCompat;
import androidx.core.content.ContextCompat;

import android.Manifest;
import android.content.Intent;
import android.content.SharedPreferences;
import android.content.pm.PackageManager;
import android.icu.text.UnicodeSetSpanner;
import android.os.Bundle;
import android.preference.PreferenceManager;
import android.widget.Toast;

import com.baidu.location.BDLocation;
import com.baidu.location.BDLocationListener;
import com.baidu.location.LocationClient;
import com.baidu.location.LocationClientOption;
import com.baidu.mapapi.SDKInitializer;
import com.coolweather.android.db.ChoosedCounty;
import com.coolweather.android.util.BDLocationUtil;
import com.coolweather.android.util.Utility;

import java.util.ArrayList;
import java.util.List;

public class MainActivity extends AppCompatActivity &#123;


    private LocationClient locationClient;


    @Override
    protected void onCreate(Bundle savedInstanceState) &#123;
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        final SharedPreferences prefs = PreferenceManager.getDefaultSharedPreferences(this);
        if (prefs.getString(&quot;weather&quot;,null)!=null) &#123;
            String countyName = prefs.getString(&quot;weatherCityName&quot;, &quot;åŒ—äº¬&quot;);
            SharedPreferences.Editor edit = prefs.edit();
            edit.putString(&quot;curCounty&quot;, countyName);
            edit.apply();
            Utility.saveChoosedCounty(countyName);
            Intent intent = new Intent(this, WeatherActivity.class);
            startActivity(intent);
            finish();
        &#125; else &#123;
            locationClient = new LocationClient(getApplicationContext());
            locationClient.registerLocationListener(new BDLocationListener() &#123;
                @Override
                public void onReceiveLocation(final BDLocation location) &#123;
                    String district = location.getDistrict();
                    if (district == null)&#123;
                        runOnUiThread(new Runnable() &#123;
                            @Override
                            public void run() &#123;
                                Toast.makeText(MainActivity.this,
                                        &quot;æ— æ³•è·å–å®šä½ï¼Œé‡ç½®å®šä½ä¸ºåŒ—äº¬&quot;,
                                        Toast.LENGTH_SHORT).show();
                            &#125;
                        &#125;);
                        district = &quot;åŒ—äº¬&quot;;
                    &#125;
                    locationClient.stop();
                    Utility.saveChoosedCounty(district);
                    SharedPreferences.Editor edit = prefs.edit();
                    edit.putString(&quot;curCounty&quot;, district);
                    edit.apply();
                    Intent intent = new Intent(MainActivity.this, WeatherActivity.class);
                    startActivity(intent);
                    finish();
                &#125;
            &#125;);
            SDKInitializer.initialize(getApplicationContext());
            //ç”³è¯·æƒé™
            if (requestPermission())&#123;
                requestLocation();
            &#125;

        &#125;
    &#125;

    private void requestLocation()&#123;
        LocationClientOption option = new LocationClientOption();
        option.setIsNeedAddress(true);
        locationClient.setLocOption(option);
        locationClient.start();
    &#125;

    /**
     * è¯·æ±‚æƒé™
     */
    private boolean requestPermission()&#123;
        List&lt;String&gt; permissionList = new ArrayList&lt;&gt;();
        if (ContextCompat.checkSelfPermission(MainActivity.this, Manifest.
                permission.ACCESS_FINE_LOCATION)!= PackageManager.PERMISSION_GRANTED) &#123;
            permissionList.add(Manifest.permission.ACCESS_FINE_LOCATION);
        &#125;
        if (ContextCompat.checkSelfPermission(MainActivity.this, Manifest.
                permission.WRITE_EXTERNAL_STORAGE)!= PackageManager.PERMISSION_GRANTED) &#123;
            permissionList.add(Manifest.permission.WRITE_EXTERNAL_STORAGE);
        &#125;
        if (ContextCompat.checkSelfPermission(MainActivity.this,
                Manifest.permission.ACCESS_COARSE_LOCATION)!= PackageManager.PERMISSION_GRANTED)&#123;
            permissionList.add(Manifest.permission.ACCESS_COARSE_LOCATION);
        &#125;
        if (ContextCompat.checkSelfPermission(MainActivity.this,
                Manifest.permission.READ_PHONE_STATE) != PackageManager.PERMISSION_GRANTED)&#123;
            permissionList.add(Manifest.permission.READ_PHONE_STATE);
        &#125;
        if (!permissionList.isEmpty()) &#123;
            String [] permissions = permissionList.toArray(new String[permissionList.
                    size()]);
            ActivityCompat.requestPermissions(MainActivity.this, permissions, 1);
            return false;
        &#125;
        return true;
    &#125;

    @Override
    public void onRequestPermissionsResult(int requestCode, @NonNull String[] permissions, @NonNull int[] grantResults) &#123;
        switch (requestCode) &#123;
            case 1:
                if (grantResults.length &gt; 0) &#123;
                    for (int result : grantResults) &#123;
                        if (result != PackageManager.PERMISSION_GRANTED) &#123;
                            Toast.makeText(this, &quot;å¿…é¡»åŒæ„æ‰€æœ‰æƒé™æ‰èƒ½ä½¿ç”¨æœ¬ç¨‹åº&quot;,
                                    Toast.LENGTH_SHORT).show();
                            finish();
                            return;
                        &#125;
                    &#125;
                    requestLocation();
                &#125; else &#123;
                    Toast.makeText(this, &quot;å‘ç”ŸæœªçŸ¥é”™è¯¯&quot;, Toast.LENGTH_SHORT).show();
                &#125;
                break;
            default:
        &#125;
    &#125;


&#125;
</code></pre>
<p>WeatherActivity</p>
<pre><code>package com.coolweather.android;

import androidx.annotation.NonNull;
import androidx.annotation.RequiresApi;
import androidx.appcompat.app.AppCompatActivity;
import androidx.swiperefreshlayout.widget.SwipeRefreshLayout;
import androidx.viewpager.widget.PagerAdapter;
import androidx.viewpager.widget.ViewPager;

import android.annotation.SuppressLint;
import android.content.Intent;
import android.content.SharedPreferences;
import android.graphics.Color;
import android.os.Build;
import android.os.Bundle;
import android.preference.PreferenceManager;
import android.util.ArraySet;
import android.util.Log;
import android.view.LayoutInflater;
import android.view.View;
import android.view.ViewGroup;
import android.widget.Button;
import android.widget.ImageView;
import android.widget.LinearLayout;
import android.widget.ScrollView;
import android.widget.TextView;
import android.widget.Toast;

import com.bumptech.glide.Glide;
import com.coolweather.android.db.ChoosedCounty;
import com.coolweather.android.gson.Forecast;
import com.coolweather.android.gson.Lifestyle;
import com.coolweather.android.gson.Weather;
import com.coolweather.android.util.HttpUtil;
import com.coolweather.android.util.Utility;
import com.coolweather.android.view.PocketSwipeRefreshLayout;


import org.litepal.crud.DataSupport;

import java.io.IOException;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;

import okhttp3.Call;
import okhttp3.Callback;
import okhttp3.Response;

@RequiresApi(api = Build.VERSION_CODES.M)
public class WeatherActivity extends AppCompatActivity &#123;

    /**
     * é‡‡ç”¨singleTaskæ¨¡å¼ï¼Œåªå­˜åœ¨ä¸€ä¸ªweatheræ´»åŠ¨
     *
     */
    private static final String TAG = &quot;WeatherActivity&quot;;

    private PocketSwipeRefreshLayout swipeRefreshLayout;
    private ImageView bingPIcImg;
    private Button navButton;
    private TextView titleCityText;
    private LinearLayout dotLayout;

    private SharedPreferences prefs;

    private ViewPager viewPager;
    private PagerAdapter adapter;
    //ä¿å­˜æ¯ä¸ªé¡µé¢view
    private ArrayList&lt;View&gt; pageList = new ArrayList&lt;&gt;();
    private List&lt;ImageView&gt; dotImageList = new ArrayList&lt;&gt;();
    //å½“å‰é¡µç´¢å¼•
    private int position;
    //å½“å‰æ˜¾ç¤ºçš„åŸå¸‚
    private String curCountyName;

    //æ‰€æœ‰é€‰ä¸­çš„åŸå¸‚
    private List&lt;String&gt; choosedCountyList = new ArrayList&lt;&gt;();
    //åŸå¸‚å¯¹åº”çš„ä½ç½®
    private HashMap&lt;String, Integer&gt; countyIndex = new HashMap&lt;&gt;();

    //æ›´æ–°ä¸€ä¸ªé¡µé¢
    private int UPDATE_ONE_PAGE = 0;
    //æ›´æ–°æ‰€æœ‰é¡µé¢
    private int UPDATE_ALL_PAGE = 1;
    //æ›´æ–°æ ‡è®°ï¼Œç”¨æ¥åˆ‡æ¢ä¸‹æ‹‰åˆ·æ–°æ›´æ–°ä¸€ä¸ªé¡µé¢ å’Œ å‡å°‘é¡µé¢æ›´æ–°æ‰€æœ‰é¡µé¢æ¥å»é™¤ç¼“å­˜
    private int updateStatu = UPDATE_ONE_PAGE;



    @Override
    protected void onCreate(Bundle savedInstanceState) &#123;
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_weather);
        //å®ç°çŠ¶æ€æ é…è‰²ç»Ÿä¸€
        if (Build.VERSION.SDK_INT&gt;=21)&#123;
            View decorView = getWindow().getDecorView();
            decorView.setSystemUiVisibility(View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN|
                    View.SYSTEM_UI_FLAG_LAYOUT_STABLE);
            getWindow().setStatusBarColor(Color.TRANSPARENT);
        &#125;
        setContentView(R.layout.activity_weather);
        //æ•°æ®åˆå§‹åŒ–-- å°†ä¼ å…¥çš„æ•°æ®èµ‹å€¼åˆ°å¯¹åº”çš„ä½ç½®
        choosedCountyList = initChoosedCounties();
        prefs = PreferenceManager.getDefaultSharedPreferences
                (this);
        curCountyName = prefs.getString(&quot;curCounty&quot;,choosedCountyList.get(0));
        position = getPositionFromName(curCountyName, choosedCountyList);

        //åœ†ç‚¹æ¥æ˜¾ç¤ºå½“å‰é¡µé¢çš„ä½ç½®
        dotLayout = (LinearLayout) findViewById(R.id.dot_layout);
        for (int i = 0; i &lt; choosedCountyList.size(); i++) &#123;
            ImageView imageView = new ImageView(WeatherActivity.this);
            imageView.setLayoutParams(new ViewGroup.LayoutParams(30, 30));
            imageView.setPadding(20, 0, 20, 0);
            if (i == position) &#123;
                // é»˜è®¤é€‰ä¸­ç¬¬ä¸€å¼ å›¾ç‰‡
                imageView.setBackgroundResource(R.drawable.dot_focused);
            &#125; else &#123;
                imageView.setBackgroundResource(R.drawable.dot_normal);
            &#125;
            dotImageList.add(imageView);
            dotLayout.addView(imageView);
        &#125;


        //ä¸‹æ‹‰åˆ·æ–°
        swipeRefreshLayout = (PocketSwipeRefreshLayout) findViewById(R.id.swipe_refresh);
        swipeRefreshLayout.setColorSchemeResources(R.color.colorPrimary);
        swipeRefreshLayout.setOnRefreshListener(new PocketSwipeRefreshLayout.OnRefreshListener() &#123;
            @Override
            public void onRefresh() &#123;
                updatePageView();
                Toast.makeText(WeatherActivity.this, &quot;åˆ·æ–°&quot;,
                        Toast.LENGTH_SHORT).show();
                swipeRefreshLayout.setRefreshing(false);
            &#125;
        &#125;);
        //tupian
        bingPIcImg = (ImageView) findViewById(R.id.bing_pic_img);
        String bingPic = prefs.getString(&quot;bing_pic&quot;, null);
        if (bingPic != null)&#123;
            Glide.with(this).load(bingPic).into(bingPIcImg);
        &#125;else &#123;
            loadBingPIc();
        &#125;
        //æ·»åŠ æŒ‰é’®
        navButton = (Button) findViewById(R.id.nav_button);
        navButton.setOnClickListener(new View.OnClickListener() &#123;
            @Override
            public void onClick(View v) &#123;
                Intent intent = new Intent(WeatherActivity.this,
                        CountyChoosedActivity.class);
                startActivity(intent);
            &#125;
        &#125;);

        titleCityText = (TextView) findViewById(R.id.title_city);
        titleCityText.setText(curCountyName);

        //åˆå§‹åŒ–pagerï¼Œæ¯ä¸ªé¡µé¢éƒ½æ˜¯ä¸€ä¸ªåŸå¸‚çš„å¤©æ°”
        viewPager = (ViewPager) findViewById(R.id.weather_pager);
        LayoutInflater layoutInflater = getLayoutInflater();
        for (int i=0;i&lt;choosedCountyList.size(); i++)&#123;
            View view = layoutInflater.inflate(R.layout.weather_layout, null);
            view.setTag(i);
            String countyName = choosedCountyList.get(i);
            fillView(view, countyName,true);
            pageList.add(view);
        &#125;
        adapter = new PagerAdapter() &#123;
            @Override
            public int getCount() &#123;
                return pageList.size();
            &#125;

            @Override
            public int getItemPosition(@NonNull Object object) &#123;
                if (updateStatu == UPDATE_ONE_PAGE)&#123;
                    //æ›´æ–°å…¶ä¸­ä¸€ä¸ªé¡µé¢
                    View view = (View) object;
                    int currentPagerIdx = viewPager.getCurrentItem();
                    if (currentPagerIdx == (Integer) view.getTag()) &#123;
                        return POSITION_NONE;
                    &#125; else &#123;
                        return POSITION_UNCHANGED;
                    &#125;
                &#125;
                else if (updateStatu == UPDATE_ALL_PAGE)&#123;
                    //æ›´æ–°æ‰€æœ‰é¡µé¢ï¼Œç›®çš„ä¸ºå»é™¤ç¼“å­˜
                    return POSITION_NONE;
                &#125;
                return POSITION_NONE;
            &#125;

            @Override
            public boolean isViewFromObject(@NonNull View view, @NonNull Object object) &#123;
                return view==object;
            &#125;

            @Override
            public void destroyItem(@NonNull ViewGroup container, int position, @NonNull Object object) &#123;
                container.removeView((View) object);
            &#125;

            @NonNull
            @Override
            public Object instantiateItem(@NonNull ViewGroup container, int position) &#123;
                container.addView(pageList.get(position));
                return pageList.get(position);
            &#125;
        &#125;;
        viewPager.setAdapter(adapter);
        //ä¾¦æµ‹å½“å‰é¡µé¢ä½ç½®
        viewPager.setOnPageChangeListener(new ViewPager.OnPageChangeListener() &#123;
            @Override
            public void onPageScrolled(int position, float positionOffset, int positionOffsetPixels) &#123;
            &#125;

            @Override
            public void onPageSelected(int position) &#123;
                WeatherActivity.this.position = position;
                curCountyName = choosedCountyList.get(position);
                titleCityText.setText(curCountyName);
                for (int i=0;i&lt;dotImageList.size(); i++)&#123;
                    dotImageList.get(i).setBackgroundResource(R.drawable.dot_normal);
                &#125;
                dotImageList.get(position).setBackgroundResource(R.drawable.dot_focused);
            &#125;

            @Override
            public void onPageScrollStateChanged(int state) &#123;

            &#125;
        &#125;);

        viewPager.setCurrentItem(position);
        viewPager.setOffscreenPageLimit(8);

    &#125;

    private int getPositionFromName(String name,List&lt;String&gt; list)&#123;
        for (int i = 0; i &lt; list.size(); i++) &#123;
            if (name.equals(list.get(i)))&#123;
                return i;
            &#125;
        &#125;
        return -1;
    &#125;

    public  boolean equalList(List&lt;String&gt; a, List&lt;String&gt; b) &#123;
        if (a==b) return true;
        if (a==null || b==null) return false;
        int length = a.size();
        if (b.size() != length) return false;
        for (int i=0; i&lt;length; i++)
            if (!a.get(i).equals(b.get(i))) return false;
        return true;
    &#125;

    /**
     * å½“é‡æ–°æ¿€æ´»åï¼Œ
     * 1)æ¯”è¾ƒé€‰æ‹©åŸå¸‚æ˜¯å¦å‘ç”Ÿæ”¹å˜ï¼Œè‹¥æ— ï¼Œæ˜¾ç¤ºå½“å‰é€‰ä¸­çš„åŸå¸‚é¡µé¢
     * 2 å‘ç”Ÿæ”¹å˜ï¼Œæ·»åŠ æˆ–å‡å°‘é¡µé¢
     */
    @Override
    protected void onRestart() &#123;
        super.onRestart();
        //å½“å‰é€‰æ‹©çš„åŸå¸‚åˆ—è¡¨
        List&lt;String&gt; curList = initChoosedCounties();
        curCountyName = prefs.getString(&quot;curCounty&quot;, curList.get(0));
        position = getPositionFromName(curCountyName, curList);
        //æ”¹å˜åœ†ç‚¹ä½ç½®
        dotImageList.clear();
        dotLayout.removeAllViews();
        for (int i = 0; i &lt; curList.size(); i++) &#123;
            ImageView imageView = new ImageView(WeatherActivity.this);
            imageView.setLayoutParams(new ViewGroup.LayoutParams(30, 30));
            imageView.setPadding(20, 0, 20, 0);
            dotImageList.add(imageView);
            dotLayout.addView(imageView);
        &#125;

        //å½“å‰å˜åŒ–
        if (!equalList(curList, choosedCountyList))&#123;
            LayoutInflater layoutInflater = getLayoutInflater();
            pageList.clear();
            for (int i=0; i&lt; curList.size();i++)&#123;
                //ä»¥å‰çš„æ²¡æœ‰ï¼Œæ–°å¢çš„åŸå¸‚ï¼Œæ–°å¢é¡µé¢
                View view = layoutInflater.inflate(R.layout.weather_layout, null);
                view.setTag(i);
                String countyName = curList.get(i);
                fillView(view, countyName,false);
                pageList.add(i, view);
            &#125;
            updateStatu = UPDATE_ALL_PAGE;
            adapter.notifyDataSetChanged();

        &#125;
        //ä¸€å®šè¦åœ¨é€‰æ‹©é¡µé¢å‰æ›´æ–°åŸå¸‚åˆ—è¡¨ï¼Œä¸ç„¶å¢åŠ åŸå¸‚æ—¶onPageSelectedå‡ºç°è¶…è¿‡ç´¢å¼•çš„é—®é¢˜
        choosedCountyList = curList;
        viewPager.setCurrentItem(position);
    &#125;

    private List&lt;String&gt; initChoosedCounties()&#123;
        List&lt;ChoosedCounty&gt; all = DataSupport.findAll(ChoosedCounty.class);
        List&lt;String&gt; curList = new ArrayList&lt;&gt;();
        for (int i=0; i&lt;all.size(); i++)&#123;
            curList.add(all.get(i).getCountyName());
        &#125;
        return curList;
    &#125;

    /**
     * æ ¹æ®åŸå¸‚åè·å–å†…å®¹ï¼Œå¹¶å¡«å……view
     * @param countyName
     * @param isUpdate æ˜¯å¦æ›´æ–°å¤©æ°”æ•°æ®
     */
    private void fillView(View view, String countyName, boolean isUpdate)&#123;
        if (isUpdate)&#123;
            requestWeather(view,countyName);
        &#125;else &#123;
            String weatherString = prefs.getString(countyName, null);
            Weather weather = null;
            if (weatherString == null)&#123;
                // æ— ç¼“å­˜æ—¶å»æœåŠ¡å™¨æŸ¥è¯¢å¤©æ°”
                requestWeather(view, countyName);
            &#125;else &#123;
                weather = Utility.handleWeatherResponse(weatherString);
                showWeatherInfo(view, weather);
            &#125;
        &#125;

    &#125;

    /**
     * æ ¹æ®åŸå¸‚åæ¥æŸ¥è¯¢å¤©æ°”
     * æ”¯æŒä¸­è‹±æ–‡ä¸æ‹¼éŸ³ï¼Œ
     * @param city
     */
    public void requestWeather(final View view, final String city)&#123;
        String weatherUrl = &quot;https://free-api.heweather.net/s6/weather/?location=&quot;
                +city+&quot;&amp;key=è‡ªå·±å’Œé£å¤©æ°”çš„key&quot;;
        HttpUtil.sendOkHttpRequest(weatherUrl, new Callback() &#123;
            @Override
            public void onFailure(Call call, IOException e) &#123;
                e.printStackTrace();
                runOnUiThread(new Runnable() &#123;
                    @Override
                    public void run() &#123;
                        Toast.makeText(WeatherActivity.this, &quot;è·å–å¤©æ°”ä¿¡æ¯å¤±è´¥&quot;,
                                Toast.LENGTH_SHORT).show();
                        swipeRefreshLayout.setRefreshing(false);
                    &#125;
                &#125;);
            &#125;

            @Override
            public void onResponse(Call call, Response response) throws IOException &#123;
                final String responseText = response.body().string();
                final Weather weather = Utility.handleWeatherResponse(responseText);
                runOnUiThread(new Runnable() &#123;
                    @Override
                    public void run() &#123;
                        if (weather!=null &amp;&amp; &quot;ok&quot;.equals(weather.status))&#123;
                            @SuppressLint(&quot;CommitPrefEdits&quot;)
                            SharedPreferences.Editor edit = prefs.edit();
                            edit.putString(city, responseText);
                            edit.apply();
                            showWeatherInfo(view, weather);
                        &#125;else &#123;
                            Toast.makeText(WeatherActivity.this,&quot;è·å–å¤©æ°”ä¿¡æ¯å¤±è´¥&quot;,
                                    Toast.LENGTH_SHORT).show();
                        &#125;
                        swipeRefreshLayout.setRefreshing(false);
                    &#125;
                &#125;);
            &#125;
        &#125;);
        loadBingPIc();
    &#125;

    /**
     * å¤„ç†å¹¶å±•ç¤ºWeatherå®ä½“ç±»æ•°æ®ä¿¡æ¯
     * @param weather
     */
    private void showWeatherInfo(View view, Weather weather)&#123;
        // åˆå§‹åŒ–å„æ§ä»¶
        ScrollView weatherLayout = (ScrollView) view.findViewById(R.id.weather_layout);
        //è§£å†³SwipeRefreshLayoutä¸ScrollViewçš„ä¸‹æ‹‰å†²çª
        weatherLayout.setOnScrollChangeListener(new View.OnScrollChangeListener() &#123;
            @Override
            public void onScrollChange(View v, int scrollX, int scrollY, int oldScrollX, int oldScrollY) &#123;
                if (swipeRefreshLayout != null)&#123;
                    swipeRefreshLayout.setEnabled(scrollY==0);
                &#125;
            &#125;
        &#125;);
        TextView updateTimeText = (TextView) view.findViewById(R.id.update_time);
        TextView degreeText = (TextView) view.findViewById(R.id.degree_text);
        TextView weatherInfoText = (TextView) view.findViewById(R.id.weather_info_text);
        LinearLayout forecastLayout = (LinearLayout) view.findViewById(R.id.forecast_layout);
        LinearLayout lifestyleLayout  = (LinearLayout) view.findViewById(R.id.lifestyle_layout);
        String updateTime = weather.update.loc;
        String degree = weather.now.tmp+&quot;â„ƒ&quot;;
        String weatherInfo = weather.now.cond_txt;
        //å¡«å……å†…å®¹
        updateTimeText.setText(updateTime);
        degreeText.setText(degree);
        weatherInfoText.setText(weatherInfo);
        forecastLayout.removeAllViews();
        for (Forecast forecast:weather.daily_forecast)&#123;
            View viewN = LayoutInflater.from(this).inflate(R.layout.forecast_item,
                    forecastLayout, false);
            TextView dateText = (TextView) viewN.findViewById(R.id.date_text);
            TextView infoText = (TextView) viewN.findViewById(R.id.info_text);
            TextView minText = (TextView) viewN.findViewById(R.id.min_text);
            TextView maxText = (TextView) viewN.findViewById(R.id.max_text);

            dateText.setText(forecast.date);
            infoText.setText(forecast.cond_txt_d);
            minText.setText(forecast.tmp_min);
            maxText.setText(forecast.tmp_max);
            forecastLayout.addView(viewN);
        &#125;
        lifestyleLayout.removeAllViews();
        for (Lifestyle lifestyle:weather.lifestyles)&#123;
            View viewN = LayoutInflater.from(this).inflate(R.layout.lifestyle_item,
                    lifestyleLayout, false);
            TextView lifestyle_text_text = (TextView) viewN.findViewById(R.id.lifestyle_text_text);
            TextView lifestyle_type_text = (TextView) viewN.findViewById(R.id.lifestyle_type_text);
            lifestyle_type_text.setText(Utility.translate(lifestyle.type) +&quot; &quot;+ lifestyle.brf);
            lifestyle_text_text.setText(lifestyle.txt);
            lifestyleLayout.addView(viewN);
        &#125;
        weatherLayout.setVisibility(View.VISIBLE);
    &#125;

    /**
     * æ›´æ–°å½“å‰é¡µå¤©æ°”
     */
    private void updatePageView()&#123;
        updateStatu = UPDATE_ONE_PAGE;
        View view = pageList.get(position);
        String countyName = choosedCountyList.get(position);
        fillView(view, countyName, true);
        adapter.notifyDataSetChanged();
    &#125;

    private void loadBingPIc()&#123;
        String requestBingPicUrl = &quot;http://guolin.tech/api/bing_pic&quot;;
        HttpUtil.sendOkHttpRequest(requestBingPicUrl, new Callback() &#123;
            @Override
            public void onFailure(Call call, IOException e) &#123;
                e.printStackTrace();
            &#125;

            @Override
            public void onResponse(Call call, Response response) throws IOException &#123;
                final String pic = response.body().string();
                SharedPreferences.Editor edit = PreferenceManager.getDefaultSharedPreferences(WeatherActivity.this).edit();
                edit.putString(&quot;bing_pic&quot;, pic);
                edit.apply();
                runOnUiThread(new Runnable() &#123;
                    @Override
                    public void run() &#123;
                        Glide.with(WeatherActivity.this).load(pic).into(bingPIcImg);
                    &#125;
                &#125;);
            &#125;
        &#125;);


    &#125;

&#125;
</code></pre>
<p>CountyChoosedActivity<br>å±•ç¤ºå·²é€‰ä¸­çš„åŸå¸‚åˆ—è¡¨å’Œåˆ é™¤åŸå¸‚åˆ—è¡¨</p>
<pre><code>package com.coolweather.android;

import androidx.appcompat.app.AlertDialog;
import androidx.appcompat.app.AppCompatActivity;
import androidx.fragment.app.Fragment;
import androidx.fragment.app.FragmentManager;
import androidx.fragment.app.FragmentTransaction;

import android.annotation.SuppressLint;
import android.content.DialogInterface;
import android.content.Intent;
import android.content.SharedPreferences;
import android.os.Bundle;
import android.preference.PreferenceManager;
import android.util.ArraySet;
import android.util.Log;
import android.view.View;
import android.widget.AdapterView;
import android.widget.ArrayAdapter;
import android.widget.Button;
import android.widget.ListView;
import android.widget.TextView;
import android.widget.Toast;

import com.baidu.location.BDLocation;
import com.baidu.location.BDLocationListener;
import com.baidu.location.LocationClient;
import com.baidu.location.LocationClientOption;
import com.coolweather.android.db.ChoosedCounty;
import com.coolweather.android.util.BDLocationUtil;
import com.coolweather.android.util.Utility;

import org.litepal.crud.DataSupport;

import java.util.ArrayList;
import java.util.HashSet;
import java.util.List;

import static org.litepal.LitePalApplication.getContext;

public class CountyChoosedActivity extends AppCompatActivity &#123;

    private static final String TAG = &quot;CountyChoosedActivity&quot;;
    private SharedPreferences prefs;
    private Button addCountyButton;
    private ListView listView;
    private Button locationCityButton;
    private ArrayAdapter&lt;String&gt; adapter;
    private List&lt;String&gt; countyList = new ArrayList&lt;&gt;();
    private List&lt;ChoosedCounty&gt; countyListDB = new ArrayList&lt;&gt;();

    private LocationClient locationClient;

    @Override
    protected void onCreate(Bundle savedInstanceState) &#123;
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_county_choosed);
        prefs = PreferenceManager.getDefaultSharedPreferences(this);

        queryChoosedCountyList();
        addCountyButton = (Button) findViewById(R.id.add_county_button);
        listView = (ListView) findViewById(R.id.county_list_choosed_view);
        locationCityButton = (Button) findViewById(R.id.location_city_button);

        startLocation();

        addCountyButton.setOnClickListener(new View.OnClickListener() &#123;
            @Override
            public void onClick(View v) &#123;
                Intent intent = new Intent(getContext(), ChooseAreaActivity.class);
                startActivity(intent);
                finish();
            &#125;
        &#125;);

        adapter = new ArrayAdapter&lt;String&gt;(CountyChoosedActivity.this,
                android.R.layout.simple_list_item_1, countyList);
        listView.setAdapter(adapter);
        listView.setOnItemClickListener(new AdapterView.OnItemClickListener() &#123;
            @Override
            public void onItemClick(AdapterView&lt;?&gt; parent, View view, int position, long id) &#123;
                String s = countyList.get(position);
                SharedPreferences.Editor edit = prefs.edit();
                edit.putString(&quot;curCounty&quot;, s);
                edit.apply();
                Intent intent = new Intent(getContext(), WeatherActivity.class);
                startActivity(intent);
                finish();
            &#125;
        &#125;);
        listView.setOnItemLongClickListener(new AdapterView.OnItemLongClickListener() &#123;
            @Override
            public boolean onItemLongClick(AdapterView&lt;?&gt; parent, View view, final int position, long id) &#123;
                //å®šä¹‰AlertDialog.Builderå¯¹è±¡ï¼Œå½“é•¿æŒ‰åˆ—è¡¨é¡¹çš„æ—¶å€™å¼¹å‡ºç¡®è®¤åˆ é™¤å¯¹è¯æ¡†
                AlertDialog.Builder builder=new AlertDialog.Builder(CountyChoosedActivity.this);
                builder.setMessage(&quot;ç¡®å®šåˆ é™¤?&quot;);
                builder.setTitle(&quot;æç¤º&quot;);

                //æ·»åŠ AlertDialog.Builderå¯¹è±¡çš„setPositiveButton()æ–¹æ³•
                builder.setPositiveButton(&quot;ç¡®å®š&quot;, new DialogInterface.OnClickListener() &#123;
                    @Override
                    public void onClick(DialogInterface dialog, int which) &#123;
                        String countyName= countyList.get(position);
                        if(countyList.remove(position)!=null)&#123;
                            DataSupport.deleteAll(ChoosedCounty.class,
                                    &quot;countyName = ?&quot;, countyName);
                            System.out.println(&quot;success&quot;);
                        &#125;else &#123;
                            System.out.println(&quot;failed&quot;);
                        &#125;
                        adapter.notifyDataSetChanged();
                        Toast.makeText(getBaseContext(), &quot;åˆ é™¤åˆ—è¡¨é¡¹&quot;, Toast.LENGTH_SHORT).show();
                    &#125;
                &#125;);

                //æ·»åŠ AlertDialog.Builderå¯¹è±¡çš„setNegativeButton()æ–¹æ³•
                builder.setNegativeButton(&quot;å–æ¶ˆ&quot;, new DialogInterface.OnClickListener() &#123;
                    @Override
                    public void onClick(DialogInterface dialog, int which) &#123;

                    &#125;
                &#125;);

                AlertDialog alertDialog = builder.create();
                alertDialog.setCanceledOnTouchOutside(false);
                alertDialog.show();
                return true;

            &#125;
        &#125;);

    &#125;

    private void startLocation()&#123;
        locationClient = new LocationClient(getApplicationContext());
        locationClient.registerLocationListener(new BDLocationListener() &#123;
            @Override
            public void onReceiveLocation(final BDLocation location) &#123;
                String district = location.getDistrict();
                if (district == null)&#123;
                    runOnUiThread(new Runnable() &#123;
                        @Override
                        public void run() &#123;
                            Toast.makeText(CountyChoosedActivity.this,
                                    &quot;æ— æ³•è·å–å®šä½ï¼Œé‡ç½®å®šä½ä¸ºåŒ—äº¬&quot;,
                                    Toast.LENGTH_SHORT).show();
                        &#125;
                    &#125;);
                    district = &quot;åŒ—äº¬&quot;;
                    locationCityButton.setText( district+&quot;--é‡æ–°å®šä½&quot;);
                &#125;else &#123;
                    locationCityButton.setText( district+&quot;--å®šä½&quot;);
                &#125;
                locationClient.stop();
                final String finalDistrict = district;
                locationCityButton.setOnClickListener(new View.OnClickListener() &#123;
                    @Override
                    public void onClick(View v) &#123;
                        SharedPreferences.Editor edit = prefs.edit();
                        Utility.saveChoosedCounty(finalDistrict);
                        edit.putString(&quot;curCounty&quot;, finalDistrict);
                        edit.apply();
                        Intent intent = new Intent(CountyChoosedActivity.this, WeatherActivity.class);
                        startActivity(intent);
                        finish();
                    &#125;
                &#125;);
            &#125;
        &#125;);
        LocationClientOption option = new LocationClientOption();
        option.setIsNeedAddress(true);
        locationClient.setLocOption(option);
        locationClient.start();
    &#125;


    private void queryChoosedCountyList()&#123;
        countyListDB = DataSupport.findAll(ChoosedCounty.class);
        for (ChoosedCounty county:countyListDB)&#123;
            countyList.add(county.getCountyName());
        &#125;
    &#125;


&#125;
</code></pre>
<p>ChooseAreaActivityå’ŒChooseAreaFragmentï¼Œç”¨æ¥æ–°å¢åŸå¸‚</p>
<pre><code>package com.coolweather.android;

import androidx.annotation.Nullable;
import androidx.appcompat.app.AppCompatActivity;

import android.os.Bundle;


public class ChooseAreaActivity extends AppCompatActivity &#123;
    @Override
    protected void onCreate(@Nullable Bundle savedInstanceState) &#123;
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_choose_area);
    &#125;

&#125;
</code></pre>
<ul>
<li></li>
</ul>
<pre><code>package com.coolweather.android;

import android.app.ProgressDialog;
import android.content.Intent;
import android.content.SharedPreferences;
import android.os.Bundle;
import android.preference.PreferenceManager;
import android.view.LayoutInflater;
import android.view.View;
import android.view.ViewGroup;
import android.widget.AdapterView;
import android.widget.ArrayAdapter;
import android.widget.Button;
import android.widget.ListView;
import android.widget.TextView;
import android.widget.Toast;

import androidx.annotation.NonNull;
import androidx.annotation.Nullable;
import androidx.fragment.app.Fragment;

import com.coolweather.android.db.City;
import com.coolweather.android.db.County;
import com.coolweather.android.db.Province;
import com.coolweather.android.util.HttpUtil;
import com.coolweather.android.util.Utility;

import org.litepal.crud.DataSupport;

import java.io.IOException;
import java.util.ArrayList;
import java.util.List;

import okhttp3.Call;
import okhttp3.Callback;
import okhttp3.Response;

public class ChooseAreaFragment extends Fragment &#123;

    private SharedPreferences prefs;
    public static final int LEVEL_PROVINCE = 0;
    public static final int LEVEL_CITY = 1;
    public static final int LEVEL_COUNTY = 2;
    private ProgressDialog progressDialog;
    private TextView titleText;
    private Button backButton;
    private ListView listView;
    private ArrayAdapter&lt;String&gt; adapter;
    private List&lt;String&gt; dataList = new ArrayList&lt;&gt;();
    /**
     * çœåˆ—è¡¨
     */
    private List&lt;Province&gt; provinceList;
    /**
     * å¸‚åˆ—è¡¨
     */
    private List&lt;City&gt; cityList;
    /**
     * å¿åˆ—è¡¨
     */
    private List&lt;County&gt; countyList;

    /**
     * é€‰ä¸­çš„çœä»½
    */
    private Province selectedProvince;
    /**
     * é€‰ä¸­çš„åŸå¸‚
     */
    private City selectedCity;
    /**
     * å½“å‰é€‰ä¸­çš„çº§åˆ«
     */
    private int currentLevel;

    @Nullable
    @Override
    public View onCreateView(@NonNull LayoutInflater inflater, @Nullable ViewGroup container, @Nullable Bundle savedInstanceState) &#123;
        prefs = PreferenceManager.getDefaultSharedPreferences(getContext());
        View view = inflater.inflate(R.layout.choose_area, container, false);
        titleText = (TextView)view.findViewById(R.id.title_text);
        backButton = (Button) view.findViewById(R.id.back_button);
        listView = (ListView) view.findViewById(R.id.list_view);

        adapter = new ArrayAdapter&lt;&gt;(getContext(), android.R.layout.simple_list_item_1, dataList);
        listView.setAdapter(adapter);
        return view;
    &#125;

    @Override
    public void onActivityCreated(@Nullable Bundle savedInstanceState) &#123;
        super.onActivityCreated(savedInstanceState);
        listView.setOnItemClickListener(new AdapterView.OnItemClickListener() &#123;
            @Override
            public void onItemClick(AdapterView&lt;?&gt; parent, View view, int position, long id) &#123;
                if (currentLevel == LEVEL_PROVINCE)&#123;
                    selectedProvince = provinceList.get(position);
                    queryCities();
                &#125;else if (currentLevel == LEVEL_CITY)&#123;
                    selectedCity = cityList.get(position);
                    queryCounties();
                &#125;else if (currentLevel== LEVEL_COUNTY)&#123;
                    String countyName = countyList.get(position).getCountyName();
                    Intent intent = new Intent(getActivity(), WeatherActivity.class);
                    //ä¿å­˜æ·»åŠ çš„åŸå¸‚
                    Utility.saveChoosedCounty(countyName);
                    SharedPreferences.Editor edit = prefs.edit();
                    edit.putString(&quot;curCounty&quot;, countyName);
                    edit.apply();
                    startActivity(intent);
                    getActivity().finish();

                &#125;
            &#125;
        &#125;);

        backButton.setOnClickListener(new View.OnClickListener() &#123;
            @Override
            public void onClick(View v) &#123;
                if (currentLevel == LEVEL_COUNTY) &#123;
                    queryCities();
                &#125; else if (currentLevel == LEVEL_CITY) &#123;
                    queryProvinces();
                &#125;else if(currentLevel == LEVEL_PROVINCE)&#123;
                    Intent intent = new Intent(getActivity(), CountyChoosedActivity.class);
                    startActivity(intent);
                    getActivity().finish();
                &#125;
            &#125;
        &#125;);
        //åˆå§‹åŒ–çœä»½æ•°æ®
        queryProvinces();
    &#125;

    /**
     * æŸ¥è¯¢å…¨å›½æ‰€æœ‰çš„çœï¼Œ ä¼˜å…ˆä»æ•°æ®åº“æŸ¥è¯¢ï¼Œ å¦‚æœæ²¡æœ‰æŸ¥è¯¢åˆ°å†å»æœåŠ¡å™¨ä¸ŠæŸ¥è¯¢
    */
    private void queryProvinces() &#123;
        titleText.setText(&quot;ä¸­å›½&quot;);
        backButton.setVisibility(View.VISIBLE);
        provinceList = DataSupport.findAll(Province.class);
        if (provinceList.size() &gt; 0) &#123;
            dataList.clear();
            for (Province province : provinceList) &#123;
                dataList.add(province.getProvinceName());
            &#125;
            adapter.notifyDataSetChanged();
            listView.setSelection(0);
            currentLevel = LEVEL_PROVINCE;
        &#125; else &#123;
            String address = &quot;http://guolin.tech/api/china&quot;;
            queryFromServer(address, &quot;province&quot;);
        &#125;
    &#125;

    /**
     * æŸ¥è¯¢é€‰ä¸­çœå†…æ‰€æœ‰çš„å¸‚ï¼Œ ä¼˜å…ˆä»æ•°æ®åº“æŸ¥è¯¢ï¼Œ å¦‚æœæ²¡æœ‰æŸ¥è¯¢åˆ°å†å»æœåŠ¡å™¨ä¸ŠæŸ¥è¯¢
    */
    private void queryCities() &#123;
        titleText.setText(selectedProvince.getProvinceName());backButton.setVisibility(View.VISIBLE);
        cityList = DataSupport.where(&quot;provinceid = ?&quot;,
                String.valueOf(selectedProvince.getId())).find(City.class);
        if (cityList.size() &gt; 0) &#123;
            dataList.clear();
            for (City city : cityList) &#123;
                dataList.add(city.getCityName());
            &#125;
            adapter.notifyDataSetChanged();
            listView.setSelection(0);
            currentLevel = LEVEL_CITY;
        &#125; else &#123;
            int provinceCode = selectedProvince.getProvinceCode();
            String address = &quot;http://guolin.tech/api/china/&quot; + provinceCode;
            queryFromServer(address, &quot;city&quot;);
        &#125;
    &#125;

    /**
     * æŸ¥è¯¢é€‰ä¸­å¸‚å†…æ‰€æœ‰çš„å¿ï¼Œ ä¼˜å…ˆä»æ•°æ®åº“æŸ¥è¯¢ï¼Œ å¦‚æœæ²¡æœ‰æŸ¥è¯¢åˆ°å†å»æœåŠ¡å™¨ä¸ŠæŸ¥è¯¢
    */
    private void queryCounties() &#123;
        titleText.setText(selectedCity.getCityName());
        backButton.setVisibility(View.VISIBLE);
        countyList = DataSupport.where(&quot;cityid = ?&quot;,
                String.valueOf(selectedCity.
                getId())).find(County.class);
        if (countyList.size() &gt; 0) &#123;
            dataList.clear();
            for (County county : countyList) &#123;
                dataList.add(county.getCountyName());
            &#125;
            adapter.notifyDataSetChanged();
            listView.setSelection(0);
            currentLevel = LEVEL_COUNTY;
        &#125; else &#123;
            int provinceCode = selectedProvince.getProvinceCode();
            int cityCode = selectedCity.getCityCode();
            String address = &quot;http://guolin.tech/api/china/&quot; + provinceCode + &quot;/&quot; +
                    cityCode;
            queryFromServer(address, &quot;county&quot;);
        &#125;
    &#125;

    /**
     * æ ¹æ®ä¼ å…¥çš„åœ°å€å’Œç±»å‹ä»æœåŠ¡å™¨ä¸ŠæŸ¥è¯¢çœå¸‚å¿æ•°æ®
    */
    private void queryFromServer(String address, final String type) &#123;
        showProgressDialog();
        HttpUtil.sendOkHttpRequest(address, new Callback() &#123;
            @Override
            public void onResponse(Call call, Response response) throws IOException &#123;
                String responseText = response.body().string();
                boolean result = false;
                if (&quot;province&quot;.equals(type)) &#123;
                    result = Utility.handleProvinceResponse(responseText);
                &#125; else if (&quot;city&quot;.equals(type)) &#123;
                    result = Utility.handleCityResponse(responseText,
                            selectedProvince.getId());
                &#125; else if (&quot;county&quot;.equals(type)) &#123;
                    result = Utility.handleCountyResponse(responseText,
                            selectedCity.getId());
                &#125;
                if (result) &#123;
                    getActivity().runOnUiThread(new Runnable() &#123;@Override
                    public void run() &#123;
                        closeProgressDialog();
                        if (&quot;province&quot;.equals(type)) &#123;
                            queryProvinces();
                        &#125; else if (&quot;city&quot;.equals(type)) &#123;
                            queryCities();
                        &#125; else if (&quot;county&quot;.equals(type)) &#123;
                            queryCounties();
                        &#125;
                    &#125;
                    &#125;);
                &#125;
            &#125;

            @Override
            public void onFailure(Call call, IOException e) &#123;
            // é€šè¿‡runOnUiThread()æ–¹æ³•å›åˆ°ä¸»çº¿ç¨‹å¤„ç†é€»è¾‘
                getActivity().runOnUiThread(new Runnable() &#123;
                    @Override
                    public void run() &#123;
                        closeProgressDialog();
                        Toast.makeText(getContext(), &quot;åŠ è½½å¤±è´¥&quot;, Toast.LENGTH_SHORT).
                                show();
                    &#125;
                &#125;);
            &#125;
        &#125;);
    &#125;

    /**
     * æ˜¾ç¤ºè¿›åº¦å¯¹è¯æ¡†
    */
    private void showProgressDialog() &#123;
        if (progressDialog == null) &#123;
            progressDialog = new ProgressDialog(getActivity());
            progressDialog.setMessage(&quot;æ­£åœ¨åŠ è½½...&quot;);
            progressDialog.setCanceledOnTouchOutside(false);
        &#125;
        progressDialog.show();
    &#125;
    /**
     * å…³é—­è¿›åº¦å¯¹è¯æ¡†
    */
    private void closeProgressDialog() &#123;
        if (progressDialog != null) &#123;
            progressDialog.dismiss();
        &#125;
    &#125;
&#125;
</code></pre>
<p>AutoUpdateServiceåå°æœåŠ¡ï¼Œç”¨æ¥è‡ªåŠ¨æ›´æ–°å¤©æ°”</p>
<pre><code>package com.coolweather.android;

import android.app.AlarmManager;
import android.app.PendingIntent;
import android.app.Service;
import android.content.Intent;
import android.content.SharedPreferences;
import android.os.IBinder;
import android.os.SystemClock;
import android.preference.PreferenceManager;

import com.bumptech.glide.Glide;
import com.coolweather.android.db.ChoosedCounty;
import com.coolweather.android.gson.Weather;
import com.coolweather.android.util.BDLocationUtil;
import com.coolweather.android.util.HttpUtil;
import com.coolweather.android.util.Utility;

import org.litepal.crud.DataSupport;

import java.io.IOException;
import java.util.List;

import okhttp3.Call;
import okhttp3.Callback;
import okhttp3.Response;

public class AutoUpdateService extends Service &#123;
    public AutoUpdateService() &#123;
    &#125;

    @Override
    public IBinder onBind(Intent intent) &#123;
        return null;
    &#125;

    @Override
    public int onStartCommand(Intent intent, int flags, int startId) &#123;
        updateBingPic();
        //æ›´æ–°å¤©æ°”
        String districtLocation = BDLocationUtil.getLocationDistrict(getApplicationContext());
        updateWeather(districtLocation);
        List&lt;ChoosedCounty&gt; list = DataSupport.findAll(ChoosedCounty.class);
        for(ChoosedCounty county:list)&#123;
            updateWeather(county.getCountyName());
        &#125;

        AlarmManager manager = (AlarmManager) getSystemService(ALARM_SERVICE);
        int time = 8 * 60 * 60 * 1000;
        long triggerTime = SystemClock.elapsedRealtime()+time;
        Intent intentA = new Intent(this, AutoUpdateService.class);
        PendingIntent pendingIntent = PendingIntent.getService(this, 0, intentA, 0);
        manager.cancel(pendingIntent);
        manager.set(AlarmManager.ELAPSED_REALTIME_WAKEUP, triggerTime, pendingIntent);
        return super.onStartCommand(intent, flags, startId);
    &#125;

    private void updateWeather(final String name)&#123;
        SharedPreferences pref = PreferenceManager.getDefaultSharedPreferences(this);
        //å’Œé£å¤©æ°”
        String weatherUrl =  &quot;https://free-api.heweather.net/s6/weather/?location=&quot;
                +name+&quot;&amp;key=è‡ªå·±çš„key&quot;;
        HttpUtil.sendOkHttpRequest(weatherUrl, new Callback() &#123;
            @Override
            public void onFailure(Call call, IOException e) &#123;
                e.printStackTrace();
            &#125;

            @Override
            public void onResponse(Call call, Response response) throws IOException &#123;
                String reponseText = response.body().string();
                Weather weather = Utility.handleWeatherResponse(reponseText);
                if (weather!=null  &amp;&amp; &quot;ok&quot;.equals(weather.status))&#123;
                    SharedPreferences.Editor edit = PreferenceManager.
                            getDefaultSharedPreferences(AutoUpdateService.this).edit();
                    edit.putString(name, reponseText);
                    edit.apply();
                &#125;
            &#125;
        &#125;);
    &#125;

    private void updateBingPic()&#123;
        String requestBingPicUrl = &quot;http://guolin.tech/api/bing_pic&quot;;
        HttpUtil.sendOkHttpRequest(requestBingPicUrl, new Callback() &#123;
            @Override
            public void onFailure(Call call, IOException e) &#123;
                e.printStackTrace();
            &#125;

            @Override
            public void onResponse(Call call, Response response) throws IOException &#123;
                final String pic = response.body().string();
                SharedPreferences.Editor edit = PreferenceManager.getDefaultSharedPreferences(AutoUpdateService.this).edit();
                edit.putString(&quot;bing_pic&quot;, pic);
                edit.apply();
            &#125;
        &#125;);
    &#125;
&#125;
</code></pre>
<p>Utilityå’ŒHttpUtilå·¥å…·ç±»</p>
<pre><code>package com.coolweather.android.util;

import android.text.TextUtils;
import com.coolweather.android.db.ChoosedCounty;
import com.coolweather.android.db.City;
import com.coolweather.android.db.County;
import com.coolweather.android.db.Province;
import com.coolweather.android.gson.Weather;
import com.google.gson.Gson;

import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;
import org.litepal.crud.DataSupport;

import java.util.HashMap;
import java.util.List;
import java.util.Map;

public class Utility &#123;

    /**
     * è§£æå¤„ç†æœåŠ¡å™¨è¿”å›çš„çœçº§æ•°æ®
     */
    public static boolean handleProvinceResponse(String response)&#123;
        if (!TextUtils.isEmpty(response))&#123;
            try&#123;
                JSONArray allProvinces = new JSONArray(response);
                for (int i = 0; i &lt; allProvinces.length(); i++) &#123;
                    JSONObject provinceObject = allProvinces.getJSONObject(i);
                    Province province = new Province();
                    province.setProvinceName(provinceObject.getString(&quot;name&quot;));
                    province.setProvinceCode(provinceObject.getInt(&quot;id&quot;));
                    province.save();
                &#125;
                return true;
            &#125; catch (JSONException e) &#123;
                e.printStackTrace();
            &#125;

        &#125;
        return false;
    &#125;

    /**
     * è§£æå¤„ç†æœåŠ¡å™¨è¿”å›çš„å¸‚jiæ•°æ®
     * @param response
     * @param provinceId
     * @return
     */
    public static boolean handleCityResponse(String response, int provinceId)&#123;
        if (!TextUtils.isEmpty(response)) &#123;
            try &#123;
                JSONArray allCities = new JSONArray(response);
                for (int i = 0; i &lt; allCities.length(); i++) &#123;
                    JSONObject cityObject = allCities.getJSONObject(i);
                    City city = new City();
                    city.setCityName(cityObject.getString(&quot;name&quot;));
                    city.setCityCode(cityObject.getInt(&quot;id&quot;));
                    city.setProvinceId(provinceId);
                    city.save();
                &#125;
                return true;
            &#125; catch (JSONException e) &#123;
                e.printStackTrace();
            &#125;
        &#125;
        return false;
    &#125;

    /**
     * è§£æå’Œå¤„ç†æœåŠ¡å™¨è¿”å›çš„å¿çº§æ•°æ®
    */
    public static boolean handleCountyResponse(String response, int cityId) &#123;
        if (!TextUtils.isEmpty(response)) &#123;
            try &#123;
                JSONArray allCounties = new JSONArray(response);
                for (int i = 0; i &lt; allCounties.length(); i++) &#123;
                    JSONObject countyObject = allCounties.getJSONObject(i);
                    County county = new County();
                    county.setCountyName(countyObject.getString(&quot;name&quot;));
                    county.setWeatherId(countyObject.getString(&quot;weather_id&quot;));
                    county.setCityId(cityId);
                    county.save();
                &#125;
                return true;
            &#125; catch (JSONException e) &#123;
                e.printStackTrace();
            &#125;
        &#125;
        return false;
    &#125;

    public static Weather handleWeatherResponse(String response)&#123;
        try &#123;
            JSONObject jsonObject = new JSONObject(response);
            JSONArray jsonArray = jsonObject.getJSONArray(&quot;HeWeather6&quot;);
            String weatherContent = jsonArray.getJSONObject(0).toString();
            return new Gson().fromJson(weatherContent, Weather.class);
        &#125; catch (Exception e) &#123;
            e.printStackTrace();
        &#125;
        return null;
    &#125;

    private static final Map&lt;String, String&gt; myMap;
    static
    &#123;
        myMap = new HashMap&lt;String, String&gt;();
        myMap.put(&quot;comf&quot;,&quot;èˆ’é€‚åº¦æŒ‡æ•°&quot;);
        myMap.put(&quot;cw&quot;,&quot;æ´—è½¦æŒ‡æ•°&quot;);
        myMap.put(&quot;drsg&quot;,&quot;ç©¿è¡£æŒ‡æ•°&quot;);
        myMap.put(&quot;flu&quot;,&quot;æ„Ÿå†’æŒ‡æ•°&quot;);
        myMap.put(&quot;ptfc&quot;,&quot;äº¤é€šæŒ‡æ•°&quot;);
        myMap.put(&quot;trav&quot;,&quot;æ—…æ¸¸æŒ‡æ•°&quot;);
        myMap.put(&quot;sport&quot;,&quot;è¿åŠ¨æŒ‡æ•°&quot;);
        myMap.put(&quot;uv&quot;,&quot;ç´«å¤–çº¿æŒ‡æ•°&quot;);
        myMap.put(&quot;air&quot;,&quot;ç©ºæ°”æ±¡æŸ“æ‰©æ•£æ¡ä»¶æŒ‡æ•°&quot;);
        myMap.put(&quot;ac&quot;,&quot;ç©ºè°ƒå¼€å¯æŒ‡æ•°&quot;);
        myMap.put(&quot;ag&quot;,&quot;è¿‡æ•æŒ‡æ•°&quot;);
        myMap.put(&quot;gl&quot;,&quot;å¤ªé˜³é•œæŒ‡æ•°&quot;);
        myMap.put(&quot;mu&quot;,&quot;åŒ–å¦†æŒ‡æ•°&quot;);
        myMap.put(&quot;airc&quot;,&quot;æ™¾æ™’æŒ‡æ•°&quot;);
        myMap.put(&quot;fsh&quot;,&quot;é’“é±¼æŒ‡æ•°&quot;);
        myMap.put(&quot;spi&quot;,&quot;é˜²æ™’æŒ‡æ•°&quot;);
    &#125;

    public static String translate(String type)&#123;
        return myMap.get(type);
    &#125;


    public static void saveChoosedCounty(String countyName)&#123;
        //å»é‡
        List&lt;ChoosedCounty&gt; all = DataSupport.findAll(ChoosedCounty.class);
        for (ChoosedCounty county: all)&#123;
            if (countyName.equals(county.getCountyName()))&#123;
                return;
            &#125;
        &#125;
        ChoosedCounty county = new ChoosedCounty(countyName);
        county.save();
    &#125;

&#125;

package com.coolweather.android.util;

import okhttp3.OkHttpClient;
import okhttp3.Request;

public class HttpUtil &#123;

    public static void sendOkHttpRequest(String address, okhttp3.Callback callback)&#123;
        OkHttpClient client = new OkHttpClient();
        Request request = new Request.Builder().url(address).build();
        client.newCall(request).enqueue(callback);
    &#125;
&#125;
</code></pre>
<p><em><a href="https://github.com/BARKTEGH/CoolWeather" title="Githubåœ°å€">é¡¹ç›®çš„githubåœ°å€</a></em></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/02/InnoDB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/image.png">
      <meta itemprop="name" content="ä¸‰åè€Œç«‹">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ä¸‰åè€Œç«‹çš„åšå®¢">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ä¸‰åè€Œç«‹çš„åšå®¢">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/08/02/InnoDB/" class="post-title-link" itemprop="url">InnoDBå­˜å‚¨å¼•æ“ï¼ˆä¸€ï¼‰- InnoDBä½“ç³»ç»“æ„</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2019-08-02 20:06:20" itemprop="dateCreated datePublished" datetime="2019-08-02T20:06:20+08:00">2019-08-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-09-21 23:32:32" itemprop="dateModified" datetime="2025-09-21T23:32:32+08:00">2025-09-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>114</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>1 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="InnoDBä½“ç³»ç»“æ„"><a href="#InnoDBä½“ç³»ç»“æ„" class="headerlink" title="InnoDBä½“ç³»ç»“æ„"></a>InnoDBä½“ç³»ç»“æ„</h3><p><img src="https://i.imgur.com/uMvsQ0Z.png"></p>
<h3 id="åå°çº¿ç¨‹"><a href="#åå°çº¿ç¨‹" class="headerlink" title="åå°çº¿ç¨‹"></a>åå°çº¿ç¨‹</h3><h3 id="å†…å­˜"><a href="#å†…å­˜" class="headerlink" title="å†…å­˜"></a>å†…å­˜</h3><h2 id="InnoDBå…³é”®ç‰¹æ€§"><a href="#InnoDBå…³é”®ç‰¹æ€§" class="headerlink" title="InnoDBå…³é”®ç‰¹æ€§"></a>InnoDBå…³é”®ç‰¹æ€§</h2><p>InnoDBå­˜å‚¨å¼•æ“å…³é”®ç‰¹æ€§ï¼š</p>
<ul>
<li>æ’å…¥ç¼“å†²</li>
<li>ä¸¤æ¬¡å†™</li>
<li>è‡ªé€‚åº”å“ˆå¸Œç´¢å¼•</li>
<li>å¼‚æ­¥IO</li>
<li>åˆ·æ–°é‚»æ¥é¡µ</li>
</ul>
<h3 id="æ’å…¥ç¼“å†²"><a href="#æ’å…¥ç¼“å†²" class="headerlink" title="æ’å…¥ç¼“å†²"></a>æ’å…¥ç¼“å†²</h3><h4 id="Insert-Buffer"><a href="#Insert-Buffer" class="headerlink" title="Insert Buffer"></a>Insert Buffer</h4><h3 id="ä¸¤æ¬¡å†™"><a href="#ä¸¤æ¬¡å†™" class="headerlink" title="ä¸¤æ¬¡å†™"></a>ä¸¤æ¬¡å†™</h3><p><img src="https://i.imgur.com/LpnbgZh.png"></p>
<p>doublewriteç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼Œä¸€éƒ¨åˆ†æ˜¯å†…å­˜ä¸­çš„doublewrite bufferï¼Œå¤§å°ä¸º2MBï¼Œå¦ä¸€éƒ¨åˆ†æ˜¯ç‰©ç†ç£ç›˜ä¸Šå…±äº«è¡¨ç©ºé—´ä¸­è¿ç»­128ä¸ªé¡µï¼Œå¤§å°åŒæ ·ä¸º2MBã€‚</p>
<blockquote>
<p>MysqlæŠ€æœ¯å†…å¹•ï¼ˆInnoDBå­˜å‚¨å¼•æ“ï¼‰</p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/02/mysql%E9%94%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/image.png">
      <meta itemprop="name" content="ä¸‰åè€Œç«‹">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ä¸‰åè€Œç«‹çš„åšå®¢">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ä¸‰åè€Œç«‹çš„åšå®¢">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/08/02/mysql%E9%94%81/" class="post-title-link" itemprop="url">InnoDBå­˜å‚¨å¼•æ“ï¼ˆäºŒï¼‰--InnoDBå­˜å‚¨å¼•æ“ä¸­çš„é”</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2019-08-02 20:06:20" itemprop="dateCreated datePublished" datetime="2019-08-02T20:06:20+08:00">2019-08-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-09-21 23:32:32" itemprop="dateModified" datetime="2025-09-21T23:32:32+08:00">2025-09-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>2.7k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>10 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="é”çš„ç±»å‹"><a href="#é”çš„ç±»å‹" class="headerlink" title="é”çš„ç±»å‹"></a>é”çš„ç±»å‹</h2><p>InnoDBå­˜å‚¨å¼•æ“å®ç°äº†å¦‚ä¸‹ä¸¤ç§æ ‡å‡†çš„è¡Œçº§é”ï¼š</p>
<ul>
<li>å…±äº«é”(SLock),å…è®¸äº‹åŠ¡è¯»ä¸€è¡Œæ•°æ®ã€‚</li>
<li>æ’ä»–é”(XLock),å…è®¸äº‹åŠ¡åˆ é™¤æˆ–æ›´æ–°ä¸€è¡Œæ•°æ®ã€‚</li>
</ul>
<table>
<thead>
<tr>
<th align="center"></th>
<th align="center">X</th>
<th align="center">S</th>
</tr>
</thead>
<tbody><tr>
<td align="center">X</td>
<td align="center">ä¸å…¼å®¹</td>
<td align="center">ä¸å…¼å®¹</td>
</tr>
<tr>
<td align="center">S</td>
<td align="center">ä¸å…¼å®¹</td>
<td align="center">å…¼å®¹</td>
</tr>
</tbody></table>
<p>æ­¤å¤–ï¼ŒInnoDBå­˜å‚¨å¼•æ“æ”¯æŒå¤šç²’åº¦(granular)é”å®šï¼Œè¿™ç§é”å®šå…è®¸äº‹åŠ¡åœ¨è¡Œçº§ä¸Šçš„<br>é”å’Œè¡¨çº§ä¸Šçš„é”åŒæ—¶å­˜åœ¨ã€‚ä¸ºäº†æ”¯æŒåœ¨ä¸åŒç²’åº¦ä¸Šè¿›è¡ŒåŠ é”æ“ä½œï¼ŒInnoDBå­˜å‚¨å¼•æ“æ”¯æŒ<br>ä¸€ç§é¢å¤–çš„é”æ–¹å¼ï¼Œç§°ä¹‹ä¸ºæ„å‘é”(Intention Lock)ã€‚æ„å‘é”æ˜¯å°†é”å®šçš„å¯¹è±¡åˆ†ä¸ºå¤šä¸ªå±‚<br>æ¬¡ï¼Œæ„å‘é”æ„å‘³ç€äº‹åŠ¡å¸Œæœ›åœ¨æ›´ç»†ç²’åº¦(fine granularity)ä¸Šè¿›è¡ŒåŠ é”ã€‚</p>
<p><img src="https://i.imgur.com/nj2uACp.png"></p>
<h2 id="ä¸€è‡´æ€§éé”å®šè¯»"><a href="#ä¸€è‡´æ€§éé”å®šè¯»" class="headerlink" title="ä¸€è‡´æ€§éé”å®šè¯»"></a>ä¸€è‡´æ€§éé”å®šè¯»</h2><p>è‡´æ€§çš„éé”å®šè¯»(consistent nonlocking read)æ˜¯æŒ‡InnoDBå­˜å‚¨å¼•ç¹é€šè¿‡è¡Œå¤šç‰ˆæœ¬æ§åˆ¶(multi versioning)çš„æ–¹å¼æ¥è¯»å–å½“å‰æ‰§è¡Œæ—¶é—´æ•°æ®åº“ä¸­è¡Œçš„æ•°æ®ã€‚å¦‚æœè¯»å–çš„è¡Œæ­£åœ¨æ‰§è¡ŒDELETEæˆ–UPDATEæ“ä½œï¼Œè¿™æ—¶è¯»å–æ“ä½œä¸ä¼šå› æ­¤å»ç­‰å¾…è¡Œä¸Šé”çš„é‡Šæ”¾ã€‚ç›¸ååœ°ï¼ŒInnoDBå­˜å‚¨å¼•æ“ä¼šå»è¯»å–è¡Œçš„ä¸€ä¸ªå¿«ç…§æ•°æ®ã€‚</p>
<p>å¿«ç…§æ•°æ®æ˜¯æŒ‡è¯¥è¡Œçš„ä¹‹å‰ç‰ˆæœ¬çš„æ•°æ®ï¼Œè¯¥å®ç°æ˜¯é€šè¿‡undoæ®µæ¥å®Œæˆã€‚è€Œundoç”¨æ¥åœ¨äº‹åŠ¡ä¸­å›æ»šæ•°æ®ï¼Œå› æ­¤å¿«ç…§æ•°æ®æœ¬èº«æ˜¯æ²¡æœ‰é¢å¤–çš„å¼€é”€ã€‚æ­¤å¤–ï¼Œè¯»å–å¿«ç…§æ•°æ®æ˜¯ä¸è¦ä¸Šé”çš„ï¼Œå› ä¸ºæ²¡æœ‰äº‹åŠ¡éœ€è¦å¯¹å†å²çš„æ•°æ®è¿›è¡Œä¿®æ”¹æ“ä½œã€‚å¯ä»¥çœ‹åˆ°ï¼Œéé”å®šè¯»æœºåˆ¶æå¤§åœ°æé«™äº†æ•°æ®åº“çš„å¹¶å‘æ€§ã€‚<strong>åœ¨InnoDBå­˜å‚¨å¼•æ“çš„é»˜è®¤è®¾ç½®ä¸‹ï¼Œè¿™æ˜¯é»˜è®¤çš„è¯»å–æ–¹å¼ï¼Œå³è¯»å–ä¸ä¼šå ç”¨å’Œç­‰å¾…è¡¨ä¸Šçš„é”ã€‚</strong></p>
<p>ä½†æ˜¯åœ¨ä¸åŒäº‹åŠ¡éš”ç¦»çº§åˆ«ä¸‹ï¼Œè¯»å–çš„æ–¹å¼ä¸åŒï¼Œå¹¶ä¸æ˜¯åœ¨æ¯ä¸ªäº‹åŠ¡éš”ç¦»çº§åˆ«ä¸‹éƒ½æ˜¯é‡‡ç”¨éé”å®šçš„ä¸€è‡´æ€§è¯»ã€‚åœ¨äº‹åŠ¡éš”ç¦»çº§åˆ«READ COMMITTEDå’ŒREPEATABLE READ (InnoDBå­˜å‚¨å¼•æ“çš„é»˜è®¤äº‹åŠ¡éš”ç¦»çº§åˆ¥)ä¸‹ï¼ŒInnoDBå­˜å‚¨å¼•æ“ä½¿ç”¨éé”å®šçš„ä¸€è‡´æ€§è¯»ã€‚ç„¶è€Œï¼Œå¯¹äºå¿«ç…§æ•°æ®çš„å®šä¹‰å´ä¸ç›¸åŒã€‚åœ¨READ COMMITTEDäº‹åŠ¡éš”ç¦»çº§åˆ«ä¸‹ï¼Œå¯¹äºå¿«ç…§æ•°æ®ï¼Œéä¸€è‡´æ€§è¯»æ€»æ˜¯è¯»å–è¢«é”å®šè¡Œçš„æœ€æ–°ä¸€ä»½å¿«ç…§æ•°æ®ã€‚è€Œåœ¨REPEATABLE READäº‹åŠ¡éš”ç¦»çº§åˆ«<br>ä¸‹ï¼Œå¯¹äºå¿«ç…§æ•°æ®ï¼Œéä¸€è‡´æ€§è¯»æ€»æ˜¯è¯»å–äº‹åŠ¡å¼€å§‹æ—¶çš„è¡Œæ•°æ®ç‰ˆæœ¬ã€‚</p>
<h3 id="MVCCçš„å®ç°è¿‡ç¨‹"><a href="#MVCCçš„å®ç°è¿‡ç¨‹" class="headerlink" title="MVCCçš„å®ç°è¿‡ç¨‹"></a>MVCCçš„å®ç°è¿‡ç¨‹</h3><p><strong>ç‰ˆæœ¬å·</strong></p>
<p>ç³»ç»Ÿç‰ˆæœ¬å·ï¼šæ˜¯ä¸€ä¸ªé€’å¢çš„æ•°å­—ï¼Œæ¯å¼€å§‹ä¸€ä¸ªæ–°çš„äº‹åŠ¡ï¼Œç³»ç»Ÿç‰ˆæœ¬å·å°±ä¼šè‡ªåŠ¨é€’å¢ã€‚</p>
<p>äº‹åŠ¡ç‰ˆæœ¬å·ï¼šäº‹åŠ¡å¼€å§‹æ—¶çš„ç³»ç»Ÿç‰ˆæœ¬å·ã€‚</p>
<p><strong>éšè—çš„åˆ—</strong></p>
<p>MVCC åœ¨æ¯è¡Œè®°å½•åé¢éƒ½ä¿å­˜ç€ä¸¤ä¸ªéšè—çš„åˆ—ï¼Œç”¨æ¥å­˜å‚¨ä¸¤ä¸ªç‰ˆæœ¬å·ï¼š</p>
<p>åˆ›å»ºç‰ˆæœ¬å·ï¼šæŒ‡ç¤ºåˆ›å»ºä¸€ä¸ªæ•°æ®è¡Œçš„å¿«ç…§æ—¶çš„ç³»ç»Ÿç‰ˆæœ¬å·ï¼›</p>
<p>åˆ é™¤ç‰ˆæœ¬å·ï¼šå¦‚æœè¯¥å¿«ç…§çš„åˆ é™¤ç‰ˆæœ¬å·å¤§äºå½“å‰äº‹åŠ¡ç‰ˆæœ¬å·è¡¨ç¤ºè¯¥å¿«ç…§æœ‰æ•ˆï¼Œå¦åˆ™è¡¨ç¤ºè¯¥å¿«ç…§å·²ç»è¢«åˆ é™¤äº†ã€‚</p>
<p>ä»¥ä¸‹å®ç°è¿‡ç¨‹é’ˆå¯¹å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ã€‚</p>
<p>å½“å¼€å§‹ä¸€ä¸ªäº‹åŠ¡æ—¶ï¼Œè¯¥äº‹åŠ¡çš„ç‰ˆæœ¬å·è‚¯å®šå¤§äºå½“å‰æ‰€æœ‰æ•°æ®è¡Œå¿«ç…§çš„åˆ›å»ºç‰ˆæœ¬å·ï¼Œç†è§£è¿™ä¸€ç‚¹å¾ˆå…³é”®ã€‚æ•°æ®è¡Œå¿«ç…§çš„åˆ›å»ºç‰ˆæœ¬å·æ˜¯åˆ›å»ºæ•°æ®è¡Œå¿«ç…§æ—¶çš„ç³»ç»Ÿç‰ˆæœ¬å·ï¼Œç³»ç»Ÿç‰ˆæœ¬å·éšç€åˆ›å»ºäº‹åŠ¡è€Œé€’å¢ï¼Œå› æ­¤æ–°åˆ›å»ºä¸€ä¸ªäº‹åŠ¡æ—¶ï¼Œè¿™ä¸ªäº‹åŠ¡çš„ç³»ç»Ÿç‰ˆæœ¬å·æ¯”ä¹‹å‰çš„ç³»ç»Ÿç‰ˆæœ¬å·éƒ½å¤§ï¼Œä¹Ÿå°±æ˜¯æ¯”æ‰€æœ‰æ•°æ®è¡Œå¿«ç…§çš„åˆ›å»ºç‰ˆæœ¬å·éƒ½å¤§ã€‚</p>
<ol>
<li>SELECT</li>
</ol>
<p>å¤šä¸ªäº‹åŠ¡å¿…é¡»è¯»å–åˆ°åŒä¸€ä¸ªæ•°æ®è¡Œçš„å¿«ç…§ï¼Œå¹¶ä¸”è¿™ä¸ªå¿«ç…§æ˜¯è·ç¦»ç°åœ¨æœ€è¿‘çš„ä¸€ä¸ªæœ‰æ•ˆå¿«ç…§ã€‚ä½†æ˜¯ä¹Ÿæœ‰ä¾‹å¤–ï¼Œå¦‚æœæœ‰ä¸€ä¸ªäº‹åŠ¡æ­£åœ¨ä¿®æ”¹è¯¥æ•°æ®è¡Œï¼Œé‚£ä¹ˆå®ƒå¯ä»¥è¯»å–äº‹åŠ¡æœ¬èº«æ‰€åšçš„ä¿®æ”¹ï¼Œè€Œä¸ç”¨å’Œå…¶å®ƒäº‹åŠ¡çš„è¯»å–ç»“æœä¸€è‡´ã€‚</p>
<p>æŠŠæ²¡æœ‰å¯¹ä¸€ä¸ªæ•°æ®è¡Œåšä¿®æ”¹çš„äº‹åŠ¡ç§°ä¸º Tï¼ŒT æ‰€è¦è¯»å–çš„æ•°æ®è¡Œå¿«ç…§çš„åˆ›å»ºç‰ˆæœ¬å·å¿…é¡»å°äºç­‰äº T çš„ç‰ˆæœ¬å·ï¼Œå› ä¸ºå¦‚æœå¤§äº T çš„ç‰ˆæœ¬å·ï¼Œé‚£ä¹ˆè¡¨ç¤ºè¯¥æ•°æ®è¡Œå¿«ç…§æ˜¯å…¶å®ƒäº‹åŠ¡çš„æœ€æ–°ä¿®æ”¹ï¼Œå› æ­¤ä¸èƒ½å»è¯»å–å®ƒã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒT æ‰€è¦è¯»å–çš„æ•°æ®è¡Œå¿«ç…§çš„åˆ é™¤ç‰ˆæœ¬å·å¿…é¡»æ˜¯æœªå®šä¹‰æˆ–è€…å¤§äº T çš„ç‰ˆæœ¬å·ï¼Œå› ä¸ºå¦‚æœå°äºç­‰äº T çš„ç‰ˆæœ¬å·ï¼Œé‚£ä¹ˆè¡¨ç¤ºè¯¥æ•°æ®è¡Œå¿«ç…§æ˜¯å·²ç»è¢«åˆ é™¤çš„ï¼Œä¸åº”è¯¥å»è¯»å–å®ƒã€‚</p>
<ol start="2">
<li><p>INSERT<br>å°†å½“å‰ç³»ç»Ÿç‰ˆæœ¬å·ä½œä¸ºæ•°æ®è¡Œå¿«ç…§çš„åˆ›å»ºç‰ˆæœ¬å·ã€‚</p>
</li>
<li><p>DELETE<br>å°†å½“å‰ç³»ç»Ÿç‰ˆæœ¬å·ä½œä¸ºæ•°æ®è¡Œå¿«ç…§çš„åˆ é™¤ç‰ˆæœ¬å·ã€‚</p>
</li>
<li><p>UPDATE<br>å°†å½“å‰ç³»ç»Ÿç‰ˆæœ¬å·ä½œä¸ºæ›´æ–°å‰çš„æ•°æ®è¡Œå¿«ç…§çš„åˆ é™¤ç‰ˆæœ¬å·ï¼Œå¹¶å°†å½“å‰ç³»ç»Ÿç‰ˆæœ¬å·ä½œä¸ºæ›´æ–°åçš„æ•°æ®è¡Œå¿«ç…§çš„åˆ›å»ºç‰ˆæœ¬å·ã€‚å¯ä»¥ç†è§£ä¸ºå…ˆæ‰§è¡Œ DELETE åæ‰§è¡Œ INSERTã€‚</p>
</li>
</ol>
<h2 id="ä¸€è‡´æ€§é”å®šè¯»"><a href="#ä¸€è‡´æ€§é”å®šè¯»" class="headerlink" title="ä¸€è‡´æ€§é”å®šè¯»"></a>ä¸€è‡´æ€§é”å®šè¯»</h2><p>InnoDBå­˜å‚¨å¼•æ“å¯¹äºselectæ”¯æŒä¸¤ç§ä¸€è‡´æ€§çš„é”å®šè¯»(locking read)æ“ä½œï¼š</p>
<ul>
<li>SELECT â€” FOR UPDATE</li>
<li>SELECT â€” LOCK IN SHARE MODE</li>
</ul>
<p>SELECT-FOR UPDATEå¯¹è¯»å–çš„è¡Œè®°å½•åŠ ä¸€ä¸ªXé”ï¼Œå…¶ä»–äº‹åŠ¡ä¸èƒ½å¯¹å·²é”å®šçš„è¡ŒåŠ ä¸Šä»»ä½•é”ã€‚SELECT-LOCK IN SHARE MODEå¯¹è¯»å–çš„è¡Œè®°å½•åŠ ä¸€ä¸ªSé”ï¼Œå…¶ä»–äº‹åŠ¡å¯ä»¥å‘è¢«é”å®šçš„è¡ŒåŠ Sé”ï¼Œä½†æ˜¯å¦‚æœåŠ Xé”ï¼Œåˆ™ä¼šè¢«é˜»å¡ã€‚</p>
<h2 id="é”çš„ç®—æ³•"><a href="#é”çš„ç®—æ³•" class="headerlink" title="é”çš„ç®—æ³•"></a>é”çš„ç®—æ³•</h2><h3 id="è¡Œé”çš„ä¸‰ç§ç®—æ³•"><a href="#è¡Œé”çš„ä¸‰ç§ç®—æ³•" class="headerlink" title="è¡Œé”çš„ä¸‰ç§ç®—æ³•"></a>è¡Œé”çš„ä¸‰ç§ç®—æ³•</h3><p>InnoDBå­˜å‚¨å¼•æ“æœ‰3ç§è¡Œé”çš„ç®—æ³•ï¼Œå…¶åˆ†åˆ«æ˜¯:</p>
<ul>
<li>Record Lockï¼šå•ä¸ªè¡Œè®°å½•ä¸Šçš„é”</li>
<li>Gap Lockï¼šé—´éš™é”ï¼Œé”å®šä¸€ä¸ªèŒƒå›´ï¼Œä½†ä¸åŒ…å«è®°å½•æœ¬èº«</li>
<li>Next-Key Lock : Gap Lock+Record Lock,é”å®šä¸€ä¸ªèŒƒå›´ï¼Œå¹¶ä¸”é”å®šè®°å½•æœ¬èº«</li>
</ul>
<p>Record Lockæ€»æ˜¯ä¼šå»é”ä½ç´¢å¼•è®°å½•ï¼Œå¦‚æœInnoDBå­˜å‚¨å¼•æ“è¡¨åœ¨å»ºç«‹çš„æ—¶å€™æ²¡æœ‰è®¾ç½®ä»»ä½•ä¸€ä¸ªç´¢å¼•ï¼Œé‚£ä¹ˆè¿™æ—¶InnoDBå­˜å‚¨å¼•æ“ä¼šä½¿ç”¨<strong>éšå¼çš„ä¸»é”®</strong>æ¥è¿›è¡Œé”å®šã€‚Next-Key Lock æ˜¯ç»“åˆäº† Gap Lock å’Œ Record Lock çš„ä¸€ç§é”å®šç®—æ³•ï¼Œåœ¨ Next-Key Lockç®—æ³•ä¸‹ï¼ŒInnoDBå¯¹äºè¡Œçš„æŸ»è¯¢éƒ½æ˜¯é‡‡ç”¨è¿™ç§é”å®šç®—æ³•ã€‚</p>
<p>ä¾‹å¦‚ä¸€ä¸ªç´¢å¼•æœ‰10, 11ï¼Œ13å’Œ20è¿™å››ä¸ªå€¼ï¼Œé‚£ä¹ˆè¯¥ç´¢å¼•å¯èƒ½è¢«Next-Key Lockingçš„åŒºé—´ä¸ºï¼š</p>
<pre><code>(-00 ,10]
(10,11]
(11ï¼Œ 13]
(13, 20]
(20,+ ~)
</code></pre>
<p>å½“æŸ»è¯¢çš„ç´¢å¼•å«æœ‰å”¯ä¸€å±æ€§æ—¶ï¼ŒInnoDBå­˜å‚¨å¼•æ“ä¼šå¯¹Next-Key Lockè¿›è¡Œä¼˜åŒ–ï¼Œå°†å…¶é™çº§ä¸ºRecord Lock,å³ä»…é”ä½ç´¢å¼•æœ¬èº«ï¼Œè€Œä¸æ˜¯èŒƒå›´ã€‚ï¼ˆä»…é€‚ç”¨äºæŸ¥è¯¢çš„åˆ—æ˜¯å”¯ä¸€ç´¢å¼•çš„æƒ…å†µï¼‰</p>
<p>è‹¥å”¯ä¸€ç´¢å¼•ç”±å¤šä¸ªåˆ—ç»„æˆï¼Œè€ŒæŸ»è¯¢ä»…æ˜¯æŸ»æ‰¾å¤šä¸ªå”¯ä¸€ç´¢å¼•åˆ—ä¸­çš„å…¶ä¸­ä¸€ä¸ªï¼Œé‚£ä¹ˆæŸ»è¯¢å…¶å®æ˜¯rangeç±»å‹æŸ¥è¯¢ï¼Œè€Œä¸æ˜¯pointç±»å‹æŸ¥è¯¢ï¼Œæ•…InnoDBå­˜å‚¨å¼•æ“ä¾ç„¶ä½¿ç”¨Next-Key Lockè¿›è¡Œé”å®šã€‚</p>
<h3 id="å¹»è¯»é—®é¢˜"><a href="#å¹»è¯»é—®é¢˜" class="headerlink" title="å¹»è¯»é—®é¢˜"></a>å¹»è¯»é—®é¢˜</h3><p>Phantom Problemæ˜¯æŒ‡åœ¨åŒä¸€äº‹åŠ¡ä¸‹ï¼Œè¿ç»­æ‰§è¡Œä¸¤æ¬¡åŒæ ·çš„SQLè¯­å¥å¯èƒ½å¯¼è‡´ä¸åŒçš„ç»“æœï¼Œç¬¬äºŒæ¬¡çš„SQLè¯­å¥å¯èƒ½ä¼šè¿”å›ä¹‹å‰ä¸å­˜åœ¨çš„è¡Œã€‚</p>
<p>InnoDBå­˜å‚¨å¼•æ“é»˜è®¤çš„äº‹åŠ¡éš”ç¦»çº§åˆ«æ˜¯REPEATABLE READ,åœ¨è¯¥éš”ç¦»çº§åˆ«ä¸‹,å…¶é‡‡ç”¨Next-Key Lockingçš„æ–¹å¼æ¥åŠ é”ã€‚è€Œåœ¨äº‹åŠ¡éš”ç¦»çº§åˆ«READ COMMITTEDä¸‹,å…¶ä»…é‡‡ç”¨Record Lockã€‚</p>
<h2 id="äº‹åŠ¡å¹¶å‘ä¸€è‡´æ€§é—®é¢˜"><a href="#äº‹åŠ¡å¹¶å‘ä¸€è‡´æ€§é—®é¢˜" class="headerlink" title="äº‹åŠ¡å¹¶å‘ä¸€è‡´æ€§é—®é¢˜"></a>äº‹åŠ¡å¹¶å‘ä¸€è‡´æ€§é—®é¢˜</h2><h3 id="ä¸¢å¤±ä¿®æ”¹"><a href="#ä¸¢å¤±ä¿®æ”¹" class="headerlink" title="ä¸¢å¤±ä¿®æ”¹"></a>ä¸¢å¤±ä¿®æ”¹</h3><p>T1 å’Œ T2 ä¸¤ä¸ªäº‹åŠ¡éƒ½å¯¹ä¸€ä¸ªæ•°æ®è¿›è¡Œä¿®æ”¹ï¼ŒT1 å…ˆä¿®æ”¹ï¼ŒT2 éšåä¿®æ”¹ï¼ŒT2 çš„ä¿®æ”¹è¦†ç›–äº† T1 çš„ä¿®æ”¹ã€‚</p>
<p><img src="https://i.imgur.com/vooUmjt.png"></p>
<h3 id="è¯»è„æ•°æ®"><a href="#è¯»è„æ•°æ®" class="headerlink" title="è¯»è„æ•°æ®"></a>è¯»è„æ•°æ®</h3><p>T1 ä¿®æ”¹ä¸€ä¸ªæ•°æ®ï¼ŒT2 éšåè¯»å–è¿™ä¸ªæ•°æ®ã€‚å¦‚æœ T1 æ’¤é”€äº†è¿™æ¬¡ä¿®æ”¹ï¼Œé‚£ä¹ˆ T2 è¯»å–çš„æ•°æ®æ˜¯è„æ•°æ®ã€‚</p>
<p><img src="https://i.imgur.com/FqatQev.png"></p>
<h3 id="ä¸å¯é‡å¤è¯»"><a href="#ä¸å¯é‡å¤è¯»" class="headerlink" title="ä¸å¯é‡å¤è¯»"></a>ä¸å¯é‡å¤è¯»</h3><p>T2 è¯»å–ä¸€ä¸ªæ•°æ®ï¼ŒT1 å¯¹è¯¥æ•°æ®åšäº†ä¿®æ”¹ã€‚å¦‚æœ T2 å†æ¬¡è¯»å–è¿™ä¸ªæ•°æ®ï¼Œæ­¤æ—¶è¯»å–çš„ç»“æœå’Œç¬¬ä¸€æ¬¡è¯»å–çš„ç»“æœä¸åŒã€‚</p>
<p><img src="https://i.imgur.com/u369vWW.png"></p>
<h3 id="å¹»å½±è¯»"><a href="#å¹»å½±è¯»" class="headerlink" title="å¹»å½±è¯»"></a>å¹»å½±è¯»</h3><p>T1 è¯»å–æŸä¸ªèŒƒå›´çš„æ•°æ®ï¼ŒT2 åœ¨è¿™ä¸ªèŒƒå›´å†…æ’å…¥æ–°çš„æ•°æ®ï¼ŒT1 å†æ¬¡è¯»å–è¿™ä¸ªèŒƒå›´çš„æ•°æ®ï¼Œæ­¤æ—¶è¯»å–çš„ç»“æœå’Œå’Œç¬¬ä¸€æ¬¡è¯»å–çš„ç»“æœä¸åŒã€‚</p>
<p><img src="https://i.imgur.com/7LGip7z.png"></p>
<p>äº§ç”Ÿå¹¶å‘ä¸ä¸€è‡´æ€§é—®é¢˜ä¸»è¦åŸå› æ˜¯ç ´åäº†äº‹åŠ¡çš„éš”ç¦»æ€§ï¼Œè§£å†³æ–¹æ³•æ˜¯é€šè¿‡å¹¶å‘æ§åˆ¶æ¥ä¿è¯éš”ç¦»æ€§ã€‚å¹¶å‘æ§åˆ¶å¯ä»¥é€šè¿‡å°é”æ¥å®ç°ï¼Œä½†æ˜¯å°é”æ“ä½œéœ€è¦ç”¨æˆ·è‡ªå·±æ§åˆ¶ï¼Œç›¸å½“å¤æ‚ã€‚æ•°æ®åº“ç®¡ç†ç³»ç»Ÿæä¾›äº†äº‹åŠ¡çš„éš”ç¦»çº§åˆ«ï¼Œè®©ç”¨æˆ·ä»¥ä¸€ç§æ›´è½»æ¾çš„æ–¹å¼å¤„ç†å¹¶å‘ä¸€è‡´æ€§é—®é¢˜ã€‚</p>
<h3 id="äº‹åŠ¡éš”ç¦»çº§åˆ«"><a href="#äº‹åŠ¡éš”ç¦»çº§åˆ«" class="headerlink" title="äº‹åŠ¡éš”ç¦»çº§åˆ«"></a>äº‹åŠ¡éš”ç¦»çº§åˆ«</h3><ul>
<li><p>æœªæäº¤è¯»ï¼ˆREAD UNCOMMITTEDï¼‰ â€”äº‹åŠ¡ä¸­çš„ä¿®æ”¹ï¼Œå³ä½¿æ²¡æœ‰æäº¤ï¼Œå¯¹å…¶å®ƒäº‹åŠ¡ä¹Ÿæ˜¯å¯è§çš„ã€‚</p>
</li>
<li><p>æäº¤è¯»ï¼ˆREAD COMMITTEDï¼‰ â€” ä¸€ä¸ªäº‹åŠ¡åªèƒ½è¯»å–å·²ç»æäº¤çš„äº‹åŠ¡æ‰€åšçš„ä¿®æ”¹ã€‚æ¢å¥è¯è¯´ï¼Œä¸€ä¸ªäº‹åŠ¡æ‰€åšçš„ä¿®æ”¹åœ¨æäº¤ä¹‹å‰å¯¹å…¶å®ƒäº‹åŠ¡æ˜¯ä¸å¯è§çš„ã€‚</p>
</li>
<li><p>å¯é‡å¤è¯»ï¼ˆREPEATABLE READï¼‰â€”ä¿è¯åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­å¤šæ¬¡è¯»å–åŒæ ·æ•°æ®çš„ç»“æœæ˜¯ä¸€æ ·çš„ã€‚</p>
</li>
<li><p>å¯ä¸²è¡ŒåŒ–ï¼ˆSERIALIZABLEï¼‰â€“å¼ºåˆ¶äº‹åŠ¡ä¸²è¡Œæ‰§è¡Œã€‚</p>
</li>
</ul>
<table>
<thead>
<tr>
<th align="center">éš”ç¦»çº§åˆ«</th>
<th align="center">è„è¯»</th>
<th align="center">ä¸å¯é‡å¤è¯»</th>
<th align="center">å¹»å½±è¯»</th>
</tr>
</thead>
<tbody><tr>
<td align="center">æœªæäº¤è¯»</td>
<td align="center">âˆš</td>
<td align="center">âˆš</td>
<td align="center">âˆš</td>
</tr>
<tr>
<td align="center">æäº¤è¯»</td>
<td align="center">Ã—</td>
<td align="center">âˆš</td>
<td align="center">âˆš</td>
</tr>
<tr>
<td align="center">å¯é‡å¤è¯»</td>
<td align="center">Ã—</td>
<td align="center">Ã—</td>
<td align="center">âˆš</td>
</tr>
<tr>
<td align="center">å¯ä¸²è¡ŒåŒ–</td>
<td align="center">Ã—</td>
<td align="center">Ã—</td>
<td align="center">Ã—</td>
</tr>
</tbody></table>
<h2 id="é˜»å¡"><a href="#é˜»å¡" class="headerlink" title="é˜»å¡"></a>é˜»å¡</h2><p>å› ä¸ºä¸åŒé”ä¹‹é—´çš„å…¼å®¹æ€§å…³ç³»ï¼Œåœ¨æœ‰äº›æ—¶åˆ»ä¸€ä¸ªäº‹åŠ¡ä¸­çš„é”éœ€è¦ç­‰å¾…å¦ä¸€ä¸ªäº‹åŠ¡ä¸­çš„é”é‡Šæ”¾å®ƒæ‰€å ç”¨çš„èµ„æºï¼Œè¿™å°±æ˜¯é˜»å¡ã€‚é˜»å¡å¹¶ä¸æ˜¯ä¸€ä»¶åäº‹ï¼Œå…¶æ˜¯ä¸ºäº†ç¡®ä¿äº‹åŠ¡å¯ä»¥å¹¶å‘ä¸”æ­£å¸¸åœ°è¿è¡Œã€‚</p>
<p>åœ¨InnoDBå­˜å‚¨å¼•æ“ä¸­ï¼Œå‚æ•°innodb_lock_wait_timeoutç”¨æ¥æ§åˆ¶ç­‰å¾…çš„æ—¶é—´(é»˜è®¤æ˜¯50ç§’)ï¼Œinnodb_rollback_on_timeoutç”¨æ¥è®¾å®šæ˜¯å¦åœ¨ç­‰å¾…è¶…æ—¶æ—¶å¯¹è¿›è¡Œä¸­çš„äº‹åŠ¡è¿›è¡Œå›æ»šæ“ä½œ(é»˜è®¤æ˜¯OFF,ä»£è¡¨ä¸å›æ»š)ã€‚</p>
<p><strong>åœ¨é»˜è®¤æƒ…å†µä¸‹InnoDBå­˜å‚¨å¼•æ“ä¸ä¼šå›æ»šè¶…æ—¶å¼•å‘çš„é”™è¯¯å¼‚å¸¸ã€‚å…¶å®InnoDBå­˜å‚¨å¼•æ“åœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹éƒ½ä¸ä¼šå¯¹å¼‚å¸¸è¿›è¡Œå›æ»šã€‚</strong></p>
<h2 id="é”å‡çº§"><a href="#é”å‡çº§" class="headerlink" title="é”å‡çº§"></a>é”å‡çº§</h2><p>é”å‡çº§(Lock Escalation)æ˜¯æŒ‡å°†å½“å‰é”çš„ç²’åº¦é™ä½ã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œæ•°æ®åº“å¯ä»¥æŠŠä¸€ä¸ªè¡¨çš„1000ä¸ªè¡Œé”å‡çº§ä¸ºä¸€ä¸ªé¡µé”ï¼Œæˆ–è€…å°†é¡µé”å‡çº§ä¸ºè¡¨é”ã€‚å¦‚æœåœ¨æ•°æ®åº“çš„è®¾è®¡ä¸­è®¤ä¸ºé”æ˜¯ä¸€ç§ç¨€æœ‰èµ„æºï¼Œè€Œä¸”æƒ³é¿å…é”çš„å¼€é”€ï¼Œé‚£æ•°æ®åº“ä¸­ä¼šé¢‘ç¹å‡ºç°é”å‡çº§ç°è±¡ã€‚</p>
<p>InnoDBå­˜å‚¨å¼•æ“ä¸å­˜åœ¨é”å‡çº§çš„é—®é¢˜ã€‚å› ä¸ºå…¶ä¸æ˜¯æ ¹æ®æ¯ä¸ªè®°å½•æ¥äº§ç”Ÿè¡Œé”çš„ï¼Œç›¸<br>åï¼Œå…¶æ ¹æ®æ¯ä¸ªäº‹åŠ¡è®¿é—®çš„æ¯ä¸ªé¡µå¯¹é”è¿›è¡Œç®¡ç†çš„ï¼Œé‡‡ç”¨çš„æ˜¯ä½å›¾çš„æ–¹å¼ã€‚å› æ­¤ä¸ç®¡ä¸€<br>ä¸ªäº‹åŠ¡é”ä½é¡µä¸­ä¸€ä¸ªè®°å½•è¿˜æ˜¯å¤šä¸ªè®°å½•ï¼Œå…¶å¼€é”€é€šå¸¸éƒ½æ˜¯ä¸€è‡´çš„ã€‚</p>
<blockquote>
<p>MySQLæŠ€æœ¯å†…å¹•ï¼ˆInnoDBå­˜å‚¨å¼•æ“ï¼‰</p>
<p> <a href="https://github.com/CyC2018/CS-Notes/blob/master/notes/%E6%95%B0%E6%8D%AE%E5%BA%93%E7%B3%BB%E7%BB%9F%E5%8E%9F%E7%90%86.md" title="CS-Note">CS-Note</a></p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/19/Paxos/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/image.png">
      <meta itemprop="name" content="ä¸‰åè€Œç«‹">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ä¸‰åè€Œç«‹çš„åšå®¢">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ä¸‰åè€Œç«‹çš„åšå®¢">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/07/19/Paxos/" class="post-title-link" itemprop="url">åˆ†å¸ƒå¼ä¸€è‡´æ€§åè®®</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2019-07-19 20:06:20" itemprop="dateCreated datePublished" datetime="2019-07-19T20:06:20+08:00">2019-07-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-09-21 23:32:32" itemprop="dateModified" datetime="2025-09-21T23:32:32+08:00">2025-09-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/" itemprop="url" rel="index"><span itemprop="name">åˆ†å¸ƒå¼</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>1.1k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>4 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Paxosç®—æ³•"><a href="#Paxosç®—æ³•" class="headerlink" title="Paxosç®—æ³•"></a>Paxosç®—æ³•</h2><p>Paxosç®—æ³•æ ¸å¿ƒæ˜¯ä¸€ä¸ªä¸€è‡´æ€§ç®—æ³•ã€‚<br>åœ¨è¯¥ä¸€è‡´æ€§ç®—æ³•ä¸­ï¼Œæœ‰ä¸‰ç§å‚ä¸è§’è‰²ï¼ŒProposerï¼ŒAcceptorå’ŒLearnerã€‚</p>
<h3 id="é€‰å®šææ¡ˆç®—æ³•æµç¨‹ï¼š"><a href="#é€‰å®šææ¡ˆç®—æ³•æµç¨‹ï¼š" class="headerlink" title="é€‰å®šææ¡ˆç®—æ³•æµç¨‹ï¼š"></a>é€‰å®šææ¡ˆç®—æ³•æµç¨‹ï¼š</h3><p><img src="https://i.imgur.com/ILh54Uy.png"></p>
<p>é˜¶æ®µä¸€</p>
<ol>
<li>Proposeré€‰æ‹©ä¸€ä¸ªææ¡ˆç¼–å·Kï¼Œç„¶åæƒ³Acceptorçš„æŸä¸ªè¶…è¿‡åŠæ•°çš„å­é›†æˆå‘˜å‘é€ç¼–å·ä¸ºKçš„Prepareè¯·æ±‚ã€‚</li>
<li>å¦‚æœä¸€ä¸ªAcceptoræ”¶åˆ°ä¸€ä¸ªç¼–å·ä¸ºKçš„Prepareè¯·æ±‚ï¼Œå¦‚æœKå¤§äºè¯¥Acceptorå·²ç»å“åº”çš„æ‰€æœ‰Prepareè¯·æ±‚çš„ç¼–å·ï¼Œé‚£ä¹ˆå®ƒå°±ä¼šå°†å·²ç»æ‰¹å‡†è¿‡çš„æœ€å¤§ç¼–å·ææ¡ˆä½œä¸ºå“åº”åé¦ˆç»™Proposerï¼›å¦‚æœè¯¥Acceptorä¹‹å‰æœªæ‰¹å‡†è¿‡ææ¡ˆï¼Œé‚£ä¹ˆç›´æ¥è¿”å›ç©ºå“åº”ã€‚<strong>è¯¥Acceptoræ‰¿è¯ºä¸ä¼šå†æ‰¹å‡†å°äºKçš„ææ¡ˆï¼Œè®¾ç½®æ¥æ”¶çš„ææ¡ˆå€¼ä¸ºKã€‚</strong></li>
</ol>
<p>é˜¶æ®µäºŒï¼š</p>
<ol>
<li>å¦‚æœProposeræ”¶åˆ°åŠæ•°ä»¥ä¸Šçš„Acceptorå¯¹äºå…¶å‘å‡ºçš„ç¼–å·ä¸ºKçš„Prepareè¯·æ±‚å“åº”ï¼Œé‚£ä¹ˆå®ƒå°±ä¼šå‘é€ä¸€ä¸ªé’ˆå¯¹[K,V]ææ¡ˆçš„Acceptè¯·æ±‚ç»™Acceptorã€‚(Vä¸ºè¿”å›çš„æ‰€æœ‰å“åº”ä¸­ç¼–å·æœ€å¤§ææ¡ˆçš„å€¼)</li>
<li>å¦‚æœAcceptoræ”¶åˆ°è¿™ä¸ª[K,V]ææ¡ˆçš„Acceptè¯·æ±‚ï¼Œåªè¦è¯¥Acceptorå°šæœªå¯¹ç¼–å·å¤§äºKçš„Prepareè¯·æ±‚ä½œå‡ºå“åº”ï¼Œå®ƒå°±å¯ä»¥é€šè¿‡ææ¡ˆã€‚</li>
</ol>
<h3 id="ææ¡ˆçš„è·å–"><a href="#ææ¡ˆçš„è·å–" class="headerlink" title="ææ¡ˆçš„è·å–"></a>ææ¡ˆçš„è·å–</h3><p>æ–¹æ¡ˆä¸€</p>
<p>ä¸€æ—¦Acceptoræ‰¹å‡†äº†ä¸€ä¸ªææ¡ˆï¼Œå°±å°†è¯¥ææ¡ˆå‘é€ç»™æ‰€æœ‰Learnerã€‚<br>éœ€è¦è®©æ¯ä¸ªAcceptorä¸æ‰€æœ‰Learneré€ä¸ªè¿›è¡Œé€šä¿¡ï¼Œé€šä¿¡æ¬¡æ•°è‡³å°‘ä¸ºäºŒè€…ä¹˜ç§¯ã€‚</p>
<p>æ–¹æ¡ˆäºŒ</p>
<p>æ‰€æœ‰çš„Acceptorå°†ææ¡ˆæ‰¹å‡†æƒ…å†µç»Ÿä¸€å‘é€ç»™ä¸€ä¸ªç‰¹å®šçš„Learnerï¼Œå®ƒæ¥è´Ÿè´£é€šçŸ¥å…¶ä»–çš„Learnerã€‚<br>é—®é¢˜ï¼šä¸»Learneréšæ—¶å¯èƒ½å‡ºç°æ•…éšœ</p>
<p>æ–¹æ¡ˆä¸‰</p>
<p>Acceptorå°†æ‰¹å‡†çš„å¤©å‘é€ç»™ç‰¹å®šçš„Learneré›†åˆ</p>
<h3 id="å®ä¾‹"><a href="#å®ä¾‹" class="headerlink" title="å®ä¾‹"></a>å®ä¾‹</h3><h4 id="Prepare-é˜¶æ®µ"><a href="#Prepare-é˜¶æ®µ" class="headerlink" title="Prepare é˜¶æ®µ"></a>Prepare é˜¶æ®µ</h4><p>ä¸‹å›¾æ¼”ç¤ºäº†ä¸¤ä¸ª Proposer å’Œä¸‰ä¸ª Acceptor çš„ç³»ç»Ÿä¸­è¿è¡Œè¯¥ç®—æ³•çš„åˆå§‹è¿‡ç¨‹ï¼Œæ¯ä¸ª Proposer éƒ½ä¼šå‘æ‰€æœ‰ Acceptor å‘é€ Prepare è¯·æ±‚ã€‚</p>
<p><img src="https://i.imgur.com/lvlzG5p.png"></p>
<p>å½“ Acceptor æ¥æ”¶åˆ°ä¸€ä¸ª Prepare è¯·æ±‚ï¼ŒåŒ…å«çš„æè®®ä¸º [n1, v1]ï¼Œå¹¶ä¸”ä¹‹å‰è¿˜æœªæ¥æ”¶è¿‡ Prepare è¯·æ±‚ï¼Œé‚£ä¹ˆå‘é€ä¸€ä¸ª Prepare å“åº”ï¼Œè®¾ç½®å½“å‰æ¥æ”¶åˆ°çš„æè®®ä¸º [n1, v1]ï¼Œå¹¶ä¸”ä¿è¯ä»¥åä¸ä¼šå†æ¥å—åºå·å°äº n1 çš„æè®®ã€‚</p>
<p>å¦‚ä¸‹å›¾ï¼ŒAcceptor X åœ¨æ”¶åˆ° [n&#x3D;2, v&#x3D;8] çš„ Prepare è¯·æ±‚æ—¶ï¼Œç”±äºä¹‹å‰æ²¡æœ‰æ¥æ”¶è¿‡æè®®ï¼Œå› æ­¤å°±å‘é€ä¸€ä¸ª [no previous] çš„ Prepare å“åº”ï¼Œè®¾ç½®å½“å‰æ¥æ”¶åˆ°çš„æè®®ä¸º [n&#x3D;2, v&#x3D;8]ï¼Œå¹¶ä¸”ä¿è¯ä»¥åä¸ä¼šå†æ¥å—åºå·å°äº 2 çš„æè®®ã€‚å…¶å®ƒçš„ Acceptor ç±»ä¼¼ã€‚</p>
<p><img src="https://i.imgur.com/euXdPJZ.jpg"></p>
<p>å¦‚æœ Acceptor æ¥æ”¶åˆ°ä¸€ä¸ª Prepare è¯·æ±‚ï¼ŒåŒ…å«çš„æè®®ä¸º [n2, v2]ï¼Œå¹¶ä¸”ä¹‹å‰å·²ç»æ¥æ”¶è¿‡æè®® [n1, v1]ã€‚å¦‚æœ n1 &gt; n2ï¼Œé‚£ä¹ˆå°±ä¸¢å¼ƒè¯¥æè®®è¯·æ±‚ï¼›å¦åˆ™ï¼Œå‘é€ Prepare å“åº”ï¼Œè¯¥ Prepare å“åº”åŒ…å«ä¹‹å‰å·²ç»æ¥æ”¶è¿‡çš„æè®® [n1, v1]ï¼Œè®¾ç½®å½“å‰æ¥æ”¶åˆ°çš„æè®®ä¸º [n2, v2]ï¼Œå¹¶ä¸”ä¿è¯ä»¥åä¸ä¼šå†æ¥å—åºå·å°äº n2 çš„æè®®ã€‚</p>
<p>å¦‚ä¸‹å›¾ï¼ŒAcceptor Z æ”¶åˆ° Proposer A å‘æ¥çš„ [n&#x3D;2, v&#x3D;8] çš„ Prepare è¯·æ±‚ï¼Œç”±äºä¹‹å‰å·²ç»æ¥æ”¶è¿‡ [n&#x3D;4, v&#x3D;5] çš„æè®®ï¼Œå¹¶ä¸” n &gt; 2ï¼Œå› æ­¤å°±æŠ›å¼ƒè¯¥æè®®è¯·æ±‚ï¼›Acceptor X æ”¶åˆ° Proposer B å‘æ¥çš„ [n&#x3D;4, v&#x3D;5] çš„ Prepare è¯·æ±‚ï¼Œå› ä¸ºä¹‹å‰æ¥æ”¶åˆ°çš„æè®®ä¸º [n&#x3D;2, v&#x3D;8]ï¼Œå¹¶ä¸” 2 &lt;&#x3D; 4ï¼Œå› æ­¤å°±å‘é€ [n&#x3D;2, v&#x3D;8] çš„ Prepare å“åº”ï¼Œè®¾ç½®å½“å‰æ¥æ”¶åˆ°çš„æè®®ä¸º [n&#x3D;4, v&#x3D;5]ï¼Œå¹¶ä¸”ä¿è¯ä»¥åä¸ä¼šå†æ¥å—åºå·å°äº 4 çš„æè®®ã€‚Acceptor Y ç±»ä¼¼ã€‚<br><img src="https://i.imgur.com/90o9cLJ.jpg"></p>
<h4 id="Accept-é˜¶æ®µ"><a href="#Accept-é˜¶æ®µ" class="headerlink" title="Accept é˜¶æ®µ"></a>Accept é˜¶æ®µ</h4><p>å½“ä¸€ä¸ª Proposer æ¥æ”¶åˆ°è¶…è¿‡ä¸€åŠ Acceptor çš„ Prepare å“åº”æ—¶ï¼Œå°±å¯ä»¥å‘é€ Accept è¯·æ±‚ã€‚</p>
<p>Proposer A æ¥æ”¶åˆ°ä¸¤ä¸ª Prepare å“åº”ä¹‹åï¼Œå°±å‘é€ [n&#x3D;2, v&#x3D;8] Accept è¯·æ±‚ã€‚è¯¥ Accept è¯·æ±‚ä¼šè¢«æ‰€æœ‰ Acceptor ä¸¢å¼ƒï¼Œå› ä¸ºæ­¤æ—¶æ‰€æœ‰ Acceptor éƒ½ä¿è¯ä¸æ¥å—åºå·å°äº 4 çš„æè®®ã€‚</p>
<p>Proposer B è¿‡åä¹Ÿæ”¶åˆ°äº†ä¸¤ä¸ª Prepare å“åº”ï¼Œå› æ­¤ä¹Ÿå¼€å§‹å‘é€ Accept è¯·æ±‚ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒAccept è¯·æ±‚çš„ v éœ€è¦å–å®ƒæ”¶åˆ°çš„æœ€å¤§æè®®ç¼–å·å¯¹åº”çš„ v å€¼ï¼Œä¹Ÿå°±æ˜¯ 8ã€‚å› æ­¤å®ƒå‘é€ [n&#x3D;4, v&#x3D;8] çš„ Accept è¯·æ±‚ã€‚</p>
<p><img src="https://i.imgur.com/DhgPWlP.png"></p>
<h4 id="Learn-é˜¶æ®µ"><a href="#Learn-é˜¶æ®µ" class="headerlink" title="Learn é˜¶æ®µ"></a>Learn é˜¶æ®µ</h4><p>Acceptor æ¥æ”¶åˆ° Accept è¯·æ±‚æ—¶ï¼Œå¦‚æœåºå·å¤§äºç­‰äºè¯¥ Acceptor æ‰¿è¯ºçš„æœ€å°åºå·ï¼Œé‚£ä¹ˆå°±å‘é€ Learn æè®®ç»™æ‰€æœ‰çš„ Learnerã€‚å½“ Learner å‘ç°æœ‰å¤§å¤šæ•°çš„ Acceptor æ¥æ”¶äº†æŸä¸ªæè®®ï¼Œé‚£ä¹ˆè¯¥æè®®çš„æè®®å€¼å°±è¢« Paxos é€‰æ‹©å‡ºæ¥ã€‚</p>
<p><img src="https://i.imgur.com/vROZJFn.jpg"></p>
<h2 id="Raftç®—æ³•"><a href="#Raftç®—æ³•" class="headerlink" title="Raftç®—æ³•"></a>Raftç®—æ³•</h2><blockquote>
<p><a href="https://github.com/CyC2018/CS-Notes/blob/master/notes/%E5%88%86%E5%B8%83%E5%BC%8F.md#%E4%BA%94paxos">https://github.com/CyC2018/CS-Notes/blob/master/notes/%E5%88%86%E5%B8%83%E5%BC%8F.md#%E4%BA%94paxos</a></p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/01/ElaticSearch/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/image.png">
      <meta itemprop="name" content="ä¸‰åè€Œç«‹">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ä¸‰åè€Œç«‹çš„åšå®¢">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ä¸‰åè€Œç«‹çš„åšå®¢">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/07/01/ElaticSearch/" class="post-title-link" itemprop="url">ElasticSearchç®€ä»‹</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2019-07-01 21:16:20" itemprop="dateCreated datePublished" datetime="2019-07-01T21:16:20+08:00">2019-07-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-09-21 23:32:32" itemprop="dateModified" datetime="2025-09-21T23:32:32+08:00">2025-09-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/ElasticSearch/" itemprop="url" rel="index"><span itemprop="name">ElasticSearch</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>17k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>1:01</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="ElasticSearchåŸºæœ¬æ¦‚å¿µ"><a href="#ElasticSearchåŸºæœ¬æ¦‚å¿µ" class="headerlink" title="ElasticSearchåŸºæœ¬æ¦‚å¿µ"></a>ElasticSearchåŸºæœ¬æ¦‚å¿µ</h2><ul>
<li><p><strong>èŠ‚ç‚¹(node)</strong>: ä¸€ä¸ªèŠ‚ç‚¹æ˜¯ä¸€ä¸ªé€»è¾‘ä¸Šç‹¬ç«‹çš„æœåŠ¡ï¼Œå¯ä»¥å­˜å‚¨æ•°æ®ï¼Œå¹¶å‚ä¸é›†ç¾¤çš„ç´¢å¼•å’Œæœç´¢åŠŸèƒ½, ä¸€ä¸ªèŠ‚ç‚¹ä¹Ÿæœ‰å”¯ä¸€çš„åå­—ï¼Œç¾¤é›†é€šè¿‡èŠ‚ç‚¹åç§°è¿›è¡Œç®¡ç†å’Œé€šä¿¡.</p>
</li>
<li><p><strong>ç´¢å¼•ï¼ˆIndex)</strong> ï¼š ç´¢å¼•ä¸å…³ç³»å‹æ•°æ®åº“å®ä¾‹(Database)ç›¸å½“ã€‚ç´¢å¼•åªæ˜¯ä¸€ä¸ª é€»è¾‘å‘½åç©ºé—´ï¼Œå®ƒæŒ‡å‘ä¸€ä¸ªæˆ–å¤šä¸ªåˆ†ç‰‡(shards)ï¼Œå†…éƒ¨ç”¨Apache Luceneå®ç°ç´¢å¼•ä¸­æ•°æ®çš„è¯»å†™</p>
</li>
<li><p><strong>æ–‡æ¡£ç±»å‹ï¼ˆTypeï¼‰</strong>ï¼šç›¸å½“äºæ•°æ®åº“ä¸­çš„tableæ¦‚å¿µã€‚æ¯ä¸ªæ–‡æ¡£åœ¨ElasticSearchä¸­éƒ½å¿…é¡»è®¾å®šå®ƒçš„ç±»å‹ã€‚æ–‡æ¡£ç±»å‹ä½¿å¾—åŒä¸€ä¸ªç´¢å¼•ä¸­åœ¨å­˜å‚¨ç»“æ„ä¸åŒæ–‡æ¡£æ—¶ï¼Œåªéœ€è¦ä¾æ®æ–‡æ¡£ç±»å‹å°±å¯ä»¥æ‰¾åˆ°å¯¹åº”çš„å‚æ•°æ˜ å°„(Mapping)ä¿¡æ¯ï¼Œæ–¹ä¾¿æ–‡æ¡£çš„å­˜å–</p>
</li>
<li><p><strong>æ–‡æ¡£ï¼ˆDocument)</strong> ï¼šç›¸å½“äºæ•°æ®åº“ä¸­çš„rowï¼Œ æ˜¯å¯ä»¥è¢«ç´¢å¼•çš„åŸºæœ¬å•ä½ã€‚æ–‡æ¡£æ˜¯ä»¥JSONæ ¼å¼å­˜å‚¨çš„ã€‚åœ¨ä¸€ä¸ªç´¢å¼•ä¸­ï¼Œæ‚¨å¯ä»¥å­˜å‚¨å¤šä¸ªçš„æ–‡æ¡£ã€‚è¯·æ³¨æ„ï¼Œè™½ç„¶åœ¨ä¸€ä¸ªç´¢å¼•ä¸­æœ‰å¤šåˆ†æ–‡æ¡£ï¼Œä½†è¿™äº›æ–‡æ¡£çš„ç»“æ„æ˜¯ä¸€è‡´çš„ï¼Œå¹¶åœ¨ç¬¬ä¸€æ¬¡å­˜å‚¨çš„æ—¶å€™æŒ‡å®š, æ–‡æ¡£å±äºä¸€ç§ ç±»å‹(type)ï¼Œå„ç§å„æ ·çš„ç±»å‹å­˜åœ¨äºä¸€ä¸ªç´¢å¼•ä¸­ã€‚</p>
</li>
<li><p><strong>é›†ç¾¤ï¼ˆCluster)</strong>: åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªå…·æœ‰ç›¸åŒ cluster.name çš„èŠ‚ç‚¹.</p>
<ol>
<li><pre><code>é›†ç¾¤å†…èŠ‚ç‚¹ååŒå·¥ä½œï¼Œå…±äº«æ•°æ®ï¼Œå¹¶å…±åŒåˆ†æ‹…å·¥ä½œè´Ÿè·ã€‚
</code></pre>
</li>
<li><pre><code>ç”±äºèŠ‚ç‚¹æ˜¯ä»å±é›†ç¾¤çš„ï¼Œé›†ç¾¤ä¼šè‡ªæˆ‘é‡ç»„æ¥å‡åŒ€åœ°åˆ†å‘æ•°æ®. 
</code></pre>
</li>
<li><pre><code>cluster Nameæ˜¯å¾ˆé‡è¦çš„ï¼Œå› ä¸ºæ¯ä¸ªèŠ‚ç‚¹åªèƒ½æ˜¯ç¾¤é›†çš„ä¸€éƒ¨åˆ†ï¼Œå½“è¯¥èŠ‚ç‚¹è¢«è®¾ç½®ä¸ºç›¸åŒçš„åç§°æ—¶ï¼Œå°±ä¼šè‡ªåŠ¨åŠ å…¥ç¾¤é›†ã€‚
</code></pre>
</li>
<li><pre><code>é›†ç¾¤ä¸­é€šè¿‡é€‰ä¸¾äº§ç”Ÿä¸€ä¸ªmaterèŠ‚ç‚¹ï¼Œå®ƒå°†è´Ÿè´£ç®¡ç†é›†ç¾¤èŒƒç•´çš„å˜æ›´ï¼Œä¾‹å¦‚åˆ›å»ºæˆ–åˆ é™¤ç´¢å¼•ï¼Œæ·»åŠ èŠ‚ç‚¹åˆ°é›†ç¾¤æˆ–ä»é›†ç¾¤åˆ é™¤èŠ‚ç‚¹ã€‚master èŠ‚ç‚¹æ— éœ€å‚ä¸æ–‡æ¡£å±‚é¢çš„å˜æ›´å’Œæœç´¢ï¼Œè¿™æ„å‘³ç€ä»…æœ‰ä¸€ä¸ª master èŠ‚ç‚¹å¹¶ä¸ä¼šå› æµé‡å¢é•¿è€Œæˆä¸ºç“¶é¢ˆã€‚ä»»æ„ä¸€ä¸ªèŠ‚ç‚¹éƒ½å¯ä»¥æˆä¸º master èŠ‚ç‚¹ã€‚æˆ‘ä»¬ä¾‹ä¸¾çš„é›†ç¾¤åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå› æ­¤å®ƒä¼šæ‰®æ¼” master èŠ‚ç‚¹çš„è§’è‰²ã€‚
</code></pre>
</li>
<li><pre><code>ä½œä¸ºç”¨æˆ·ï¼Œæˆ‘ä»¬å¯ä»¥è®¿é—®åŒ…æ‹¬ master èŠ‚ç‚¹åœ¨å†…çš„é›†ç¾¤ä¸­çš„ä»»ä¸€èŠ‚ç‚¹ã€‚æ¯ä¸ªèŠ‚ç‚¹éƒ½çŸ¥é“å„ä¸ªæ–‡æ¡£çš„ä½ç½®ï¼Œå¹¶èƒ½å¤Ÿå°†æˆ‘ä»¬çš„è¯·æ±‚ç›´æ¥è½¬å‘åˆ°æ‹¥æœ‰æˆ‘ä»¬æƒ³è¦çš„æ•°æ®çš„èŠ‚ç‚¹ã€‚æ— è®ºæˆ‘ä»¬è®¿é—®çš„æ˜¯å“ªä¸ªèŠ‚ç‚¹ï¼Œå®ƒéƒ½ä¼šæ§åˆ¶ä»æ‹¥æœ‰æ•°æ®çš„èŠ‚ç‚¹æ”¶é›†å“åº”çš„è¿‡ç¨‹ï¼Œå¹¶è¿”å›ç»™å®¢æˆ·ç«¯æœ€ç»ˆçš„ç»“æœã€‚è¿™ä¸€åˆ‡éƒ½æ˜¯ç”± Elasticsearch é€æ˜ç®¡ç†çš„
</code></pre>
</li>
</ol>
</li>
<li><p><strong>åˆ†ç‰‡(shard)</strong> ï¼šæ˜¯ å·¥ä½œå•å…ƒ(worker unit) åº•å±‚çš„ä¸€å‘˜ï¼Œç”¨æ¥åˆ†é…é›†ç¾¤ä¸­çš„æ•°æ®ï¼Œå®ƒåªè´Ÿè´£ä¿å­˜ç´¢å¼•ä¸­æ‰€æœ‰æ•°æ®çš„ä¸€å°ç‰‡ã€‚</p>
<ol>
<li>åˆ†ç‰‡æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„Luceneå®ä¾‹ï¼Œå¹¶ä¸”å®ƒè‡ªèº«ä¹Ÿæ˜¯ä¸€ä¸ªå®Œæ•´çš„æœç´¢å¼•æ“ã€‚</li>
<li><pre><code>æ–‡æ¡£å­˜å‚¨å¹¶ä¸”è¢«ç´¢å¼•åœ¨åˆ†ç‰‡ä¸­ï¼Œä½†æ˜¯æˆ‘ä»¬çš„ç¨‹åºå¹¶ä¸ä¼šç›´æ¥ä¸å®ƒä»¬é€šä¿¡ã€‚å–è€Œä»£ä¹‹ï¼Œå®ƒä»¬ç›´æ¥ä¸ç´¢å¼•è¿›è¡Œé€šä¿¡çš„
</code></pre>
</li>
<li><pre><code>æŠŠåˆ†ç‰‡æƒ³è±¡æˆä¸€ä¸ªæ•°æ®çš„å®¹å™¨ã€‚æ•°æ®è¢«å­˜å‚¨åœ¨åˆ†ç‰‡ä¸­ï¼Œç„¶ååˆ†ç‰‡åˆè¢«åˆ†é…åœ¨é›†ç¾¤çš„èŠ‚ç‚¹ä¸Šã€‚å½“ä½ çš„é›†ç¾¤æ‰©å±•æˆ–è€…ç¼©å°æ—¶ï¼Œelasticsearch ä¼šè‡ªåŠ¨çš„åœ¨èŠ‚ç‚¹ä¹‹é—´è¿ç§»åˆ†é…åˆ†ç‰‡ï¼Œä»¥ä¾¿é›†ç¾¤ä¿æŒå‡è¡¡
</code></pre>
</li>
<li><pre><code>åˆ†ç‰‡åˆ†ä¸º ä¸»åˆ†ç‰‡(primary shard) ä»¥åŠ ä»åˆ†ç‰‡(replica shard) ä¸¤ç§ã€‚åœ¨ä½ çš„ç´¢å¼•ä¸­ï¼Œæ¯ä¸€ä¸ªæ–‡æ¡£éƒ½å±äºä¸€ä¸ªä¸»åˆ†ç‰‡
</code></pre>
</li>
<li><pre><code>ä»åˆ†ç‰‡åªæ˜¯ä¸»åˆ†ç‰‡çš„ä¸€ä¸ªå‰¯æœ¬ï¼Œå®ƒç”¨äºæä¾›æ•°æ®çš„å†—ä½™å‰¯æœ¬ï¼Œåœ¨ç¡¬ä»¶æ•…éšœæ—¶æä¾›æ•°æ®ä¿æŠ¤ï¼ŒåŒæ—¶æœåŠ¡äºæœç´¢å’Œæ£€ç´¢è¿™ç§åªè¯»è¯·æ±‚
</code></pre>
</li>
<li><pre><code>ç´¢å¼•ä¸­çš„ä¸»åˆ†ç‰‡çš„æ•°é‡åœ¨ç´¢å¼•åˆ›å»ºåå°±å›ºå®šä¸‹æ¥äº†ï¼Œä½†æ˜¯ä»åˆ†ç‰‡çš„æ•°é‡å¯ä»¥éšæ—¶æ”¹å˜ã€‚
</code></pre>
</li>
<li><pre><code>ä¸€ä¸ªç´¢å¼•é»˜è®¤è®¾ç½®äº†5ä¸ªä¸»åˆ†ç‰‡ï¼Œæ¯ä¸ªä¸»åˆ†ç‰‡æœ‰ä¸€ä¸ªä»åˆ†ç‰‡å¯¹åº”
</code></pre>
</li>
</ol>
</li>
<li><p><strong>å‰¯æœ¬ï¼ˆReplicaï¼‰ï¼š</strong>åŒä¸€ä¸ªåˆ†ç‰‡(Shard)çš„å¤‡ä»½æ•°æ®ï¼Œä¸€ä¸ªåˆ†ç‰‡å¯èƒ½ä¼šæœ‰0ä¸ªæˆ–å¤šä¸ªå‰¯æœ¬ï¼Œè¿™äº›å‰¯æœ¬ä¸­çš„æ•°æ®ä¿è¯å¼ºä¸€è‡´æˆ–æœ€ç»ˆä¸€è‡´ã€‚</p>
</li>
</ul>
<h2 id="Elasticsearché›†ç¾¤"><a href="#Elasticsearché›†ç¾¤" class="headerlink" title="Elasticsearché›†ç¾¤"></a>Elasticsearché›†ç¾¤</h2><p><img src="https://i.imgur.com/GXwjiNi.png"></p>
<h2 id="Elasticsearché›†ç¾¤æœç´¢"><a href="#Elasticsearché›†ç¾¤æœç´¢" class="headerlink" title="Elasticsearché›†ç¾¤æœç´¢"></a>Elasticsearché›†ç¾¤æœç´¢</h2><p>ï¼ˆå…¨æ–‡è½¬è½½è‡ª <a href="https://zhuanlan.zhihu.com/p/34674517">Elasticsearchå†…æ ¸è§£æ - æŸ¥è¯¢ç¯‡</a>ï¼‰</p>
<p>ç›®å‰çš„Elasticsearchæœ‰ä¸¤ä¸ªæ˜æ˜¾çš„èº«ä»½ï¼Œä¸€ä¸ªæ˜¯åˆ†å¸ƒå¼æœç´¢ç³»ç»Ÿï¼Œå¦ä¸€ä¸ªæ˜¯åˆ†å¸ƒå¼NoSQLæ•°æ®åº“ï¼Œå¯¹äºè¿™ä¸¤ç§ä¸åŒçš„èº«ä»½ï¼Œè¯»å†™è¯­ä¹‰åŸºæœ¬ç±»ä¼¼ï¼Œä½†ä¹Ÿæœ‰ä¸€ç‚¹å·®å¼‚ã€‚<br><img src="https://i.imgur.com/8GPAX41.png"></p>
<h3 id="è¯»æ“ä½œ"><a href="#è¯»æ“ä½œ" class="headerlink" title="è¯»æ“ä½œ"></a>è¯»æ“ä½œ</h3><p>å®æ—¶æ€§å¯¹äºæœç´¢è€Œè¨€æ˜¯è¿‘å®æ—¶çš„ï¼Œå»¶è¿Ÿåœ¨100msä»¥ä¸Šï¼Œå¯¹äºNoSQLåˆ™éœ€è¦æ˜¯å®æ—¶çš„ã€‚</p>
<p>ä¸€è‡´æ€§æŒ‡çš„æ˜¯å†™å…¥æˆåŠŸåï¼Œä¸‹æ¬¡è¯»æ“ä½œä¸€å®šè¦èƒ½è¯»å–åˆ°æœ€æ–°çš„æ•°æ®ã€‚å¯¹äºæœç´¢ï¼Œè¿™ä¸ªè¦æ±‚ä¼šä½ä¸€äº›ï¼Œå¯ä»¥æœ‰ä¸€äº›å»¶è¿Ÿã€‚ä½†æ˜¯å¯¹äºNoSQLæ•°æ®åº“ï¼Œåˆ™ä¸€èˆ¬è¦æ±‚æœ€å¥½æ˜¯å¼ºä¸€è‡´æ€§çš„ã€‚</p>
<p>ç»“æœåŒ¹é…ä¸Šï¼ŒNoSQLä½œä¸ºæ•°æ®åº“ï¼ŒæŸ¥è¯¢è¿‡ç¨‹ä¸­åªæœ‰ç¬¦åˆä¸ç¬¦åˆä¸¤ç§æƒ…å†µï¼Œè€Œæœç´¢é‡Œé¢è¿˜æœ‰æ˜¯å¦ç›¸å…³ï¼Œç±»ä¼¼äºNoSQLçš„ç»“æœåªèƒ½æ˜¯0æˆ–1ï¼Œè€Œæœç´¢é‡Œé¢å¯èƒ½ä¼šæœ‰0.1ï¼Œ0.5ï¼Œ0.9ç­‰éƒ¨åˆ†åŒ¹é…æˆ–è€…æ›´ç›¸å…³çš„æƒ…å†µã€‚</p>
<p>ç»“æœå¬å›ä¸Šï¼Œæœç´¢ä¸€èˆ¬åªéœ€è¦å¬å›æœ€æ»¡è¶³æ¡ä»¶çš„Top Nç»“æœå³å¯ï¼Œè€ŒNoSQLä¸€èˆ¬éƒ½éœ€è¦è¿”å›æ»¡è¶³æ¡ä»¶çš„æ‰€æœ‰ç»“æœã€‚</p>
<p>æœç´¢ç³»ç»Ÿä¸€èˆ¬éƒ½æ˜¯ä¸¤é˜¶æ®µæŸ¥è¯¢ï¼Œç¬¬ä¸€ä¸ªé˜¶æ®µæŸ¥è¯¢åˆ°å¯¹åº”çš„Doc IDï¼Œä¹Ÿå°±æ˜¯PKï¼›ç¬¬äºŒé˜¶æ®µå†é€šè¿‡Doc IDå»æŸ¥è¯¢å®Œæ•´æ–‡æ¡£ï¼Œè€ŒNoSQLæ•°æ®åº“ä¸€èˆ¬æ˜¯ä¸€é˜¶æ®µå°±è¿”å›ç»“æœã€‚åœ¨Elasticsearchä¸­ä¸¤ç§éƒ½æ”¯æŒã€‚</p>
<p>ç›®å‰NoSQLçš„æŸ¥è¯¢ï¼Œèšåˆã€åˆ†æå’Œç»Ÿè®¡ç­‰åŠŸèƒ½ä¸Šéƒ½æ˜¯è¦æ¯”æœç´¢å¼±çš„ã€‚</p>
<h3 id="Luceneçš„è¯»"><a href="#Luceneçš„è¯»" class="headerlink" title="Luceneçš„è¯»"></a>Luceneçš„è¯»</h3><p>Elasticsearchä½¿ç”¨äº†Luceneä½œä¸ºæœç´¢å¼•æ“åº“ï¼Œé€šè¿‡Luceneå®Œæˆç‰¹å®šå­—æ®µçš„æœç´¢ç­‰åŠŸèƒ½ï¼Œåœ¨Luceneä¸­è¿™ä¸ªåŠŸèƒ½æ˜¯é€šè¿‡IndexSearcherçš„ä¸‹åˆ—æ¥å£å®ç°çš„ï¼š</p>
<pre><code>public TopDocs search(Query query, int n);
public Document doc(int docID);
public int count(Query query);
......(å…¶ä»–)
</code></pre>
<p>ç¬¬ä¸€ä¸ªsearchæ¥å£å®ç°æœç´¢åŠŸèƒ½ï¼Œè¿”å›æœ€æ»¡è¶³Queryçš„Nä¸ªç»“æœï¼›ç¬¬äºŒä¸ªdocæ¥å£é€šè¿‡doc idæŸ¥è¯¢Docå†…å®¹ï¼›ç¬¬ä¸‰ä¸ªcountæ¥å£é€šè¿‡Queryè·å–åˆ°å‘½ä¸­æ•°ã€‚</p>
<p>è¿™ä¸‰ä¸ªåŠŸèƒ½æ˜¯æœç´¢ä¸­çš„æœ€åŸºæœ¬çš„ä¸‰ä¸ªåŠŸèƒ½ç‚¹ï¼Œå¯¹äºå¤§éƒ¨åˆ†Elasticsearchä¸­çš„æŸ¥è¯¢éƒ½æ˜¯æ¯”è¾ƒå¤æ‚çš„ï¼Œç›´æ¥ç”¨è¿™ä¸ªæ¥å£æ˜¯æ— æ³•æ»¡è¶³éœ€æ±‚çš„ï¼Œæ¯”å¦‚åˆ†å¸ƒå¼é—®é¢˜ã€‚è¿™äº›é—®é¢˜éƒ½ç•™ç»™äº†Elasticsearchè§£å†³ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥çœ‹Elasticsearchä¸­ç›¸å…³è¯»åŠŸèƒ½çš„å‰–æã€‚</p>
<h3 id="Elasticsearchçš„è¯»"><a href="#Elasticsearchçš„è¯»" class="headerlink" title="Elasticsearchçš„è¯»"></a>Elasticsearchçš„è¯»</h3><p>Elasticsearchä¸­æ¯ä¸ªShardéƒ½ä¼šæœ‰å¤šä¸ªReplicaï¼Œä¸»è¦æ˜¯ä¸ºäº†ä¿è¯æ•°æ®å¯é æ€§ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œè¿˜å¯ä»¥å¢åŠ è¯»èƒ½åŠ›ï¼Œå› ä¸ºå†™çš„æ—¶å€™è™½ç„¶è¦å†™å¤§éƒ¨åˆ†Replica Shardï¼Œä½†æ˜¯æŸ¥è¯¢çš„æ—¶å€™åªéœ€è¦æŸ¥è¯¢Primaryå’ŒReplicaä¸­çš„ä»»ä½•ä¸€ä¸ªå°±å¯ä»¥äº†ã€‚<br><img src="https://i.imgur.com/iRNbl8w.png"></p>
<p>åœ¨ä¸Šå›¾ä¸­ï¼Œè¯¥Shardæœ‰1ä¸ªPrimaryå’Œ2ä¸ªReplica Nodeï¼Œå½“æŸ¥è¯¢çš„æ—¶å€™ï¼Œä»ä¸‰ä¸ªèŠ‚ç‚¹ä¸­æ ¹æ®Requestä¸­çš„preferenceå‚æ•°é€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹æŸ¥è¯¢ã€‚preferenceå¯ä»¥è®¾ç½®_localï¼Œ_primaryï¼Œ_replicaä»¥åŠå…¶ä»–é€‰é¡¹ã€‚å¦‚æœé€‰æ‹©äº†primaryï¼Œåˆ™æ¯æ¬¡æŸ¥è¯¢éƒ½æ˜¯ç›´æ¥æŸ¥è¯¢Primaryï¼Œå¯ä»¥ä¿è¯æ¯æ¬¡æŸ¥è¯¢éƒ½æ˜¯æœ€æ–°çš„ã€‚å¦‚æœè®¾ç½®äº†å…¶ä»–å‚æ•°ï¼Œé‚£ä¹ˆå¯èƒ½ä¼šæŸ¥è¯¢åˆ°R1æˆ–è€…R2ï¼Œè¿™æ—¶å€™å°±æœ‰å¯èƒ½æŸ¥è¯¢ä¸åˆ°æœ€æ–°çš„æ•°æ®ã€‚</p>
<p>æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹ï¼ŒElasticsearchä¸­çš„æŸ¥è¯¢æ˜¯å¦‚ä½•æ”¯æŒåˆ†å¸ƒå¼çš„ã€‚</p>
<p><img src="https://i.imgur.com/9qTJ332.png"></p>
<p>Elasticsearchä¸­é€šè¿‡åˆ†åŒºå®ç°åˆ†å¸ƒå¼ï¼Œæ•°æ®å†™å…¥çš„æ—¶å€™æ ¹æ®_routingè§„åˆ™å°†æ•°æ®å†™å…¥æŸä¸€ä¸ªShardä¸­ï¼Œè¿™æ ·å°±èƒ½å°†æµ·é‡æ•°æ®åˆ†å¸ƒåœ¨å¤šä¸ªShardä»¥åŠå¤šå°æœºå™¨ä¸Šï¼Œå·²è¾¾åˆ°åˆ†å¸ƒå¼çš„ç›®æ ‡ã€‚è¿™æ ·å°±å¯¼è‡´äº†æŸ¥è¯¢çš„æ—¶å€™ï¼Œæ½œåœ¨æ•°æ®ä¼šåœ¨å½“å‰indexçš„æ‰€æœ‰çš„Shardä¸­ï¼Œæ‰€ä»¥ElasticsearchæŸ¥è¯¢çš„æ—¶å€™éœ€è¦æŸ¥è¯¢æ‰€æœ‰Shardï¼ŒåŒä¸€ä¸ªShardçš„Primaryå’ŒReplicaé€‰æ‹©ä¸€ä¸ªå³å¯ï¼ŒæŸ¥è¯¢è¯·æ±‚ä¼šåˆ†å‘ç»™æ‰€æœ‰Shardï¼Œæ¯ä¸ªShardä¸­éƒ½æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„æŸ¥è¯¢å¼•æ“ï¼Œæ¯”å¦‚éœ€è¦è¿”å›Top 10çš„ç»“æœï¼Œé‚£ä¹ˆæ¯ä¸ªShardéƒ½ä¼šæŸ¥è¯¢å¹¶ä¸”è¿”å›Top 10çš„ç»“æœï¼Œç„¶ååœ¨Client Nodeé‡Œé¢ä¼šæ¥æ”¶æ‰€æœ‰Shardçš„ç»“æœï¼Œç„¶åé€šè¿‡ä¼˜å…ˆçº§é˜Ÿåˆ—äºŒæ¬¡æ’åºï¼Œé€‰æ‹©å‡ºTop 10çš„ç»“æœè¿”å›ç»™ç”¨æˆ·ã€‚</p>
<p>è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯è¯·æ±‚è†¨èƒ€ï¼Œç”¨æˆ·çš„ä¸€ä¸ªæœç´¢è¯·æ±‚åœ¨Elasticsearchå†…éƒ¨ä¼šå˜æˆShardä¸ªè¯·æ±‚ï¼Œè¿™é‡Œæœ‰ä¸ªä¼˜åŒ–ç‚¹ï¼Œè™½ç„¶æ˜¯Shardä¸ªè¯·æ±‚ï¼Œä½†æ˜¯è¿™ä¸ªShardä¸ªæ•°ä¸ä¸€å®šè¦æ˜¯å½“å‰Indexä¸­çš„Shardä¸ªæ•°ï¼Œåªè¦æ˜¯å½“å‰æŸ¥è¯¢ç›¸å…³çš„Shardå³å¯ï¼Œè¿™ä¸ªéœ€è¦åŸºäºä¸šåŠ¡å’Œè¯·æ±‚å†…å®¹ä¼˜åŒ–ï¼Œé€šè¿‡è¿™ç§æ–¹å¼å¯ä»¥ä¼˜åŒ–è¯·æ±‚è†¨èƒ€æ•°ã€‚</p>
<p>Elasticsearchä¸­çš„æŸ¥è¯¢ä¸»è¦åˆ†ä¸ºä¸¤ç±»ï¼ŒGetè¯·æ±‚ï¼šé€šè¿‡IDæŸ¥è¯¢ç‰¹å®šDocï¼›Searchè¯·æ±‚ï¼šé€šè¿‡QueryæŸ¥è¯¢åŒ¹é…Docã€‚<br><img src="https://i.imgur.com/Jvc3vIp.png"></p>
<blockquote>
<p>ä¸Šå›¾ä¸­å†…å­˜ä¸­çš„Segmentæ˜¯æŒ‡åˆšRefresh Segmentï¼Œä½†æ˜¯è¿˜æ²¡æŒä¹…åŒ–åˆ°ç£ç›˜çš„æ–°Segmentï¼Œè€Œéä»ç£ç›˜åŠ è½½åˆ°å†…å­˜ä¸­çš„Segmentã€‚</p>
</blockquote>
<p>å¯¹äºSearchç±»è¯·æ±‚ï¼ŒæŸ¥è¯¢çš„æ—¶å€™æ˜¯ä¸€èµ·æŸ¥è¯¢å†…å­˜å’Œç£ç›˜ä¸Šçš„Segmentï¼Œæœ€åå°†ç»“æœåˆå¹¶åè¿”å›ã€‚è¿™ç§æŸ¥è¯¢æ˜¯è¿‘å®æ—¶ï¼ˆNear Real Timeï¼‰çš„ï¼Œä¸»è¦æ˜¯ç”±äºå†…å­˜ä¸­çš„Indexæ•°æ®éœ€è¦ä¸€æ®µæ—¶é—´åæ‰ä¼šåˆ·æ–°ä¸ºSegmentã€‚</p>
<p>å¯¹äºGetç±»è¯·æ±‚ï¼ŒæŸ¥è¯¢çš„æ—¶å€™æ˜¯å…ˆæŸ¥è¯¢å†…å­˜ä¸­çš„TransLogï¼Œå¦‚æœæ‰¾åˆ°å°±ç«‹å³è¿”å›ï¼Œå¦‚æœæ²¡æ‰¾åˆ°å†æŸ¥è¯¢ç£ç›˜ä¸Šçš„TransLogï¼Œå¦‚æœè¿˜æ²¡æœ‰åˆ™å†å»æŸ¥è¯¢ç£ç›˜ä¸Šçš„Segmentã€‚è¿™ç§æŸ¥è¯¢æ˜¯å®æ—¶ï¼ˆReal Timeï¼‰çš„ã€‚è¿™ç§æŸ¥è¯¢é¡ºåºå¯ä»¥ä¿è¯æŸ¥è¯¢åˆ°çš„Docæ˜¯æœ€æ–°ç‰ˆæœ¬çš„Docï¼Œè¿™ä¸ªåŠŸèƒ½ä¹Ÿæ˜¯ä¸ºäº†ä¿è¯NoSQLåœºæ™¯ä¸‹çš„å®æ—¶æ€§è¦æ±‚ã€‚</p>
<p><img src="https://i.imgur.com/HV3mnwG.png"></p>
<p>æ‰€æœ‰çš„æœç´¢ç³»ç»Ÿä¸€èˆ¬éƒ½æ˜¯ä¸¤é˜¶æ®µæŸ¥è¯¢ï¼Œç¬¬ä¸€é˜¶æ®µæŸ¥è¯¢åˆ°åŒ¹é…çš„DocIDï¼Œç¬¬äºŒé˜¶æ®µå†æŸ¥è¯¢DocIDå¯¹åº”çš„å®Œæ•´æ–‡æ¡£ï¼Œè¿™ç§åœ¨Elasticsearchä¸­ç§°ä¸ºquery_then_fetchï¼Œè¿˜æœ‰ä¸€ç§æ˜¯ä¸€é˜¶æ®µæŸ¥è¯¢çš„æ—¶å€™å°±è¿”å›å®Œæ•´Docï¼Œåœ¨Elasticsearchä¸­ç§°ä½œquery_and_fetchï¼Œä¸€èˆ¬ç¬¬äºŒç§é€‚ç”¨äºåªéœ€è¦æŸ¥è¯¢ä¸€ä¸ªShardçš„è¯·æ±‚ã€‚</p>
<p>é™¤äº†ä¸€é˜¶æ®µï¼Œä¸¤é˜¶æ®µå¤–ï¼Œè¿˜æœ‰ä¸€ç§ä¸‰é˜¶æ®µæŸ¥è¯¢çš„æƒ…å†µã€‚æœç´¢é‡Œé¢æœ‰ä¸€ç§ç®—åˆ†é€»è¾‘æ˜¯æ ¹æ®TFï¼ˆTerm Frequencyï¼‰å’ŒDFï¼ˆDocument Frequencyï¼‰è®¡ç®—åŸºç¡€åˆ†ï¼Œä½†æ˜¯Elasticsearchä¸­æŸ¥è¯¢çš„æ—¶å€™ï¼Œæ˜¯åœ¨æ¯ä¸ªShardä¸­ç‹¬ç«‹æŸ¥è¯¢çš„ï¼Œæ¯ä¸ªShardä¸­çš„TFå’ŒDFä¹Ÿæ˜¯ç‹¬ç«‹çš„ï¼Œè™½ç„¶åœ¨å†™å…¥çš„æ—¶å€™é€šè¿‡_routingä¿è¯Docåˆ†å¸ƒå‡åŒ€ï¼Œä½†æ˜¯æ²¡æ³•ä¿è¯TFå’ŒDFå‡åŒ€ï¼Œé‚£ä¹ˆå°±æœ‰ä¼šå¯¼è‡´å±€éƒ¨çš„TFå’ŒDFä¸å‡†çš„æƒ…å†µå‡ºç°ï¼Œè¿™ä¸ªæ—¶å€™åŸºäºTFã€DFçš„ç®—åˆ†å°±ä¸å‡†ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒElasticsearchä¸­å¼•å…¥äº†DFSæŸ¥è¯¢ï¼Œæ¯”å¦‚DFS_query_then_fetchï¼Œä¼šå…ˆæ”¶é›†æ‰€æœ‰Shardä¸­çš„TFå’ŒDFå€¼ï¼Œç„¶åå°†è¿™äº›å€¼å¸¦å…¥è¯·æ±‚ä¸­ï¼Œå†æ¬¡æ‰§è¡Œquery_then_fetchï¼Œè¿™æ ·ç®—åˆ†çš„æ—¶å€™TFå’ŒDFå°±æ˜¯å‡†ç¡®çš„ï¼Œç±»ä¼¼çš„æœ‰DFS_query_and_fetchã€‚è¿™ç§æŸ¥è¯¢çš„ä¼˜åŠ¿æ˜¯ç®—åˆ†æ›´åŠ ç²¾å‡†ï¼Œä½†æ˜¯æ•ˆç‡ä¼šå˜å·®ã€‚å¦ä¸€ç§é€‰æ‹©æ˜¯ç”¨BM25ä»£æ›¿TF&#x2F;DFæ¨¡å‹ã€‚</p>
<p>åœ¨æ–°ç‰ˆæœ¬Elasticsearchä¸­ï¼Œç”¨æˆ·æ²¡æ³•æŒ‡å®šDFS_query_and_fetchå’Œquery_and_fetchï¼Œè¿™ä¸¤ç§åªèƒ½è¢«Elasticsearchç³»ç»Ÿæ”¹å†™ã€‚</p>
<h3 id="ElasticsearchæŸ¥è¯¢æµç¨‹"><a href="#ElasticsearchæŸ¥è¯¢æµç¨‹" class="headerlink" title="ElasticsearchæŸ¥è¯¢æµç¨‹"></a>ElasticsearchæŸ¥è¯¢æµç¨‹</h3><p>Elasticsearchä¸­çš„å¤§éƒ¨åˆ†æŸ¥è¯¢ï¼Œä»¥åŠæ ¸å¿ƒåŠŸèƒ½éƒ½æ˜¯Searchç±»å‹æŸ¥è¯¢ï¼Œä¸Šé¢æˆ‘ä»¬äº†è§£åˆ°æŸ¥è¯¢åˆ†ä¸ºä¸€é˜¶æ®µï¼ŒäºŒé˜¶æ®µå’Œä¸‰é˜¶æ®µï¼Œè¿™é‡Œæˆ‘ä»¬å°±ä»¥æœ€å¸¸è§çš„çš„äºŒé˜¶æ®µæŸ¥è¯¢ä¸ºä¾‹æ¥ä»‹ç»æŸ¥è¯¢æµç¨‹ã€‚</p>
<p><img src="https://i.imgur.com/0dEOtB8.png"></p>
<h4 id="æ³¨å†ŒAction"><a href="#æ³¨å†ŒAction" class="headerlink" title="æ³¨å†ŒAction"></a>æ³¨å†ŒAction</h4><p>Elasticsearchä¸­ï¼ŒæŸ¥è¯¢å’Œå†™æ“ä½œä¸€æ ·éƒ½æ˜¯åœ¨ActionModule.javaä¸­æ³¨å†Œå…¥å£å¤„ç†å‡½æ•°çš„ã€‚</p>
<pre><code>registerHandler.accept(new RestSearchAction(settings, restController));
......
actions.register(SearchAction.INSTANCE, TransportSearchAction.class);
......
</code></pre>
<p>å¦‚æœè¯·æ±‚æ˜¯Restè¯·æ±‚ï¼Œåˆ™ä¼šåœ¨RestSearchActionä¸­è§£æè¯·æ±‚ï¼Œæ£€æŸ¥æŸ¥è¯¢ç±»å‹ï¼Œä¸èƒ½è®¾ç½®ä¸ºdfs_query_and_fetchæˆ–è€…query_and_fetchï¼Œè¿™ä¸¤ä¸ªç›®å‰åªèƒ½ç”¨äºElasticsearchä¸­çš„ä¼˜åŒ–åœºæ™¯ï¼Œç„¶åå°†è¯·æ±‚å‘ç»™åé¢çš„TransportSearchActionå¤„ç†ã€‚ç„¶åæ„é€ SearchRequestï¼Œå°†è¯·æ±‚å‘é€ç»™TransportSearchActionå¤„ç†ã€‚</p>
<p>å¦‚æœæ˜¯ç¬¬ä¸€é˜¶æ®µçš„Query Phaseè¯·æ±‚ï¼Œåˆ™ä¼šè°ƒç”¨SearchServiceçš„executeQueryPhaseæ–¹æ³•ã€‚</p>
<p>å¦‚æœæ˜¯ç¬¬äºŒé˜¶æ®µçš„Fetch Phaseè¯·æ±‚ï¼Œåˆ™ä¼šè°ƒç”¨SearchServiceçš„executeFetchPhaseæ–¹æ³•ã€‚</p>
<h4 id="Client-Node"><a href="#Client-Node" class="headerlink" title="Client Node"></a>Client Node</h4><p>Client Node ä¹ŸåŒ…æ‹¬äº†å‰é¢è¯´è¿‡çš„Parse Requestï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°äº†ï¼Œæ¥ä¸‹æ¥çœ‹ä¸€ä¸‹å…¶ä»–çš„éƒ¨åˆ†ã€‚</p>
<ol>
<li>Get Remove Cluster Shard</li>
</ol>
<p>åˆ¤æ–­æ˜¯å¦éœ€è¦è·¨é›†ç¾¤è®¿é—®ï¼Œå¦‚æœéœ€è¦ï¼Œåˆ™è·å–åˆ°è¦è®¿é—®çš„Shardåˆ—è¡¨ã€‚</p>
<ol start="2">
<li>Get Search Shard Iterator</li>
</ol>
<p>è·å–å½“å‰Clusterä¸­è¦è®¿é—®çš„Shardï¼Œå’Œä¸Šä¸€æ­¥ä¸­çš„Remove Cluster Shardåˆå¹¶ï¼Œæ„å»ºå‡ºæœ€ç»ˆè¦è®¿é—®çš„å®Œæ•´Shardåˆ—è¡¨ã€‚</p>
<p>è¿™ä¸€æ­¥ä¸­ï¼Œä¼šæ ¹æ®Requestè¯·æ±‚ä¸­çš„å‚æ•°ä»Primary Nodeå’Œå¤šä¸ªReplica Nodeä¸­é€‰æ‹©å‡ºä¸€ä¸ªè¦è®¿é—®çš„Shardã€‚</p>
<ol start="3">
<li>For Every Shard:Perform</li>
</ol>
<p>éå†æ¯ä¸ªShardï¼Œå¯¹æ¯ä¸ªShardæ‰§è¡Œåé¢é€»è¾‘ã€‚</p>
<ol start="4">
<li>Send Request To Query Shard</li>
</ol>
<p>å°†æŸ¥è¯¢é˜¶æ®µè¯·æ±‚å‘é€ç»™ç›¸åº”çš„Shardã€‚</p>
<ol start="5">
<li>Merge Docs</li>
</ol>
<p>ä¸Šä¸€æ­¥å°†è¯·æ±‚å‘é€ç»™å¤šä¸ªShardåï¼Œè¿™ä¸€æ­¥å°±æ˜¯å¼‚æ­¥ç­‰å¾…è¿”å›ç»“æœï¼Œç„¶åå¯¹ç»“æœåˆå¹¶ã€‚è¿™é‡Œçš„åˆå¹¶ç­–ç•¥æ˜¯ç»´æŠ¤ä¸€ä¸ªTop Nå¤§å°çš„ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼Œæ¯å½“æ”¶åˆ°ä¸€ä¸ªshardçš„è¿”å›ï¼Œå°±æŠŠç»“æœæ”¾å…¥ä¼˜å…ˆçº§é˜Ÿåˆ—åšä¸€æ¬¡æ’åºï¼Œç›´åˆ°æ‰€æœ‰çš„Shardéƒ½è¿”å›ã€‚</p>
<p>ç¿»é¡µé€»è¾‘ä¹Ÿæ˜¯åœ¨è¿™é‡Œï¼Œå¦‚æœéœ€è¦å–Top 30~ Top 40çš„ç»“æœï¼Œè¿™ä¸ªçš„æ„æ€æ˜¯æ‰€æœ‰ShardæŸ¥è¯¢ç»“æœä¸­çš„ç¬¬30åˆ°40çš„ç»“æœï¼Œé‚£ä¹ˆåœ¨æ¯ä¸ªShardä¸­æ— æ³•ç¡®å®šæœ€ç»ˆçš„ç»“æœï¼Œæ¯ä¸ªShardéœ€è¦è¿”å›Top 40çš„ç»“æœç»™Client Nodeï¼Œç„¶åClient Nodeä¸­åœ¨merge docsçš„æ—¶å€™ï¼Œè®¡ç®—å‡ºTop 40çš„ç»“æœï¼Œæœ€åå†å»é™¤æ‰Top 30ï¼Œå‰©ä½™çš„10ä¸ªç»“æœå°±æ˜¯éœ€è¦çš„Top 30~ Top 40çš„ç»“æœã€‚</p>
<p>ä¸Šè¿°ç¿»é¡µé€»è¾‘æœ‰ä¸€ä¸ªæ˜æ˜¾çš„ç¼ºç‚¹å°±æ˜¯æ¯æ¬¡Shardè¿”å›çš„æ•°æ®ä¸­åŒ…æ‹¬äº†å·²ç»ç¿»è¿‡çš„å†å²ç»“æœï¼Œå¦‚æœç¿»é¡µå¾ˆæ·±ï¼Œåˆ™åœ¨è¿™é‡Œéœ€è¦æ’åºçš„Docsä¼šå¾ˆå¤šï¼Œæ¯”å¦‚Shardæœ‰1000ï¼Œå–ç¬¬9990åˆ°10000çš„ç»“æœï¼Œé‚£ä¹ˆè¿™æ¬¡æŸ¥è¯¢ï¼ŒShardæ€»å…±éœ€è¦è¿”å›1000 * 10000ï¼Œä¹Ÿå°±æ˜¯ä¸€åƒä¸‡Docï¼Œè¿™ç§æƒ…å†µå¾ˆå®¹æ˜“å¯¼è‡´OOMã€‚</p>
<p>å¦ä¸€ç§ç¿»é¡µæ–¹å¼æ˜¯ä½¿ç”¨search_afterï¼Œè¿™ç§æ–¹å¼ä¼šæ›´è½»é‡çº§ï¼Œå¦‚æœæ¯æ¬¡åªéœ€è¦è¿”å›10æ¡ç»“æ„ï¼Œåˆ™æ¯ä¸ªShardåªéœ€è¦è¿”å›search_afterä¹‹åçš„10ä¸ªç»“æœå³å¯ï¼Œè¿”å›çš„æ€»æ•°æ®é‡åªæ˜¯å’ŒShardä¸ªæ•°ä»¥åŠæœ¬æ¬¡éœ€è¦çš„ä¸ªæ•°æœ‰å…³ï¼Œå’Œå†å²å·²è¯»å–çš„ä¸ªæ•°æ— å…³ã€‚è¿™ç§æ–¹å¼æ›´å®‰å…¨ä¸€äº›ï¼Œæ¨èä½¿ç”¨è¿™ç§ã€‚</p>
<p>å¦‚æœæœ‰aggregateï¼Œä¹Ÿä¼šåœ¨è¿™é‡Œåšèšåˆï¼Œä½†æ˜¯ä¸åŒçš„aggregateç±»å‹çš„mergeç­–ç•¥ä¸ä¸€æ ·ï¼Œå…·ä½“çš„å¯ä»¥åœ¨åé¢çš„aggregateæ–‡ç« ä¸­å†ä»‹ç»ã€‚</p>
<ol start="6">
<li>Send Request To Fetch Shard</li>
</ol>
<p>é€‰å‡ºTop Nä¸ªDoc IDåå‘é€ç»™è¿™äº›Doc IDæ‰€åœ¨çš„Shardæ‰§è¡ŒFetch Phaseï¼Œæœ€åä¼šè¿”å›Top Nçš„Docçš„å†…å®¹ã€‚</p>
<h4 id="Query-Phase"><a href="#Query-Phase" class="headerlink" title="Query Phase"></a>Query Phase</h4><p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ç¬¬ä¸€é˜¶æ®µæŸ¥è¯¢çš„æ­¥éª¤ï¼š</p>
<ol>
<li>Create Search Context</li>
</ol>
<p>åˆ›å»ºSearch Contextï¼Œä¹‹åSearchè¿‡ç¨‹ä¸­çš„æ‰€æœ‰ä¸­é—´çŠ¶æ€éƒ½ä¼šå­˜åœ¨Contextä¸­ï¼Œè¿™äº›çŠ¶æ€æ€»å…±æœ‰50å¤šä¸ªï¼Œå…·ä½“å¯ä»¥æŸ¥çœ‹DefaultSearchContextæˆ–è€…å…¶ä»–SearchContextçš„å­ç±»ã€‚</p>
<ol start="2">
<li>Parse Query</li>
</ol>
<p>è§£æQueryçš„Sourceï¼Œå°†ç»“æœå­˜å…¥Search Contextã€‚è¿™é‡Œä¼šæ ¹æ®è¯·æ±‚ä¸­Queryç±»å‹çš„ä¸åŒåˆ›å»ºä¸åŒçš„Queryå¯¹è±¡ï¼Œæ¯”å¦‚TermQueryã€FuzzyQueryç­‰ï¼Œæœ€ç»ˆçœŸæ­£æ‰§è¡ŒTermQueryã€FuzzyQueryç­‰è¯­ä¹‰çš„åœ°æ–¹æ˜¯åœ¨Luceneä¸­ã€‚</p>
<p>è¿™é‡ŒåŒ…æ‹¬äº†dfsPhaseã€queryPhaseå’ŒfetchPhaseä¸‰ä¸ªé˜¶æ®µçš„preProcesséƒ¨åˆ†ï¼Œåªæœ‰queryPhaseçš„preProcessä¸­æœ‰æ‰§è¡Œé€»è¾‘ï¼Œå…¶ä»–ä¸¤ä¸ªéƒ½æ˜¯ç©ºé€»è¾‘ï¼Œæ‰§è¡Œå®ŒpreProcessåï¼Œæ‰€æœ‰éœ€è¦çš„å‚æ•°éƒ½ä¼šè®¾ç½®å®Œæˆã€‚</p>
<p>ç”±äºElasticsearchä¸­æœ‰äº›è¯·æ±‚ä¹‹é—´æ˜¯ç›¸äº’å…³è”çš„ï¼Œå¹¶éç‹¬ç«‹çš„ï¼Œæ¯”å¦‚scrollè¯·æ±‚ï¼Œæ‰€ä»¥è¿™é‡ŒåŒæ—¶ä¼šè®¾ç½®Contextçš„ç”Ÿå‘½å‘¨æœŸã€‚</p>
<p>åŒæ—¶ä¼šè®¾ç½®lowLevelCancellationæ˜¯å¦æ‰“å¼€ï¼Œè¿™ä¸ªå‚æ•°æ˜¯é›†ç¾¤çº§åˆ«é…ç½®ï¼ŒåŒæ—¶ä¹Ÿèƒ½åŠ¨æ€å¼€å…³ï¼Œæ‰“å¼€åä¼šåœ¨åé¢æ‰§è¡Œæ—¶åšæ›´å¤šçš„æ£€æµ‹ï¼Œæ£€æµ‹æ˜¯å¦éœ€è¦åœæ­¢åç»­é€»è¾‘ç›´æ¥è¿”å›ã€‚</p>
<ol start="3">
<li>Get From Cache</li>
</ol>
<p>åˆ¤æ–­è¯·æ±‚æ˜¯å¦å…è®¸è¢«Cacheï¼Œå¦‚æœå…è®¸ï¼Œåˆ™æ£€æŸ¥Cacheä¸­æ˜¯å¦å·²ç»æœ‰ç»“æœï¼Œå¦‚æœæœ‰åˆ™ç›´æ¥è¯»å–Cacheï¼Œå¦‚æœæ²¡æœ‰åˆ™ç»§ç»­æ‰§è¡Œåç»­æ­¥éª¤ï¼Œæ‰§è¡Œå®Œåï¼Œå†å°†ç»“æœåŠ å…¥Cacheã€‚</p>
<ol start="4">
<li>Add Collectors</li>
</ol>
<p>Collectorä¸»è¦ç›®æ ‡æ˜¯æ”¶é›†æŸ¥è¯¢ç»“æœï¼Œå®ç°æ’åºï¼Œå¯¹è‡ªå®šä¹‰ç»“æœé›†è¿‡æ»¤å’Œæ”¶é›†ç­‰ã€‚è¿™ä¸€æ­¥ä¼šå¢åŠ å¤šä¸ªCollectorsï¼Œå¤šä¸ªCollectorç»„æˆä¸€ä¸ªListã€‚</p>
<ol>
<li><p>FilteredCollectorï¼šå…ˆåˆ¤æ–­è¯·æ±‚ä¸­æ˜¯å¦æœ‰Post Filterï¼ŒPost Filterç”¨äºSearchï¼ŒAggç­‰ç»“æŸåå†æ¬¡å¯¹ç»“æœåšFilterï¼Œå¸Œæœ›Filterä¸å½±å“Aggç»“æœã€‚å¦‚æœæœ‰Post Filteråˆ™åˆ›å»ºä¸€ä¸ªFilteredCollectorï¼ŒåŠ å…¥Collector Listä¸­ã€‚</p>
</li>
<li><p>PluginInMultiCollectorï¼šåˆ¤æ–­è¯·æ±‚ä¸­æ˜¯å¦åˆ¶å®šäº†è‡ªå®šä¹‰çš„ä¸€äº›Collectorï¼Œå¦‚æœæœ‰ï¼Œåˆ™åˆ›å»ºååŠ å…¥Collector Listã€‚</p>
</li>
<li><p>MinimumScoreCollectorï¼šåˆ¤æ–­è¯·æ±‚ä¸­æ˜¯å¦åˆ¶å®šäº†æœ€å°åˆ†æ•°é˜ˆå€¼ï¼Œå¦‚æœæŒ‡å®šäº†ï¼Œåˆ™åˆ›å»ºMinimumScoreCollectoråŠ å…¥Collector Listä¸­ï¼Œåœ¨åç»­æ”¶é›†ç»“æœæ—¶ï¼Œä¼šè¿‡æ»¤æ‰å¾—åˆ†å°äºæœ€å°åˆ†æ•°çš„Docã€‚</p>
</li>
<li><p>EarlyTerminatingCollectorï¼šåˆ¤æ–­è¯·æ±‚ä¸­æ˜¯å¦æå‰ç»“æŸDocçš„Seekï¼Œå¦‚æœæ˜¯åˆ™åˆ›å»ºEarlyTerminatingCollectorï¼ŒåŠ å…¥Collector Listä¸­ã€‚åœ¨åç»­Seekå’Œæ”¶é›†Docçš„è¿‡ç¨‹ä¸­ï¼Œå½“Seekçš„Docæ•°è¾¾åˆ°Early Terminatingåä¼šåœæ­¢Seekåç»­å€’æ’é“¾ã€‚</p>
</li>
<li><p>CancellableCollectorï¼šåˆ¤æ–­å½“å‰æ“ä½œæ˜¯å¦å¯ä»¥è¢«ä¸­æ–­ç»“æŸï¼Œæ¯”å¦‚æ˜¯å¦å·²ç»è¶…æ—¶ç­‰ï¼Œå¦‚æœæ˜¯ä¼šæŠ›å‡ºä¸€ä¸ªTaskCancelledExceptionå¼‚å¸¸ã€‚è¯¥åŠŸèƒ½ä¸€èˆ¬ç”¨æ¥æå‰ç»“æŸè¾ƒé•¿çš„æŸ¥è¯¢è¯·æ±‚ï¼Œå¯ä»¥ç”¨æ¥ä¿æŠ¤ç³»ç»Ÿã€‚</p>
</li>
<li><p>EarlyTerminatingSortingCollectorï¼šå¦‚æœIndexæ˜¯æ’åºçš„ï¼Œé‚£ä¹ˆå¯ä»¥æå‰ç»“æŸå¯¹å€’æ’é“¾çš„Seekï¼Œç›¸å½“äºåœ¨ä¸€ä¸ªæ’åºé€’å‡é“¾è¡¨ä¸Šè¿”å›æœ€å¤§çš„Nä¸ªå€¼ï¼Œåªéœ€è¦ç›´æ¥è¿”å›å‰Nä¸ªå€¼å°±å¯ä»¥äº†ã€‚è¿™ä¸ªCollectorä¼šåŠ åˆ°Collector Listçš„å¤´éƒ¨ã€‚EarlyTerminatingSortingå’ŒEarlyTerminatingçš„åŒºåˆ«æ˜¯ï¼ŒEarlyTerminatingSortingæ˜¯ä¸€ç§å¯¹ç»“æœæ— æŸä¼¤çš„ä¼˜åŒ–ï¼Œè€ŒEarlyTerminatingæ˜¯æœ‰æŸçš„ï¼Œäººä¸ºææ–­æ‰§è¡Œçš„ä¼˜åŒ–ã€‚</p>
</li>
<li><p>TopDocsCollectorï¼šè¿™ä¸ªæ˜¯æœ€æ ¸å¿ƒçš„Top Nç»“æœé€‰æ‹©å™¨ï¼Œä¼šåŠ å…¥åˆ°Collector Listçš„å¤´éƒ¨ã€‚TopScoreDocCollectorå’ŒTopFieldCollectoréƒ½æ˜¯TopDocsCollectorçš„å­ç±»ï¼ŒTopScoreDocCollectorä¼šæŒ‰ç…§å›ºå®šçš„æ–¹å¼ç®—åˆ†ï¼Œæ’åºä¼šæŒ‰ç…§åˆ†æ•°+doc idçš„æ–¹å¼æ’åˆ—ï¼Œå¦‚æœå¤šä¸ªdocçš„åˆ†æ•°ä¸€æ ·ï¼Œå…ˆé€‰æ‹©doc idå°çš„æ–‡æ¡£ã€‚è€ŒTopFieldCollectoråˆ™æ˜¯æ ¹æ®ç”¨æˆ·æŒ‡å®šçš„Fieldçš„å€¼æ’åºã€‚</p>
</li>
<li><p>lucene::search</p>
</li>
</ol>
<p>è¿™ä¸€æ­¥ä¼šè°ƒç”¨Luceneä¸­IndexSearchçš„searchæ¥å£ï¼Œæ‰§è¡ŒçœŸæ­£çš„æœç´¢é€»è¾‘ã€‚æ¯ä¸ªShardä¸­ä¼šæœ‰å¤šä¸ªSegmentï¼Œæ¯ä¸ªSegmentå¯¹åº”ä¸€ä¸ªLeafReaderContextï¼Œè¿™é‡Œä¼šéå†æ¯ä¸ªSegmentï¼Œåˆ°æ¯ä¸ªSegmentä¸­å»Searchç»“æœï¼Œç„¶åè®¡ç®—åˆ†æ•°ã€‚</p>
<p>æœç´¢é‡Œé¢ä¸€èˆ¬æœ‰ä¸¤é˜¶æ®µç®—åˆ†ï¼Œç¬¬ä¸€é˜¶æ®µæ˜¯åœ¨è¿™é‡Œç®—çš„ï¼Œä¼šå¯¹æ¯ä¸ªSeekåˆ°çš„Docéƒ½è®¡ç®—åˆ†æ•°ï¼Œä¸ºäº†å‡å°‘CPUæ¶ˆè€—ï¼Œä¸€èˆ¬æ˜¯ç®—ä¸€ä¸ªåŸºæœ¬åˆ†æ•°ã€‚è¿™ä¸€é˜¶æ®µå®Œæˆåï¼Œä¼šæœ‰ä¸ªæ’åºã€‚ç„¶ååœ¨ç¬¬äºŒé˜¶æ®µï¼Œå†å¯¹Top çš„ç»“æœåšä¸€æ¬¡äºŒé˜¶æ®µç®—åˆ†ï¼Œåœ¨äºŒé˜¶æ®µç®—åˆ†çš„æ—¶å€™ä¼šè€ƒè™‘æ›´å¤šçš„å› å­ã€‚äºŒé˜¶æ®µç®—åˆ†åœ¨åç»­æ“ä½œä¸­ã€‚</p>
<p>å…·ä½“è¯·æ±‚ï¼Œæ¯”å¦‚TermQueryã€WildcardQueryçš„æŸ¥è¯¢é€»è¾‘éƒ½åœ¨Luceneä¸­ï¼Œåé¢ä¼šæœ‰ä¸“é—¨æ–‡ç« ä»‹ç»ã€‚</p>
<ol start="6">
<li>rescore</li>
</ol>
<p>æ ¹æ®Requestä¸­æ˜¯å¦åŒ…å«rescoreé…ç½®å†³å®šæ˜¯å¦è¿›è¡ŒäºŒé˜¶æ®µæ’åºï¼Œå¦‚æœæœ‰åˆ™æ‰§è¡ŒäºŒé˜¶æ®µç®—åˆ†é€»è¾‘ï¼Œä¼šè€ƒè™‘æ›´å¤šçš„ç®—åˆ†å› å­ã€‚äºŒé˜¶æ®µç®—åˆ†ä¹Ÿæ˜¯ä¸€ç§è®¡ç®—æœºä¸­å¸¸è§çš„å¤šå±‚è®¾è®¡ï¼Œæ˜¯ä¸€ç§èµ„æºæ¶ˆè€—å’Œæ•ˆç‡çš„æŠ˜ä¸­ã€‚</p>
<p>Elasticsearchä¸­æ”¯æŒé…ç½®å¤šä¸ªRescoreï¼Œè¿™äº›rescoreé€»è¾‘ä¼šé¡ºåºéå†æ‰§è¡Œã€‚æ¯ä¸ªrescoreå†…éƒ¨ä¼šå…ˆæŒ‰ç…§è¯·æ±‚å‚æ•°windowé€‰æ‹©å‡ºTop windowçš„docï¼Œç„¶åå¯¹è¿™äº›docæ’åºï¼Œæ’å®Œåå†åˆå¹¶å›åŸæœ‰çš„Top ç»“æœé¡ºåºä¸­ã€‚</p>
<ol start="7">
<li>suggest::execute()</li>
</ol>
<p>å¦‚æœæœ‰æ¨èè¯·æ±‚ï¼Œåˆ™åœ¨è¿™é‡Œæ‰§è¡Œæ¨èè¯·æ±‚ã€‚å¦‚æœè¯·æ±‚ä¸­åªåŒ…å«äº†æ¨èçš„éƒ¨åˆ†ï¼Œåˆ™å¾ˆå¤šåœ°æ–¹å¯ä»¥ä¼˜åŒ–ã€‚æ¨èä¸æ˜¯ä»Šå¤©çš„é‡ç‚¹ï¼Œè¿™é‡Œå°±ä¸ä»‹ç»äº†ï¼Œåé¢æœ‰æœºä¼šå†ä»‹ç»ã€‚</p>
<ol start="8">
<li>aggregation::execute()</li>
</ol>
<p>å¦‚æœå«æœ‰èšåˆç»Ÿè®¡è¯·æ±‚ï¼Œåˆ™åœ¨è¿™é‡Œæ‰§è¡Œã€‚Elasticsearchä¸­çš„aggregateçš„å¤„ç†é€»è¾‘ä¹Ÿç±»ä¼¼äºSearchï¼Œé€šè¿‡å¤šä¸ªCollectoræ¥å®ç°ã€‚åœ¨Client Nodeä¸­ä¹Ÿéœ€è¦å¯¹aggregationåšåˆå¹¶ã€‚aggregateé€»è¾‘æ›´å¤æ‚ä¸€äº›ï¼Œå°±ä¸åœ¨è¿™é‡Œèµ˜è¿°äº†ï¼Œåé¢æœ‰éœ€è¦å°±å†å•ç‹¬å¼€æ–‡ç« ä»‹ç»ã€‚</p>
<p>ä¸Šè¿°é€»è¾‘éƒ½æ‰§è¡Œå®Œæˆåï¼Œå¦‚æœå½“å‰æŸ¥è¯¢è¯·æ±‚åªéœ€è¦æŸ¥è¯¢ä¸€ä¸ªShardï¼Œé‚£ä¹ˆä¼šç›´æ¥åœ¨å½“å‰Nodeæ‰§è¡ŒFetch Phaseã€‚</p>
<h4 id="Fetch-Phase"><a href="#Fetch-Phase" class="headerlink" title="Fetch Phase"></a>Fetch Phase</h4><p>Elasticsearchä½œä¸ºæœç´¢ç³»ç»Ÿæ—¶ï¼Œæˆ–è€…ä»»ä½•æœç´¢ç³»ç»Ÿä¸­ï¼Œé™¤äº†Queryé˜¶æ®µå¤–ï¼Œè¿˜ä¼šæœ‰ä¸€ä¸ªFetché˜¶æ®µï¼Œè¿™ä¸ªFetché˜¶æ®µåœ¨æ•°æ®åº“ç±»ç³»ç»Ÿä¸­æ˜¯æ²¡æœ‰çš„ï¼Œæ˜¯æœç´¢ç³»ç»Ÿä¸­é¢å¤–å¢åŠ çš„é˜¶æ®µã€‚æœç´¢ç³»ç»Ÿä¸­é¢å¤–å¢åŠ Fetché˜¶æ®µçš„åŸå› æ˜¯æœç´¢ç³»ç»Ÿä¸­æ•°æ®åˆ†å¸ƒå¯¼è‡´çš„ï¼Œåœ¨æœç´¢ä¸­ï¼Œæ•°æ®é€šè¿‡routingåˆ†Shardçš„æ—¶å€™ï¼Œåªèƒ½æ ¹æ®ä¸€ä¸ªä¸»å­—æ®µå€¼æ¥å†³å®šï¼Œä½†æ˜¯æŸ¥è¯¢çš„æ—¶å€™å¯èƒ½ä¼šæ ¹æ®å…¶ä»–éä¸»å­—æ®µæŸ¥è¯¢ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™æ‰€æœ‰Shardä¸­éƒ½å¯èƒ½ä¼šå­˜åœ¨ç›¸åŒéä¸»å­—æ®µå€¼çš„Docï¼Œæ‰€ä»¥éœ€è¦æŸ¥è¯¢æ‰€æœ‰Shardæ‰èƒ½ä¸ä¼šå‡ºç°ç»“æœé—æ¼ã€‚åŒæ—¶å¦‚æœæŸ¥è¯¢ä¸»å­—æ®µï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™å°±èƒ½ç›´æ¥å®šä½åˆ°Shardï¼Œå°±åªéœ€è¦æŸ¥è¯¢ç‰¹å®šShardå³å¯ï¼Œè¿™ä¸ªæ—¶å€™å°±ç±»ä¼¼äºæ•°æ®åº“ç³»ç»Ÿäº†ã€‚å¦å¤–ï¼Œæ•°æ®åº“ä¸­çš„äºŒçº§ç´¢å¼•åˆæ˜¯å¦å¤–ä¸€ç§æƒ…å†µï¼Œä½†ç±»ä¼¼äºæŸ¥ä¸»å­—æ®µçš„æƒ…å†µï¼Œè¿™é‡Œå°±ä¸å¤šè¯´äº†ã€‚</p>
<p>åŸºäºä¸Šè¿°åŸå› ï¼Œç¬¬ä¸€é˜¶æ®µæŸ¥è¯¢çš„æ—¶å€™å¹¶ä¸çŸ¥é“æœ€ç»ˆç»“æœä¼šåœ¨å“ªä¸ªShardä¸Šï¼Œæ‰€ä»¥æ¯ä¸ªShardä¸­ç®¡éƒ½éœ€è¦æŸ¥è¯¢å®Œæ•´ç»“æœï¼Œæ¯”å¦‚éœ€è¦Top 10ï¼Œé‚£ä¹ˆæ¯ä¸ªShardéƒ½éœ€è¦æŸ¥è¯¢å½“å‰Shardçš„æ‰€æœ‰æ•°æ®ï¼Œæ‰¾å‡ºå½“å‰Shardçš„Top 10ï¼Œç„¶åè¿”å›ç»™Client Nodeã€‚å¦‚æœæœ‰100ä¸ªShardï¼Œé‚£ä¹ˆå°±éœ€è¦è¿”å›100 * 10 &#x3D; 1000ä¸ªç»“æœï¼Œè€ŒFetch Docå†…å®¹çš„æ“ä½œæ¯”è¾ƒè€—è´¹IOå’ŒCPUï¼Œå¦‚æœåœ¨ç¬¬ä¸€é˜¶æ®µå°±Fetch Docï¼Œé‚£ä¹ˆè¿™ä¸ªèµ„æºå¼€é”€å°±ä¼šéå¸¸å¤§ã€‚æ‰€ä»¥ï¼Œä¸€èˆ¬æ˜¯å½“Client Nodeé€‰æ‹©å‡ºæœ€ç»ˆTop Nçš„ç»“æœåï¼Œå†å¯¹æœ€ç»ˆçš„Top Nè¯»å–Docå†…å®¹ã€‚é€šè¿‡å¢åŠ ä¸€ç‚¹ç½‘ç»œå¼€é”€è€Œé¿å…å¤§é‡IOå’ŒCPUæ“ä½œï¼Œè¿™ä¸ªæŠ˜ä¸­æ˜¯éå¸¸åˆ’ç®—çš„ã€‚</p>
<p>Fetché˜¶æ®µçš„ç›®çš„æ˜¯é€šè¿‡DocIDè·å–åˆ°ç”¨æˆ·éœ€è¦çš„å®Œæ•´Docå†…å®¹ã€‚è¿™äº›å†…å®¹åŒ…æ‹¬äº†DocValuesï¼ŒStoreï¼ŒSourceï¼ŒScriptå’ŒHighlightç­‰ï¼Œå…·ä½“çš„åŠŸèƒ½ç‚¹æ˜¯åœ¨SearchModuleä¸­æ³¨å†Œçš„ï¼Œç³»ç»Ÿé»˜è®¤æ³¨å†Œçš„æœ‰ï¼š</p>
<ul>
<li>ExplainFetchSubPhase</li>
<li>DocValueFieldsFetchSubPhase</li>
<li>ScriptFieldsFetchSubPhase</li>
<li>FetchSourceSubPhase</li>
<li>VersionFetchSubPhase</li>
<li>MatchedQueriesFetchSubPhase</li>
<li>HighlightPhase</li>
<li>ParentFieldSubFetchPhase</li>
</ul>
<p>é™¤äº†ç³»ç»Ÿé»˜è®¤çš„8ç§å¤–ï¼Œè¿˜æœ‰é€šè¿‡æ’ä»¶çš„å½¢å¼æ³¨å†Œè‡ªå®šä¹‰çš„åŠŸèƒ½ï¼Œè¿™äº›SubPhaseä¸­æœ€é‡è¦çš„æ˜¯Sourceå’ŒHighlightï¼ŒSourceæ˜¯åŠ è½½åŸæ–‡ï¼ŒHighlightæ˜¯è®¡ç®—é«˜äº®æ˜¾ç¤ºçš„å†…å®¹ç‰‡æ–­ã€‚</p>
<p>ä¸Šè¿°å¤šä¸ªSubPhaseä¼šé’ˆå¯¹æ¯ä¸ªDocé¡ºåºæ‰§è¡Œï¼Œå¯èƒ½ä¼šäº§ç”Ÿå¤šæ¬¡çš„éšæœºIOï¼Œè¿™é‡Œä¼šæœ‰ä¸€äº›ä¼˜åŒ–æ–¹æ¡ˆï¼Œä½†æ˜¯éƒ½æ˜¯é’ˆå¯¹ç‰¹å®šåœºæ™¯çš„ï¼Œä¸å…·æœ‰é€šç”¨æ€§ã€‚</p>
<p>Fetch Phaseæ‰§è¡Œå®Œåï¼Œæ•´ä¸ªæŸ¥è¯¢æµç¨‹å°±ç»“æŸäº†ã€‚</p>
<h2 id="Elasticsearché›†ç¾¤å†™å…¥"><a href="#Elasticsearché›†ç¾¤å†™å…¥" class="headerlink" title="Elasticsearché›†ç¾¤å†™å…¥"></a>Elasticsearché›†ç¾¤å†™å…¥</h2><p>ï¼ˆå…¨æ–‡è½¬è½½è‡ª <a href="https://zhuanlan.zhihu.com/p/34669354">Elasticsearchå†…æ ¸è§£æ - å†™å…¥ç¯‡</a>ï¼‰</p>
<h3 id="å†™æ“ä½œ"><a href="#å†™æ“ä½œ" class="headerlink" title="å†™æ“ä½œ"></a>å†™æ“ä½œ</h3><ul>
<li>å®æ—¶æ€§ï¼š<ul>
<li>æœç´¢ç³»ç»Ÿçš„Indexä¸€èˆ¬éƒ½æ˜¯NRTï¼ˆNear Real Timeï¼‰ï¼Œè¿‘å®æ—¶çš„ï¼Œæ¯”å¦‚Elasticsearchä¸­ï¼ŒIndexçš„å®æ—¶æ€§æ˜¯ç”±refreshæ§åˆ¶çš„ï¼Œé»˜è®¤æ˜¯1sï¼Œæœ€å¿«å¯åˆ°100msï¼Œé‚£ä¹ˆä¹Ÿå°±æ„å‘³ç€Index docæˆåŠŸåï¼Œéœ€è¦ç­‰å¾…ä¸€ç§’é’Ÿåæ‰å¯ä»¥è¢«æœç´¢åˆ°ã€‚</li>
<li>NoSQLæ•°æ®åº“çš„WriteåŸºæœ¬éƒ½æ˜¯RTï¼ˆReal Timeï¼‰ï¼Œå®æ—¶çš„ï¼Œå†™å…¥æˆåŠŸåï¼Œç«‹å³æ˜¯å¯è§çš„ã€‚Elasticsearchä¸­çš„Indexè¯·æ±‚ä¹Ÿèƒ½ä¿è¯æ˜¯å®æ—¶çš„ï¼Œå› ä¸ºGetè¯·æ±‚ä¼šç›´æ¥è¯»å†…å­˜ä¸­å°šæœªFlushåˆ°å­˜å‚¨ä»‹è´¨çš„TransLogã€‚</li>
</ul>
</li>
<li>å¯é æ€§ï¼š<ul>
<li>æœç´¢ç³»ç»Ÿå¯¹å¯é æ€§è¦æ±‚éƒ½ä¸é«˜ï¼Œä¸€èˆ¬æ•°æ®çš„å¯é æ€§é€šè¿‡å°†åŸå§‹æ•°æ®å­˜å‚¨åœ¨å¦ä¸€ä¸ªå­˜å‚¨ç³»ç»Ÿæ¥ä¿è¯ï¼Œå½“æœç´¢ç³»ç»Ÿçš„æ•°æ®å‘ç”Ÿä¸¢å¤±æ—¶ï¼Œå†ä»å…¶ä»–å­˜å‚¨ç³»ç»Ÿå¯¼ä¸€ä»½æ•°æ®è¿‡æ¥é‡æ–°rebuildå°±å¯ä»¥äº†ã€‚åœ¨Elasticsearchä¸­ï¼Œé€šè¿‡è®¾ç½®TransLogçš„Flushé¢‘ç‡å¯ä»¥æ§åˆ¶å¯é æ€§ï¼Œè¦ä¹ˆæ˜¯æŒ‰è¯·æ±‚ï¼Œæ¯æ¬¡è¯·æ±‚éƒ½Flushï¼›è¦ä¹ˆæ˜¯æŒ‰æ—¶é—´ï¼Œæ¯éš”ä¸€æ®µæ—¶é—´Flushä¸€æ¬¡ã€‚ä¸€èˆ¬ä¸ºäº†æ€§èƒ½è€ƒè™‘ï¼Œä¼šè®¾ç½®ä¸ºæ¯éš”5ç§’æˆ–è€…1åˆ†é’ŸFlushä¸€æ¬¡ï¼ŒFlushé—´éš”æ—¶é—´è¶Šé•¿ï¼Œå¯é æ€§å°±ä¼šè¶Šä½ã€‚</li>
<li>NoSQLæ•°æ®åº“ä½œä¸ºä¸€æ¬¾æ•°æ®åº“ï¼Œå¿…é¡»è¦æœ‰å¾ˆé«˜çš„å¯é æ€§ï¼Œæ•°æ®å¯é æ€§æ˜¯ç”Ÿå‘½åº•çº¿ï¼Œå†³ä¸èƒ½æœ‰é—ªå¤±ã€‚å¦‚æœæŠŠElasticsearchå½“åšNoSQLæ•°æ®åº“ï¼Œæ­¤æ—¶éœ€è¦è®¾ç½®TransLogçš„Flushç­–ç•¥ä¸ºæ¯ä¸ªè¯·æ±‚éƒ½è¦Flushï¼Œè¿™æ ·æ‰èƒ½ä¿è¯å½“å‰Shardå†™å…¥æˆåŠŸåï¼Œæ•°æ®èƒ½å°½é‡æŒä¹…åŒ–ä¸‹æ¥ã€‚</li>
</ul>
</li>
</ul>
<h3 id="å†™æ“ä½œçš„å…³é”®ç‚¹"><a href="#å†™æ“ä½œçš„å…³é”®ç‚¹" class="headerlink" title="å†™æ“ä½œçš„å…³é”®ç‚¹"></a>å†™æ“ä½œçš„å…³é”®ç‚¹</h3><p>åœ¨è€ƒè™‘æˆ–åˆ†æä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿçš„å†™æ“ä½œæ—¶ï¼Œä¸€èˆ¬éœ€è¦ä»ä¸‹é¢å‡ ä¸ªæ–¹é¢è€ƒè™‘ï¼š</p>
<ul>
<li>å¯é æ€§ï¼šæˆ–è€…æ˜¯æŒä¹…æ€§ï¼Œæ•°æ®å†™å…¥ç³»ç»ŸæˆåŠŸåï¼Œæ•°æ®ä¸ä¼šè¢«å›æ»šæˆ–ä¸¢å¤±ã€‚</li>
<li>ä¸€è‡´æ€§ï¼šæ•°æ®å†™å…¥æˆåŠŸåï¼Œå†æ¬¡æŸ¥è¯¢æ—¶å¿…é¡»èƒ½ä¿è¯è¯»å–åˆ°æœ€æ–°ç‰ˆæœ¬çš„æ•°æ®ï¼Œä¸èƒ½è¯»å–åˆ°æ—§æ•°æ®ã€‚</li>
<li>åŸå­æ€§ï¼šä¸€ä¸ªå†™å…¥æˆ–è€…æ›´æ–°æ“ä½œï¼Œè¦ä¹ˆå®Œå…¨æˆåŠŸï¼Œè¦ä¹ˆå®Œå…¨å¤±è´¥ï¼Œä¸å…è®¸å‡ºç°ä¸­é—´çŠ¶æ€ã€‚</li>
<li>éš”ç¦»æ€§ï¼šå¤šä¸ªå†™å…¥æ“ä½œç›¸äº’ä¸å½±å“ã€‚</li>
<li>å®æ—¶æ€§ï¼šå†™å…¥åæ˜¯å¦å¯ä»¥ç«‹å³è¢«æŸ¥è¯¢åˆ°ã€‚</li>
<li>æ€§èƒ½ï¼šå†™å…¥æ€§èƒ½ï¼Œååé‡åˆ°åº•æ€ä¹ˆæ ·ã€‚</li>
</ul>
<p>Elasticsearchä½œä¸ºåˆ†å¸ƒå¼ç³»ç»Ÿï¼Œä¹Ÿéœ€è¦åœ¨å†™å…¥çš„æ—¶å€™æ»¡è¶³ä¸Šè¿°çš„å››ä¸ªç‰¹ç‚¹ï¼Œæˆ‘ä»¬åœ¨åé¢çš„å†™æµç¨‹ä»‹ç»ä¸­ä¼šæ¶‰åŠåˆ°ä¸Šè¿°å››ä¸ªæ–¹é¢ã€‚</p>
<p>æ¥ä¸‹æ¥,æˆ‘ä»¬ä¸€å±‚ä¸€å±‚å‰–æElasticsearchå†…éƒ¨çš„å†™æœºåˆ¶ã€‚</p>
<h3 id="Luceneçš„å†™"><a href="#Luceneçš„å†™" class="headerlink" title="Luceneçš„å†™"></a>Luceneçš„å†™</h3><p>ä¼—æ‰€å‘¨çŸ¥ï¼ŒElasticsearchå†…éƒ¨ä½¿ç”¨äº†Luceneå®Œæˆç´¢å¼•åˆ›å»ºå’Œæœç´¢åŠŸèƒ½ï¼ŒLuceneä¸­å†™æ“ä½œä¸»è¦æ˜¯é€šè¿‡IndexWriterç±»å®ç°ï¼ŒIndexWriteræä¾›ä¸‰ä¸ªæ¥å£ï¼š</p>
<pre><code> public long addDocument();
 public long updateDocuments();
 public long deleteDocuments();
</code></pre>
<p>é€šè¿‡è¿™ä¸‰ä¸ªæ¥å£å¯ä»¥å®Œæˆå•ä¸ªæ–‡æ¡£çš„å†™å…¥ï¼Œæ›´æ–°å’Œåˆ é™¤åŠŸèƒ½ï¼ŒåŒ…æ‹¬äº†åˆ†è¯ï¼Œå€’æ’åˆ›å»ºï¼Œæ­£æ’åˆ›å»ºç­‰ç­‰æ‰€æœ‰æœç´¢ç›¸å…³çš„æµç¨‹ã€‚åªè¦Docé€šè¿‡IndesWriterå†™å…¥åï¼Œåé¢å°±å¯ä»¥é€šè¿‡IndexSearcheræœç´¢äº†ï¼Œçœ‹èµ·æ¥åŠŸèƒ½å·²ç»å®Œå–„äº†ï¼Œä½†æ˜¯ä»ç„¶æœ‰ä¸€äº›é—®é¢˜æ²¡æœ‰è§£ï¼š</p>
<ol>
<li>ä¸Šè¿°æ“ä½œæ˜¯å•æœºçš„ï¼Œè€Œä¸æ˜¯æˆ‘ä»¬éœ€è¦çš„åˆ†å¸ƒå¼ã€‚</li>
<li>æ–‡æ¡£å†™å…¥Luceneåå¹¶ä¸æ˜¯ç«‹å³å¯æŸ¥è¯¢çš„ï¼Œéœ€è¦ç”Ÿæˆå®Œæ•´çš„Segmentåæ‰å¯è¢«æœç´¢ï¼Œå¦‚ä½•ä¿è¯å®æ—¶æ€§ï¼Ÿ</li>
<li>Luceneç”Ÿæˆçš„Segmentæ˜¯åœ¨å†…å­˜ä¸­ï¼Œå¦‚æœæœºå™¨å®•æœºæˆ–æ‰ç”µåï¼Œå†…å­˜ä¸­çš„Segmentä¼šä¸¢å¤±ï¼Œå¦‚ä½•ä¿è¯æ•°æ®å¯é æ€§ ï¼Ÿ</li>
<li>Luceneä¸æ”¯æŒéƒ¨åˆ†æ–‡æ¡£æ›´æ–°ï¼Œä½†æ˜¯è¿™åˆæ˜¯ä¸€ä¸ªå¼ºéœ€æ±‚ï¼Œå¦‚ä½•æ”¯æŒéƒ¨åˆ†æ›´æ–°ï¼Ÿ</li>
</ol>
<p>ä¸Šè¿°é—®é¢˜ï¼Œåœ¨Luceneä¸­æ˜¯æ²¡æœ‰è§£å†³çš„ï¼Œé‚£ä¹ˆå°±éœ€è¦Elasticsearchä¸­è§£å†³ä¸Šè¿°é—®é¢˜ã€‚</p>
<h3 id="Elasticsearchçš„å†™"><a href="#Elasticsearchçš„å†™" class="headerlink" title="Elasticsearchçš„å†™"></a>Elasticsearchçš„å†™</h3><p>Elasticsearché‡‡ç”¨å¤šShardæ–¹å¼ï¼Œé€šè¿‡é…ç½®routingè§„åˆ™å°†æ•°æ®åˆ†æˆå¤šä¸ªæ•°æ®å­é›†ï¼Œæ¯ä¸ªæ•°æ®å­é›†æä¾›ç‹¬ç«‹çš„ç´¢å¼•å’Œæœç´¢åŠŸèƒ½ã€‚å½“å†™å…¥æ–‡æ¡£çš„æ—¶å€™ï¼Œæ ¹æ®routingè§„åˆ™ï¼Œå°†æ–‡æ¡£å‘é€ç»™ç‰¹å®šShardä¸­å»ºç«‹ç´¢å¼•ã€‚è¿™æ ·å°±èƒ½å®ç°åˆ†å¸ƒå¼äº†ã€‚</p>
<p>æ­¤å¤–ï¼ŒElasticsearchæ•´ä½“æ¶æ„ä¸Šé‡‡ç”¨äº†ä¸€ä¸»å¤šå‰¯çš„æ–¹å¼ï¼š</p>
<p><img src="https://i.imgur.com/4letnXs.png"></p>
<p>æ¯ä¸ªIndexç”±å¤šä¸ªShardç»„æˆï¼Œæ¯ä¸ªShardæœ‰ä¸€ä¸ªä¸»èŠ‚ç‚¹å’Œå¤šä¸ªå‰¯æœ¬èŠ‚ç‚¹ï¼Œå‰¯æœ¬ä¸ªæ•°å¯é…ã€‚ä½†æ¯æ¬¡å†™å…¥çš„æ—¶å€™ï¼Œå†™å…¥è¯·æ±‚ä¼šå…ˆæ ¹æ®_routingè§„åˆ™é€‰æ‹©å‘ç»™å“ªä¸ªShardï¼ŒIndex Requestä¸­å¯ä»¥è®¾ç½®ä½¿ç”¨å“ªä¸ªFiledçš„å€¼ä½œä¸ºè·¯ç”±å‚æ•°ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®ï¼Œåˆ™ä½¿ç”¨Mappingä¸­çš„é…ç½®ï¼Œå¦‚æœmappingä¸­ä¹Ÿæ²¡æœ‰é…ç½®ï¼Œåˆ™ä½¿ç”¨_idä½œä¸ºè·¯ç”±å‚æ•°ï¼Œç„¶åé€šè¿‡_routingçš„Hashå€¼é€‰æ‹©å‡ºShardï¼ˆåœ¨OperationRoutingç±»ä¸­ï¼‰ï¼Œæœ€åä»é›†ç¾¤çš„Metaä¸­æ‰¾å‡ºå‡ºè¯¥Shardçš„PrimaryèŠ‚ç‚¹ã€‚</p>
<p>è¯·æ±‚æ¥ç€ä¼šå‘é€ç»™Primary Shardï¼Œåœ¨Primary Shardä¸Šæ‰§è¡ŒæˆåŠŸåï¼Œå†ä»Primary Shardä¸Šå°†è¯·æ±‚åŒæ—¶å‘é€ç»™å¤šä¸ªReplica Shardï¼Œè¯·æ±‚åœ¨å¤šä¸ªReplica Shardä¸Šæ‰§è¡ŒæˆåŠŸå¹¶è¿”å›ç»™Primary Shardåï¼Œå†™å…¥è¯·æ±‚æ‰§è¡ŒæˆåŠŸï¼Œè¿”å›ç»“æœç»™å®¢æˆ·ç«¯ã€‚</p>
<p>è¿™ç§æ¨¡å¼ä¸‹ï¼Œå†™å…¥æ“ä½œçš„å»¶æ—¶å°±ç­‰äºlatency &#x3D; Latency(Primary Write) + Max(Replicas Write)ã€‚åªè¦æœ‰å‰¯æœ¬åœ¨ï¼Œå†™å…¥å»¶æ—¶æœ€å°ä¹Ÿæ˜¯ä¸¤æ¬¡å•Shardçš„å†™å…¥æ—¶å»¶æ€»å’Œï¼Œå†™å…¥æ•ˆç‡ä¼šè¾ƒä½ï¼Œä½†æ˜¯è¿™æ ·çš„å¥½å¤„ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œé¿å…å†™å…¥åï¼Œå•æœºæˆ–ç£ç›˜æ•…éšœå¯¼è‡´æ•°æ®ä¸¢å¤±ï¼Œåœ¨æ•°æ®é‡è¦æ€§å’Œæ€§èƒ½æ–¹é¢ï¼Œä¸€èˆ¬éƒ½æ˜¯ä¼˜å…ˆé€‰æ‹©æ•°æ®ï¼Œé™¤éä¸€äº›å…è®¸ä¸¢æ•°æ®çš„ç‰¹æ®Šåœºæ™¯ã€‚</p>
<p>é‡‡ç”¨å¤šä¸ªå‰¯æœ¬åï¼Œé¿å…äº†å•æœºæˆ–ç£ç›˜æ•…éšœå‘ç”Ÿæ—¶ï¼Œå¯¹å·²ç»æŒä¹…åŒ–åçš„æ•°æ®é€ æˆæŸå®³ï¼Œä½†æ˜¯Elasticsearché‡Œä¸ºäº†å‡å°‘ç£ç›˜IOä¿è¯è¯»å†™æ€§èƒ½ï¼Œä¸€èˆ¬æ˜¯æ¯éš”ä¸€æ®µæ—¶é—´ï¼ˆæ¯”å¦‚5åˆ†é’Ÿï¼‰æ‰ä¼šæŠŠLuceneçš„Segmentå†™å…¥ç£ç›˜æŒä¹…åŒ–ï¼Œå¯¹äºå†™å…¥å†…å­˜ï¼Œä½†è¿˜æœªFlushåˆ°ç£ç›˜çš„Luceneæ•°æ®ï¼Œå¦‚æœå‘ç”Ÿæœºå™¨å®•æœºæˆ–è€…æ‰ç”µï¼Œé‚£ä¹ˆå†…å­˜ä¸­çš„æ•°æ®ä¹Ÿä¼šä¸¢å¤±ï¼Œè¿™æ—¶å€™å¦‚ä½•ä¿è¯ï¼Ÿ</p>
<p>å¯¹äºè¿™ç§é—®é¢˜ï¼ŒElasticsearchå­¦ä¹ äº†æ•°æ®åº“ä¸­çš„å¤„ç†æ–¹å¼ï¼šå¢åŠ CommitLogæ¨¡å—ï¼ŒElasticsearchä¸­å«TransLogã€‚</p>
<p><img src="https://i.imgur.com/318wR0R.png"></p>
<p>åœ¨æ¯ä¸€ä¸ªShardä¸­ï¼Œå†™å…¥æµç¨‹åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œå…ˆå†™å…¥Luceneï¼Œå†å†™å…¥TransLogã€‚</p>
<p>å†™å…¥è¯·æ±‚åˆ°è¾¾Shardåï¼Œå…ˆå†™Luceneæ–‡ä»¶ï¼Œåˆ›å»ºå¥½ç´¢å¼•ï¼Œæ­¤æ—¶ç´¢å¼•è¿˜åœ¨å†…å­˜é‡Œé¢ï¼Œæ¥ç€å»å†™TransLogï¼Œå†™å®ŒTransLogåï¼Œåˆ·æ–°TransLogæ•°æ®åˆ°ç£ç›˜ä¸Šï¼Œå†™ç£ç›˜æˆåŠŸåï¼Œè¯·æ±‚è¿”å›ç»™ç”¨æˆ·ã€‚è¿™é‡Œæœ‰å‡ ä¸ªå…³é”®ç‚¹ï¼Œä¸€æ˜¯å’Œæ•°æ®åº“ä¸åŒï¼Œæ•°æ®åº“æ˜¯å…ˆå†™CommitLogï¼Œç„¶åå†å†™å†…å­˜ï¼Œè€ŒElasticsearchæ˜¯å…ˆå†™å†…å­˜ï¼Œæœ€åæ‰å†™TransLogï¼Œä¸€ç§å¯èƒ½çš„åŸå› æ˜¯Luceneçš„å†…å­˜å†™å…¥ä¼šæœ‰å¾ˆå¤æ‚çš„é€»è¾‘ï¼Œå¾ˆå®¹æ˜“å¤±è´¥ï¼Œæ¯”å¦‚åˆ†è¯ï¼Œå­—æ®µé•¿åº¦è¶…è¿‡é™åˆ¶ç­‰ï¼Œæ¯”è¾ƒé‡ï¼Œä¸ºäº†é¿å…TransLogä¸­æœ‰å¤§é‡æ— æ•ˆè®°å½•ï¼Œå‡å°‘recoverçš„å¤æ‚åº¦å’Œæé«˜é€Ÿåº¦ï¼Œæ‰€ä»¥å°±æŠŠå†™Luceneæ”¾åœ¨äº†æœ€å‰é¢ã€‚äºŒæ˜¯å†™Luceneå†…å­˜åï¼Œå¹¶ä¸æ˜¯å¯è¢«æœç´¢çš„ï¼Œéœ€è¦é€šè¿‡RefreshæŠŠå†…å­˜çš„å¯¹è±¡è½¬æˆå®Œæ•´çš„Segmentåï¼Œç„¶åå†æ¬¡reopenåæ‰èƒ½è¢«æœç´¢ï¼Œä¸€èˆ¬è¿™ä¸ªæ—¶é—´è®¾ç½®ä¸º1ç§’é’Ÿï¼Œå¯¼è‡´å†™å…¥Elasticsearchçš„æ–‡æ¡£ï¼Œæœ€å¿«è¦1ç§’é’Ÿæ‰å¯è¢«ä»æœç´¢åˆ°ï¼Œæ‰€ä»¥Elasticsearchåœ¨æœç´¢æ–¹é¢æ˜¯NRTï¼ˆNear Real Timeï¼‰è¿‘å®æ—¶çš„ç³»ç»Ÿã€‚ä¸‰æ˜¯å½“Elasticsearchä½œä¸ºNoSQLæ•°æ®åº“æ—¶ï¼ŒæŸ¥è¯¢æ–¹å¼æ˜¯GetByIdï¼Œè¿™ç§æŸ¥è¯¢å¯ä»¥ç›´æ¥ä»TransLogä¸­æŸ¥è¯¢ï¼Œè¿™æ—¶å€™å°±æˆäº†RTï¼ˆReal Timeï¼‰å®æ—¶ç³»ç»Ÿã€‚å››æ˜¯æ¯éš”ä¸€æ®µæ¯”è¾ƒé•¿çš„æ—¶é—´ï¼Œæ¯”å¦‚30åˆ†é’Ÿåï¼ŒLuceneä¼šæŠŠå†…å­˜ä¸­ç”Ÿæˆçš„æ–°Segmentåˆ·æ–°åˆ°ç£ç›˜ä¸Šï¼Œåˆ·æ–°åç´¢å¼•æ–‡ä»¶å·²ç»æŒä¹…åŒ–äº†ï¼Œå†å²çš„TransLogå°±æ²¡ç”¨äº†ï¼Œä¼šæ¸…ç©ºæ‰æ—§çš„TransLogã€‚</p>
<p>ä¸Šé¢ä»‹ç»äº†Elasticsearchåœ¨å†™å…¥æ—¶çš„ä¸¤ä¸ªå…³é”®æ¨¡å—ï¼ŒReplicaå’ŒTransLogï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹Updateæµç¨‹ï¼š</p>
<p><img src="https://i.imgur.com/eYTGXM6.png"></p>
<p>Luceneä¸­ä¸æ”¯æŒéƒ¨åˆ†å­—æ®µçš„Updateï¼Œæ‰€ä»¥éœ€è¦åœ¨Elasticsearchä¸­å®ç°è¯¥åŠŸèƒ½ï¼Œå…·ä½“æµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>æ”¶åˆ°Updateè¯·æ±‚åï¼Œä»Segmentæˆ–è€…TransLogä¸­è¯»å–åŒidçš„å®Œæ•´Docï¼Œè®°å½•ç‰ˆæœ¬å·ä¸ºV1ã€‚</li>
<li>å°†ç‰ˆæœ¬V1çš„å…¨é‡Docå’Œè¯·æ±‚ä¸­çš„éƒ¨åˆ†å­—æ®µDocåˆå¹¶ä¸ºä¸€ä¸ªå®Œæ•´çš„Docï¼ŒåŒæ—¶æ›´æ–°å†…å­˜ä¸­çš„VersionMapã€‚è·å–åˆ°å®Œæ•´Docåï¼ŒUpdateè¯·æ±‚å°±å˜æˆäº†Indexè¯·æ±‚ã€‚</li>
<li>åŠ é”ã€‚</li>
<li>å†æ¬¡ä»versionMapä¸­è¯»å–è¯¥idçš„æœ€å¤§ç‰ˆæœ¬å·V2ï¼Œå¦‚æœversionMapä¸­æ²¡æœ‰ï¼Œåˆ™ä»Segmentæˆ–è€…TransLogä¸­è¯»å–ï¼Œè¿™é‡ŒåŸºæœ¬éƒ½ä¼šä»versionMapä¸­è·å–åˆ°ã€‚</li>
<li>æ£€æŸ¥ç‰ˆæœ¬æ˜¯å¦å†²çª(V1&#x3D;&#x3D;V2)ï¼Œå¦‚æœå†²çªï¼Œåˆ™å›é€€åˆ°å¼€å§‹çš„â€œUpdate docâ€é˜¶æ®µï¼Œé‡æ–°æ‰§è¡Œã€‚å¦‚æœä¸å†²çªï¼Œåˆ™æ‰§è¡Œæœ€æ–°çš„Addè¯·æ±‚ã€‚</li>
<li>åœ¨Index Docé˜¶æ®µï¼Œé¦–å…ˆå°†Version + 1å¾—åˆ°V3ï¼Œå†å°†DocåŠ å…¥åˆ°Luceneä¸­å»ï¼ŒLuceneä¸­ä¼šå…ˆåˆ åŒidä¸‹çš„å·²å­˜åœ¨doc idï¼Œç„¶åå†å¢åŠ æ–°Docã€‚å†™å…¥LuceneæˆåŠŸåï¼Œå°†å½“å‰V3æ›´æ–°åˆ°versionMapä¸­ã€‚</li>
<li>é‡Šæ”¾é”ï¼Œéƒ¨åˆ†æ›´æ–°çš„æµç¨‹å°±ç»“æŸäº†ã€‚</li>
</ol>
<p>ä»‹ç»å®Œéƒ¨åˆ†æ›´æ–°çš„æµç¨‹åï¼Œå¤§å®¶åº”è¯¥ä»æ•´ä½“æ¶æ„ä¸Šå¯¹Elasticsearchçš„å†™å…¥æœ‰äº†ä¸€ä¸ªåˆæ­¥çš„æ˜ è±¡ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è¯¦ç»†å‰–æä¸‹å†™å…¥çš„è¯¦ç»†æ­¥éª¤ã€‚</p>
<h3 id="Elasticsearchå†™å…¥è¯·æ±‚ç±»å‹"><a href="#Elasticsearchå†™å…¥è¯·æ±‚ç±»å‹" class="headerlink" title="Elasticsearchå†™å…¥è¯·æ±‚ç±»å‹"></a>Elasticsearchå†™å…¥è¯·æ±‚ç±»å‹</h3><p>Elasticsearchä¸­çš„å†™å…¥è¯·æ±‚ç±»å‹ï¼Œä¸»è¦åŒ…æ‹¬ä¸‹åˆ—å‡ ä¸ªï¼šIndex(Create)ï¼ŒUpdateï¼ŒDeleteå’ŒBulkï¼Œå…¶ä¸­å‰3ä¸ªæ˜¯å•æ–‡æ¡£æ“ä½œï¼Œåä¸€ä¸ªBulkæ˜¯å¤šæ–‡æ¡£æ“ä½œï¼Œå…¶ä¸­Bulkä¸­å¯ä»¥åŒ…æ‹¬Index(Create)ï¼ŒUpdateå’ŒDeleteã€‚</p>
<p>åœ¨6.0.0åŠå…¶ä¹‹åçš„ç‰ˆæœ¬ä¸­ï¼Œå‰3ä¸ªå•æ–‡æ¡£æ“ä½œçš„å®ç°åŸºæœ¬éƒ½å’ŒBulkæ“ä½œä¸€è‡´ï¼Œç”šè‡³æœ‰äº›å°±æ˜¯é€šè¿‡è°ƒç”¨Bulkçš„æ¥å£å®ç°çš„ã€‚ä¼°è®¡æ¥ä¸‹æ¥å‡ ä¸ªç‰ˆæœ¬åï¼ŒIndex(Create)ï¼ŒUpdateï¼ŒDeleteéƒ½ä¼šè¢«å½“åšBulkçš„ä¸€ç§ç‰¹ä¾‹åŒ–æ“ä½œè¢«å¤„ç†ã€‚è¿™æ ·ï¼Œä»£ç å’Œé€»è¾‘éƒ½ä¼šæ›´æ¸…æ™°ä¸€äº›ã€‚</p>
<p>ä¸‹é¢ï¼Œæˆ‘ä»¬å°±ä»¥Bulkè¯·æ±‚ä¸ºä¾‹æ¥ä»‹ç»å†™å…¥æµç¨‹ã€‚</p>
<h3 id="Elasticsearchå†™å…¥æµç¨‹å›¾"><a href="#Elasticsearchå†™å…¥æµç¨‹å›¾" class="headerlink" title="Elasticsearchå†™å…¥æµç¨‹å›¾"></a>Elasticsearchå†™å…¥æµç¨‹å›¾</h3><p><img src="https://i.imgur.com/gijyfoP.png"></p>
<ul>
<li>çº¢è‰²ï¼šClient Nodeã€‚</li>
<li>ç»¿è‰²ï¼šPrimary Nodeã€‚</li>
<li>è“è‰²ï¼šReplica Nodeã€‚</li>
</ul>
<h4 id="æ³¨å†ŒAction-1"><a href="#æ³¨å†ŒAction-1" class="headerlink" title="æ³¨å†ŒAction"></a>æ³¨å†ŒAction</h4><p>åœ¨Elasticsearchä¸­ï¼Œæ‰€æœ‰actionçš„å…¥å£å¤„ç†æ–¹æ³•éƒ½æ˜¯æ³¨å†Œåœ¨ActionModule.javaä¸­ï¼Œæ¯”å¦‚Bulk Requestæœ‰ä¸¤ä¸ªæ³¨å†Œå…¥å£ï¼Œåˆ†åˆ«æ˜¯Restå’ŒTransportå…¥å£.</p>
<p>å¦‚æœè¯·æ±‚æ˜¯Restè¯·æ±‚ï¼Œåˆ™ä¼šåœ¨RestBulkActionä¸­Parse Requestï¼Œæ„é€ å‡ºBulkRequestï¼Œç„¶åå‘ç»™åé¢çš„TransportActionå¤„ç†ã€‚</p>
<p>TransportShardBulkActionçš„åŸºç±»TransportReplicationActionä¸­æ³¨å†Œäº†å¯¹Primaryï¼ŒReplicaç­‰çš„ä¸åŒå¤„ç†å…¥å£:</p>
<p>è¿™é‡Œå¯¹åŸå§‹è¯·æ±‚ï¼ŒPrimary Nodeè¯·æ±‚å’ŒReplica Nodeè¯·æ±‚å„è‡ªæ³¨å†Œäº†ä¸€ä¸ªhandlerå¤„ç†å…¥å£ã€‚</p>
<h4 id="Client-Node-1"><a href="#Client-Node-1" class="headerlink" title="Client Node"></a>Client Node</h4><p>Client Node ä¹ŸåŒ…æ‹¬äº†å‰é¢è¯´è¿‡çš„Parse Requestï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°äº†ï¼Œæ¥ä¸‹æ¥çœ‹ä¸€ä¸‹å…¶ä»–çš„éƒ¨åˆ†ã€‚</p>
<ol>
<li>Ingest Pipeline</li>
</ol>
<p>åœ¨è¿™ä¸€æ­¥å¯ä»¥å¯¹åŸå§‹æ–‡æ¡£åšä¸€äº›å¤„ç†ï¼Œæ¯”å¦‚HTMLè§£æï¼Œè‡ªå®šä¹‰çš„å¤„ç†ï¼Œå…·ä½“å¤„ç†é€»è¾‘å¯ä»¥é€šè¿‡æ’ä»¶æ¥å®ç°ã€‚åœ¨Elasticsearchä¸­ï¼Œç”±äºIngest Pipelineä¼šæ¯”è¾ƒè€—è´¹CPUç­‰èµ„æºï¼Œå¯ä»¥è®¾ç½®ä¸“é—¨çš„Ingest Nodeï¼Œä¸“é—¨ç”¨æ¥å¤„ç†Ingest Pipelineé€»è¾‘ã€‚</p>
<p>å¦‚æœå½“å‰Nodeä¸èƒ½æ‰§è¡ŒIngest Pipelineï¼Œåˆ™ä¼šå°†è¯·æ±‚å‘ç»™å¦ä¸€å°å¯ä»¥æ‰§è¡ŒIngest Pipelineçš„Nodeã€‚</p>
<ol start="2">
<li>Auto Create Index</li>
</ol>
<p>åˆ¤æ–­å½“å‰Indexæ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™éœ€è¦è‡ªåŠ¨åˆ›å»ºIndexï¼Œè¿™é‡Œéœ€è¦å’ŒMasteräº¤äº’ã€‚ä¹Ÿå¯ä»¥é€šè¿‡é…ç½®å…³é—­è‡ªåŠ¨åˆ›å»ºIndexçš„åŠŸèƒ½ã€‚</p>
<ol start="3">
<li>Set Routing</li>
</ol>
<p>è®¾ç½®è·¯ç”±æ¡ä»¶ï¼Œå¦‚æœRequestä¸­æŒ‡å®šäº†è·¯ç”±æ¡ä»¶ï¼Œåˆ™ç›´æ¥ä½¿ç”¨Requestä¸­çš„Routingï¼Œå¦åˆ™ä½¿ç”¨Mappingä¸­é…ç½®çš„ï¼Œå¦‚æœMappingä¸­æ— é…ç½®ï¼Œåˆ™ä½¿ç”¨é»˜è®¤çš„_idå­—æ®µå€¼ã€‚</p>
<p>åœ¨è¿™ä¸€æ­¥ä¸­ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šidå­—æ®µï¼Œåˆ™ä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„_idå­—æ®µï¼Œç›®å‰ä½¿ç”¨çš„æ˜¯UUIDã€‚</p>
<ol start="4">
<li>Construct BulkShardRequest</li>
</ol>
<p>ç”±äºBulk Requestä¸­ä¼šåŒ…æ‹¬å¤šä¸ª(Index&#x2F;Update&#x2F;Delete)è¯·æ±‚ï¼Œè¿™äº›è¯·æ±‚æ ¹æ®routingå¯èƒ½ä¼šè½åœ¨å¤šä¸ªShardä¸Šæ‰§è¡Œï¼Œè¿™ä¸€æ­¥ä¼šæŒ‰ShardæŒ‘æ‹£Single Write Requestï¼ŒåŒä¸€ä¸ªShardä¸­çš„è¯·æ±‚èšé›†åœ¨ä¸€èµ·ï¼Œæ„å»ºBulkShardRequestï¼Œæ¯ä¸ªBulkShardRequestå¯¹åº”ä¸€ä¸ªShardã€‚</p>
<ol start="5">
<li>Send Request To Primary</li>
</ol>
<p>è¿™ä¸€æ­¥ä¼šå°†æ¯ä¸€ä¸ªBulkShardRequestè¯·æ±‚å‘é€ç»™ç›¸åº”Shardçš„Primary Nodeã€‚</p>
<h4 id="Primary-Node"><a href="#Primary-Node" class="headerlink" title="Primary Node"></a>Primary Node</h4><p>Primary è¯·æ±‚çš„å…¥å£æ˜¯åœ¨PrimaryOperationTransportHandlerçš„messageReceivedï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ç›¸å…³çš„é€»è¾‘æµç¨‹ã€‚</p>
<ol>
<li>Index or Update or Delete</li>
</ol>
<p>å¾ªç¯æ‰§è¡Œæ¯ä¸ªSingle Write Requestï¼Œå¯¹äºæ¯ä¸ªRequestï¼Œæ ¹æ®æ“ä½œç±»å‹(CREATE&#x2F;INDEX&#x2F;UPDATE&#x2F;DELETE)é€‰æ‹©ä¸åŒçš„å¤„ç†é€»è¾‘ã€‚</p>
<p>å…¶ä¸­ï¼ŒCreate&#x2F;Indexæ˜¯ç›´æ¥æ–°å¢Docï¼ŒDeleteæ˜¯ç›´æ¥æ ¹æ®_idåˆ é™¤Docï¼ŒUpdateä¼šç¨å¾®å¤æ‚äº›ï¼Œæˆ‘ä»¬ä¸‹é¢å°±ä»¥Updateä¸ºä¾‹æ¥ä»‹ç»ã€‚</p>
<ol start="2">
<li>Translate Update To Index or Delete</li>
</ol>
<p>è¿™ä¸€æ­¥æ˜¯Updateæ“ä½œçš„ç‰¹æœ‰æ­¥éª¤ï¼Œåœ¨è¿™é‡Œï¼Œä¼šå°†Updateè¯·æ±‚è½¬æ¢ä¸ºIndexæˆ–è€…Deleteè¯·æ±‚ã€‚é¦–å…ˆï¼Œä¼šé€šè¿‡GetRequestæŸ¥è¯¢åˆ°å·²ç»å­˜åœ¨çš„åŒ_id Docï¼ˆå¦‚æœæœ‰ï¼‰çš„å®Œæ•´å­—æ®µå’Œå€¼ï¼ˆä¾èµ–_sourceå­—æ®µï¼‰ï¼Œç„¶åå’Œè¯·æ±‚ä¸­çš„Docåˆå¹¶ã€‚åŒæ—¶ï¼Œè¿™é‡Œä¼šè·å–åˆ°è¯»åˆ°çš„Docç‰ˆæœ¬å·ï¼Œè®°åšV1ã€‚</p>
<ol start="3">
<li>Parse Doc</li>
</ol>
<p>è¿™é‡Œä¼šè§£æDocä¸­å„ä¸ªå­—æ®µã€‚ç”ŸæˆParsedDocumentå¯¹è±¡ï¼ŒåŒæ—¶ä¼šç”Ÿæˆuid Termã€‚åœ¨Elasticsearchä¸­ï¼Œ_uid &#x3D; type # _idï¼Œå¯¹ç”¨æˆ·ï¼Œ_Idå¯è§ï¼Œè€ŒElasticsearchä¸­å­˜å‚¨çš„æ˜¯_uidã€‚è¿™ä¸€éƒ¨åˆ†ç”Ÿæˆçš„ParsedDocumentä¸­ä¹Ÿæœ‰Elasticsearchçš„ç³»ç»Ÿå­—æ®µï¼Œå¤§éƒ¨åˆ†ä¼šæ ¹æ®å½“å‰å†…å®¹å¡«å……ï¼Œéƒ¨åˆ†æœªçŸ¥çš„ä¼šåœ¨åé¢ç»§ç»­å¡«å……ParsedDocumentã€‚</p>
<ol start="4">
<li>Update Mapping</li>
</ol>
<p>Elasticsearchä¸­æœ‰ä¸ªè‡ªåŠ¨æ›´æ–°Mappingçš„åŠŸèƒ½ï¼Œå°±åœ¨è¿™ä¸€æ­¥ç”Ÿæ•ˆã€‚ä¼šå…ˆæŒ‘é€‰å‡ºMappingä¸­æœªåŒ…å«çš„æ–°Fieldï¼Œç„¶ååˆ¤æ–­æ˜¯å¦è¿è¡Œè‡ªåŠ¨æ›´æ–°Mappingï¼Œå¦‚æœå…è®¸ï¼Œåˆ™æ›´æ–°Mappingã€‚</p>
<ol start="5">
<li>Get Sequence Id and Version</li>
</ol>
<p>ç”±äºå½“å‰æ˜¯Primary Shardï¼Œåˆ™ä¼šä»SequenceNumber Serviceè·å–ä¸€ä¸ªsequenceIDå’ŒVersionã€‚SequenceIDåœ¨Shardçº§åˆ«æ¯æ¬¡é€’å¢1ï¼ŒSequenceIDåœ¨å†™å…¥DocæˆåŠŸåï¼Œä¼šç”¨æ¥åˆå§‹åŒ–LocalCheckpointã€‚Versionåˆ™æ˜¯æ ¹æ®å½“å‰Docçš„æœ€å¤§Versioné€’å¢1ã€‚</p>
<ol start="6">
<li>Add Doc To Lucene</li>
</ol>
<p>è¿™ä¸€æ­¥å¼€å§‹çš„æ—¶å€™ä¼šç»™ç‰¹å®š_uidåŠ é”ï¼Œç„¶ååˆ¤æ–­è¯¥_uidå¯¹åº”çš„Versionæ˜¯å¦ç­‰äºä¹‹å‰Translate Update To Indexæ­¥éª¤é‡Œè·å–åˆ°çš„Versionï¼Œå¦‚æœä¸ç›¸ç­‰ï¼Œåˆ™è¯´æ˜åˆšæ‰è¯»å–Docåï¼Œè¯¥Docå‘ç”Ÿäº†å˜åŒ–ï¼Œå‡ºç°äº†ç‰ˆæœ¬å†²çªï¼Œè¿™æ—¶å€™ä¼šæŠ›å‡ºä¸€ä¸ªVersionConflictçš„å¼‚å¸¸ï¼Œè¯¥å¼‚å¸¸ä¼šåœ¨Primary Nodeæœ€å¼€å§‹å¤„æ•è·ï¼Œé‡æ–°ä»â€œTranslate Update To Index or Deleteâ€å¼€å§‹æ‰§è¡Œã€‚</p>
<p>å¦‚æœVersionç›¸ç­‰ï¼Œåˆ™ç»§ç»­æ‰§è¡Œï¼Œå¦‚æœå·²ç»å­˜åœ¨åŒidçš„Docï¼Œåˆ™ä¼šè°ƒç”¨Luceneçš„UpdateDocument(uid, doc)æ¥å£ï¼Œå…ˆæ ¹æ®uidåˆ é™¤Docï¼Œç„¶åå†Indexæ–°Docã€‚å¦‚æœæ˜¯é¦–æ¬¡å†™å…¥ï¼Œåˆ™ç›´æ¥è°ƒç”¨Luceneçš„AddDocumentæ¥å£å®ŒæˆDocçš„Indexï¼ŒAddDocumentä¹Ÿæ˜¯é€šè¿‡UpdateDocumentå®ç°ã€‚</p>
<p>è¿™ä¸€æ­¥ä¸­æœ‰ä¸ªé—®é¢˜æ˜¯ï¼Œå¦‚ä½•ä¿è¯Delete-Then-Addçš„åŸå­æ€§ï¼Œæ€ä¹ˆé¿å…ä¸­é—´çŠ¶æ€æ—¶è¢«Refreshï¼Ÿç­”æ¡ˆæ˜¯åœ¨å¼€å§‹Deleteä¹‹å‰ï¼Œä¼šåŠ ä¸€ä¸ªRefresh Lockï¼Œç¦æ­¢è¢«Refreshï¼Œåªæœ‰ç­‰Addå®Œåé‡Šæ”¾äº†Refresh Lockåæ‰èƒ½è¢«Refreshï¼Œè¿™æ ·å°±ä¿è¯äº†Delete-Then-Addçš„åŸå­æ€§ã€‚</p>
<p>Luceneçš„UpdateDocumentæ¥å£ä¸­å°±åªæ˜¯å¤„ç†å¤šä¸ªFieldï¼Œä¼šéå†æ¯ä¸ªFieldé€ä¸ªå¤„ç†ï¼Œå¤„ç†é¡ºåºæ˜¯invert indexï¼Œstore fieldï¼Œdoc valuesï¼Œpoint dimensionï¼Œåç»­ä¼šæœ‰æ–‡ç« ä¸“é—¨ä»‹ç»Luceneä¸­çš„å†™å…¥ã€‚</p>
<ol start="7">
<li>Write Translog</li>
</ol>
<p>å†™å®ŒLuceneçš„Segmentåï¼Œä¼šä»¥keyvalueçš„å½¢å¼å†™TransLogï¼ŒKeyæ˜¯_idï¼ŒValueæ˜¯Docå†…å®¹ã€‚å½“æŸ¥è¯¢çš„æ—¶å€™ï¼Œå¦‚æœè¯·æ±‚æ˜¯GetDocByIDï¼Œåˆ™å¯ä»¥ç›´æ¥æ ¹æ®_idä»TransLogä¸­è¯»å–åˆ°ï¼Œæ»¡è¶³NoSQLåœºæ™¯ä¸‹çš„å®æ—¶æ€§è¦å»ã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œåªæ˜¯å†™å…¥åˆ°å†…å­˜çš„TransLogï¼Œæ˜¯å¦Syncåˆ°ç£ç›˜çš„é€»è¾‘è¿˜åœ¨åé¢ã€‚</p>
<p>è¿™ä¸€æ­¥çš„æœ€åï¼Œä¼šæ ‡è®°å½“å‰SequenceIDå·²ç»æˆåŠŸæ‰§è¡Œï¼Œæ¥ç€ä¼šæ›´æ–°å½“å‰Shardçš„LocalCheckPointã€‚</p>
<ol start="8">
<li>Renew Bulk Request</li>
</ol>
<p>è¿™é‡Œä¼šé‡æ–°æ„é€ Bulk Requestï¼ŒåŸå› æ˜¯å‰é¢å·²ç»å°†UpdateRequestç¿»è¯‘æˆäº†Indexæˆ–Deleteè¯·æ±‚ï¼Œåˆ™åç»­æ‰€æœ‰Replicaä¸­åªéœ€è¦æ‰§è¡ŒIndexæˆ–Deleteè¯·æ±‚å°±å¯ä»¥äº†ï¼Œä¸éœ€è¦å†æ‰§è¡ŒUpdateé€»è¾‘ï¼Œä¸€æ˜¯ä¿è¯Replicaä¸­é€»è¾‘æ›´ç®€å•ï¼Œæ€§èƒ½æ›´å¥½ï¼ŒäºŒæ˜¯ä¿è¯åŒä¸€ä¸ªè¯·æ±‚åœ¨Primaryå’ŒReplicaä¸­çš„æ‰§è¡Œç»“æœä¸€æ ·ã€‚</p>
<ol start="9">
<li>Flush Translog</li>
</ol>
<p>è¿™é‡Œä¼šæ ¹æ®TransLogçš„ç­–ç•¥ï¼Œé€‰æ‹©ä¸åŒçš„æ‰§è¡Œæ–¹å¼ï¼Œè¦ä¹ˆæ˜¯ç«‹å³Flushåˆ°ç£ç›˜ï¼Œè¦ä¹ˆæ˜¯ç­‰åˆ°ä»¥åå†Flushã€‚Flushçš„é¢‘ç‡è¶Šé«˜ï¼Œå¯é æ€§è¶Šé«˜ï¼Œå¯¹å†™å…¥æ€§èƒ½å½±å“è¶Šå¤§ã€‚</p>
<ol start="10">
<li>Send Requests To Replicas</li>
</ol>
<p>è¿™é‡Œä¼šå°†åˆšæ‰æ„é€ çš„æ–°çš„Bulk Requestå¹¶è¡Œå‘é€ç»™å¤šä¸ªReplicaï¼Œç„¶åç­‰å¾…Replicaçš„è¿”å›ï¼Œè¿™é‡Œéœ€è¦ç­‰å¾…æ‰€æœ‰Replicaè¿”å›åï¼ˆå¯èƒ½æœ‰æˆåŠŸï¼Œä¹Ÿæœ‰å¯èƒ½å¤±è´¥ï¼‰ï¼ŒPrimary Nodeæ‰ä¼šè¿”å›ç”¨æˆ·ã€‚å¦‚æœæŸä¸ªReplicaå¤±è´¥äº†ï¼Œåˆ™Primaryä¼šç»™Masterå‘é€ä¸€ä¸ªRemove Shardè¯·æ±‚ï¼Œè¦æ±‚Masterå°†è¯¥Replica Shardä»å¯ç”¨èŠ‚ç‚¹ä¸­ç§»é™¤ã€‚</p>
<p>è¿™é‡Œï¼ŒåŒæ—¶ä¼šå°†SequenceIDï¼ŒPrimaryTermï¼ŒGlobalCheckPointç­‰ä¼ é€’ç»™Replicaã€‚</p>
<p>å‘é€ç»™Replicaçš„è¯·æ±‚ä¸­ï¼ŒAction Nameç­‰äºåŸå§‹ActionName + [R]ï¼Œè¿™é‡Œçš„Rè¡¨ç¤ºReplicaã€‚é€šè¿‡è¿™ä¸ª[R]çš„ä¸åŒï¼Œå¯ä»¥æ‰¾åˆ°å¤„ç†Replicaè¯·æ±‚çš„Handlerã€‚</p>
<ol start="11">
<li>Receive Response From Replicas</li>
</ol>
<p>Replicaä¸­è¯·æ±‚éƒ½å¤„ç†å®Œåï¼Œä¼šæ›´æ–°Primary Nodeçš„LocalCheckPointã€‚</p>
<h4 id="Replica-Node"><a href="#Replica-Node" class="headerlink" title="Replica Node"></a>Replica Node</h4><p>Replica è¯·æ±‚çš„å…¥å£æ˜¯åœ¨ReplicaOperationTransportHandlerçš„messageReceivedï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ç›¸å…³çš„é€»è¾‘æµç¨‹ã€‚</p>
<ol>
<li>Index or Delete</li>
</ol>
<p>æ ¹æ®è¯·æ±‚ç±»å‹æ˜¯Indexè¿˜æ˜¯Deleteï¼Œé€‰æ‹©ä¸åŒçš„æ‰§è¡Œé€»è¾‘ã€‚è¿™é‡Œæ²¡æœ‰Updateï¼Œæ˜¯å› ä¸ºåœ¨Primary Nodeä¸­å·²ç»å°†Updateè½¬æ¢æˆäº†Indexæˆ–Deleteè¯·æ±‚äº†ã€‚</p>
<ol start="2">
<li><p>Parse Doc</p>
</li>
<li><p>Update Mapping</p>
</li>
</ol>
<p>ä»¥ä¸Šéƒ½å’ŒPrimary Nodeä¸­é€»è¾‘ä¸€è‡´ã€‚</p>
<ol start="4">
<li>Get Sequence Id and Version</li>
</ol>
<p>Primary Nodeä¸­ä¼šç”ŸæˆSequence IDå’ŒVersionï¼Œç„¶åæ”¾å…¥ReplicaRequestä¸­ï¼Œè¿™é‡Œåªéœ€è¦ä»Requestä¸­è·å–åˆ°å°±è¡Œã€‚</p>
<ol start="5">
<li>Add Doc To Lucene</li>
</ol>
<p>ç”±äºå·²ç»åœ¨Primary Nodeä¸­å°†éƒ¨åˆ†Updateè¯·æ±‚è½¬æ¢æˆäº†Indexæˆ–Deleteè¯·æ±‚ï¼Œè¿™é‡Œåªéœ€è¦å¤„ç†Indexå’ŒDeleteä¸¤ç§è¯·æ±‚ï¼Œä¸å†éœ€è¦å¤„ç†Updateè¯·æ±‚äº†ã€‚æ¯”Primary Nodeä¼šæ›´ç®€å•ä¸€äº›ã€‚</p>
<ol start="6">
<li><p>Write Translog</p>
</li>
<li><p>Flush Translog</p>
</li>
</ol>
<p>ä»¥ä¸Šéƒ½å’ŒPrimary Nodeä¸­é€»è¾‘ä¸€è‡´ã€‚</p>
<h3 id="ESå†™å…¥æ€»ç»“"><a href="#ESå†™å…¥æ€»ç»“" class="headerlink" title="ESå†™å…¥æ€»ç»“"></a>ESå†™å…¥æ€»ç»“</h3><p>ä¸Šé¢è¯¦ç»†ä»‹ç»äº†Elasticsearchçš„å†™å…¥æµç¨‹åŠå…¶å„ä¸ªæµç¨‹çš„å·¥ä½œæœºåˆ¶ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œå†æ¬¡æ€»ç»“ä¸‹ä¹‹å‰æå‡ºçš„åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„å…­å¤§ç‰¹æ€§ï¼š</p>
<p>å¯é æ€§ï¼šç”±äºLuceneçš„è®¾è®¡ä¸­ä¸è€ƒè™‘å¯é æ€§ï¼Œåœ¨Elasticsearchä¸­é€šè¿‡Replicaå’ŒTransLogä¸¤å¥—æœºåˆ¶ä¿è¯æ•°æ®çš„å¯é æ€§ã€‚<br>ä¸€è‡´æ€§ï¼šLuceneä¸­çš„Flushé”åªä¿è¯Updateæ¥å£é‡Œé¢Deleteå’ŒAddä¸­é—´ä¸ä¼šFlushï¼Œä½†æ˜¯Addå®Œæˆåä»ç„¶æœ‰å¯èƒ½ç«‹å³å‘ç”ŸFlushï¼Œå¯¼è‡´Segmentå¯è¯»ã€‚è¿™æ ·å°±æ²¡æ³•ä¿è¯Primaryå’Œæ‰€æœ‰å…¶ä»–Replicaå¯ä»¥åŒä¸€æ—¶é—´Flushï¼Œå°±ä¼šå‡ºç°æŸ¥è¯¢ä¸ç¨³å®šçš„æƒ…å†µï¼Œè¿™é‡Œåªèƒ½å®ç°æœ€ç»ˆä¸€è‡´æ€§ã€‚<br>åŸå­æ€§ï¼šAddå’ŒDeleteéƒ½æ˜¯ç›´æ¥è°ƒç”¨Luceneçš„æ¥å£ï¼Œæ˜¯åŸå­çš„ã€‚å½“éƒ¨åˆ†æ›´æ–°æ—¶ï¼Œä½¿ç”¨Versionå’Œé”ä¿è¯æ›´æ–°æ˜¯åŸå­çš„ã€‚<br>éš”ç¦»æ€§ï¼šä»ç„¶é‡‡ç”¨Versionå’Œå±€éƒ¨é”æ¥ä¿è¯æ›´æ–°çš„æ˜¯ç‰¹å®šç‰ˆæœ¬çš„æ•°æ®ã€‚<br>å®æ—¶æ€§ï¼šä½¿ç”¨å®šæœŸRefresh Segmentåˆ°å†…å­˜ï¼Œå¹¶ä¸”Reopen Segmentæ–¹å¼ä¿è¯æœç´¢å¯ä»¥åœ¨è¾ƒçŸ­æ—¶é—´ï¼ˆæ¯”å¦‚1ç§’ï¼‰å†…è¢«æœç´¢åˆ°ã€‚é€šè¿‡å°†æœªåˆ·æ–°åˆ°ç£ç›˜æ•°æ®è®°å…¥TransLogï¼Œä¿è¯å¯¹æœªæäº¤æ•°æ®å¯ä»¥é€šè¿‡IDå®æ—¶è®¿é—®åˆ°ã€‚<br>æ€§èƒ½ï¼šæ€§èƒ½æ˜¯ä¸€ä¸ªç³»ç»Ÿæ€§å·¥ç¨‹ï¼Œæ‰€æœ‰ç¯èŠ‚éƒ½è¦è€ƒè™‘å¯¹æ€§èƒ½çš„å½±å“ï¼Œåœ¨Elasticsearchä¸­ï¼Œåœ¨å¾ˆå¤šåœ°æ–¹çš„è®¾è®¡éƒ½è€ƒè™‘åˆ°äº†æ€§èƒ½ï¼Œä¸€æ˜¯ä¸éœ€è¦æ‰€æœ‰Replicaéƒ½è¿”å›åæ‰èƒ½è¿”å›ç»™ç”¨æˆ·ï¼Œåªéœ€è¦è¿”å›ç‰¹å®šæ•°ç›®çš„å°±è¡Œï¼›äºŒæ˜¯ç”Ÿæˆçš„Segmentç°åœ¨å†…å­˜ä¸­æä¾›æœåŠ¡ï¼Œç­‰ä¸€æ®µæ—¶é—´åæ‰åˆ·æ–°åˆ°ç£ç›˜ï¼ŒSegmentåœ¨å†…å­˜è¿™æ®µæ—¶é—´çš„å¯é æ€§ç”±TransLogä¿è¯ï¼›ä¸‰æ˜¯TransLogå¯ä»¥é…ç½®ä¸ºå‘¨æœŸæ€§çš„Flushï¼Œä½†è¿™ä¸ªä¼šç»™å¯é æ€§å¸¦æ¥ä¼¤å®³ï¼›å››æ˜¯æ¯ä¸ªçº¿ç¨‹æŒæœ‰ä¸€ä¸ªSegmentï¼Œå¤šçº¿ç¨‹æ—¶ç›¸äº’ä¸å½±å“ï¼Œç›¸äº’ç‹¬ç«‹ï¼Œæ€§èƒ½æ›´å¥½ï¼›äº”æ˜¯ç³»ç»Ÿçš„å†™å…¥æµç¨‹å¯¹ç‰ˆæœ¬ä¾èµ–è¾ƒé‡ï¼Œè¯»å–é¢‘ç‡è¾ƒé«˜ï¼Œå› æ­¤é‡‡ç”¨äº†versionMapï¼Œå‡å°‘çƒ­ç‚¹æ•°æ®çš„å¤šæ¬¡ç£ç›˜IOå¼€é”€ã€‚Luceneä¸­é’ˆå¯¹æ€§èƒ½åšäº†å¤§é‡çš„ä¼˜åŒ–ã€‚åé¢æˆ‘ä»¬ä¹Ÿä¼šæœ‰æ–‡ç« ä¸“é—¨ä»‹ç»Luceneä¸­çš„ä¼˜åŒ–æ€è·¯ã€‚</p>
<h2 id="Elasticsearchåˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†å‰–æ-èŠ‚ç‚¹"><a href="#Elasticsearchåˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†å‰–æ-èŠ‚ç‚¹" class="headerlink" title="Elasticsearchåˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†å‰–æ-èŠ‚ç‚¹"></a>Elasticsearchåˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†å‰–æ-èŠ‚ç‚¹</h2><p>ï¼ˆå…¨æ–‡è½¬è½½è‡ª<a href="https://zhuanlan.zhihu.com/p/34858035%EF%BC%89">https://zhuanlan.zhihu.com/p/34858035ï¼‰</a></p>
<h3 id="Elasticsearchåˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†å‰–æ-èŠ‚ç‚¹ç›®å½•"><a href="#Elasticsearchåˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†å‰–æ-èŠ‚ç‚¹ç›®å½•" class="headerlink" title="Elasticsearchåˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†å‰–æ-èŠ‚ç‚¹ç›®å½•"></a>Elasticsearchåˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†å‰–æ-èŠ‚ç‚¹ç›®å½•</h3><p>Elasticsearchåˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†å‰–æâ€ç³»åˆ—å°†ä¼šå¯¹Elasticsearchçš„åˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†è¿›è¡Œè¯¦ç»†çš„å‰–æï¼Œä»‹ç»å…¶å®ç°æ–¹å¼ã€åŸç†ä»¥åŠå…¶å­˜åœ¨çš„é—®é¢˜ç­‰(åŸºäº6.2ç‰ˆæœ¬)ã€‚</p>
<p>ESç›®å‰æ˜¯æœ€æµè¡Œçš„åˆ†å¸ƒå¼æœç´¢å¼•æ“ç³»ç»Ÿï¼Œå…¶ä½¿ç”¨Luceneä½œä¸ºå•æœºå­˜å‚¨å¼•æ“å¹¶æä¾›å¼ºå¤§çš„æœç´¢æŸ¥è¯¢èƒ½åŠ›ã€‚å­¦ä¹ å…¶æœç´¢åŸç†ï¼Œåˆ™å¿…é¡»äº†è§£Luceneï¼Œè€Œå­¦ä¹ ESçš„æ¶æ„ï¼Œå°±å¿…é¡»äº†è§£å…¶åˆ†å¸ƒå¼å¦‚ä½•å®ç°ï¼Œè€Œä¸€è‡´æ€§æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿçš„æ ¸å¿ƒä¹‹ä¸€ã€‚</p>
<p>æœ¬ç¯‡å°†ä»‹ç»ESçš„é›†ç¾¤ç»„æˆã€èŠ‚ç‚¹å‘ç°ä¸Masteré€‰ä¸¾ï¼Œé”™è¯¯æ£€æµ‹ä¸æ‰©ç¼©å®¹ç›¸å…³çš„å†…å®¹ã€‚ESåœ¨å¤„ç†èŠ‚ç‚¹å‘ç°ä¸Masteré€‰ä¸¾ç­‰æ–¹é¢æ²¡æœ‰é€‰æ‹©Zookeeperç­‰å¤–éƒ¨ç»„ä»¶ï¼Œè€Œæ˜¯è‡ªå·±å®ç°çš„ä¸€å¥—ï¼Œæœ¬æ–‡ä¼šä»‹ç»ESçš„è¿™å¥—æœºåˆ¶æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œå­˜åœ¨ä»€ä¹ˆé—®é¢˜ã€‚æœ¬æ–‡çš„ä¸»è¦å†…å®¹å¦‚ä¸‹ï¼š</p>
<ol>
<li>ESé›†ç¾¤æ„æˆ</li>
<li>èŠ‚ç‚¹å‘ç°</li>
<li>Masteré€‰ä¸¾</li>
<li>é”™è¯¯æ£€æµ‹</li>
<li>é›†ç¾¤æ‰©ç¼©å®¹</li>
<li>ä¸Zookeeperã€raftç­‰å®ç°æ–¹å¼çš„æ¯”è¾ƒ</li>
</ol>
<h3 id="ESé›†ç¾¤æ„æˆ"><a href="#ESé›†ç¾¤æ„æˆ" class="headerlink" title="ESé›†ç¾¤æ„æˆ"></a>ESé›†ç¾¤æ„æˆ</h3><p>é¦–å…ˆï¼Œä¸€ä¸ªElasticsearché›†ç¾¤(ä¸‹é¢ç®€ç§°ESé›†ç¾¤)æ˜¯ç”±è®¸å¤šèŠ‚ç‚¹(Node)æ„æˆçš„ï¼ŒNodeå¯ä»¥æœ‰ä¸åŒçš„ç±»å‹ï¼Œé€šè¿‡ä»¥ä¸‹é…ç½®ï¼Œå¯ä»¥äº§ç”Ÿå››ç§ä¸åŒç±»å‹çš„Nodeï¼š</p>
<pre><code>conf/elasticsearch.yml:
    node.master: true/false
    node.data: true/false
</code></pre>
<p>å››ç§ä¸åŒç±»å‹çš„Nodeæ˜¯ä¸€ä¸ªnode.masterå’Œnode.dataçš„true&#x2F;falseçš„ä¸¤ä¸¤ç»„åˆã€‚å½“ç„¶è¿˜æœ‰å…¶ä»–ç±»å‹çš„Nodeï¼Œæ¯”å¦‚IngestNode(ç”¨äºæ•°æ®é¢„å¤„ç†ç­‰)ï¼Œä¸åœ¨æœ¬æ–‡è®¨è®ºèŒƒå›´å†…ã€‚</p>
<p>å½“node.masterä¸ºtrueæ—¶ï¼Œå…¶è¡¨ç¤ºè¿™ä¸ªnodeæ˜¯ä¸€ä¸ªmasterçš„å€™é€‰èŠ‚ç‚¹ï¼Œå¯ä»¥å‚ä¸é€‰ä¸¾ï¼Œåœ¨ESçš„æ–‡æ¡£ä¸­å¸¸è¢«ç§°ä½œmaster-eligible nodeï¼Œç±»ä¼¼äºMasterCandidateã€‚ESæ­£å¸¸è¿è¡Œæ—¶åªèƒ½æœ‰ä¸€ä¸ªmaster(å³leader)ï¼Œå¤šäº1ä¸ªæ—¶ä¼šå‘ç”Ÿè„‘è£‚ã€‚</p>
<p>å½“node.dataä¸ºtrueæ—¶ï¼Œè¿™ä¸ªèŠ‚ç‚¹ä½œä¸ºä¸€ä¸ªæ•°æ®èŠ‚ç‚¹ï¼Œä¼šå­˜å‚¨åˆ†é…åœ¨è¯¥nodeä¸Šçš„shardçš„æ•°æ®å¹¶è´Ÿè´£è¿™äº›shardçš„å†™å…¥ã€æŸ¥è¯¢ç­‰ã€‚</p>
<p>æ­¤å¤–ï¼Œä»»ä½•ä¸€ä¸ªé›†ç¾¤å†…çš„nodeéƒ½å¯ä»¥æ‰§è¡Œä»»ä½•è¯·æ±‚ï¼Œå…¶ä¼šè´Ÿè´£å°†è¯·æ±‚è½¬å‘ç»™å¯¹åº”çš„nodeè¿›è¡Œå¤„ç†ï¼Œæ‰€ä»¥å½“node.masterå’Œnode.dataéƒ½ä¸ºfalseæ—¶ï¼Œè¿™ä¸ªèŠ‚ç‚¹å¯ä»¥ä½œä¸ºä¸€ä¸ªç±»ä¼¼proxyçš„èŠ‚ç‚¹ï¼Œæ¥å—è¯·æ±‚å¹¶è¿›è¡Œè½¬å‘ã€ç»“æœèšåˆç­‰ã€‚</p>
<p><img src="https://i.imgur.com/gXb00hk.png"></p>
<p>ä¸Šå›¾æ˜¯ä¸€ä¸ªESé›†ç¾¤çš„ç¤ºæ„å›¾ï¼Œå…¶ä¸­NodeAæ˜¯å½“å‰é›†ç¾¤çš„Masterï¼ŒNodeBå’ŒNodeCæ˜¯Masterçš„å€™é€‰èŠ‚ç‚¹ï¼Œå…¶ä¸­NodeAå’ŒNodeBåŒæ—¶ä¹Ÿæ˜¯æ•°æ®èŠ‚ç‚¹(DataNode)ï¼Œæ­¤å¤–ï¼ŒNodeDæ˜¯ä¸€ä¸ªå•çº¯çš„æ•°æ®èŠ‚ç‚¹ï¼ŒNode_Eæ˜¯ä¸€ä¸ªproxyèŠ‚ç‚¹ã€‚æ¯ä¸ªNodeä¼šè·Ÿå…¶ä»–æ‰€æœ‰Nodeå»ºç«‹è¿æ¥ã€‚</p>
<p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬æä¸€ä¸ªé—®é¢˜ï¼Œä¾›è¯»è€…æ€è€ƒï¼šä¸€ä¸ªESé›†ç¾¤åº”å½“é…ç½®å¤šå°‘ä¸ªmaster-eligible nodeï¼Œå½“é›†ç¾¤çš„å­˜å‚¨æˆ–è€…è®¡ç®—èµ„æºä¸è¶³ï¼Œéœ€è¦æ‰©å®¹æ—¶ï¼Œæ–°æ‰©ä¸Šå»çš„èŠ‚ç‚¹åº”è¯¥è®¾ç½®ä¸ºä½•ç§ç±»å‹ï¼Ÿ</p>
<h3 id="èŠ‚ç‚¹å‘ç°"><a href="#èŠ‚ç‚¹å‘ç°" class="headerlink" title="èŠ‚ç‚¹å‘ç°"></a>èŠ‚ç‚¹å‘ç°</h3><p>ZenDiscoveryæ˜¯ESè‡ªå·±å®ç°çš„ä¸€å¥—ç”¨äºèŠ‚ç‚¹å‘ç°å’Œé€‰ä¸»ç­‰åŠŸèƒ½çš„æ¨¡å—ï¼Œæ²¡æœ‰ä¾èµ–Zookeeperç­‰å·¥å…·ï¼Œå®˜æ–¹æ–‡æ¡£ï¼š</p>
<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-discovery-zen.html">https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-discovery-zen.html</a></p>
<p>ç®€å•æ¥è¯´ï¼ŒèŠ‚ç‚¹å‘ç°ä¾èµ–ä»¥ä¸‹é…ç½®ï¼š</p>
<pre><code>conf/elasticsearch.yml:
    discovery.zen.ping.unicast.hosts: [1.1.1.1, 1.1.1.2, 1.1.1.3]
</code></pre>
<p>è¿™ä¸ªé…ç½®å¯ä»¥çœ‹ä½œæ˜¯ï¼Œåœ¨æœ¬èŠ‚ç‚¹åˆ°æ¯ä¸ªhostsä¸­çš„èŠ‚ç‚¹å»ºç«‹ä¸€æ¡è¾¹ï¼Œå½“æ•´ä¸ªé›†ç¾¤æ‰€æœ‰çš„nodeå½¢æˆä¸€ä¸ªè”é€šå›¾æ—¶ï¼Œæ‰€æœ‰èŠ‚ç‚¹éƒ½å¯ä»¥çŸ¥é“é›†ç¾¤ä¸­æœ‰å“ªäº›èŠ‚ç‚¹ï¼Œä¸ä¼šå½¢æˆå­¤å²›ã€‚</p>
<p>å®˜æ–¹æ¨èè¿™é‡Œè®¾ç½®ä¸ºæ‰€æœ‰çš„master-eligible nodeï¼Œè¯»è€…å¯ä»¥æƒ³æƒ³è¿™æ ·æœ‰ä½•å¥½å¤„ï¼š</p>
<pre><code>It is recommended that the unicast hosts list be maintained as the list of master-eligible
</code></pre>
<h3 id="Masteré€‰ä¸¾"><a href="#Masteré€‰ä¸¾" class="headerlink" title="Masteré€‰ä¸¾"></a>Masteré€‰ä¸¾</h3><p>ä¸Šé¢æåˆ°ï¼Œé›†ç¾¤ä¸­å¯èƒ½ä¼šæœ‰å¤šä¸ªmaster-eligible nodeï¼Œæ­¤æ—¶å°±è¦è¿›è¡Œmasteré€‰ä¸¾ï¼Œä¿è¯åªæœ‰ä¸€ä¸ªå½“é€‰masterã€‚å¦‚æœæœ‰å¤šä¸ªnodeå½“é€‰ä¸ºmasterï¼Œåˆ™é›†ç¾¤ä¼šå‡ºç°è„‘è£‚ï¼Œè„‘è£‚ä¼šç ´åæ•°æ®çš„ä¸€è‡´æ€§ï¼Œå¯¼è‡´é›†ç¾¤è¡Œä¸ºä¸å¯æ§ï¼Œäº§ç”Ÿå„ç§éé¢„æœŸçš„å½±å“ã€‚</p>
<p>ä¸ºäº†é¿å…äº§ç”Ÿè„‘è£‚ï¼ŒESé‡‡ç”¨äº†å¸¸è§çš„åˆ†å¸ƒå¼ç³»ç»Ÿæ€è·¯ï¼Œä¿è¯é€‰ä¸¾å‡ºçš„masterè¢«å¤šæ•°æ´¾(quorum)çš„master-eligible nodeè®¤å¯ï¼Œä»¥æ­¤æ¥ä¿è¯åªæœ‰ä¸€ä¸ªmasterã€‚è¿™ä¸ªquorumé€šè¿‡ä»¥ä¸‹é…ç½®è¿›è¡Œé…ç½®ï¼š</p>
<pre><code>conf/elasticsearch.yml:
    discovery.zen.minimum_master_nodes: 2
</code></pre>
<p>è¿™ä¸ªé…ç½®å¯¹äºæ•´ä¸ªé›†ç¾¤éå¸¸é‡è¦ã€‚</p>
<h4 id="masteré€‰ä¸¾è°å‘èµ·ï¼Œä»€ä¹ˆæ—¶å€™å‘èµ·ï¼Ÿ"><a href="#masteré€‰ä¸¾è°å‘èµ·ï¼Œä»€ä¹ˆæ—¶å€™å‘èµ·ï¼Ÿ" class="headerlink" title="masteré€‰ä¸¾è°å‘èµ·ï¼Œä»€ä¹ˆæ—¶å€™å‘èµ·ï¼Ÿ"></a>masteré€‰ä¸¾è°å‘èµ·ï¼Œä»€ä¹ˆæ—¶å€™å‘èµ·ï¼Ÿ</h4><p>masteré€‰ä¸¾å½“ç„¶æ˜¯ç”±master-eligibleèŠ‚ç‚¹å‘èµ·ï¼Œå½“ä¸€ä¸ªmaster-eligibleèŠ‚ç‚¹å‘ç°æ»¡è¶³ä»¥ä¸‹æ¡ä»¶æ—¶å‘èµ·é€‰ä¸¾ï¼š</p>
<p>è¯¥master-eligibleèŠ‚ç‚¹çš„å½“å‰çŠ¶æ€ä¸æ˜¯masterã€‚<br>è¯¥master-eligibleèŠ‚ç‚¹é€šè¿‡ZenDiscoveryæ¨¡å—çš„pingæ“ä½œè¯¢é—®å…¶å·²çŸ¥çš„é›†ç¾¤å…¶ä»–èŠ‚ç‚¹ï¼Œæ²¡æœ‰ä»»ä½•èŠ‚ç‚¹è¿æ¥åˆ°masterã€‚<br>åŒ…æ‹¬æœ¬èŠ‚ç‚¹åœ¨å†…ï¼Œå½“å‰å·²æœ‰è¶…è¿‡minimum_master_nodesä¸ªèŠ‚ç‚¹æ²¡æœ‰è¿æ¥åˆ°masterã€‚<br>æ€»ç»“ä¸€å¥è¯ï¼Œå³å½“ä¸€ä¸ªèŠ‚ç‚¹å‘ç°åŒ…æ‹¬è‡ªå·±åœ¨å†…çš„å¤šæ•°æ´¾çš„master-eligibleèŠ‚ç‚¹è®¤ä¸ºé›†ç¾¤æ²¡æœ‰masteræ—¶ï¼Œå°±å¯ä»¥å‘èµ·masteré€‰ä¸¾ã€‚</p>
<h4 id="å½“éœ€è¦é€‰ä¸¾masteræ—¶ï¼Œé€‰ä¸¾è°ï¼Ÿ"><a href="#å½“éœ€è¦é€‰ä¸¾masteræ—¶ï¼Œé€‰ä¸¾è°ï¼Ÿ" class="headerlink" title="å½“éœ€è¦é€‰ä¸¾masteræ—¶ï¼Œé€‰ä¸¾è°ï¼Ÿ"></a>å½“éœ€è¦é€‰ä¸¾masteræ—¶ï¼Œé€‰ä¸¾è°ï¼Ÿ</h4><p>é¦–å…ˆæ˜¯é€‰ä¸¾è°çš„é—®é¢˜ï¼Œå¦‚ä¸‹é¢æºç æ‰€ç¤ºï¼Œé€‰ä¸¾çš„æ˜¯æ’åºåçš„ç¬¬ä¸€ä¸ªMasterCandidate(å³master-eligible node)ã€‚</p>
<pre><code>public MasterCandidate electMaster(Collection&lt;MasterCandidate&gt; candidates) &#123;
        assert hasEnoughCandidates(candidates);
        List&lt;MasterCandidate&gt; sortedCandidates = new ArrayList&lt;&gt;(candidates);
        sortedCandidates.sort(MasterCandidate::compare);
        return sortedCandidates.get(0);
    &#125;
</code></pre>
<p>é‚£ä¹ˆæ˜¯æŒ‰ç…§ä»€ä¹ˆæ’åºçš„ï¼Ÿ</p>
<pre><code>public static int compare(MasterCandidate c1, MasterCandidate c2) &#123;
    // we explicitly swap c1 and c2 here. the code expects &quot;better&quot; is lower in a sorted
    // list, so if c2 has a higher cluster state version, it needs to come first.
    int ret = Long.compare(c2.clusterStateVersion, c1.clusterStateVersion);
    if (ret == 0) &#123;
        ret = compareNodes(c1.getNode(), c2.getNode());
    &#125;
    return ret;
&#125;
</code></pre>
<p>å¦‚ä¸Šé¢æºç æ‰€ç¤ºï¼Œå…ˆæ ¹æ®èŠ‚ç‚¹çš„clusterStateVersionæ¯”è¾ƒï¼ŒclusterStateVersionè¶Šå¤§ï¼Œä¼˜å…ˆçº§è¶Šé«˜ã€‚clusterStateVersionç›¸åŒæ—¶ï¼Œè¿›å…¥compareNodesï¼Œå…¶å†…éƒ¨æŒ‰ç…§èŠ‚ç‚¹çš„Idæ¯”è¾ƒ(Idä¸ºèŠ‚ç‚¹ç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶éšæœºç”Ÿæˆ)ã€‚</p>
<p>æ€»ç»“ä¸€ä¸‹ï¼š</p>
<p>å½“clusterStateVersionè¶Šå¤§ï¼Œä¼˜å…ˆçº§è¶Šé«˜ã€‚è¿™æ˜¯ä¸ºäº†ä¿è¯æ–°Masteræ‹¥æœ‰æœ€æ–°çš„clusterState(å³é›†ç¾¤çš„meta)ï¼Œé¿å…å·²ç»commitçš„metaå˜æ›´ä¸¢å¤±ã€‚å› ä¸ºMasterå½“é€‰åï¼Œå°±ä¼šä»¥è¿™ä¸ªç‰ˆæœ¬çš„clusterStateä¸ºåŸºç¡€è¿›è¡Œæ›´æ–°ã€‚(ä¸€ä¸ªä¾‹å¤–æ˜¯é›†ç¾¤å…¨éƒ¨é‡å¯ï¼Œæ‰€æœ‰èŠ‚ç‚¹éƒ½æ²¡æœ‰metaï¼Œéœ€è¦å…ˆé€‰å‡ºä¸€ä¸ªmasterï¼Œç„¶åmasterå†é€šè¿‡æŒä¹…åŒ–çš„æ•°æ®è¿›è¡Œmetaæ¢å¤ï¼Œå†è¿›è¡ŒmetaåŒæ­¥)ã€‚<br>å½“clusterStateVersionç›¸åŒæ—¶ï¼ŒèŠ‚ç‚¹çš„Idè¶Šå°ï¼Œä¼˜å…ˆçº§è¶Šé«˜ã€‚å³æ€»æ˜¯å€¾å‘äºé€‰æ‹©Idå°çš„Nodeï¼Œè¿™ä¸ªIdæ˜¯èŠ‚ç‚¹ç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶ç”Ÿæˆçš„ä¸€ä¸ªéšæœºå­—ç¬¦ä¸²ã€‚ä¹‹æ‰€ä»¥è¿™ä¹ˆè®¾è®¡ï¼Œåº”è¯¥æ˜¯ä¸ºäº†è®©é€‰ä¸¾ç»“æœå°½å¯èƒ½ç¨³å®šï¼Œä¸è¦å‡ºç°éƒ½æƒ³å½“masterè€Œé€‰ä¸å‡ºæ¥çš„æƒ…å†µã€‚</p>
<h4 id="ä»€ä¹ˆæ—¶å€™é€‰ä¸¾æˆåŠŸï¼Ÿ"><a href="#ä»€ä¹ˆæ—¶å€™é€‰ä¸¾æˆåŠŸï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ—¶å€™é€‰ä¸¾æˆåŠŸï¼Ÿ"></a>ä»€ä¹ˆæ—¶å€™é€‰ä¸¾æˆåŠŸï¼Ÿ</h4><p>å½“ä¸€ä¸ªmaster-eligible node(æˆ‘ä»¬å‡è®¾ä¸ºNode_A)å‘èµ·ä¸€æ¬¡é€‰ä¸¾æ—¶ï¼Œå®ƒä¼šæŒ‰ç…§ä¸Šè¿°æ’åºç­–ç•¥é€‰å‡ºä¸€ä¸ªå®ƒè®¤ä¸ºçš„masterã€‚</p>
<p>å‡è®¾Node_Aé€‰Node_Bå½“Masterï¼š<br>Node_Aä¼šå‘Node_Bå‘é€joinè¯·æ±‚ï¼Œé‚£ä¹ˆæ­¤æ—¶ï¼š</p>
<p>(1) å¦‚æœNode_Bå·²ç»æˆä¸ºMasterï¼ŒNode_Bå°±ä¼šæŠŠNode_AåŠ å…¥åˆ°é›†ç¾¤ä¸­ï¼Œç„¶åå‘å¸ƒæœ€æ–°çš„cluster_state, æœ€æ–°çš„cluster_stateå°±ä¼šåŒ…å«Node_Açš„ä¿¡æ¯ã€‚ç›¸å½“äºä¸€æ¬¡æ­£å¸¸æƒ…å†µçš„æ–°èŠ‚ç‚¹åŠ å…¥ã€‚å¯¹äºNode_Aï¼Œç­‰æ–°çš„cluster_stateå‘å¸ƒåˆ°Node_Açš„æ—¶å€™ï¼ŒNode_Aä¹Ÿå°±å®Œæˆjoinäº†ã€‚</p>
<p>(2) å¦‚æœNode_Båœ¨ç«é€‰Masterï¼Œé‚£ä¹ˆNode_Bä¼šæŠŠè¿™æ¬¡joinå½“ä½œä¸€å¼ é€‰ç¥¨ã€‚å¯¹äºè¿™ç§æƒ…å†µï¼ŒNode_Aä¼šç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œçœ‹Node_Bæ˜¯å¦èƒ½æˆä¸ºçœŸæ­£çš„Masterï¼Œç›´åˆ°è¶…æ—¶æˆ–è€…æœ‰åˆ«çš„Masteré€‰æˆåŠŸã€‚</p>
<p>(3) å¦‚æœNode_Bè®¤ä¸ºè‡ªå·±ä¸æ˜¯Master(ç°åœ¨ä¸æ˜¯ï¼Œå°†æ¥ä¹Ÿé€‰ä¸ä¸Š)ï¼Œé‚£ä¹ˆNode_Bä¼šæ‹’ç»è¿™æ¬¡joinã€‚å¯¹äºè¿™ç§æƒ…å†µï¼ŒNode_Aä¼šå¼€å¯ä¸‹ä¸€è½®é€‰ä¸¾ã€‚</p>
<p>å‡è®¾Node_Aé€‰è‡ªå·±å½“Masterï¼š<br>æ­¤æ—¶NodeAä¼šç­‰åˆ«çš„nodeæ¥joinï¼Œå³ç­‰å¾…åˆ«çš„nodeçš„é€‰ç¥¨ï¼Œå½“æ”¶é›†åˆ°è¶…è¿‡åŠæ•°çš„é€‰ç¥¨æ—¶ï¼Œè®¤ä¸ºè‡ªå·±æˆä¸ºmasterï¼Œç„¶åå˜æ›´cluster_stateä¸­çš„master nodeä¸ºè‡ªå·±ï¼Œå¹¶å‘é›†ç¾¤å‘å¸ƒè¿™ä¸€æ¶ˆæ¯ã€‚</p>
<p>æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥çœ‹çœ‹ä¸‹é¢è¿™æ®µæºç ï¼š</p>
<pre><code>if (transportService.getLocalNode().equals(masterNode)) &#123;
            final int requiredJoins = Math.max(0, electMaster.minimumMasterNodes() - 1); // we count as one
            logger.debug(&quot;elected as master, waiting for incoming joins ([&#123;&#125;] needed)&quot;, requiredJoins);
            nodeJoinController.waitToBeElectedAsMaster(requiredJoins, masterElectionWaitForJoinsTimeout,
                    new NodeJoinController.ElectionCallback() &#123;
                        @Override
                        public void onElectedAsMaster(ClusterState state) &#123;
                            synchronized (stateMutex) &#123;
                                joinThreadControl.markThreadAsDone(currentThread);
                            &#125;
                        &#125;

                        @Override
                        public void onFailure(Throwable t) &#123;
                            logger.trace(&quot;failed while waiting for nodes to join, rejoining&quot;, t);
                            synchronized (stateMutex) &#123;
                                joinThreadControl.markThreadAsDoneAndStartNew(currentThread);
                            &#125;
                        &#125;
                    &#125;

            );
        &#125; else &#123;
            // process any incoming joins (they will fail because we are not the master)
            nodeJoinController.stopElectionContext(masterNode + &quot; elected&quot;);

            // send join request
            final boolean success = joinElectedMaster(masterNode);

            synchronized (stateMutex) &#123;
                if (success) &#123;
                    DiscoveryNode currentMasterNode = this.clusterState().getNodes().getMasterNode();
                    if (currentMasterNode == null) &#123;
                        // Post 1.3.0, the master should publish a new cluster state before acking our join request. we now should have
                        // a valid master.
                        logger.debug(&quot;no master node is set, despite of join request completing. retrying pings.&quot;);
                        joinThreadControl.markThreadAsDoneAndStartNew(currentThread);
                    &#125; else if (currentMasterNode.equals(masterNode) == false) &#123;
                        // update cluster state
                        joinThreadControl.stopRunningThreadAndRejoin(&quot;master_switched_while_finalizing_join&quot;);
                    &#125;

                    joinThreadControl.markThreadAsDone(currentThread);
                &#125; else &#123;
                    // failed to join. Try again...
                    joinThreadControl.markThreadAsDoneAndStartNew(currentThread);
                &#125;
            &#125;
        &#125;
</code></pre>
<p>æŒ‰ç…§ä¸Šè¿°æµç¨‹ï¼Œæˆ‘ä»¬æè¿°ä¸€ä¸ªç®€å•çš„åœºæ™¯æ¥å¸®åŠ©å¤§å®¶ç†è§£ï¼š</p>
<p>å‡å¦‚é›†ç¾¤ä¸­æœ‰3ä¸ªmaster-eligible nodeï¼Œåˆ†åˆ«ä¸ºNode_Aã€ Node_Bã€ Node_C, é€‰ä¸¾ä¼˜å…ˆçº§ä¹Ÿåˆ†åˆ«ä¸ºNode_Aã€Node_Bã€Node_Cã€‚ä¸‰ä¸ªnodeéƒ½è®¤ä¸ºå½“å‰æ²¡æœ‰masterï¼Œäºæ˜¯éƒ½å„è‡ªå‘èµ·é€‰ä¸¾ï¼Œé€‰ä¸¾ç»“æœéƒ½ä¸ºNode_A(å› ä¸ºé€‰ä¸¾æ—¶æŒ‰ç…§ä¼˜å…ˆçº§æ’åºï¼Œå¦‚ä¸Šæ–‡æ‰€è¿°)ã€‚äºæ˜¯Node_Aå¼€å§‹ç­‰join(é€‰ç¥¨)ï¼ŒNode_Bã€Node_Céƒ½å‘Node_Aå‘é€joinï¼Œå½“Node_Aæ¥æ”¶åˆ°ä¸€æ¬¡joinæ—¶ï¼ŒåŠ ä¸Šå®ƒè‡ªå·±çš„ä¸€ç¥¨ï¼Œå°±è·å¾—äº†ä¸¤ç¥¨äº†(è¶…è¿‡åŠæ•°)ï¼Œäºæ˜¯Node_Aæˆä¸ºMasterã€‚æ­¤æ—¶cluster_state(é›†ç¾¤çŠ¶æ€)ä¸­åŒ…å«ä¸¤ä¸ªèŠ‚ç‚¹ï¼Œå½“Node_Aå†æ”¶åˆ°å¦ä¸€ä¸ªèŠ‚ç‚¹çš„joinæ—¶ï¼Œcluster_stateåŒ…å«å…¨éƒ¨ä¸‰ä¸ªèŠ‚ç‚¹ã€‚</p>
<h4 id="é€‰ä¸¾æ€ä¹ˆä¿è¯ä¸è„‘è£‚ï¼Ÿ"><a href="#é€‰ä¸¾æ€ä¹ˆä¿è¯ä¸è„‘è£‚ï¼Ÿ" class="headerlink" title="é€‰ä¸¾æ€ä¹ˆä¿è¯ä¸è„‘è£‚ï¼Ÿ"></a>é€‰ä¸¾æ€ä¹ˆä¿è¯ä¸è„‘è£‚ï¼Ÿ</h4><p>åŸºæœ¬åŸåˆ™è¿˜æ˜¯å¤šæ•°æ´¾çš„ç­–ç•¥ï¼Œå¦‚æœå¿…é¡»å¾—åˆ°å¤šæ•°æ´¾çš„è®¤å¯æ‰èƒ½æˆä¸ºMasterï¼Œé‚£ä¹ˆæ˜¾ç„¶ä¸å¯èƒ½æœ‰ä¸¤ä¸ªMasteréƒ½å¾—åˆ°å¤šæ•°æ´¾çš„è®¤å¯ã€‚</p>
<p>ä¸Šè¿°æµç¨‹ä¸­ï¼Œmasterå€™é€‰äººéœ€è¦ç­‰å¾…å¤šæ•°æ´¾èŠ‚ç‚¹è¿›è¡Œjoinåæ‰èƒ½çœŸæ­£æˆä¸ºmasterï¼Œå°±æ˜¯ä¸ºäº†ä¿è¯è¿™ä¸ªmasterå¾—åˆ°äº†å¤šæ•°æ´¾çš„è®¤å¯ã€‚ä½†æ˜¯æˆ‘è¿™é‡Œæƒ³è¯´çš„æ˜¯ï¼Œä¸Šè¿°æµç¨‹åœ¨ç»å¤§éƒ¨ä»½åœºæ™¯ä¸‹æ²¡é—®é¢˜ï¼Œå¬ä¸Šå»ä¹Ÿéå¸¸åˆç†ï¼Œä½†æ˜¯å´æ˜¯æœ‰bugçš„ã€‚</p>
<p>å› ä¸ºä¸Šè¿°æµç¨‹å¹¶æ²¡æœ‰é™åˆ¶åœ¨é€‰ä¸¾è¿‡ç¨‹ä¸­ï¼Œä¸€ä¸ªNodeåªèƒ½æŠ•ä¸€ç¥¨ï¼Œé‚£ä¹ˆä»€ä¹ˆåœºæ™¯ä¸‹ä¼šæŠ•ä¸¤ç¥¨å‘¢ï¼Ÿæ¯”å¦‚NodeBæŠ•NodeAä¸€ç¥¨ï¼Œä½†æ˜¯NodeAè¿Ÿè¿Ÿä¸æˆä¸ºMasterï¼ŒNodeBç­‰ä¸åŠäº†å‘èµ·äº†ä¸‹ä¸€è½®é€‰ä¸»ï¼Œè¿™æ—¶å€™å‘ç°é›†ç¾¤é‡Œå¤šäº†ä¸ªNode0ï¼ŒNode0ä¼˜å…ˆçº§æ¯”NodeAè¿˜é«˜ï¼Œé‚£NodeBè‚¯å®šå°±æ”¹æŠ•Node0äº†ã€‚å‡è®¾Node0å’ŒNodeAéƒ½å¤„åœ¨ç­‰é€‰ç¥¨çš„ç¯èŠ‚ï¼Œé‚£æ˜¾ç„¶è¿™æ—¶å€™NodeBå…¶å®å‘æŒ¥äº†ä¸¤ç¥¨çš„ä½œç”¨ï¼Œè€Œä¸”æŠ•ç»™äº†ä¸åŒçš„äººã€‚</p>
<p>é‚£ä¹ˆè¿™ç§é—®é¢˜åº”è¯¥æ€ä¹ˆè§£å†³å‘¢ï¼Œæ¯”å¦‚raftç®—æ³•ä¸­å°±å¼•å…¥äº†é€‰ä¸¾å‘¨æœŸ(term)çš„æ¦‚å¿µï¼Œä¿è¯äº†æ¯ä¸ªé€‰ä¸¾å‘¨æœŸä¸­æ¯ä¸ªæˆå‘˜åªèƒ½æŠ•ä¸€ç¥¨ï¼Œå¦‚æœéœ€è¦å†æŠ•å°±ä¼šè¿›å…¥ä¸‹ä¸€ä¸ªé€‰ä¸¾å‘¨æœŸï¼Œterm+1ã€‚å‡å¦‚æœ€åå‡ºç°ä¸¤ä¸ªèŠ‚ç‚¹éƒ½è®¤ä¸ºè‡ªå·±æ˜¯masterï¼Œé‚£ä¹ˆè‚¯å®šæœ‰ä¸€ä¸ªtermè¦å¤§äºå¦ä¸€ä¸ªçš„termï¼Œè€Œä¸”å› ä¸ºä¸¤ä¸ªterméƒ½æ”¶é›†åˆ°äº†å¤šæ•°æ´¾çš„é€‰ç¥¨ï¼Œæ‰€ä»¥å¤šæ•°èŠ‚ç‚¹çš„termæ˜¯è¾ƒå¤§çš„é‚£ä¸ªï¼Œä¿è¯äº†termå°çš„masterä¸å¯èƒ½commitä»»ä½•çŠ¶æ€å˜æ›´(commitéœ€è¦å¤šæ•°æ´¾èŠ‚ç‚¹å…ˆæŒä¹…åŒ–æ—¥å¿—æˆåŠŸï¼Œç”±äºæœ‰termæ£€æµ‹ï¼Œä¸å¯èƒ½è¾¾åˆ°å¤šæ•°æ´¾æŒä¹…åŒ–æ¡ä»¶)ã€‚è¿™å°±ä¿è¯äº†é›†ç¾¤çš„çŠ¶æ€å˜æ›´æ€»æ˜¯ä¸€è‡´çš„ã€‚</p>
<p>è€ŒESç›®å‰(6.2ç‰ˆæœ¬)å¹¶æ²¡æœ‰è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæ„é€ ç±»ä¼¼åœºæ™¯çš„æµ‹è¯•caseå¯ä»¥çœ‹åˆ°ä¼šé€‰å‡ºä¸¤ä¸ªmasterï¼Œä¸¤ä¸ªnodeéƒ½è®¤ä¸ºè‡ªå·±æ˜¯masterï¼Œå‘å…¨é›†ç¾¤å‘å¸ƒçŠ¶æ€å˜æ›´ï¼Œè¿™ä¸ªå‘å¸ƒä¹Ÿæ˜¯ä¸¤é˜¶æ®µçš„ï¼Œå…ˆä¿è¯å¤šæ•°æ´¾èŠ‚ç‚¹â€œæ¥å—â€è¿™æ¬¡å˜æ›´ï¼Œç„¶åå†è¦æ±‚å…¨éƒ¨èŠ‚ç‚¹commitè¿™æ¬¡å˜æ›´ã€‚å¾ˆä¸å¹¸ï¼Œç›®å‰ä¸¤ä¸ªmasterå¯èƒ½éƒ½å®Œæˆç¬¬ä¸€ä¸ªé˜¶æ®µï¼Œè¿›å…¥commité˜¶æ®µï¼Œå¯¼è‡´èŠ‚ç‚¹é—´çŠ¶æ€å‡ºç°ä¸ä¸€è‡´ï¼Œè€Œåœ¨raftä¸­è¿™æ˜¯ä¸å¯èƒ½çš„ã€‚é‚£ä¹ˆä¸ºä»€ä¹ˆéƒ½èƒ½å®Œæˆç¬¬ä¸€ä¸ªé˜¶æ®µå‘¢ï¼Œå› ä¸ºç¬¬ä¸€ä¸ªé˜¶æ®µESåªæ˜¯å°†æ–°çš„cluster_stateåšç®€å•çš„æ£€æŸ¥åæ”¾å…¥å†…å­˜é˜Ÿåˆ—ï¼Œå¦‚æœå½“å‰cluster_stateçš„masterä¸ºç©ºï¼Œä¸ä¼šå¯¹æ–°çš„clusterstateä¸­çš„masteråšæ£€æŸ¥ï¼Œå³åœ¨æ¥å—äº†NodeAæˆä¸ºmasterçš„cluster_stateå(è¿˜æœªcommit)ï¼Œè¿˜å¯ä»¥ç»§ç»­æ¥å—NodeBæˆä¸ºmasterçš„cluster_stateã€‚è¿™å°±ä½¿NodeAå’ŒNodeBéƒ½èƒ½è¾¾åˆ°commitæ¡ä»¶ï¼Œå‘èµ·commitå‘½ä»¤ï¼Œä»è€Œå°†é›†ç¾¤çŠ¶æ€å¼•å‘ä¸ä¸€è‡´ã€‚å½“ç„¶ï¼Œè¿™ç§è„‘è£‚å¾ˆå¿«ä¼šè‡ªåŠ¨æ¢å¤ï¼Œå› ä¸ºä¸ä¸€è‡´å‘ç”ŸåæŸä¸ªmasterå†æ¬¡å‘å¸ƒcluster_stateæ—¶å°±ä¼šå‘ç°æ— æ³•è¾¾åˆ°å¤šæ•°æ´¾æ¡ä»¶ï¼Œæˆ–è€…æ˜¯å‘ç°å®ƒçš„followerå¹¶ä¸æ„æˆå¤šæ•°æ´¾è€Œè‡ªåŠ¨é™çº§ä¸ºcandidateç­‰ã€‚</p>
<p>è¿™é‡Œè¦è¡¨è¾¾çš„æ˜¯ï¼ŒESçš„ZenDiscoveryæ¨¡å—ä¸æˆç†Ÿçš„ä¸€è‡´æ€§æ–¹æ¡ˆç›¸æ¯”ï¼Œåœ¨æŸäº›ç‰¹æ®Šåœºæ™¯ä¸‹å­˜åœ¨ç¼ºé™·ï¼Œä¸‹ä¸€ç¯‡æ–‡ç« è®²ESçš„metaå˜æ›´æµç¨‹æ—¶ä¹Ÿä¼šåˆ†æå…¶ä»–çš„ESæ— æ³•æ»¡è¶³ä¸€è‡´æ€§çš„åœºæ™¯ã€‚</p>
<h3 id="é”™è¯¯æ£€æµ‹"><a href="#é”™è¯¯æ£€æµ‹" class="headerlink" title="é”™è¯¯æ£€æµ‹"></a>é”™è¯¯æ£€æµ‹</h3><h4 id="MasterFaultDetectionä¸NodesFaultDetection"><a href="#MasterFaultDetectionä¸NodesFaultDetection" class="headerlink" title="MasterFaultDetectionä¸NodesFaultDetection"></a>MasterFaultDetectionä¸NodesFaultDetection</h4><p>è¿™é‡Œçš„é”™è¯¯æ£€æµ‹å¯ä»¥ç†è§£ä¸ºç±»ä¼¼å¿ƒè·³çš„æœºåˆ¶ï¼Œæœ‰ä¸¤ç±»é”™è¯¯æ£€æµ‹ï¼Œä¸€ç±»æ˜¯Masterå®šæœŸæ£€æµ‹é›†ç¾¤å†…å…¶ä»–çš„Nodeï¼Œå¦ä¸€ç±»æ˜¯é›†ç¾¤å†…å…¶ä»–çš„Nodeå®šæœŸæ£€æµ‹å½“å‰é›†ç¾¤çš„Masterã€‚æ£€æŸ¥çš„æ–¹æ³•å°±æ˜¯å®šæœŸæ‰§è¡Œpingè¯·æ±‚ã€‚ESæ–‡æ¡£ï¼š</p>
<p>There are two fault detection processes running. The first is by the master, to ping all the other nodes in the cluster and verify that they are alive. And on the other end, each node pings to master to verify if its still alive or an election process needs to be initiated.<br>å¦‚æœMasteræ£€æµ‹åˆ°æŸä¸ªNodeè¿ä¸ä¸Šäº†ï¼Œä¼šæ‰§è¡ŒremoveNodeçš„æ“ä½œï¼Œå°†èŠ‚ç‚¹ä»cluste_stateä¸­ç§»é™¤ï¼Œå¹¶å‘å¸ƒæ–°çš„cluster_stateã€‚å½“å„ä¸ªæ¨¡å—applyæ–°çš„cluster_stateæ—¶ï¼Œå°±ä¼šæ‰§è¡Œä¸€äº›æ¢å¤æ“ä½œï¼Œæ¯”å¦‚é€‰æ‹©æ–°çš„primaryShardæˆ–è€…replicaï¼Œæ‰§è¡Œæ•°æ®å¤åˆ¶ç­‰ã€‚</p>
<p>å¦‚æœæŸä¸ªNodeå‘ç°Masterè¿ä¸ä¸Šäº†ï¼Œä¼šæ¸…ç©ºpendingåœ¨å†…å­˜ä¸­è¿˜æœªcommitçš„new cluster_stateï¼Œç„¶åå‘èµ·rejoinï¼Œé‡æ–°åŠ å…¥é›†ç¾¤(å¦‚æœè¾¾åˆ°é€‰ä¸¾æ¡ä»¶åˆ™è§¦å‘æ–°masteré€‰ä¸¾)ã€‚</p>
<h4 id="rejoin"><a href="#rejoin" class="headerlink" title="rejoin"></a>rejoin</h4><p>é™¤äº†ä¸Šè¿°ä¸¤ç§æƒ…å†µï¼Œè¿˜æœ‰ä¸€ç§æƒ…å†µæ˜¯Masterå‘ç°è‡ªå·±å·²ç»ä¸æ»¡è¶³å¤šæ•°æ´¾æ¡ä»¶(&gt;&#x3D;minimumMasterNodes)äº†ï¼Œéœ€è¦ä¸»åŠ¨é€€å‡ºmasterçŠ¶æ€(é€€å‡ºmasterçŠ¶æ€å¹¶æ‰§è¡Œrejoin)ä»¥é¿å…è„‘è£‚çš„å‘ç”Ÿï¼Œé‚£ä¹ˆmasterå¦‚ä½•å‘ç°è‡ªå·±éœ€è¦rejoinå‘¢ï¼Ÿ</p>
<p>ä¸Šé¢æåˆ°ï¼Œå½“æœ‰èŠ‚ç‚¹è¿ä¸ä¸Šæ—¶ï¼Œä¼šæ‰§è¡ŒremoveNodeã€‚åœ¨æ‰§è¡ŒremoveNodeæ—¶åˆ¤æ–­å‰©ä½™çš„Nodeæ˜¯å¦æ»¡è¶³å¤šæ•°æ´¾æ¡ä»¶ï¼Œå¦‚æœä¸æ»¡è¶³ï¼Œåˆ™æ‰§è¡Œrejoinã€‚</p>
<pre><code>if (electMasterService.hasEnoughMasterNodes(remainingNodesClusterState.nodes()) == false) &#123;
            final int masterNodes = electMasterService.countMasterNodes(remainingNodesClusterState.nodes());
            rejoin.accept(LoggerMessageFormat.format(&quot;not enough master nodes (has [&#123;&#125;], but needed [&#123;&#125;])&quot;,
                                                     masterNodes, electMasterService.minimumMasterNodes()));
            return resultBuilder.build(currentState);
        &#125; else &#123;
            return resultBuilder.build(allocationService.deassociateDeadNodes(remainingNodesClusterState, true, describeTasks(tasks)));
        &#125;
</code></pre>
<p>åœ¨publishæ–°çš„cluster_stateæ—¶ï¼Œåˆ†ä¸ºsendé˜¶æ®µå’Œcommité˜¶æ®µï¼Œsendé˜¶æ®µè¦æ±‚å¤šæ•°æ´¾å¿…é¡»æˆåŠŸï¼Œç„¶åå†è¿›è¡Œcommitã€‚å¦‚æœåœ¨sendé˜¶æ®µæ²¡æœ‰å®ç°å¤šæ•°æ´¾è¿”å›æˆåŠŸï¼Œé‚£ä¹ˆå¯èƒ½æ˜¯æœ‰äº†æ–°çš„masteræˆ–è€…æ˜¯æ— æ³•è¿æ¥åˆ°å¤šæ•°æ´¾ä¸ªèŠ‚ç‚¹ç­‰ï¼Œåˆ™masteréœ€è¦æ‰§è¡Œrejoinã€‚</p>
<pre><code>try &#123;
        publishClusterState.publish(clusterChangedEvent, electMaster.minimumMasterNodes(), ackListener);
    &#125; catch (FailedToCommitClusterStateException t) &#123;
        // cluster service logs a WARN message
        logger.debug(&quot;failed to publish cluster state version [&#123;&#125;] (not enough nodes acknowledged, min master nodes [&#123;&#125;])&quot;,
            newState.version(), electMaster.minimumMasterNodes());

        synchronized (stateMutex) &#123;
            pendingStatesQueue.failAllStatesAndClear(
                new ElasticsearchException(&quot;failed to publish cluster state&quot;));

            rejoin(&quot;zen-disco-failed-to-publish&quot;);
        &#125;
        throw t;
    &#125;
</code></pre>
<p>åœ¨å¯¹å…¶ä»–èŠ‚ç‚¹è¿›è¡Œå®šæœŸçš„pingæ—¶ï¼Œå‘ç°æœ‰å…¶ä»–èŠ‚ç‚¹ä¹Ÿæ˜¯masterï¼Œæ­¤æ—¶ä¼šæ¯”è¾ƒæœ¬èŠ‚ç‚¹ä¸å¦ä¸€ä¸ªmasterèŠ‚ç‚¹çš„cluster_stateçš„versionï¼Œè°çš„versionå¤§è°æˆä¸ºmasterï¼Œversionå°çš„æ‰§è¡Œrejoinã€‚</p>
<pre><code>if (otherClusterStateVersion &gt; localClusterState.version()) &#123;
        rejoin(&quot;zen-disco-discovered another master with a new cluster_state [&quot; + otherMaster + &quot;][&quot; + reason + &quot;]&quot;);
    &#125; else &#123;
        // TODO: do this outside mutex
        logger.warn(&quot;discovered [&#123;&#125;] which is also master but with an older cluster_state, telling [&#123;&#125;] to rejoin the cluster ([&#123;&#125;])&quot;, otherMaster, otherMaster, reason);
        try &#123;
            // make sure we&#39;re connected to this node (connect to node does nothing if we&#39;re already connected)
            // since the network connections are asymmetric, it may be that we received a state but have disconnected from the node
            // in the past (after a master failure, for example)
            transportService.connectToNode(otherMaster);
            transportService.sendRequest(otherMaster, DISCOVERY_REJOIN_ACTION_NAME, new RejoinClusterRequest(localClusterState.nodes().getLocalNodeId()), new EmptyTransportResponseHandler(ThreadPool.Names.SAME) &#123;

                @Override
                public void handleException(TransportException exp) &#123;
                    logger.warn((Supplier&lt;?&gt;) () -&gt; new ParameterizedMessage(&quot;failed to send rejoin request to [&#123;&#125;]&quot;, otherMaster), exp);
                &#125;
            &#125;);
        &#125; catch (Exception e) &#123;
            logger.warn((Supplier&lt;?&gt;) () -&gt; new ParameterizedMessage(&quot;failed to send rejoin request to [&#123;&#125;]&quot;, otherMaster), e);
        &#125;
    &#125;
</code></pre>
<h3 id="é›†ç¾¤æ‰©ç¼©å®¹"><a href="#é›†ç¾¤æ‰©ç¼©å®¹" class="headerlink" title="é›†ç¾¤æ‰©ç¼©å®¹"></a>é›†ç¾¤æ‰©ç¼©å®¹</h3><p>ä¸Šé¢è®²äº†èŠ‚ç‚¹å‘ç°ã€Masteré€‰ä¸¾ã€é”™è¯¯æ£€æµ‹ç­‰æœºåˆ¶ï¼Œé‚£ä¹ˆç°åœ¨æˆ‘ä»¬å¯ä»¥æ¥çœ‹ä¸€ä¸‹å¦‚ä½•å¯¹é›†ç¾¤è¿›è¡Œæ‰©ç¼©å®¹ã€‚</p>
<h4 id="æ‰©å®¹DataNode"><a href="#æ‰©å®¹DataNode" class="headerlink" title="æ‰©å®¹DataNode"></a>æ‰©å®¹DataNode</h4><p>å‡è®¾ä¸€ä¸ªESé›†ç¾¤å­˜å‚¨æˆ–è€…è®¡ç®—èµ„æºä¸å¤Ÿäº†ï¼Œæˆ‘ä»¬éœ€è¦è¿›è¡Œæ‰©å®¹ï¼Œè¿™é‡Œæˆ‘ä»¬åªé’ˆå¯¹DataNodeï¼Œå³é…ç½®ä¸ºï¼š</p>
<pre><code>conf/elasticsearch.yml:
    node.master: false
    node.data: true
</code></pre>
<p>ç„¶åéœ€è¦é…ç½®é›†ç¾¤åã€èŠ‚ç‚¹åç­‰å…¶ä»–é…ç½®ï¼Œä¸ºäº†è®©è¯¥èŠ‚ç‚¹èƒ½å¤ŸåŠ å…¥é›†ç¾¤ï¼Œæˆ‘ä»¬æŠŠdiscovery.zen.ping.unicast.hostsé…ç½®ä¸ºé›†ç¾¤ä¸­çš„master-eligible nodeã€‚</p>
<pre><code>conf/elasticsearch.yml:
    cluster.name: es-cluster
    node.name: node_Z
    discovery.zen.ping.unicast.hosts: [&quot;x.x.x.x&quot;, &quot;x.x.x.y&quot;, &quot;x.x.x.z&quot;]
</code></pre>
<p>ç„¶åå¯åŠ¨èŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹ä¼šè‡ªåŠ¨åŠ å…¥åˆ°é›†ç¾¤ä¸­ï¼Œé›†ç¾¤ä¼šè‡ªåŠ¨è¿›è¡Œrebalanceï¼Œæˆ–è€…é€šè¿‡reroute apiè¿›è¡Œæ‰‹åŠ¨æ“ä½œã€‚</p>
<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-reroute.html">https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-reroute.html</a></p>
<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/shards-allocation.html">https://www.elastic.co/guide/en/elasticsearch/reference/current/shards-allocation.html</a></p>
<h4 id="ç¼©å®¹DataNode"><a href="#ç¼©å®¹DataNode" class="headerlink" title="ç¼©å®¹DataNode"></a>ç¼©å®¹DataNode</h4><p>å‡è®¾ä¸€ä¸ªESé›†ç¾¤ä½¿ç”¨çš„æœºå™¨æ•°å¤ªå¤šäº†ï¼Œéœ€è¦ç¼©å®¹ï¼Œæˆ‘ä»¬æ€ä¹ˆå®‰å…¨çš„æ“ä½œæ¥ä¿è¯æ•°æ®å®‰å…¨ï¼Œå¹¶ä¸”ä¸å½±å“å¯ç”¨æ€§å‘¢ï¼Ÿ</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬é€‰æ‹©éœ€è¦ç¼©å®¹çš„èŠ‚ç‚¹ï¼Œæ³¨æ„æœ¬èŠ‚åªé’ˆå¯¹DataNodeçš„ç¼©å®¹ï¼ŒMasterNodeç¼©å®¹æ¶‰åŠåˆ°æ›´å¤æ‚çš„é—®é¢˜ï¼Œä¸‹é¢å†è®²ã€‚</p>
<p>ç„¶åï¼Œæˆ‘ä»¬éœ€è¦æŠŠè¿™ä¸ªNodeä¸Šçš„Shardsè¿ç§»åˆ°å…¶ä»–èŠ‚ç‚¹ä¸Šï¼Œæ–¹æ³•æ˜¯å…ˆè®¾ç½®allocationè§„åˆ™ï¼Œç¦æ­¢åˆ†é…Shardåˆ°è¦ç¼©å®¹çš„æœºå™¨ä¸Šï¼Œç„¶åè®©é›†ç¾¤è¿›è¡Œrebalanceã€‚</p>
<pre><code>PUT _cluster/settings
&#123;
  &quot;transient&quot; : &#123;
    &quot;cluster.routing.allocation.exclude._ip&quot; : &quot;10.0.0.1&quot;
  &#125;
&#125;
</code></pre>
<p>ç­‰è¿™ä¸ªèŠ‚ç‚¹ä¸Šçš„æ•°æ®å…¨éƒ¨è¿ç§»å®Œæˆåï¼ŒèŠ‚ç‚¹å¯ä»¥å®‰å…¨ä¸‹çº¿ã€‚</p>
<p>æ›´è¯¦ç»†çš„æ“ä½œæ–¹å¼å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼š</p>
<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/allocation-filtering.html">https://www.elastic.co/guide/en/elasticsearch/reference/current/allocation-filtering.html</a></p>
<h4 id="æ‰©å®¹MasterNode"><a href="#æ‰©å®¹MasterNode" class="headerlink" title="æ‰©å®¹MasterNode"></a>æ‰©å®¹MasterNode</h4><p>å‡å¦‚æˆ‘ä»¬æƒ³æ‰©å®¹ä¸€ä¸ªMasterNode(master-eligible node)ï¼Œ é‚£ä¹ˆæœ‰ä¸ªéœ€è¦è€ƒè™‘çš„é—®é¢˜æ˜¯ï¼Œä¸Šé¢æåˆ°ä¸ºäº†é¿å…è„‘è£‚ï¼ŒESæ˜¯é‡‡ç”¨å¤šæ•°æ´¾çš„ç­–ç•¥ï¼Œéœ€è¦é…ç½®ä¸€ä¸ªquorumæ•°ï¼š</p>
<pre><code>conf/elasticsearch.yml:
    discovery.zen.minimum_master_nodes: 2
</code></pre>
<p>å‡è®¾ä¹‹å‰3ä¸ªmaster-eligible nodeï¼Œæˆ‘ä»¬å¯ä»¥é…ç½®quorumä¸º2ï¼Œå¦‚æœæ‰©å®¹åˆ°4ä¸ªmaster-eligible nodeï¼Œé‚£ä¹ˆquorumå°±è¦æé«˜åˆ°3ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬åº”è¯¥å…ˆæŠŠdiscovery.zen.minimum_master_nodesè¿™ä¸ªé…ç½®æ”¹æˆ3ï¼Œå†æ‰©å®¹masterï¼Œæ›´æ”¹è¿™ä¸ªé…ç½®å¯ä»¥é€šè¿‡APIçš„æ–¹å¼ï¼š</p>
<pre><code>curl -XPUT localhost:9200/_cluster/settings -d &#39;&#123;
    &quot;persistent&quot; : &#123;
        &quot;discovery.zen.minimum_master_nodes&quot; : 3
    &#125;
&#125;
</code></pre>
<p>è¿™ä¸ªAPIå‘é€ç»™å½“å‰é›†ç¾¤çš„masterï¼Œç„¶åæ–°çš„å€¼ç«‹å³ç”Ÿæ•ˆï¼Œç„¶åmasterä¼šæŠŠè¿™ä¸ªé…ç½®æŒä¹…åŒ–åˆ°cluster metaä¸­ï¼Œä¹‹åæ‰€æœ‰èŠ‚ç‚¹éƒ½ä¼šä»¥è¿™ä¸ªé…ç½®ä¸ºå‡†ã€‚</p>
<p>ä½†æ˜¯è¿™ç§æ–¹å¼æœ‰ä¸ªé—®é¢˜åœ¨äºï¼Œé…ç½®æ–‡ä»¶ä¸­é…ç½®çš„å€¼å’Œcluster metaä¸­çš„å€¼å¾ˆå¯èƒ½å‡ºç°ä¸ä¸€è‡´ï¼Œä¸ä¸€è‡´å¾ˆå®¹æ˜“å¯¼è‡´ä¸€äº›å¥‡æ€ªçš„é—®é¢˜ï¼Œæ¯”å¦‚è¯´é›†ç¾¤é‡å¯åï¼Œåœ¨æ¢å¤cluster metaå‰å°±éœ€è¦è¿›è¡Œmasteré€‰ä¸¾ï¼Œæ­¤æ—¶åªå¯èƒ½æ‹¿é…ç½®ä¸­çš„å€¼ï¼Œæ‹¿ä¸åˆ°cluster metaä¸­çš„å€¼ï¼Œä½†æ˜¯cluster metaæ¢å¤åï¼Œåˆéœ€è¦ä»¥cluster metaä¸­çš„å€¼ä¸ºå‡†ï¼Œè¿™ä¸­é—´è‚¯å®šå­˜åœ¨ä¸€äº›æ­£ç¡®æ€§ç›¸å…³çš„è¾¹ç•Œcaseã€‚</p>
<p>æ€»ä¹‹ï¼ŒåŠ¨masterèŠ‚ç‚¹ä»¥åŠç›¸å…³çš„é…ç½®ä¸€å®šè¦è°¨æ…ï¼Œmasteré…ç½®é”™è¯¯å¾ˆæœ‰å¯èƒ½å¯¼è‡´è„‘è£‚ç”šè‡³æ•°æ®å†™åã€æ•°æ®ä¸¢å¤±ç­‰åœºæ™¯ã€‚</p>
<h3 id="ç¼©å®¹MasterNode"><a href="#ç¼©å®¹MasterNode" class="headerlink" title="ç¼©å®¹MasterNode"></a>ç¼©å®¹MasterNode</h3><p>ç¼©å®¹MasterNodeä¸æ‰©å®¹è·Ÿæ‰©å®¹æ˜¯ç›¸åçš„æµç¨‹ï¼Œæˆ‘ä»¬éœ€è¦å…ˆæŠŠèŠ‚ç‚¹ç¼©ä¸‹æ¥ï¼Œå†æŠŠquorumæ•°è°ƒä¸‹æ¥ï¼Œä¸å†è¯¦ç»†æè¿°</p>
<h3 id="ä¸Zookeeperã€raftç­‰å®ç°æ–¹å¼çš„æ¯”è¾ƒ"><a href="#ä¸Zookeeperã€raftç­‰å®ç°æ–¹å¼çš„æ¯”è¾ƒ" class="headerlink" title="ä¸Zookeeperã€raftç­‰å®ç°æ–¹å¼çš„æ¯”è¾ƒ"></a>ä¸Zookeeperã€raftç­‰å®ç°æ–¹å¼çš„æ¯”è¾ƒ</h3><h4 id="ä¸ä½¿ç”¨Zookeeperç›¸æ¯”"><a href="#ä¸ä½¿ç”¨Zookeeperç›¸æ¯”" class="headerlink" title="ä¸ä½¿ç”¨Zookeeperç›¸æ¯”"></a>ä¸ä½¿ç”¨Zookeeperç›¸æ¯”</h4><p>æœ¬ç¯‡è®²äº†ESé›†ç¾¤ä¸­èŠ‚ç‚¹ç›¸å…³çš„å‡ å¤§åŠŸèƒ½çš„å®ç°æ–¹å¼ï¼š</p>
<ol>
<li>èŠ‚ç‚¹å‘ç°</li>
<li>Masteré€‰ä¸¾</li>
<li>é”™è¯¯æ£€æµ‹</li>
<li>é›†ç¾¤æ‰©ç¼©å®¹</li>
</ol>
<p>è¯•æƒ³ä¸‹ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨Zookeeperæ¥å®ç°è¿™å‡ ä¸ªåŠŸèƒ½ï¼Œä¼šå¸¦æ¥å“ªäº›å˜åŒ–ï¼Ÿ</p>
<h5 id="Zookeeperä»‹ç»"><a href="#Zookeeperä»‹ç»" class="headerlink" title="Zookeeperä»‹ç»"></a>Zookeeperä»‹ç»</h5><p>æˆ‘ä»¬é¦–å…ˆä»‹ç»ä¸€ä¸‹Zookeeperï¼Œç†Ÿæ‚‰çš„åŒå­¦å¯ä»¥ç•¥è¿‡ã€‚</p>
<p>Zookeeperåˆ†å¸ƒå¼æœåŠ¡æ¡†æ¶æ˜¯Apache Hadoop çš„ä¸€ä¸ªå­é¡¹ç›®ï¼Œå®ƒä¸»è¦æ˜¯ç”¨æ¥è§£å†³åˆ†å¸ƒå¼åº”ç”¨ä¸­ç»å¸¸é‡åˆ°çš„ä¸€äº›æ•°æ®ç®¡ç†é—®é¢˜ï¼Œå¦‚ï¼šç»Ÿä¸€å‘½åæœåŠ¡ã€çŠ¶æ€åŒæ­¥æœåŠ¡ã€é›†ç¾¤ç®¡ç†ã€åˆ†å¸ƒå¼åº”ç”¨é…ç½®é¡¹çš„ç®¡ç†ç­‰ã€‚</p>
<p>ç®€å•æ¥è¯´ï¼ŒZookeeperå°±æ˜¯ç”¨äºç®¡ç†åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„èŠ‚ç‚¹ã€é…ç½®ã€çŠ¶æ€ï¼Œå¹¶å®Œæˆå„ä¸ªèŠ‚ç‚¹é—´é…ç½®å’ŒçŠ¶æ€çš„åŒæ­¥ç­‰ã€‚å¤§é‡çš„åˆ†å¸ƒå¼ç³»ç»Ÿä¾èµ–Zookeeperæˆ–è€…æ˜¯ç±»ä¼¼çš„ç»„ä»¶ã€‚</p>
<p>Zookeeperé€šè¿‡ç›®å½•æ ‘çš„å½¢å¼æ¥ç®¡ç†æ•°æ®ï¼Œæ¯ä¸ªèŠ‚ç‚¹ç§°ä¸ºä¸€ä¸ªznodeï¼Œæ¯ä¸ªznodeç”±3éƒ¨åˆ†ç»„æˆ:</p>
<ul>
<li>stat. æ­¤ä¸ºçŠ¶æ€ä¿¡æ¯, æè¿°è¯¥znodeçš„ç‰ˆæœ¬, æƒé™ç­‰ä¿¡æ¯.</li>
<li>data. ä¸è¯¥znodeå…³è”çš„æ•°æ®.</li>
<li>children. è¯¥znodeä¸‹çš„å­èŠ‚ç‚¹.</li>
</ul>
<p>statä¸­æœ‰ä¸€é¡¹æ˜¯ephemeralOwnerï¼Œå¦‚æœæœ‰å€¼ï¼Œä»£è¡¨æ˜¯ä¸€ä¸ªä¸´æ—¶èŠ‚ç‚¹ï¼Œä¸´æ—¶èŠ‚ç‚¹ä¼šåœ¨sessionç»“æŸååˆ é™¤ï¼Œå¯ä»¥ç”¨æ¥è¾…åŠ©åº”ç”¨è¿›è¡Œmasteré€‰ä¸¾å’Œé”™è¯¯æ£€æµ‹ã€‚</p>
<p>Zookeeperæä¾›watchåŠŸèƒ½ï¼Œå¯ä»¥ç”¨äºç›‘å¬ç›¸åº”çš„äº‹ä»¶ï¼Œæ¯”å¦‚æŸä¸ªznodeä¸‹çš„å­èŠ‚ç‚¹çš„å¢å‡ï¼ŒæŸä¸ªznodeæœ¬èº«çš„å¢å‡ï¼ŒæŸä¸ªznodeçš„æ›´æ–°ç­‰ã€‚</p>
<h5 id="æ€ä¹ˆä½¿ç”¨Zookeeperå®ç°ESçš„ä¸Šè¿°åŠŸèƒ½"><a href="#æ€ä¹ˆä½¿ç”¨Zookeeperå®ç°ESçš„ä¸Šè¿°åŠŸèƒ½" class="headerlink" title="æ€ä¹ˆä½¿ç”¨Zookeeperå®ç°ESçš„ä¸Šè¿°åŠŸèƒ½"></a>æ€ä¹ˆä½¿ç”¨Zookeeperå®ç°ESçš„ä¸Šè¿°åŠŸèƒ½</h5><ol>
<li>èŠ‚ç‚¹å‘ç°ï¼šæ¯ä¸ªèŠ‚ç‚¹çš„é…ç½®æ–‡ä»¶ä¸­é…ç½®ä¸€ä¸‹ZookeeperæœåŠ¡å™¨çš„åœ°å€ï¼ŒèŠ‚ç‚¹å¯åŠ¨ååˆ°Zookeeperä¸­æŸä¸ªç›®å½•ä¸­æ³¨å†Œä¸€ä¸ªä¸´æ—¶çš„znodeã€‚å½“å‰é›†ç¾¤çš„masterç›‘å¬è¿™ä¸ªç›®å½•çš„å­èŠ‚ç‚¹å¢å‡çš„äº‹ä»¶ï¼Œå½“å‘ç°æœ‰æ–°èŠ‚ç‚¹æ—¶ï¼Œå°†æ–°èŠ‚ç‚¹åŠ å…¥é›†ç¾¤ã€‚</li>
<li>masteré€‰ä¸¾ï¼šå½“ä¸€ä¸ªmaster-eligible nodeå¯åŠ¨æ—¶ï¼Œéƒ½å°è¯•åˆ°å›ºå®šä½ç½®æ³¨å†Œä¸€ä¸ªåä¸ºmasterçš„ä¸´æ—¶znodeï¼Œå¦‚æœæ³¨å†ŒæˆåŠŸï¼Œå³æˆä¸ºmasterï¼Œå¦‚æœæ³¨å†Œå¤±è´¥åˆ™ç›‘å¬è¿™ä¸ªznodeçš„å˜åŒ–ã€‚å½“masterå‡ºç°æ•…éšœæ—¶ï¼Œç”±äºæ˜¯ä¸´æ—¶znodeï¼Œä¼šè‡ªåŠ¨åˆ é™¤ï¼Œè¿™æ—¶é›†ç¾¤ä¸­å…¶ä»–çš„master-eligible nodeå°±ä¼šå°è¯•å†æ¬¡æ³¨å†Œã€‚ä½¿ç”¨Zookeeperåå…¶å®æ˜¯æŠŠé€‰masterå˜æˆäº†æŠ¢masterã€‚</li>
<li>é”™è¯¯æ£€æµ‹ï¼šç”±äºèŠ‚ç‚¹çš„znodeå’Œmasterçš„znodeéƒ½æ˜¯ä¸´æ—¶znodeï¼Œå¦‚æœèŠ‚ç‚¹æ•…éšœï¼Œä¼šä¸Zookeeperæ–­å¼€sessionï¼Œznodeè‡ªåŠ¨åˆ é™¤ã€‚é›†ç¾¤çš„masteråªéœ€è¦ç›‘å¬znodeå˜æ›´äº‹ä»¶å³å¯ï¼Œå¦‚æœmasteræ•…éšœï¼Œå…¶ä»–çš„å€™é€‰masteråˆ™ä¼šç›‘å¬åˆ°master znodeè¢«åˆ é™¤çš„äº‹ä»¶ï¼Œå°è¯•æˆä¸ºæ–°çš„masterã€‚</li>
<li>é›†ç¾¤æ‰©ç¼©å®¹ï¼šæ‰©ç¼©å®¹å°†ä¸å†éœ€è¦è€ƒè™‘minimum_master_nodesé…ç½®çš„é—®é¢˜ï¼Œä¼šå˜å¾—æ›´å®¹æ˜“ã€‚</li>
</ol>
<h5 id="ä½¿ç”¨Zookeeperçš„ä¼˜åŠ£ç‚¹"><a href="#ä½¿ç”¨Zookeeperçš„ä¼˜åŠ£ç‚¹" class="headerlink" title="ä½¿ç”¨Zookeeperçš„ä¼˜åŠ£ç‚¹"></a>ä½¿ç”¨Zookeeperçš„ä¼˜åŠ£ç‚¹</h5><p>ä½¿ç”¨Zookeeperçš„å¥½å¤„æ˜¯ï¼ŒæŠŠä¸€äº›å¤æ‚çš„åˆ†å¸ƒå¼ä¸€è‡´æ€§é—®é¢˜äº¤ç»™Zookeeperæ¥åšï¼ŒESæœ¬èº«çš„é€»è¾‘å°±å¯ä»¥ç®€åŒ–å¾ˆå¤šï¼Œæ­£ç¡®æ€§ä¹Ÿæœ‰ä¿è¯ï¼Œè¿™ä¹Ÿæ˜¯å¤§éƒ¨åˆ†åˆ†å¸ƒå¼ç³»ç»Ÿå®è·µè¿‡çš„è·¯å­ã€‚è€ŒESçš„è¿™å¥—ZenDiscoveryæœºåˆ¶ç»å†è¿‡å¾ˆå¤šæ¬¡bug fixï¼Œåˆ°ç›®å‰ä»æœ‰ä¸€äº›è¾¹è§’çš„åœºæ™¯å­˜åœ¨bugï¼Œè€Œä¸”è¿ç»´ä¹Ÿä¸ç®€å•ã€‚</p>
<p>é‚£ä¸ºä»€ä¹ˆESä¸ä½¿ç”¨Zookeeperå‘¢ï¼Œå¤§æ¦‚æ˜¯å®˜æ–¹å¼€å‘è§‰å¾—å¢åŠ Zookeeperä¾èµ–åä¼šå¤šä¾èµ–ä¸€ä¸ªç»„ä»¶ï¼Œä½¿é›†ç¾¤éƒ¨ç½²å˜å¾—æ›´å¤æ‚ï¼Œç”¨æˆ·åœ¨è¿ç»´æ—¶éœ€è¦å¤šè¿ç»´ä¸€ä¸ªZookeeperã€‚</p>
<p>é‚£ä¹ˆåœ¨è‡ªä¸»å®ç°è¿™æ¡è·¯ä¸Šï¼Œè¿˜æœ‰ä»€ä¹ˆåˆ«çš„ç®—æ³•é€‰æ‹©å—ï¼Ÿå½“ç„¶æœ‰çš„ï¼Œæ¯”å¦‚raftã€‚</p>
<h4 id="ä¸ä½¿ç”¨raftç›¸æ¯”"><a href="#ä¸ä½¿ç”¨raftç›¸æ¯”" class="headerlink" title="ä¸ä½¿ç”¨raftç›¸æ¯”"></a>ä¸ä½¿ç”¨raftç›¸æ¯”</h4><p>raftç®—æ³•æ˜¯è¿‘å‡ å¹´å¾ˆç«çš„ä¸€ä¸ªåˆ†å¸ƒå¼ä¸€è‡´æ€§ç®—æ³•ï¼Œå…¶å®ç°ç›¸æ¯”paxosç®€å•ï¼Œåœ¨å„ç§åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ä¹Ÿå¾—åˆ°äº†åº”ç”¨ã€‚è¿™é‡Œä¸å†æè¿°å…¶ç®—æ³•çš„ç»†èŠ‚ï¼Œæˆ‘ä»¬å•ä»masteré€‰ä¸¾ç®—æ³•è§’åº¦ï¼Œæ¯”è¾ƒä¸€ä¸‹raftä¸ESç›®å‰é€‰ä¸¾ç®—æ³•çš„å¼‚åŒç‚¹ï¼š</p>
<h5 id="ç›¸åŒç‚¹"><a href="#ç›¸åŒç‚¹" class="headerlink" title="ç›¸åŒç‚¹"></a>ç›¸åŒç‚¹</h5><ol>
<li>å¤šæ•°æ´¾åŸåˆ™ï¼šå¿…é¡»å¾—åˆ°è¶…è¿‡åŠæ•°çš„é€‰ç¥¨æ‰èƒ½æˆä¸ºmasterã€‚</li>
<li>é€‰å‡ºçš„leaderä¸€å®šæ‹¥æœ‰æœ€æ–°å·²æäº¤æ•°æ®ï¼šåœ¨raftä¸­ï¼Œæ•°æ®æ›´æ–°çš„èŠ‚ç‚¹ä¸ä¼šç»™æ•°æ®æ—§çš„èŠ‚ç‚¹æŠ•é€‰ç¥¨ï¼Œè€Œå½“é€‰éœ€è¦å¤šæ•°æ´¾çš„é€‰ç¥¨ï¼Œåˆ™å½“é€‰äººä¸€å®šæœ‰æœ€æ–°å·²æäº¤æ•°æ®ã€‚åœ¨esä¸­ï¼Œversionå¤§çš„èŠ‚ç‚¹æ’åºä¼˜å…ˆçº§é«˜ï¼ŒåŒæ ·ç”¨äºä¿è¯è¿™ä¸€ç‚¹ã€‚</li>
</ol>
<h5 id="ä¸åŒç‚¹"><a href="#ä¸åŒç‚¹" class="headerlink" title="ä¸åŒç‚¹"></a>ä¸åŒç‚¹</h5><ol>
<li>æ­£ç¡®æ€§è®ºè¯ï¼šraftæ˜¯ä¸€ä¸ªè¢«è®ºè¯è¿‡æ­£ç¡®æ€§çš„ç®—æ³•ï¼Œè€ŒESçš„ç®—æ³•æ˜¯ä¸€ä¸ªæ²¡æœ‰ç»è¿‡è®ºè¯çš„ç®—æ³•ï¼Œåªèƒ½åœ¨å®è·µä¸­å‘ç°é—®é¢˜ï¼Œåšbug fixï¼Œè¿™æ˜¯æˆ‘è®¤ä¸ºæœ€å¤§çš„ä¸åŒã€‚</li>
<li>æ˜¯å¦æœ‰é€‰ä¸¾å‘¨æœŸtermï¼šraftå¼•å…¥äº†é€‰ä¸¾å‘¨æœŸçš„æ¦‚å¿µï¼Œæ¯è½®é€‰ä¸¾termåŠ 1ï¼Œä¿è¯äº†åœ¨åŒä¸€ä¸ªtermä¸‹æ¯ä¸ªå‚ä¸äººåªèƒ½æŠ•1ç¥¨ã€‚ESåœ¨é€‰ä¸¾æ—¶æ²¡æœ‰termçš„æ¦‚å¿µï¼Œä¸èƒ½ä¿è¯æ¯è½®æ¯ä¸ªèŠ‚ç‚¹åªæŠ•ä¸€ç¥¨ã€‚</li>
<li>é€‰ä¸¾çš„å€¾å‘æ€§ï¼šraftä¸­åªè¦ä¸€ä¸ªèŠ‚ç‚¹æ‹¥æœ‰æœ€æ–°çš„å·²æäº¤çš„æ•°æ®ï¼Œåˆ™æœ‰æœºä¼šé€‰ä¸¾æˆä¸ºmasterã€‚åœ¨ESä¸­ï¼Œversionç›¸åŒæ—¶ä¼šæŒ‰ç…§NodeIdæ’åºï¼Œæ€»æ˜¯NodeIdå°çš„äººä¼˜å…ˆçº§é«˜ã€‚<br>çœ‹æ³•<br>raftä»æ­£ç¡®æ€§ä¸Šçœ‹è‚¯å®šæ˜¯æ›´å¥½çš„é€‰æ‹©ï¼Œè€ŒESçš„é€‰ä¸¾ç®—æ³•ç»è¿‡å‡ æ¬¡bug fixä¹Ÿè¶Šæ¥è¶Šåƒraftã€‚å½“ç„¶ï¼Œåœ¨ESæœ€æ—©å¼€å‘æ—¶è¿˜æ²¡æœ‰raftï¼Œè€Œæœªæ¥ESå¦‚æœç»§ç»­æ²¿ç€è¿™ä¸ªæ–¹å‘èµ°å¾ˆå¯èƒ½æœ€ç»ˆå°±å˜æˆä¸€ä¸ªraftå®ç°ã€‚</li>
</ol>
<hr>
<blockquote>
<p><a href="https://zhuanlan.zhihu.com/p/34858035">Elasticsearchåˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†å‰–æ(ä¸€)-èŠ‚ç‚¹ç¯‡</a> </p>
<p><a href="https://zhuanlan.zhihu.com/p/34669354">Elasticsearchå†…æ ¸è§£æ - å†™å…¥ç¯‡</a></p>
<p>ElasticSearchæƒå¨æŒ‡å—</p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/15/RocketMQ/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/image.png">
      <meta itemprop="name" content="ä¸‰åè€Œç«‹">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ä¸‰åè€Œç«‹çš„åšå®¢">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ä¸‰åè€Œç«‹çš„åšå®¢">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/06/15/RocketMQ/" class="post-title-link" itemprop="url">RabbitMQåŸºæœ¬ä»‹ç»</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2019-06-15 20:06:20" itemprop="dateCreated datePublished" datetime="2019-06-15T20:06:20+08:00">2019-06-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-09-21 23:32:32" itemprop="dateModified" datetime="2025-09-21T23:32:32+08:00">2025-09-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">æ¶ˆæ¯é˜Ÿåˆ—</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>4.5k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>17 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="RabbitMQåŸºæœ¬æ¦‚å¿µ"><a href="#RabbitMQåŸºæœ¬æ¦‚å¿µ" class="headerlink" title="RabbitMQåŸºæœ¬æ¦‚å¿µ"></a>RabbitMQåŸºæœ¬æ¦‚å¿µ</h2><h3 id="ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…"><a href="#ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…" class="headerlink" title="ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…"></a>ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…</h3><p><img src="https://i.imgur.com/mBAfQhI.png"></p>
<p>Producerï¼šç”Ÿäº§è€…ï¼ŒæŠ•é€’æ¶ˆæ¯çš„ä¸€æ–¹ã€‚</p>
<p>Consumer: æ¶ˆè´¹è€…ï¼Œå°±æ˜¯æ¥æ”¶æ¶ˆæ¯çš„ä¸€æ–¹ã€‚</p>
<p>Broker: æ¶ˆæ¯ä¸­é—´ä»¶çš„æœåŠ¡èŠ‚ç‚¹ ã€‚</p>
<h3 id="é˜Ÿåˆ—"><a href="#é˜Ÿåˆ—" class="headerlink" title="é˜Ÿåˆ—"></a>é˜Ÿåˆ—</h3><p>Queue: é˜Ÿåˆ—ï¼Œæ˜¯RabbitMQ çš„å†…éƒ¨å¯¹è±¡ï¼Œç”¨äºå­˜å‚¨æ¶ˆæ¯ã€‚</p>
<p>RabbitMQä¸­æ¶ˆæ¯éƒ½åªèƒ½å­˜å‚¨åœ¨é˜Ÿåˆ—ä¸­ã€‚</p>
<p>å¤šä¸ªæ¶ˆè´¹è€…å¯ä»¥è®¢é˜…åŒä¸€ä¸ªé˜Ÿåˆ—ï¼Œè¿™æ—¶é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ä¼šè¢«å¹³å‡åˆ†æ‘Š CRound-Robin ï¼Œå³è½®è¯¢)<br>ç»™å¤šä¸ªæ¶ˆè´¹è€…è¿›è¡Œå¤„ç†ï¼Œè€Œä¸æ˜¯æ¯ä¸ªæ¶ˆè´¹è€…éƒ½æ”¶åˆ°æ‰€æœ‰çš„æ¶ˆæ¯å¹¶å¤„ç†ã€‚</p>
<p>RabbitMQ ä¸æ”¯æŒé˜Ÿåˆ—å±‚é¢çš„å¹¿æ’­æ¶ˆè´¹ã€‚</p>
<h3 id="äº¤æ¢å™¨ã€è·¯ç”±é”®ä¸ç»‘å®š"><a href="#äº¤æ¢å™¨ã€è·¯ç”±é”®ä¸ç»‘å®š" class="headerlink" title="äº¤æ¢å™¨ã€è·¯ç”±é”®ä¸ç»‘å®š"></a>äº¤æ¢å™¨ã€è·¯ç”±é”®ä¸ç»‘å®š</h3><p>Exchange: äº¤æ¢å™¨ã€‚ç”Ÿäº§è€…å°†æ¶ˆæ¯å‘é€åˆ° Exchange (äº¤æ¢å™¨ï¼Œé€šå¸¸ä¹Ÿ<br>å¯ä»¥ç”¨å¤§å†™çš„ â€œXâ€ æ¥è¡¨ç¤º)ï¼Œç”±äº¤æ¢å™¨å°†æ¶ˆæ¯è·¯ç”±åˆ°ä¸€ä¸ªæˆ–è€…å¤šä¸ªé˜Ÿåˆ—ä¸­ã€‚å¦‚æœè·¯ç”±ä¸åˆ°ï¼Œæˆ–è®¸ä¼šè¿”å›ç»™ç”Ÿäº§è€…ï¼Œæˆ–è®¸ç›´æ¥ä¸¢å¼ƒã€‚</p>
<p>RoutingKey: è·¯ç”±é”® ã€‚ç”Ÿäº§è€…å°†æ¶ˆæ¯å‘ç»™äº¤æ¢å™¨ çš„æ—¶å€™ï¼Œä¸€èˆ¬ä¼šæŒ‡å®šä¸€ä¸ªRoutingKey ï¼Œç”¨æ¥æŒ‡å®šè¿™ä¸ªæ¶ˆæ¯çš„è·¯ç”±è§„åˆ™ï¼Œè€Œè¿™ä¸ª RoutingKey éœ€è¦ä¸äº¤æ¢å™¨ç±»å‹å’Œç»‘å®šé”® (BindingKey) è”<br>åˆä½¿ç”¨æ‰èƒ½æœ€ç»ˆç”Ÿæ•ˆã€‚</p>
<p>Binding: ç»‘å®šã€‚RabbitMQ ä¸­é€šè¿‡ç»‘å®šå°†äº¤æ¢å™¨ä¸é˜Ÿåˆ—å…³è”èµ·æ¥ï¼Œåœ¨ç»‘å®šçš„æ—¶å€™ä¸€èˆ¬ä¼šæŒ‡å®šä¸€ä¸ªç»‘å®šé”® ( BindingKey ) ï¼Œè¿™æ · RabbitMQ å°±çŸ¥é“å¦‚ä½•æ­£ç¡®åœ°å°†æ¶ˆæ¯è·¯ç”±åˆ°é˜Ÿåˆ—äº†ã€‚</p>
<p><img src="https://i.imgur.com/MN0SEP6.png"></p>
<p>åœ¨äº¤æ¢å™¨ç±»å‹å’Œç»‘å®šé”® (BindingKey) å›ºå®šçš„æƒ…å†µä¸‹ï¼Œç”Ÿäº§è€…å¯ä»¥åœ¨å‘é€æ¶ˆæ¯ç»™äº¤æ¢å™¨æ—¶ï¼Œé€šè¿‡æŒ‡å®šRoutingKeyæ¥å†³å®šæ¶ˆæ¯æµå‘å“ªé‡Œã€‚</p>
<h3 id="äº¤æ¢å™¨ç±»å‹"><a href="#äº¤æ¢å™¨ç±»å‹" class="headerlink" title="äº¤æ¢å™¨ç±»å‹"></a>äº¤æ¢å™¨ç±»å‹</h3><p>RabbitMQ å¸¸ç”¨çš„äº¤æ¢å™¨ç±»å‹æœ‰ fanout ã€ direct ã€ topic ã€ headers è¿™å››ç§ ã€‚ </p>
<h4 id="fanout"><a href="#fanout" class="headerlink" title="fanout"></a>fanout</h4><p>å®ƒä¼šæŠŠæ‰€æœ‰å‘é€åˆ°è¯¥äº¤æ¢å™¨çš„æ¶ˆæ¯è·¯ç”±åˆ°æ‰€æœ‰ä¸è¯¥äº¤æ¢å™¨ç»‘å®šçš„é˜Ÿåˆ—ä¸­ã€‚</p>
<h4 id="direct"><a href="#direct" class="headerlink" title="direct"></a>direct</h4><p>direct ç±»å‹çš„äº¤æ¢å™¨è·¯ç”±è§„åˆ™ä¹Ÿå¾ˆç®€å•ï¼Œå®ƒä¼šæŠŠæ¶ˆæ¯è·¯ç”±åˆ°é‚£äº› BindingKey å’Œ RoutingKey<br>å®Œå…¨åŒ¹é…çš„é˜Ÿåˆ—ä¸­ã€‚</p>
<h4 id="topic"><a href="#topic" class="headerlink" title="topic"></a>topic</h4><p>topic ç±»å‹çš„äº¤æ¢å™¨åœ¨åŒ¹é…è§„åˆ™ä¸Šè¿›è¡Œäº†æ‰©å±•ï¼Œå®ƒä¸ direct ç±»å‹çš„äº¤æ¢å™¨ç›¸ä¼¼ï¼Œä¹Ÿæ˜¯å°†æ¶ˆæ¯è·¯ç”±åˆ° BindingKey å’Œ RoutingKey ç›¸åŒ¹é…çš„é˜Ÿåˆ—ä¸­ï¼Œä½†è¿™é‡Œçš„åŒ¹é…è§„åˆ™æœ‰äº›ä¸åŒï¼Œå®ƒçº¦å®š:</p>
<ul>
<li>RoutingKey ä¸ºä¸€ä¸ªç‚¹å·â€.â€åˆ†éš”çš„å­—ç¬¦ä¸²(è¢«ç‚¹å·â€.â€åˆ†éš”å¼€çš„æ¯ä¸€æ®µç‹¬ç«‹çš„å­—ç¬¦ä¸²ç§°ä¸ºä¸€ä¸ªå•è¯)ï¼Œå¦‚com.rabbitmq.client</li>
<li>BindingKey å’Œ RoutingKey ä¸€æ ·ä¹Ÿæ˜¯ç‚¹å·â€.â€åˆ†éš”çš„å­—ç¬¦ä¸²;</li>
<li>BindingKey ä¸­å¯ä»¥å­˜åœ¨ä¸¤ç§ç‰¹æ®Šå­—ç¬¦ä¸²â€<em>â€œå’Œâ€#â€ï¼Œç”¨äºåšæ¨¡ç³ŠåŒ¹é…ï¼Œå…¶ä¸­â€</em>â€œç”¨äºåŒ¹é…ä¸€ä¸ªå•è¯ï¼Œâ€#â€ç”¨äºåŒ¹é…å¤šè§„æ ¼å•è¯(å¯ä»¥æ˜¯é›¶ä¸ª)ã€‚</li>
</ul>
<h4 id="headers"><a href="#headers" class="headerlink" title="headers"></a>headers</h4><p>headers ç±»å‹çš„äº¤æ¢å™¨ä¸ä¾èµ–äºè·¯ç”±é”®çš„åŒ¹é…è§„åˆ™æ¥è·¯ç”±æ¶ˆæ¯ï¼Œè€Œæ˜¯æ ¹æ®å‘é€çš„æ¶ˆæ¯å†…å®¹ä¸­<br>çš„ headers å±æ€§è¿›è¡ŒåŒ¹é…ã€‚åœ¨ç»‘å®šé˜Ÿåˆ—å’Œäº¤æ¢å™¨æ—¶åˆ¶å®šä¸€ç»„é”®å€¼å¯¹ ï¼Œ å½“å‘é€æ¶ˆæ¯åˆ°äº¤æ¢å™¨æ—¶ï¼Œ<br>RabbitMQ ä¼šè·å–åˆ°è¯¥æ¶ˆæ¯çš„ headers (ä¹Ÿæ˜¯ä¸€ä¸ªé”®å€¼å¯¹çš„å½¢å¼) ï¼Œå¯¹æ¯”å…¶ä¸­çš„é”®å€¼å¯¹æ˜¯å¦å®Œå…¨<br>åŒ¹é…é˜Ÿåˆ—å’Œäº¤æ¢å™¨ç»‘å®šæ—¶æŒ‡å®šçš„é”®å€¼å¯¹ï¼Œå¦‚æœå®Œå…¨åŒ¹é…åˆ™æ¶ˆæ¯ä¼šè·¯ç”±åˆ°è¯¥é˜Ÿåˆ—ï¼Œå¦åˆ™ä¸ä¼šè·¯ç”±<br>åˆ°è¯¥é˜Ÿåˆ— ã€‚ headers ç±»å‹çš„äº¤æ¢å™¨æ€§èƒ½ä¼šå¾ˆå·®ï¼Œè€Œä¸”ä¹Ÿä¸å®ç”¨ï¼ŒåŸºæœ¬ä¸Šä¸ä¼šçœ‹åˆ°å®ƒçš„å­˜åœ¨ã€‚</p>
<h3 id="RabbitMQ-è¿è½¬æµç¨‹"><a href="#RabbitMQ-è¿è½¬æµç¨‹" class="headerlink" title="RabbitMQ è¿è½¬æµç¨‹"></a>RabbitMQ è¿è½¬æµç¨‹</h3><p>ç”Ÿäº§è€…å‘é€æ¶ˆæ¯ï¼š</p>
<ol>
<li>ç”Ÿäº§è€…è¿æ¥åˆ° RabbitMQ Brokerï¼Œå»ºç«‹ä¸€ä¸ªè¿æ¥(Connection),å¼€å¯ä¸€ä¸ªä¿¡é“ (Channel)</li>
<li>ç”Ÿäº§è€…å£°æ˜ä¸€ä¸ªäº¤æ¢å™¨ ï¼Œå¹¶è®¾ç½®ç›¸å…³å±æ€§ï¼Œæ¯”å¦‚ äº¤æ¢æœºç±»å‹ã€æ˜¯å¦æŒä¹…åŒ–ç­‰ã€‚</li>
<li>ç”Ÿäº§è€…å£°æ˜ ä¸€ä¸ªé˜Ÿåˆ—äº•è®¾ç½®ç›¸å…³å±æ€§ï¼Œæ¯”å¦‚æ˜¯å¦æ’ä»–ã€æ˜¯å¦æŒä¹…åŒ–ã€æ˜¯å¦è‡ªåŠ¨åˆ é™¤ç­‰ã€‚</li>
<li>ç”Ÿäº§è€…é€šè¿‡è·¯ç”±é”®å°†äº¤æ¢å™¨å’Œé˜Ÿåˆ—ç»‘å®šèµ·æ¥ã€‚</li>
<li>ç”Ÿäº§è€…å‘é€æ¶ˆæ¯è‡³ RabbitMQ Brokerï¼Œå…¶ä¸­åŒ…å«è·¯ç”±é”®ã€äº¤æ¢å™¨ç­‰ä¿¡æ¯ã€‚</li>
<li>ç›¸åº”çš„äº¤æ¢å™¨æ ¹æ®æ¥æ”¶åˆ°çš„è·¯ç”±é”®æŸ¥æ‰¾ç›¸åŒ¹é…çš„é˜Ÿåˆ— ã€‚</li>
<li>å¦‚æœæ‰¾åˆ°ï¼Œåˆ™å°†ä»ç”Ÿäº§è€…å‘é€è¿‡æ¥çš„æ¶ˆæ¯å­˜å…¥ç›¸åº”çš„é˜Ÿåˆ—ä¸­ã€‚</li>
<li>å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™æ ¹æ®ç”Ÿäº§è€…é…ç½®çš„å±æ€§é€‰æ‹©ä¸¢å¼ƒè¿˜æ˜¯å›é€€ç»™ç”Ÿäº§è€…ã€‚</li>
<li>å…³é—­ä¿¡é“ã€‚</li>
<li>å…³é—­è¿æ¥ã€‚</li>
</ol>
<p>æ¶ˆè´¹è€…æ¥æ”¶æ¶ˆæ¯çš„è¿‡ç¨‹:</p>
<ol>
<li>æ¶ˆè´¹è€…è¿æ¥åˆ° RabbitMQ Brokerï¼Œå»ºç«‹ä¸€ä¸ªè¿æ¥ (Connection ) ï¼Œå¼€å¯ ä¸€ä¸ªä¿¡é“ (Channel) ã€‚</li>
<li>æ¶ˆè´¹è€…å‘ RabbitMQ Broker è¯·æ±‚æ¶ˆè´¹ç›¸åº”é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ï¼Œå¯èƒ½ä¼šè®¾ç½®ç›¸åº”çš„å›è°ƒå‡½æ•°ï¼Œ<br>ä»¥åŠåšä¸€äº›å‡†å¤‡å·¥ä½œ(è¯¦ç»†å†…å®¹è¯·å‚è€ƒ 3 .4èŠ‚ã€‰ã€‚</li>
<li>ç­‰å¾… RabbitMQ Broker å›åº”å¹¶æŠ•é€’ç›¸åº”é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ï¼Œ æ¶ˆè´¹è€…æ¥æ”¶æ¶ˆæ¯ã€‚</li>
<li>æ¶ˆè´¹è€…ç¡®è®¤ ( ack) æ¥æ”¶åˆ°çš„æ¶ˆæ¯ ã€‚</li>
<li>RabbitMQ ä»é˜Ÿåˆ—ä¸­åˆ é™¤ç›¸åº”å·±ç»è¢«ç¡®è®¤çš„æ¶ˆæ¯ ã€‚</li>
<li>å…³é—­ä¿¡é“ã€‚</li>
<li>å…³é—­è¿æ¥ã€‚</li>
</ol>
<h2 id="RabbitMQè¿›é˜¶"><a href="#RabbitMQè¿›é˜¶" class="headerlink" title="RabbitMQè¿›é˜¶"></a>RabbitMQè¿›é˜¶</h2><h3 id="æ¶ˆæ¯ç‰¹æ®Šæƒ…å†µ"><a href="#æ¶ˆæ¯ç‰¹æ®Šæƒ…å†µ" class="headerlink" title="æ¶ˆæ¯ç‰¹æ®Šæƒ…å†µ"></a>æ¶ˆæ¯ç‰¹æ®Šæƒ…å†µ</h3><p>mandatory å’Œ immediate æ˜¯ channel . basicPublish æ–¹æ³•ä¸­çš„ä¸¤ä¸ªå‚æ•°ï¼Œå®ƒä»¬éƒ½æœ‰<br>å½“æ¶ˆæ¯ä¼ é€’è¿‡ç¨‹ä¸­ä¸å¯è¾¾ç›®çš„åœ°æ—¶å°†æ¶ˆæ¯è¿”å›ç»™ç”Ÿäº§è€…çš„åŠŸèƒ½ã€‚ RabbitMQ æä¾›çš„å¤‡ä»½äº¤æ¢å™¨<br>(Altemate Exchange) å¯ä»¥å°†æœªèƒ½è¢«äº¤æ¢å™¨è·¯ç”±çš„æ¶ˆæ¯(æ²¡æœ‰ç»‘å®šé˜Ÿåˆ—æˆ–è€…æ²¡æœ‰åŒ¹é…çš„ç»‘å®šã€‰å­˜<br>å‚¨èµ·æ¥ï¼Œè€Œä¸ç”¨è¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p>
<h4 id="mandatoryå‚æ•°"><a href="#mandatoryå‚æ•°" class="headerlink" title="mandatoryå‚æ•°"></a>mandatoryå‚æ•°</h4><p>å½“ mandatory å‚æ•°è®¾ä¸º true æ—¶ï¼Œäº¤æ¢å™¨æ— æ³•æ ¹æ®è‡ªèº«çš„ç±»å‹å’Œè·¯ç”±é”®æ‰¾åˆ°ä¸€ä¸ªç¬¦åˆæ¡ä»¶<br>çš„é˜Ÿåˆ—ï¼Œé‚£ä¹ˆ RabbitMQ ä¼šè°ƒç”¨ Basic.Return å‘½ä»¤å°†æ¶ˆæ¯è¿”å›ç»™ç”Ÿäº§è€… ã€‚å½“ mandatory å‚<br>æ•°è®¾ç½®ä¸º false æ—¶ï¼Œå‡ºç°ä¸Šè¿°æƒ…å½¢ï¼Œåˆ™æ¶ˆæ¯ç›´æ¥è¢«ä¸¢å¼ƒ ã€‚</p>
<p>é‚£ä¹ˆç”Ÿäº§è€…å¦‚ä½•è·å–åˆ°æ²¡æœ‰è¢«æ­£ç¡®è·¯ç”±åˆ°åˆé€‚é˜Ÿåˆ—çš„æ¶ˆæ¯å‘¢?è¿™æ—¶å€™å¯ä»¥é€šè¿‡è°ƒç”¨<br>channel.addReturnListener æ¥æ·»åŠ  ReturnListener ç›‘æ˜•å™¨å®ç°ã€‚</p>
<p><img src="https://i.imgur.com/AxjpPgI.png"></p>
<h4 id="immediateå‚æ•°"><a href="#immediateå‚æ•°" class="headerlink" title="immediateå‚æ•°"></a>immediateå‚æ•°</h4><p>å½“ imrnediate å‚æ•°è®¾ä¸º true æ—¶ï¼Œå¦‚æœäº¤æ¢å™¨åœ¨å°†æ¶ˆæ¯è·¯ç”±åˆ°é˜Ÿåˆ—æ—¶å‘ç°é˜Ÿåˆ—ä¸Šå¹¶ä¸å­˜åœ¨<br>ä»»ä½•æ¶ˆè´¹è€…ï¼Œé‚£ä¹ˆè¿™æ¡æ¶ˆæ¯å°†ä¸ä¼šå­˜å…¥é˜Ÿåˆ—ä¸­ã€‚å½“ä¸è·¯ç”±é”®åŒ¹é…çš„æ‰€æœ‰é˜Ÿåˆ—éƒ½æ²¡æœ‰æ¶ˆè´¹è€…æ—¶ ï¼Œ<br>è¯¥æ¶ˆæ¯ä¼šé€šè¿‡ Basic.Return è¿”å›è‡³ç”Ÿäº§è€…ã€‚</p>
<p>RabbitMQ3.0ç‰ˆæœ¬å¼€å§‹å»æ‰äº†å¯¹ imrnediate å‚æ•°çš„æ”¯æŒï¼Œå¯¹æ­¤ RabbitMQ å®˜æ–¹è§£é‡Šæ˜¯:imrnediate å‚æ•°ä¼šå½±å“é•œåƒé˜Ÿåˆ—çš„æ€§èƒ½ï¼Œå¢åŠ äº†ä»£ç å¤æ‚æ€§ï¼Œå»ºè®®é‡‡ç”¨TTLå’ŒDLX çš„æ–¹æ³•æ›¿ä»£ã€‚</p>
<h4 id="å¤‡ä»½äº¤æ¢å™¨"><a href="#å¤‡ä»½äº¤æ¢å™¨" class="headerlink" title="å¤‡ä»½äº¤æ¢å™¨"></a>å¤‡ä»½äº¤æ¢å™¨</h4><p>å¤‡ä»½äº¤æ¢å™¨ï¼Œè‹±æ–‡åç§°ä¸º Altemate Exchangeï¼Œç®€ç§°åº™ï¼Œæˆ–è€…æ›´ç›´ç™½åœ°ç§°ä¹‹ä¸ºâ€å¤‡èƒäº¤æ¢å™¨â€ã€‚<br>ç”Ÿäº§è€…åœ¨å‘é€æ¶ˆæ¯çš„æ—¶å€™å¦‚æœä¸è®¾ç½® mandatory å‚æ•° ï¼Œ é‚£ä¹ˆæ¶ˆæ¯åœ¨æœªè¢«è·¯ç”±çš„æƒ…å†µä¸‹å°†ä¼šä¸¢å¤± :<br>å¦‚æœè®¾ç½®äº† mandatory å‚æ•°ï¼Œé‚£ä¹ˆéœ€è¦æ·»åŠ  ReturnListener çš„ç¼–ç¨‹é€»è¾‘ï¼Œç”Ÿäº§è€…çš„ä»£ç å°†<br>å˜å¾—å¤æ‚ã€‚å¦‚æœæ—¢ä¸æƒ³å¤æ‚åŒ–ç”Ÿäº§è€…çš„ç¼–ç¨‹é€»è¾‘ï¼Œåˆä¸æƒ³æ¶ˆæ¯ä¸¢å¤±ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨å¤‡ä»½äº¤æ¢å™¨ï¼Œ<br>è¿™æ ·å¯ä»¥å°†æœªè¢«è·¯ç”±çš„æ¶ˆæ¯å­˜å‚¨åœ¨ RabbitMQ ä¸­ï¼Œå†åœ¨éœ€è¦çš„æ—¶å€™å»å¤„ç†è¿™äº›æ¶ˆæ¯ã€‚</p>
<p>å¯ä»¥é€šè¿‡åœ¨å£°æ˜äº¤æ¢å™¨(è°ƒç”¨channel.exchangeDeclareæ–¹æ³•)çš„æ—¶å€™æ·»åŠ alternate-exchange å‚æ•°æ¥å®ç°ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ç­–ç•¥çš„æ–¹å¼å®ç°ã€‚å¦‚æœä¸¤è€…åŒæ—¶ä½¿ç”¨ï¼Œåˆ™å‰è€…çš„ä¼˜å…ˆçº§æ›´é«˜ï¼Œä¼šè¦†ç›–æ‰ Policy çš„è®¾ç½® ã€‚</p>
<p><img src="https://i.imgur.com/2EGA5BE.png"></p>
<h3 id="TTL"><a href="#TTL" class="headerlink" title="TTL"></a>TTL</h3><h4 id="è®¾ç½®æ¶ˆæ¯çš„-TTL"><a href="#è®¾ç½®æ¶ˆæ¯çš„-TTL" class="headerlink" title="è®¾ç½®æ¶ˆæ¯çš„ TTL"></a>è®¾ç½®æ¶ˆæ¯çš„ TTL</h4><p>ç›®å‰æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥è®¾ç½®æ¶ˆæ¯çš„ TTLã€‚ç¬¬ä¸€ç§æ–¹æ³•æ˜¯é€šè¿‡é˜Ÿåˆ—å±æ€§è®¾ç½®ï¼Œé˜Ÿåˆ—ä¸­æ‰€æœ‰æ¶ˆæ¯éƒ½æœ‰ç›¸åŒçš„è¿‡æœŸæ—¶é—´ã€‚ç¬¬äºŒç§æ–¹æ³•æ˜¯å¯¹æ¶ˆæ¯æœ¬èº«è¿›è¡Œå•ç‹¬è®¾ç½®ï¼Œæ¯æ¡æ¶ˆæ¯çš„ TTL å¯ä»¥ä¸åŒã€‚å¦‚æœä¸¤ç§æ–¹æ³•ä¸€èµ·ä½¿ç”¨ï¼Œåˆ™æ¶ˆæ¯çš„ TTL ä»¥ä¸¤è€…ä¹‹é—´è¾ƒå°çš„é‚£ä¸ªæ•°å€¼ä¸ºå‡†ã€‚æ¶ˆæ¯åœ¨é˜Ÿåˆ—ä¸­çš„ç”Ÿå­˜æ—¶é—´ä¸€æ—¦è¶…è¿‡è®¾ç½® çš„ TTL å€¼æ—¶ï¼Œå°±ä¼šå˜æˆâ€æ­»ä¿¡â€ (Dead Message) ï¼Œæ¶ˆè´¹è€…å°†æ— æ³•å†æ”¶åˆ°è¯¥æ¶ˆæ¯ã€‚</p>
<ul>
<li><p>é€šè¿‡é˜Ÿåˆ—å±æ€§è®¾ç½®æ¶ˆæ¯ TTL çš„æ–¹æ³•æ˜¯åœ¨ channel.queueDeclare æ–¹æ³•ä¸­åŠ å…¥<br>x-message -ttl å‚æ•°å®ç°çš„ï¼Œè¿™ä¸ªå‚æ•°çš„å•ä½æ˜¯æ¯«ç§’ã€‚</p>
<pre><code>  Map&lt;String, Object&gt; argss = new HashMap&lt;String , Object&gt;();
  argss.put(&quot;x-message-ttl &quot; , 6000);
  channel.queueDeclare(queueName , durable , exclusive , autoDelete , argss) ;
  //åŒæ—¶ä¹Ÿå¯ä»¥é€šè¿‡ Policy çš„æ–¹å¼æ¥è®¾ç½® TTL.ç¤ºä¾‹å¦‚ä¸‹ :
  rabbitmqctl set_policy TTL &quot;é£Ÿ&quot; &#39;&#123;&quot;message-ttl&quot;:60000&#125;&#39; --apply-to queues
  //è¿˜å¯ä»¥é€šè¿‡è°ƒç”¨ HTTPAPI æ¥å£è®¾ç½® :
  $ curl -i -u root:root -H &quot;content-type:application/json&quot;-X PUT
  -d&#39;&#123;&quot;auto_delete&quot;:false, &quot;durable&quot;:true, &quot;arguments&quot;:&#123;&quot;x-message-ttl&quot;: 60000&#125;&#125;&#39;
  http://localhost:15672/api/queues/&#123;vhost&#125;/&#123;queuename&#125;
</code></pre>
</li>
<li><p>é’ˆå¯¹æ¯æ¡æ¶ˆæ¯è®¾ç½® TTL çš„æ–¹æ³•æ˜¯åœ¨ channel.basicPublish æ–¹æ³•ä¸­åŠ å…¥ expiration<br>çš„å±æ€§å‚æ•°ï¼Œå•ä½ä¸ºæ¯«ç§’ã€‚</p>
<pre><code>  AMQP.BasicProperties.Builder builder = new AMQP.BasicProperties . Builder();
  builder.deliveryMode(2); / / æŒä¹…åŒ–æ¶ˆæ¯
  builder.expiration( &quot; 60000 &quot; );/ / è®¾ç½® TTL=60000ms
  AMQP.BasicProperties properties = builder.build() ;
  channel.basicPublish(exchangeName, routingKey, mandatory, properties ,
  &quot;ttlTestMessage&quot;.getBytes());
</code></pre>
</li>
</ul>
<p>å¦‚æœä¸è®¾ç½® TTL.åˆ™è¡¨ç¤ºæ­¤æ¶ˆæ¯ä¸ä¼šè¿‡æœŸ ;å¦‚æœå°† TTL è®¾ç½®ä¸º 0ï¼Œåˆ™è¡¨ç¤ºé™¤éæ­¤æ—¶å¯ä»¥ç›´æ¥å°†æ¶ˆæ¯æŠ•é€’åˆ°æ¶ˆè´¹è€…ï¼Œå¦åˆ™è¯¥æ¶ˆæ¯ä¼šè¢«ç«‹å³ä¸¢å¼ƒï¼Œè¿™ä¸ªç‰¹æ€§å¯ä»¥éƒ¨åˆ†æ›¿ä»£ RabbitMQ 3.0 ç‰ˆæœ¬ä¹‹å‰çš„ immediate å‚æ•°ï¼Œä¹‹æ‰€ä»¥éƒ¨åˆ†ä»£æ›¿ï¼Œæ˜¯å› ä¸ºimmediate å‚æ•°åœ¨æŠ•é€’å¤±è´¥æ—¶ä¼šç”¨Basic.Return å°†æ¶ˆæ¯è¿”å›ã€‚</p>
<p>å¯¹äºç¬¬ä¸€ç§è®¾ç½®é˜Ÿåˆ— TTL å±æ€§çš„æ–¹æ³•ï¼Œä¸€æ—¦æ¶ˆæ¯è¿‡æœŸï¼Œå°±ä¼šä»é˜Ÿåˆ—ä¸­æŠ¹å»ï¼Œè€Œåœ¨ç¬¬äºŒç§æ–¹<br>æ³•ä¸­ï¼Œå³ä½¿æ¶ˆæ¯è¿‡æœŸï¼Œä¹Ÿä¸ä¼šé©¬ä¸Šä»é˜Ÿåˆ—ä¸­æŠ¹å»ï¼Œå› ä¸ºæ¯æ¡æ¶ˆæ¯æ˜¯å¦è¿‡æœŸæ˜¯åœ¨å³å°†æŠ•é€’åˆ°æ¶ˆè´¹<br>è€…ä¹‹å‰åˆ¤å®šçš„ã€‚</p>
<p>ä¸ºä»€ä¹ˆè¿™ä¸¤ç§æ–¹æ³•å¤„ç†çš„æ–¹å¼ä¸ä¸€æ ·?å› ä¸ºç¬¬ä¸€ç§æ–¹æ³•é‡Œï¼Œé˜Ÿåˆ—ä¸­å·±è¿‡æœŸçš„æ¶ˆæ¯è‚¯å®šåœ¨é˜Ÿ<br>åˆ—å¤´éƒ¨ï¼Œ RabbitMQ åªè¦å®šæœŸä»é˜Ÿå¤´å¼€å§‹æ‰«ææ˜¯å¦æœ‰è¿‡æœŸçš„æ¶ˆæ¯å³å¯ã€‚è€Œç¬¬äºŒç§æ–¹æ³•é‡Œï¼Œæ¯æ¡æ¶ˆ<br>æ¯çš„è¿‡æœŸæ—¶é—´ä¸åŒï¼Œå¦‚æœè¦åˆ é™¤æ‰€æœ‰è¿‡æœŸæ¶ˆæ¯åŠ¿å¿…è¦æ‰«ææ•´ä¸ªé˜Ÿåˆ—ï¼Œæ‰€ä»¥ä¸å¦‚ç­‰åˆ°æ­¤æ¶ˆæ¯å³å°†<br>è¢«æ¶ˆè´¹æ—¶å†åˆ¤å®šæ˜¯å¦è¿‡æœŸ ï¼Œ å¦‚æœè¿‡æœŸå†è¿›è¡Œåˆ é™¤å³å¯ã€‚</p>
<h4 id="è®¾ç½®é˜Ÿåˆ—çš„TTL"><a href="#è®¾ç½®é˜Ÿåˆ—çš„TTL" class="headerlink" title="è®¾ç½®é˜Ÿåˆ—çš„TTL"></a>è®¾ç½®é˜Ÿåˆ—çš„TTL</h4><p>é€šè¿‡ channel.queueDeclare æ–¹æ³•ä¸­çš„ x-expires å‚æ•°å¯ä»¥æ§åˆ¶é˜Ÿåˆ—è¢«è‡ªåŠ¨åˆ é™¤å‰å¤„äºæœªä½¿ç”¨çŠ¶æ€çš„æ—¶é—´ã€‚æœªä½¿ç”¨çš„æ„æ€æ˜¯é˜Ÿåˆ—ä¸Šæ²¡æœ‰ä»»ä½•çš„æ¶ˆè´¹è€…ï¼Œé˜Ÿåˆ—ä¹Ÿæ²¡æœ‰è¢«é‡æ–°å£°æ˜ï¼Œå¹¶ä¸”åœ¨è¿‡æœŸæ—¶é—´æ®µå†…ä¹Ÿæœªè°ƒç”¨è¿‡Basic.Getå‘½ä»¤ã€‚</p>
<p>abb itMQ ä¼šç¡®ä¿åœ¨è¿‡æœŸæ—¶é—´åˆ°è¾¾åå°†é˜Ÿåˆ—åˆ é™¤ï¼Œä½†æ˜¯ä¸ä¿éšœåˆ é™¤çš„åŠ¨ä½œæœ‰å¤šåŠæ—¶ ã€‚åœ¨<br>RabbitMQ é‡å¯å ï¼Œ æŒä¹…åŒ–çš„é˜Ÿåˆ—çš„è¿‡æœŸæ—¶é—´ä¼šè¢«é‡æ–°è®¡ç®—ã€‚<br>ç”¨äºè¡¨ç¤ºè¿‡æœŸæ—¶é—´çš„ x-expires å‚æ•°ä»¥æ¯«ç§’ä¸ºå•ä½ ï¼Œ äº•ä¸”æœä»å’Œ x-message-ttl ä¸€æ ·<br>çš„çº¦æŸæ¡ä»¶ï¼Œä¸è¿‡ä¸èƒ½è®¾ç½®ä¸º 0ã€‚æ¯”å¦‚è¯¥å‚æ•°è®¾ç½®ä¸º 1 000 ï¼Œåˆ™è¡¨ç¤ºè¯¥é˜Ÿåˆ—å¦‚æœåœ¨ 1 ç§’é’Ÿä¹‹å†…æœª<br>ä½¿ç”¨åˆ™ä¼šè¢«åˆ é™¤ã€‚</p>
<h3 id="æ­»ä¿¡é˜Ÿåˆ—"><a href="#æ­»ä¿¡é˜Ÿåˆ—" class="headerlink" title="æ­»ä¿¡é˜Ÿåˆ—"></a>æ­»ä¿¡é˜Ÿåˆ—</h3><p>DLX ï¼Œå…¨ç§°ä¸º Dead-Letter-Exchange ï¼Œå¯ä»¥ç§°ä¹‹ä¸ºæ­»ä¿¡äº¤æ¢å™¨ï¼Œä¹Ÿæœ‰äººç§°ä¹‹ä¸ºæ­»ä¿¡é‚®ç®±ã€‚å½“<br>æ¶ˆæ¯åœ¨ä¸€ä¸ªé˜Ÿåˆ—ä¸­å˜æˆæ­»ä¿¡ (dead message) ä¹‹åï¼Œå®ƒèƒ½è¢«é‡æ–°è¢«å‘é€åˆ°å¦ä¸€ä¸ªäº¤æ¢å™¨ä¸­ï¼Œè¿™ä¸ª<br>äº¤æ¢å™¨å°±æ˜¯ DLXï¼Œç»‘å®š DLX çš„é˜Ÿåˆ—å°±ç§°ä¹‹ä¸ºæ­»ä¿¡é˜Ÿåˆ—ã€‚</p>
<p>DLX ä¹Ÿæ˜¯ä¸€ä¸ªæ­£å¸¸çš„äº¤æ¢å™¨ï¼Œå’Œä¸€èˆ¬çš„äº¤æ¢å™¨æ²¡æœ‰åŒºåˆ«ï¼Œå®ƒèƒ½åœ¨ä»»ä½•çš„é˜Ÿåˆ—ä¸Šè¢«æŒ‡å®šï¼Œå®é™…ä¸Šå°±æ˜¯è®¾ç½®æŸä¸ªé˜Ÿåˆ—çš„å±æ€§ã€‚å½“è¿™ä¸ªé˜Ÿåˆ—ä¸­å­˜åœ¨æ­»ä¿¡æ—¶ï¼ŒRabbitMQ å°±ä¼šè‡ªåŠ¨åœ°å°†è¿™ä¸ªæ¶ˆæ¯é‡æ–°å‘å¸ƒåˆ°è®¾ç½®çš„ DLX ä¸Šå» ï¼Œè¿›è€Œè¢«è·¯ç”±åˆ°å¦ä¸€ä¸ªé˜Ÿåˆ—ï¼Œå³æ­»ä¿¡é˜Ÿåˆ—ã€‚å¯ä»¥ç›‘å¬è¿™ä¸ªé˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ã€ä»¥è¿›è¡Œç›¸åº”çš„å¤„ç†ï¼Œè¿™ä¸ªç‰¹æ€§ä¸å°†æ¶ˆæ¯çš„ TTL è®¾ç½®ä¸º 0 é…åˆä½¿ç”¨å¯ä»¥å¼¥è¡¥imrnediateå‚æ•°åŠŸèƒ½ã€‚</p>
<h3 id="å»¶è¿Ÿé˜Ÿåˆ—"><a href="#å»¶è¿Ÿé˜Ÿåˆ—" class="headerlink" title="å»¶è¿Ÿé˜Ÿåˆ—"></a>å»¶è¿Ÿé˜Ÿåˆ—</h3><p>å»¶è¿Ÿé˜Ÿåˆ—å­˜å‚¨çš„å¯¹è±¡æ˜¯å¯¹åº”çš„å»¶è¿Ÿæ¶ˆæ¯ï¼Œæ‰€è°“â€å»¶è¿Ÿæ¶ˆæ¯â€æ˜¯æŒ‡å½“æ¶ˆæ¯è¢«å‘é€ä»¥åï¼Œå¹¶ä¸æƒ³è®©æ¶ˆè´¹è€…ç«‹åˆ»æ‹¿åˆ°æ¶ˆæ¯ï¼Œè€Œæ˜¯ç­‰å¾…ç‰¹å®šæ—¶é—´åï¼Œæ¶ˆè´¹è€…æ‰èƒ½æ‹¿åˆ°è¿™ä¸ªæ¶ˆæ¯è¿›è¡Œæ¶ˆè´¹ ã€‚</p>
<p>åœ¨å›¾ 4-4 ä¸­ï¼Œä¸ä»…å±•ç¤ºçš„æ˜¯æ­»ä¿¡é˜Ÿåˆ—çš„ç”¨æ³•ï¼Œä¹Ÿæ˜¯å»¶è¿Ÿé˜Ÿåˆ—çš„ç”¨æ³•ï¼Œå¯¹äº queue.dlx è¿™ä¸ªæ­»ä¿¡é˜Ÿåˆ—æ¥è¯´ï¼ŒåŒæ ·å¯ä»¥çœ‹ä½œå»¶è¿Ÿé˜Ÿåˆ—ã€‚å‡è®¾ä¸€ä¸ªåº”ç”¨ä¸­éœ€è¦å°†æ¯æ¡æ¶ˆæ¯éƒ½è®¾ç½®ä¸º 10 ç§’çš„å»¶è¿Ÿï¼Œç”Ÿäº§è€…é€šè¿‡exchange.normal è¿™ä¸ªäº¤æ¢å™¨å°†å‘é€çš„æ¶ˆæ¯å­˜å‚¨åœ¨ queue.normal è¿™ä¸ªé˜Ÿåˆ—ä¸­ã€‚æ¶ˆè´¹è€…è®¢é˜…çš„å¹¶éæ˜¯ queue.normal è¿™ä¸ªé˜Ÿåˆ—ï¼Œè€Œæ˜¯ queue.dlx è¿™ä¸ªé˜Ÿåˆ— ã€‚å½“æ¶ˆæ¯ä» queue.normal è¿™ä¸ªé˜Ÿåˆ—ä¸­è¿‡æœŸä¹‹åè¢«å­˜å…¥ queue.dlx è¿™ä¸ªé˜Ÿåˆ—ä¸­ï¼Œæ¶ˆè´¹è€…å°±æ°å·§æ¶ˆè´¹åˆ°äº†å»¶è¿Ÿ 10 ç§’çš„è¿™æ¡æ¶ˆæ¯ ã€‚</p>
<p><img src="https://i.imgur.com/EksuM5p.png"></p>
<h3 id="ä¼˜å…ˆé˜Ÿåˆ—"><a href="#ä¼˜å…ˆé˜Ÿåˆ—" class="headerlink" title="ä¼˜å…ˆé˜Ÿåˆ—"></a>ä¼˜å…ˆé˜Ÿåˆ—</h3><p>ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼Œé¡¾åæ€ä¹‰ï¼Œå…·æœ‰é«˜ä¼˜å…ˆçº§çš„é˜Ÿåˆ—å…·æœ‰é«˜çš„ä¼˜å…ˆæƒï¼Œä¼˜å…ˆçº§é«˜çš„æ¶ˆæ¯å…·å¤‡ä¼˜å…ˆ<br>è¢«æ¶ˆè´¹çš„ç‰¹æƒã€‚å¯ä»¥é€šè¿‡è®¾ç½®é˜Ÿåˆ—çš„ x-max-priority å‚æ•°æ¥å®ç°ã€‚</p>
<h3 id="RPCå®ç°"><a href="#RPCå®ç°" class="headerlink" title="RPCå®ç°"></a>RPCå®ç°</h3><p> RPC çš„ä¸»è¦åŠŸç”¨æ˜¯è®©æ„å»ºåˆ†å¸ƒå¼è®¡ç®—æ›´å®¹æ˜“ï¼Œåœ¨æä¾›å¼ºå¤§çš„è¿œç¨‹è°ƒç”¨èƒ½åŠ›æ—¶ä¸æŸå¤±æœ¬åœ°è°ƒç”¨çš„è¯­ä¹‰ç®€æ´æ€§ã€‚</p>
<p>ä¸€èˆ¬åœ¨ RabbitMQ ä¸­è¿›è¡Œ RPC æ˜¯å¾ˆç®€å•ã€‚å®¢æˆ·ç«¯å‘é€è¯·æ±‚æ¶ˆæ¯ï¼ŒæœåŠ¡ç«¯å›å¤å“åº”çš„æ¶ˆæ¯ ã€‚ä¸ºäº†æ¥æ”¶å“åº”çš„æ¶ˆæ¯ï¼Œæˆ‘ä»¬éœ€è¦åœ¨è¯·æ±‚æ¶ˆæ¯ä¸­å‘é€ä¸€ä¸ªå›è°ƒé˜Ÿåˆ—ã€‚</p>
<p>è¿™é‡Œå°±ç”¨åˆ°ä¸¤ä¸ªå±æ€§ã€‚</p>
<ul>
<li>replyTo: é€šå¸¸ç”¨æ¥è®¾ç½®ä¸€ä¸ªå›è°ƒé˜Ÿåˆ—ã€‚</li>
<li>correlationId : ç”¨æ¥å…³è”è¯·æ±‚(request) å’Œå…¶è°ƒç”¨RPCä¹‹åçš„å›å¤(response ) ã€‚</li>
</ul>
<p>RPC çš„å¤„ç†æµç¨‹å¦‚ä¸‹ :</p>
<ol>
<li>å½“å®¢æˆ·ç«¯å¯åŠ¨æ—¶ï¼Œåˆ›å»ºä¸€ä¸ªåŒ¿åçš„å›è°ƒé˜Ÿåˆ—(åç§°ç”± RabbitMQ è‡ªåŠ¨åˆ›å»ºï¼Œå›¾ 4-7 ä¸­<br>çš„å›è°ƒé˜Ÿåˆ—ä¸º amq.gen-LhQzlgv3GhDOv8PIDabOXA ã€‚</li>
<li>å®¢æˆ·ç«¯ä¸º RPC è¯·æ±‚è®¾ç½® 2 ä¸ªå±æ€§ : reply T o ç”¨æ¥å‘ŠçŸ¥ RPC æœåŠ¡ç«¯å›å¤è¯·æ±‚æ—¶çš„ç›®çš„<br>é˜Ÿåˆ—ï¼Œå³å›è°ƒé˜Ÿåˆ—; correlationld ç”¨æ¥æ ‡è®°ä¸€ä¸ªè¯·æ±‚ã€‚</li>
<li>è¯·æ±‚è¢«å‘é€åˆ° rpc_queue é˜Ÿåˆ—ä¸­ã€‚</li>
<li>RPC æœåŠ¡ç«¯ç›‘å¬ rpc_queue é˜Ÿåˆ—ä¸­çš„è¯·æ±‚ï¼Œå½“è¯·æ±‚åˆ°æ¥æ—¶ ï¼Œ æœåŠ¡ç«¯ä¼šå¤„ç†å¹¶ä¸”æŠŠå¸¦æœ‰<br>ç»“æœçš„æ¶ˆæ¯å‘é€ç»™å®¢æˆ·ç«¯ã€‚ æ¥æ”¶çš„é˜Ÿåˆ—å°±æ˜¯ replyTo è®¾å®š çš„ å›è°ƒé˜Ÿåˆ—ã€‚</li>
<li>å®¢æˆ·ç«¯ç›‘æ˜•å›è°ƒé˜Ÿåˆ—ï¼Œå½“æœ‰æ¶ˆæ¯æ—¶ ï¼Œ æ£€æŸ¥ correlationld å±æ€§ï¼Œå¦‚æœä¸è¯·æ±‚åŒ¹é…ï¼Œ<br>é‚£å°±æ˜¯ç»“æœäº†ã€‚</li>
</ol>
<h3 id="æŒä¹…åŒ–"><a href="#æŒä¹…åŒ–" class="headerlink" title="æŒä¹…åŒ–"></a>æŒä¹…åŒ–</h3><p>RabbitMQçš„æŒä¹…åŒ–åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†:äº¤æ¢å™¨çš„æŒä¹…åŒ–ã€é˜Ÿåˆ—çš„æŒä¹…åŒ–å’Œæ¶ˆæ¯çš„æŒä¹…åŒ– ã€‚</p>
<p>äº¤æ¢å™¨çš„æŒä¹…åŒ–æ˜¯é€šè¿‡åœ¨å£°æ˜é˜Ÿåˆ—æ˜¯å°† durable å‚æ•°ç½®ä¸º true å®ç°çš„ã€‚</p>
<p>é˜Ÿåˆ—çš„æŒä¹…åŒ–æ˜¯é€šè¿‡åœ¨å£°æ˜é˜Ÿåˆ—æ—¶å°† durable å‚æ•°ç½®ä¸º true å®ç°çš„ã€‚</p>
<p>é˜Ÿåˆ—çš„æŒä¹…åŒ–èƒ½ä¿è¯å…¶æœ¬èº«çš„å…ƒæ•°æ®ä¸ä¼šå› å¼‚å¸¸æƒ…å†µè€Œä¸¢å¤±ï¼Œä½†æ˜¯å¹¶ä¸èƒ½ä¿è¯å†…éƒ¨æ‰€å­˜å‚¨çš„<br>æ¶ˆæ¯ä¸ä¼šä¸¢å¤±ã€‚è¦ç¡®ä¿æ¶ˆæ¯ä¸ä¼šä¸¢å¤± ï¼Œ éœ€è¦å°†å…¶è®¾ç½®ä¸ºæŒä¹…åŒ–ã€‚é€šè¿‡å°†æ¶ˆæ¯çš„æŠ•é€’æ¨¡å¼<br>(BasicProperties ä¸­çš„deliveryMode å±æ€§)è®¾ç½®ä¸º 2 å³å¯å®ç°æ¶ˆæ¯çš„æŒä¹…åŒ–ã€‚</p>
<h3 id="ç”Ÿäº§è€…ç¡®è®¤"><a href="#ç”Ÿäº§è€…ç¡®è®¤" class="headerlink" title="ç”Ÿäº§è€…ç¡®è®¤"></a>ç”Ÿäº§è€…ç¡®è®¤</h3><p>æ¶ˆæ¯çš„ç”Ÿäº§è€…å°†æ¶ˆæ¯å‘é€å‡ºå»ä¹‹åï¼Œæ¶ˆæ¯åˆ°åº•æœ‰æ²¡æœ‰æ­£ç¡®åœ°åˆ°è¾¾æœåŠ¡å™¨å‘¢?å¦‚æœä¸è¿›è¡Œç‰¹æ®Šé…ç½®ï¼Œé»˜è®¤æƒ…å†µä¸‹å‘é€æ¶ˆæ¯çš„æ“ä½œæ˜¯ä¸ä¼šè¿”å›ä»»ä½•ä¿¡æ¯ç»™ç”Ÿäº§è€…çš„ï¼Œä¹Ÿå°±æ˜¯é»˜è®¤æƒ…å†µä¸‹ç”Ÿäº§è€…æ˜¯ä¸çŸ¥é“æ¶ˆæ¯æœ‰æ²¡æœ‰æ­£ç¡®åœ°åˆ°è¾¾æœåŠ¡å™¨ã€‚å¦‚æœåœ¨æ¶ˆæ¯åˆ°è¾¾æœåŠ¡å™¨ä¹‹å‰å·±ç»ä¸¢å¤±ï¼ŒæŒä¹…åŒ–æ“ä½œä¹Ÿè§£å†³ä¸äº†è¿™ä¸ªé—®é¢˜ï¼Œå› ä¸ºæ¶ˆæ¯æ ¹æœ¬æ²¡æœ‰åˆ°è¾¾<br>æœåŠ¡å™¨ ï¼Œä½•è°ˆæŒä¹…åŒ–?</p>
<p>RabbitMQ é’ˆå¯¹è¿™ä¸ªé—®é¢˜ï¼Œæä¾›äº†ä¸¤ç§è§£å†³æ–¹å¼:</p>
<ul>
<li>é€šè¿‡äº‹åŠ¡æœºåˆ¶å®ç°</li>
<li>é€šè¿‡å‘é€æ–¹ç¡®è®¤publisher confirm  æœºåˆ¶å®ç°ã€‚</li>
</ul>
<h4 id="äº‹åŠ¡æœºåˆ¶"><a href="#äº‹åŠ¡æœºåˆ¶" class="headerlink" title="äº‹åŠ¡æœºåˆ¶"></a>äº‹åŠ¡æœºåˆ¶</h4><p>Rabb itMQ å®¢æˆ·ç«¯ä¸­ä¸äº‹åŠ¡æœºåˆ¶ç›¸å…³çš„æ–¹æ³•æœ‰ ä¸‰ ä¸ª: channel.txSelect ã€channel .txCommit å’Œ channel.txRollbackoã€‚<br>channel.txSelect ç”¨äºå°†å½“å‰çš„ä¿¡é“è®¾ç½®æˆäº‹åŠ¡æ¨¡å¼ã€‚<br>channel.txCommit ç”¨äºæäº¤äº‹åŠ¡ã€‚<br>channel.txRollback ç”¨äºäº‹åŠ¡å›æ»šã€‚</p>
<p>åœ¨é€šè¿‡ channel.txSelect æ–¹æ³•å¼€å¯äº‹åŠ¡ä¹‹åï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥å‘å¸ƒæ¶ˆæ¯ç»™ RabbitMQ äº†ï¼Œå¦‚æœäº‹åŠ¡æäº¤æˆåŠŸï¼Œåˆ™æ¶ˆæ¯ä¸€å®šåˆ°è¾¾äº† RabbitMQ ä¸­ï¼Œå¦‚æœåœ¨äº‹åŠ¡æäº¤æ‰§è¡Œä¹‹å‰ç”±äº RabbitMQå¼‚å¸¸å´©æºƒæˆ–è€…å…¶ä»–åŸå› æŠ›å‡ºå¼‚å¸¸ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬ä¾¿å¯ä»¥å°†å…¶æ•è·ï¼Œè¿›è€Œé€šè¿‡æ‰§è¡Œchannel.txRollback æ–¹æ³•æ¥å®ç°äº‹åŠ¡å›å¤œã€‚æ³¨æ„è¿™é‡Œçš„ RabbitMQ ä¸­çš„äº‹åŠ¡æœºåˆ¶ä¸å¤§å¤šæ•°æ•°æ®åº“ä¸­çš„äº‹åŠ¡æ¦‚å¿µäº•ä¸ç›¸åŒï¼Œéœ€è¦æ³¨æ„åŒºåˆ†ã€‚</p>
<p>åŠ¡ç¡®å®èƒ½å¤Ÿè§£å†³æ¶ˆæ¯å‘é€æ–¹å’Œ RabbitMQ ä¹‹é—´æ¶ˆæ¯ç¡®è®¤çš„é—®é¢˜ï¼Œåªæœ‰æ¶ˆæ¯æˆåŠŸè¢«<br>RabbitMQ æ¥æ”¶ï¼Œäº‹åŠ¡æ‰èƒ½æäº¤æˆåŠŸï¼Œå¦åˆ™ä¾¿å¯åœ¨æ•è·å¼‚å¸¸ä¹‹åè¿›è¡Œäº‹åŠ¡å›æ»š ï¼Œä¸æ­¤åŒæ—¶å¯ä»¥è¿›<br>è¡Œæ¶ˆæ¯é‡å‘ã€‚ä½†æ˜¯ä½¿ç”¨äº‹åŠ¡æœºåˆ¶ä¼šâ€å¸å¹²â€ RabbitMQ çš„æ€§èƒ½ã€‚</p>
<h4 id="å‘é€æ–¹ç¡®è®¤æœºåˆ¶"><a href="#å‘é€æ–¹ç¡®è®¤æœºåˆ¶" class="headerlink" title="å‘é€æ–¹ç¡®è®¤æœºåˆ¶"></a>å‘é€æ–¹ç¡®è®¤æœºåˆ¶</h4><p>ç”Ÿäº§è€…å°†ä¿¡é“è®¾ç½®æˆ confirmn ï¼ˆç¡®è®¤)æ¨¡å¼ï¼Œä¸€æ—¦ä¿¡é“è¿›å…¥ confmn æ¨¡å¼ï¼Œæ‰€æœ‰åœ¨è¯¥ä¿¡é“ä¸Šé¢å‘å¸ƒçš„æ¶ˆæ¯éƒ½ä¼šè¢«æŒ‡æ´¾ä¸€ä¸ªå”¯ä¸€çš„ IDï¼ˆä»1å¼€å§‹)ï¼Œä¸€æ—¦æ¶ˆæ¯è¢«æŠ•é€’åˆ°æ‰€æœ‰åŒ¹é…çš„é˜Ÿåˆ—ä¹‹åï¼ŒRabbitMQ å°±ä¼šå‘é€ä¸€ä¸ªç¡®è®¤ ï¼ˆBasic.Ack) ç»™ç”Ÿäº§è€…(åŒ…å«æ¶ˆæ¯çš„å”¯ä¸€ ID) ï¼Œè¿™å°±ä½¿å¾—ç”Ÿäº§è€…çŸ¥æ™“æ¶ˆæ¯å·²ç»æ­£ç¡®åˆ°è¾¾äº†ç›®çš„åœ°äº†ã€‚å¦‚æœæ¶ˆæ¯å’Œé˜Ÿåˆ—æ˜¯å¯æŒä¹…åŒ–çš„ï¼Œé‚£ä¹ˆç¡®è®¤æ¶ˆæ¯ä¼šåœ¨æ¶ˆæ¯å†™å…¥ç£ç›˜ä¹‹åå‘å‡ºã€‚ RabbitMQ å›ä¼ ç»™ç”Ÿäº§è€…çš„ç¡®è®¤æ¶ˆæ¯ä¸­çš„ deliveryTag åŒ…å«äº†ç¡®è®¤æ¶ˆæ¯çš„åºå·ï¼Œæ­¤å¤– RabbitMQ ä¹Ÿå¯ä»¥è®¾ç½® channel.basicAck æ–¹æ³•ä¸­çš„multiple å‚æ•°ï¼Œè¡¨ç¤ºåˆ°è¿™ä¸ªåºå·ä¹‹å‰çš„æ‰€æœ‰æ¶ˆæ¯éƒ½å·±ç»å¾—åˆ°äº†å¤„ç†ã€‚</p>
<p><img src="https://i.imgur.com/alg8Te7.png"></p>
<p>å‘é€æ–¹ç¡®è®¤æœºåˆ¶æœ€å¤§çš„å¥½å¤„åœ¨äºå®ƒæ˜¯å¼‚æ­¥çš„ï¼Œä¸€æ—¦å‘å¸ƒä¸€æ¡æ¶ˆæ¯ï¼Œç”Ÿäº§è€…åº”ç”¨ç¨‹åºå°±å¯ä»¥åœ¨ç­‰ä¿¡é“è¿”å›ç¡®è®¤çš„åŒæ—¶ç»§ç»­å‘é€ä¸‹ä¸€æ¡æ¶ˆæ¯ï¼Œå½“æ¶ˆæ¯æœ€ç»ˆå¾—åˆ°ç¡®è®¤ä¹‹åï¼Œç”Ÿäº§è€…åº”ç”¨ç¨‹åºä¾¿å¯ä»¥é€šè¿‡å›è°ƒæ–¹æ³•æ¥å¤„ç†è¯¥ç¡®è®¤æ¶ˆæ¯ï¼Œå¦‚æœ RabbitMQ å› ä¸ºè‡ªèº«å†…éƒ¨é”™è¯¯å¯¼è‡´æ¶ˆæ¯ä¸¢å¤±ï¼Œå°±ä¼šå‘é€ä¸€æ¡ nackï¼ˆBasic.Nack) å‘½ä»¤ï¼Œç”Ÿäº§è€…åº”ç”¨ç¨‹åºåŒæ ·å¯ä»¥åœ¨å›è°ƒæ–¹æ³•ä¸­å¤„ç†è¯¥ nack å‘½ä»¤ã€‚</p>
<blockquote>
<p>RabbitMQå®æˆ˜æŒ‡å—</p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/03/centos7%E9%83%A8%E7%BD%B2redis%E9%9B%86%E7%BE%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/image.png">
      <meta itemprop="name" content="ä¸‰åè€Œç«‹">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ä¸‰åè€Œç«‹çš„åšå®¢">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ä¸‰åè€Œç«‹çš„åšå®¢">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/06/03/centos7%E9%83%A8%E7%BD%B2redis%E9%9B%86%E7%BE%A4/" class="post-title-link" itemprop="url">centos7éƒ¨ç½²redisä¼ªé›†ç¾¤</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2019-06-03 21:16:20" itemprop="dateCreated datePublished" datetime="2019-06-03T21:16:20+08:00">2019-06-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-09-21 23:32:32" itemprop="dateModified" datetime="2025-09-21T23:32:32+08:00">2025-09-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Redis/" itemprop="url" rel="index"><span itemprop="name">Redis</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>649</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>2 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="ç¯å¢ƒ"><a href="#ç¯å¢ƒ" class="headerlink" title="ç¯å¢ƒ"></a>ç¯å¢ƒ</h3><p>ç³»ç»Ÿï¼š centos7</p>
<p>Redisï¼š redis-3.2.4</p>
<p>rbenv: 2.6.3</p>
<p>å®‰è£…ç›®å½•ï¼š &#x2F;root&#x2F;temp&#x2F;</p>
<h3 id="éƒ¨ç½²æµç¨‹"><a href="#éƒ¨ç½²æµç¨‹" class="headerlink" title="éƒ¨ç½²æµç¨‹"></a>éƒ¨ç½²æµç¨‹</h3><ol>
<li><p>ä¸‹è½½rediså¹¶ä¸Šä¼ åˆ°æœåŠ¡å™¨å¹¶è§£å‹åˆ°<code>/root/temp/redis-3.2.4</code></p>
</li>
<li><p>ç¼–è¯‘redisï¼Œåœ¨<code>/root/temp/redis-3.2.4</code> ç›®å½•ä¸‹è¾“å…¥make</p>
</li>
<li><p>å®‰è£…ruby</p>
<ol>
<li><p>å®‰è£…rbenv</p>
<pre><code> #install build dependencies
 sudo yum install -y git-core zlib zlib-devel gcc-c ++ patch readline readline-devel libyaml-devel libffi-devel openssl-devel make bzip2 autoconf automake libtool bison curl sqlite-devel
 
 #climå¹¶å®‰è£…rbenvç¯å¢ƒ
 cd~
 git clone gitï¼š//github.com/sstephenson/rbenv.git .rbenv
 git clone gitï¼š//github.com/sstephenson/ruby-build.git~ / .rbenv / plugins / rubyâ€‹â€‹-build
 echo&#39;export PATH =â€œ$ HOME / .rbenv / binï¼š$ HOME / .rbenv / plugins / rubyâ€‹â€‹-build / binï¼š$ PATHâ€&#39;&gt;&gt;ã€œ/ .bash_profile
 echo&#39;evalâ€œ$ï¼ˆrbenv init  - ï¼‰â€&#39;&gt;&gt;ã€œ/ .bash_profile
 
 #re-init bash
 source~ / .bash_profile
 
 #installæœ€æ–°çš„ruby
 rbenv install -v 2.6.3
 
 ï¼ƒè®¾ç½®shellå°†ä½¿ç”¨çš„é»˜è®¤rubyç‰ˆæœ¬
 rbenv global 2.6.3
 
 ï¼ƒç¦ç”¨ç”Ÿæˆæ–‡æ¡£ï¼Œå› ä¸ºè¿™éœ€è¦èŠ±è´¹å¾ˆå¤šæ—¶é—´
 echoâ€œgemï¼š -  no-documentâ€&gt;ã€œ/ .gemrc
 
 #install bundler
 gem install bundler
 
 æ¯æ¬¡å®‰è£…gemæ—¶éƒ½å¿…é¡»æ‰§è¡Œï¼ƒï¼Œä»¥ä¾¿è¿è¡Œrubyå¯æ‰§è¡Œæ–‡ä»¶
 rbenv rehash
</code></pre>
</li>
<li><p>åœ¨ä½¿ç”¨ä¸Šé¢çš„å®‰è£…rubyå¦‚æœå‡ºç°æ— æ³•ä¸‹è½½æ–‡ä»¶ï¼Œæ­¤æ—¶å¯ä»¥é€šè¿‡ä¸‹è½½å¥½rubyï¼Œæˆ‘é€‰æ‹©çš„æ˜¯æœ€æ–°ruby-2.6.3ï¼Œä¸Šä¼ åˆ°æœåŠ¡å™¨&#x2F;root&#x2F;temp&#x2F;ç›®å½•ä¸‹ï¼Œè¿›å…¥<code>/root/.rbenv/plugins/ruby-build/share/ruby-build</code>ç›®å½•ä¸‹ï¼Œæ‰¾åˆ°å¯¹åº”çš„æ–‡ä»¶ä¹Ÿå°±æ˜¯2.6.3ï¼Œæ‰“å¼€è¿™ä¸ªæ–‡ä»¶ï¼Œä¿®æ”¹</p>
<pre><code> install_package &quot;openssl-1.0.2j&quot; &quot;https://www.openssl.org/source/openssl-1.0.2j.tar.gz#e7aff292be21c259c6af26469c7a9b3ba26e9abaaffd325e3dccc9785256c431&quot; mac_openssl --if has_broken_mac_openssl
 install_package &quot;ruby-2.6.3&quot; &quot;file:///root/temp/ruby-2.6.3.tar.gz&quot; 
</code></pre>
</li>
<li><p>å¦‚æœä½¿ç”¨rvmæ¥å®‰è£…rubyï¼Œåœ¨æœ¬æœºä¸Šä¼šå‡ºç°CAè¯ä¹¦è¿‡æœŸæ— æ³•ä¸‹è½½æ–‡ä»¶ã€‚</p>
</li>
</ol>
</li>
<li><p>é…ç½®redisé›†ç¾¤</p>
<ol>
<li><p>åœ¨<code>/root/temp/redis-3.2.4</code>ç›®å½•ä¸‹æ–°å»ºç›®å½•redis-cluster</p>
</li>
<li><p>åœ¨ç›®å½•redis-clusterä¸‹åˆ›å»º7001 7002 7003 7004 7005 7006 ç›®å½•</p>
</li>
<li><p>å°†<code>/root/temp/redis-3.2.4</code>ç›®å½•ä¸‹çš„redis.confé…ç½®æ–‡ä»¶å¤åˆ¶åˆ°7001 â€¦ 7006 ç›®å½•ä¸‹</p>
</li>
<li><p>åˆ†é…ä¿®æ”¹7001-7006ç›®å½•ä¸‹çš„redis.conf æ–‡ä»¶ä¿®æ”¹ä¸ºå¯¹åº”çš„ç«¯å£å·</p>
<pre><code> port 7001 #è¦æ ¹æ®æ‰€åœ¨çš„å­ç›®å½•ä¸‹é…ç½®
 daemonize yes
 pidfile /var/run/redis_7001.pid  #è¦æ ¹æ®æ‰€åœ¨çš„å­ç›®å½•ä¸‹é…ç½®
 logfile &quot;/var/log/redis-7001.log&quot; #è¦æ ¹æ®æ‰€åœ¨çš„å­ç›®å½•ä¸‹é…ç½®
 appendonly yes
 cluster-enabled yes
 cluster-config-file nodes-7001.conf #è¦æ ¹æ®æ‰€åœ¨çš„å­ç›®å½•ä¸‹é…ç½®
 cluster-node-timeout 15000
</code></pre>
</li>
<li><p>å¯åŠ¨redis - åœ¨å¯¹åº”ç›®å½•ä¸‹è¾“å…¥å‘½ä»¤ï¼Œé€ä¸ªå¯åŠ¨</p>
<pre><code> cd  7001
 /root/temp/redis-3.2.4/src/redis-server redis.conf
 cd ..
 cd  7002
 /root/temp/redis-3.2.4/src/redis-server redis.conf
 cd ..
 cd  7003
 cd ..
 /root/temp/redis-3.2.4/src/redis-server redis.conf
 cd  7004
 cd ..
 /root/temp/redis-3.2.4/src/redis-server redis.conf
 cd ..
    cd  7005
 /root/temp/redis-3.2.4/src/redis-server redis.conf
 cd  7006
 /root/temp/redis-3.2.4/src/redis-server redis.conf
</code></pre>
</li>
<li><p>å¯åŠ¨redisé›†ç¾¤ â€” åœ¨<code>/root/temp/redis-3.2.4 </code>ç›®å½•ä¸‹è¾“å…¥</p>
<pre><code> src/redis-trib create --replicas 1 127.0.0.1:7001  127.0.0.1:7002 127.0.0.1:7003 127.0.0.1:7004 127.0.0.1:7005 127.0.0.1:7006
</code></pre>
</li>
</ol>
</li>
</ol>
<blockquote>
<p><a href="https://www.cnblogs.com/or2-/p/5084282.html">rbenvå®‰è£…ruby2.3.0åœ¨çº¿å®‰è£…ä¸ä¸Šã€‚è€å­å‡ºç»æ‹›äº†(æ›´æ–°) </a><br><a href="https://gist.github.com/soardex/e95cdc230d1ac5b824b3">https://gist.github.com/soardex/e95cdc230d1ac5b824b3</a></p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" title="ä¸‹ä¸€é¡µ" aria-label="ä¸‹ä¸€é¡µ" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">ä¸‰åè€Œç«‹</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="ç«™ç‚¹æ€»å­—æ•°">61k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="ç«™ç‚¹é˜…è¯»æ—¶é•¿">3:40</span>
  </span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> å¼ºåŠ›é©±åŠ¨
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="è¿”å›é¡¶éƒ¨">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
